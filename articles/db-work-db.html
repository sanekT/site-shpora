<div class="wrap">
    <h2 class="header-style">Работа с БД</h2>
    
    
    <h3 class="header-style2"></h3>
    <p>Начало. Уровень 2 день 2, 00:46:10</p>
    <p>SQL:</p>
    <img class="screen-2" src="../img/php/13.png" alt="">
    
    <h3 class="header-style2">Основные манипуляции с данными</h3>
    <p><b>ORDER BY</b> - это сортировка по полю в порядке возрастания <b>ASC</b> или убывания <b>DESC</b>.</p>
    <p><b>LIMIT</b> - это количество записей над которыми будут производиться действия.</p>
    <p><span class="vue-r">Хороший сайт, где указаны примеры работы с PHP, с БД, с куки, с сессиями и т.д.</span><a href="http://komotoz.ru/uroki/php/mysql_zaprosy.php">тут</a>.</p>
    
    
    <p><b>Очистить таблицу category в БД im:</b> - $query = "TRUNCATE `im`.`category`";</p>
    <p><b>Удалить поле parent_id в таблице products:</b> - $query = "ALTER TABLE `products` DROP `parent_id`;"</p>
    <p><b>Переименовать в БД im таблицу products в таблицу teachers:</b> - $query = "RENAME TABLE `im`.`products` TO `im`.`teachers`";</p>
    
    
    <p><b>Выборка данных:</b></p>
    <div class="code-style">
        <pre>
            <span class="vue-b">SELECT</span> что выбрать 
                [<span class="vue-b">FROM</span> таблица]
                [<span class="vue-b">WHERE</span> условие]
                [<span class="vue-b">GROUP BY</span> поле]
                [<span class="vue-b">ORDER BY</span> поле]
                [<span class="vue-b">LIMIT</span> количество записей]
                
            //получить все поля со значенниями под id=1 и id=2
            <span class="vue-b">SELECT</span> * 
                <span class="vue-b">FROM</span> news
                <span class="vue-b">WHERE</span> id <span class="vue-b">IN</span> (1,2)
                
            //получить id поля name 'Маша' и 'Саша'
            <span class="vue-b">SELECT</span> id 
                <span class="vue-b">FROM</span> news
                <span class="vue-b">WHERE</span> name <span class="vue-b">IN</span> ('Маша','Саша')
                
            //получить id поля name всех кроме 'Маша' и 'Саша'
            <span class="vue-b">SELECT</span> id 
                <span class="vue-b">FROM</span> news
                <span class="vue-b">WHERE</span> name <span class="vue-b">NOT IN</span> ('Маша','Саша')
                
            //получить все новости написаные автором под id = 1
            <span class="vue-b">SELECT</span> * 
                <span class="vue-b">FROM</span> news
                <span class="vue-b">WHERE</span> author_id = '1'
                
            //получить 5 последних новостей написаные от новых к старым
            <span class="vue-b">SELECT</span> * 
                <span class="vue-b">FROM</span> news
                <span class="vue-b">ORDER BY</span> date
                <span class="vue-b">DESC</span>
                <span class="vue-b">LIMIT</span> 5
           
            //Выбрать все имена из поля <b>name</b> таблицы <b>teacher</b>. По умолчанию вернёт в том порядке, в котором были добавлены.
            <span class="vue-b">SELECT</span> name <span class="vue-b">FROM</span> teacher
            
            //Выбрать все имена, адреса, города из таблицы <b>teacher</b> и отсортировать их по полю <b>name</b>
            <span class="vue-b">SELECT</span> name, addr, city
                <span class="vue-b">FROM</span> teacher
                <span class="vue-b">ORDER BY</span> name
                
            //Выбрать все названия поля <b>title</b> из таблицы <b>courses</b>, но только те где поле <b>length</b> > 30
            <span class="vue-b">SELECT</span> title
                <span class="vue-b">FROM</span> courses
                <span class="vue-b">WHERE</span> length > 30
            
            //Выбрать все поля из таблицы <b>courses</b>, но только те где поле <b>length</b> > 30 и эти названия должны иметь в начале слово 'Web', например Web-disigner, Web-programmer. На боевых сайтах не рекрмендуюут использовать *
            <span class="vue-b">SELECT</span> *
                <span class="vue-b">FROM</span> courses
                <span class="vue-b">WHERE</span> length > 30
                <span class="vue-b">AND</span> title <span class="vue-b">LIKE</span> 'Web%'
                
            //Выбрать уникальные значения продолжительности курсов
            <span class="vue-b">SELECT</span> <span class="vue-b">DISTINCT</span> length
                <span class="vue-b">FROM</span> courses
        </pre>
    </div>
    <p><b>Объединение таблиц.</b></p>
    <p>Есть 2 таблицы в БД. Одна это teachers, другая lessons:</p>
    <img class="screen" src="../img/php/14.png" alt="">
    <p>Нам нужно узнать кто из учитилей читал какие курсы. Как видно из таблицы читал курсы только Иванов. Запрос будет выглядеть так:</p>
    <div class="code-style">
        <pre>
            //выбрать имя, код имени и курс из таблицы <b>teachers</b> в связке с таблицей <b>lessons</b> по критерию <b>t.id = l.tid</b>
            <span class="vue-b">SELECT</span> t.name, t.code, l.course
                <span class="vue-b">FROM</span> teacher t
                <span class="vue-b">INNER JOIN</span> lessons l <span class="vue-b">ON</span> t.id = l.tid
        </pre>
    </div>
    <p>В результате выборки получим такой массив:</p>
    <img class="screen-2" src="../img/php/15.png" alt="">
    
    
    <p><b>Один ко многим.</b></p>
    <p>Есть 2 таблицы: одна таблица - категории товаров(category), другая сами товары(products). Задача: получить по категории, например "Ягоды" товары относящиеся к этой категории.</p>
    <p align="center" style="color:red;">category</p>
    <img class="screen-2" src="../img/php/16.png" alt="">
    <p align="center" style="color:red;">products</p>
    <img class="screen-2" src="../img/php/17.png" alt="">
    <p>В таблице products поле parent_id содержит id категорий к которым относятся товары. Можно написать запрос несколькими способами. Первый способ это вложеные запросы</p>
    <div class="code-style">
        <pre>
            //выбрать поле name из products где parent_id = и опять новая выборка id из таблицы category по искомому полю Ягоды, т.е. находим id Ягоды и возвращаем этот id в parent_id и уже возвращаются все товары, у которых такой parent_id
            <span class="vue-b">SELECT</span> name
                <span class="vue-b">FROM</span> products
                <span class="vue-b">WHERE</span> parent_id=(
                    <span class="vue-b">SELECT</span> id
                    <span class="vue-b">FROM</span> category
                    <span class="vue-b">WHERE</span> name='Ягоды')
                    
            //ответ
            Array
            (
                [0] => Array
                    (
                        [name] => Арбуз
                    )

                [1] => Array
                    (
                        [name] => Малина
                    )

            )
        </pre>
    </div>
    <p>Один ко многим называется так, потому что ищем по одной категории много товаров.</p>
    <p>Вложенные запросы не так быстро работают как запросы с инструкцией JOIN. Самыми быстрыми являются запросы с внутренним объединением таблиц INNER JOIN. Итак второй спсоб с использованием JOIN:</p>
    <div class="code-style">
        <pre>
            //выбрать поле name таблицы products в связке с таблицей category по признаку, что parent_id таблицы products равен category.id где id категории равен 2
            <span class="vue-b">SELECT</span> products.name
                <span class="vue-b">FROM</span> products
                <span class="vue-b">LEFT JOIN</span> category
                <span class="vue-b">ON</span> products.parent_id=category.id
                <span class="vue-b">WHERE</span> category.id=1
            
            //ответ
            Array
            (
                [0] => Array
                    (
                        [name] => Персик
                    )

                [1] => Array
                    (
                        [name] => Яблоко
                    )

            )
        </pre>
    </div>
    <p>Теперь напишем запрос, чтобы вернулось и категории и товары, так как id кактегории и товаров вместе нельзя ставить, один другого просто заместит, то нужно кому то из них придумать вымышленное имя, давайте товарам дадим такое имя:</p>
    <div class="code-style">
        <pre>
            //выбрать поле name таблицы category и products в связке с таблицей category по признаку, что parent_id таблицы products равен category.id
            <span class="vue-b">SELECT</span> category.id, category.name, products.id as p_id, products.name as p_name
                <span class="vue-b">FROM</span> products
                <span class="vue-b">LEFT JOIN</span> category
                <span class="vue-b">ON</span> products.parent_id=category.id
            
            //ответ
            Array
            (
                [0] => Array
                    (
                        [name] => Овощи
                        [p_name] => Свекла
                    )

                [1] => Array
                    (
                        [name] => Овощи
                        [p_name] => Картошка
                    )

                [2] => Array
                    (
                        [name] => Фрукты
                        [p_name] => Персик
                    )

                [3] => Array
                    (
                        [name] => Фрукты
                        [p_name] => Яблоко
                    )

                [4] => Array
                    (
                        [name] => Ягоды
                        [p_name] => Арбуз
                    )

                [5] => Array
                    (
                        [name] => Ягоды
                        [p_name] => Малина
                    )

            )
        </pre>
    </div>
    
    
    
    
    
    <p><b>Многие ко многим.</b></p>
    <p>Возьмём опять 3 таблицы, нам нужно узнать какие студенты у каких учителей учатся, как в запросах выше использовать parent_id уже не получится, поэтому нужна 3я таблица, в которой мы указываем id студента напротив id учителя</p> 
    <p align="center" style="color:red;">teachers</p>
    <img class="screen-2" src="../img/php/18.png" alt="">
    <p align="center" style="color:red;">students</p>
    <img class="screen-2" src="../img/php/19.png" alt="">
    <p align="center" style="color:red;">stud_tech</p>
    <img class="screen" src="../img/php/20.png" alt="">
    <p>Тут теперь нужно соединить 3 таблицы. Присоединяем к таблице учителя таблицу stud_tech по признаку teachers.id=stud_tech.teachers, и теперь надо присоединить таблицу студенты по признаку students.id=stud_tech.students:</p>
    <div class="code-style">
        <pre>
            <span class="vue-b">SELECT</span> teachers.name, students.name as s_name
                <span class="vue-b">FROM</span> teachers
                <span class="vue-b">LEFT JOIN</span> stud_tech
                <span class="vue-b">ON</span> 
                teachers.id=stud_tech.teachers
                <span class="vue-b">LEFT JOIN</span> students
                <span class="vue-b">ON</span> students.id=stud_tech.students
            //ответ
            Array
            (
                [0] => Array
                    (
                        [name] => Марь ивановна
                        [s_name] => Саша
                    )

                [1] => Array
                    (
                        [name] => Марь ивановна
                        [s_name] => Маша
                    )

                [2] => Array
                    (
                        [name] => Иван Петрович
                        [s_name] => Саша
                    )

                [3] => Array
                    (
                        [name] => Иван Петрович
                        [s_name] => Маша
                    )

                [4] => Array
                    (
                        [name] => Иван Петрович
                        [s_name] => Миша
                    )

                [5] => Array
                    (
                        [name] => Дмитрий Вадимович
                        [s_name] => 
                    )

                [6] => Array
                    (
                        [name] => Алёна Александровна
                        [s_name] => 
                    )

            )
        </pre>
    </div>
    
    
    
    
    
    <p><b>Вставка новой записи:</b></p>
    <div class="code-style">
        <pre>
            <span class="vue-b">INSERT INTO</span> название табл.(поле1, поле2)
                <span class="vue-b">VALUES</span> (значение1, значение2)
            
            <span class="vue-b">INSERT INTO</span> название табл.
                <span class="vue-b">VALUES</span> (значение1, значение2, значение3)
                
            //запись нескольких строк в таблицу
            <span class="vue-b">INSERT INTO</span> название табл.(поле1, поле2)
                <span class="vue-b">VALUES</span> (значение1, значение2), (значение1, значение2)
           
            //записать в таблицу <b>courses</b> в каждое поле по порядку значения. В первое поле - NULL, во второе поле PHP и так далее.
            <span class="vue-b">INSERT INTO</span> courses
                <span class="vue-b">VALUES</span> (NULL, 'PHP', '...', 40)
                
            //записать в таблицу <b>courses</b> в поле <b>title</b> - PHP и в поле <b>length</b> значение 40
            <span class="vue-b">INSERT INTO</span> courses()
                <span class="vue-b">VALUES</span> (NULL, 'PHP', '...', 40)
                
                
                
                
            //записать в поля <b>id</b>, <b>name</b>, <b>text</b>, <b>data</b> следующие значения из переменных. Важно!!! Переменные в запросе оборачиваем в ''
            $name = 'Маша';
            $text = 'Сообщение от Маши';
            $sqlInsert = "INSERT INTO users VALUES(NULL, '$name', '$text', NOW())";
            $result = mysqli_query($link, $sqlInsert);
        </pre>
    </div>
    <p><b>Удаление записи:</b></p>
    <div class="code-style">
        <pre>
            <span class="vue-b">DELETE FROM</span> название табл.
                [<span class="vue-b">WHERE</span> условие]
                [<span class="vue-b">ORDER BY</span> поле]
                [<span class="vue-b">LIMIT</span> количество записей]
            
            //удаление по дате. Например, удалить все новости записаные раньше 5ти дней назад
            <span class="vue-b">DELETE FROM</span> название табл.
                <span class="vue-b">WHERE</span> date &lt; DATE_SUB(CURDATE(), INTERVAL 5 DAY)
            //CURDATE() - дата сейчас
            //INTERVAL 5 DAY - отрезок времени 5 дней
            //DATA_SUB(a, b) - вычесть из даты <b>a</b> отрезок времени <b>b</b>
            
            //удалить 3 последние новости(последние значит свежие записи)
            <span class="vue-b">DELETE FROM</span> название табл.
                <span class="vue-b">ORDER BY</span> date
                <span class="vue-b">DESC</span>
                <span class="vue-b">LIMIT</span> 3
                
            //удалить записи у которых поле date = '2021-06-11'
            <span class="vue-b">DELETE FROM</span> название табл.
                <span class="vue-b">WHERE</span> date = '2021-06-11'
            
            //удалить все записи в таблице
            <span class="vue-b">DELETE FROM</span> название табл.
        </pre>
    </div>
    <p><b>Изменение записи:</b></p>
    <div class="code-style">
        <pre>
            <span class="vue-b">UPDATE</span> название табл.
                <span class="vue-b">SET</span> поле1 = выражение1, поле2 = выражение2
                <span class="vue-b">WHERE</span> условие
                [<span class="vue-b">ORDER BY</span> поле]
                [<span class="vue-b">LIMIT</span> количество записей]
                
            //надо скрыть все новости на сайте. За скрытие и показ отвечает поле <b>status</b>, 1 - показывать, 0 - скрывать
            <span class="vue-b">UPDATE</span> news
                <span class="vue-b">SET</span> status = '0'
                <span class="vue-b">WHERE</span> условие
            
            //увеличить зарплату и премию учителям фамилии которых начинаются на указанные слова - Иванов, Иванова, Ивановских и т.д.
            <span class="vue-b">UPDATE</span> teachers
                <span class="vue-b">SET</span> salary = salary * 2, premia = premia = 10
                <span class="vue-b">WHERE</span> name <span class="vue-b">LIKE</span> 'Иванов%'
                <span class="vue-b">OR</span> name <span class="vue-b">LIKE</span> 'Петров%'
                <span class="vue-b">OR</span> name <span class="vue-b">LIKE</span> 'Сидоров%'
            
            //запрос делает то же что и запрос выше, но более гибкий, так как мы будем вместо фамилий подставлять переменные
            <span class="vue-b">UPDATE</span> teachers
                <span class="vue-b">SET</span> salary = salary * 2, premia = premia = 10
                <span class="vue-b">WHERE</span> name <span class="vue-b">IN</span> ('Иванов', 'Петров', 'Сидоров')
            
            
            //также как и при удалении если не указать условие, то изменению подлежат все записи
        </pre>
    </div>
    
    
    <p><b>Получаем информацию о полях из БД:</b></p>
    <div class="code-style">
        <pre>
            <span class="vue-g"><span class="vue-b">$link</span> = <span class="vue-b">mysqli_connect</span>(<span class="vue-r">'localhost'</span>, <span class="vue-r">'root'</span>, <span class="vue-r">''</span>, <span class="vue-r">'name_db'</span>);</span>
            <span class="vue-g"><span class="vue-b">$sql</span> = "<span class="vue-r">SHOW COLUMNS FROM</span> " . <span class="vue-b">$db_name</span>;</span>
            <span class="vue-g"><span class="vue-b">mysqli_query</span>(<span class="vue-b">$link</span>, <span class="vue-b">$sql</span>);</span>
            
            //также есть SHOW FULL COLUMNS FROM - даёт немного больше информации о полях
        </pre>
    </div>
    <p>Но эти запросы не дают информацию о том как 2 таблицы связаны по внешнему ключу и чтобы получить информацию о том что они связаны по этому ключу, нам поможет служебная таблица в phpMyAdmin - information_shema</p>
    
    
    <p><b>Создание базы данных:</b></p>
    <div class="code-style">
        <pre>
            //если создаём БД из функций, то делаем такой запрос к БД. "IF NOT EXISTS" ставим для проверки на существование БД
            <span class="vue-g"><span class="vue-b">$link</span> = <span class="vue-b">mysqli_connect</span>(<span class="vue-r">'localhost'</span>, <span class="vue-r">'root'</span>, <span class="vue-r">''</span>, <span class="vue-r">'name_db'</span>);</span>
            <span class="vue-g"><span class="vue-b">$sql</span> = "<span class="vue-r">CREATE DATABASE IF NOT EXISTS</span> " . <span class="vue-b">$db_name</span>;</span>
            <span class="vue-g"><span class="vue-b">mysqli_query</span>(<span class="vue-b">$link</span>, <span class="vue-b">$sql</span>);</span>
        </pre>
    </div>
    <p><b>Создание таблицы и полей(MySQL):</b></p>
    <div class="code-style">
        <pre>
            <span class="vue-b">CREATE TABLE</span> items(
                id <span class="vue-b">int NOT NULL auto_increment</span>,
                title <span class="vue-b">varchar(255) NOT NULL default</span> '',
                description <span class="vue-b">varchar(255) NOT NULL default</span> '',
                context <span class="vue-b">text</span>,
                author <span class="vue-b">varchar(50) NOT NULL default</span> '',
                pubdate <span class="vue-b">timestamp NOT NULL default</span> '',
                <span class="vue-b">PRIMARY KEY</span> (id)
            )
        </pre>
    </div>
    
    
</div>
