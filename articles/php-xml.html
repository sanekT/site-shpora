<div class="wrap">
   
    <h2 class="header-style">PHP и XML</h2>
    <p>Уровень 3 день 2 - 01:52:20</p>
    
    
    <h3 class="header-style2">Введение в XML</h3>
    <p>XML - это расширяемый язык разметки. Предназначен для: 1) хранения структурированных данных 2) обмена информацией между программами 3) создание на его основе других, более специализированных, языков разметки(OFX, OTP, WSDL, SOAP, VML, XSL, ebXML, CML, XLANG). Цель создания - это обеспечение совместимости при передаче данных между разными системами обработки информации. Различия XML и HTML: HTML описывает ИЗ ЧЕГО СОСТОИТ и КАК отображать документ, а XML определяет ЗНАЧЕНИЕ и ОТНОШЕНИЕ данных.</p>
    <p>Простой пример xml разметки:</p>
    <div class="code-style">
        <pre>
            &lt;?xml version="1.0" encoding="utf-8" ?>
            &lt;catalog>
                &lt;book id="1">
                    &lt;author>Алекс Гомер&lt;/author>
                    &lt;title>XML и IE5&lt;/title>
                    &lt;price>200&lt;/price>
                    &lt;!--Комментарий-->
                &lt;/book>
            &lt;/catalog>
        </pre>
    </div>
    <p>В XML в отличии от HTML очень жёсткие правила. Вот они:</p>
    <ul class="list">
        <li>Если документ содержит символы выходящие за рамки ASCII, то необходимо указать кодировку</li>
        <li>XML состоит из вложеных элементов</li>
        <li>Элемент состоит из открывающегося и закрывающегося тегов, а также содержимого</li>
        <li>XML чувствителен к регистру символов</li>
        <li>Элементы могут вкладываться друг в друга</li>
        <li>Теги должны быть правильно вложены друг в друга</li>
        <li>Все парные теги должны быть закрыты</li>
        <li>Возможно формирование пустых элементов</li>
        <li>Должен существовать только один корневой элемент, который содержит все остальные элементы. Пустой документ(без корневого элемента) недопустим</li>
        <li>Элемнты могут иметь атрибуты</li>
        <li>Значения атрибутов заключаются в одинарные или двойные кавычки</li>
        <li>У каждого конкретного элемента не должно быть повторяющихся атрибутов</li>
    </ul>
    <p>Когда я составляю XML документ, то я могу указать в теге price не просто число 200, а 200 рублей и тогда xml парсер не распознает что написано. Или пошлю в теге data дату в виде 01-02-03 и кто разберёт что тут за дата. Для этих вещей придумали описывать структуру документа. Есть 2 способа описать: DTD(Document Type Definition) и XML Схемы. С помощью схемы я описываю для других, что есть что в моём xml документе.</p>
    
    
    
    
    
    
    
    <h3 class="header-style2">Средства PHP для работы с XML-документом</h3>
    <p><b>SAX(Simple API for XML)</b>:</p>
    <ul class="list">
        <li>Чтение XML-документа</li>
    </ul>
    <p><b>DOM(Document Object Model)</b>:</p>
    <ul class="list">
        <li>Чтение, изменение и создание новых XML-документов</li>
    </ul>
    <p><b>SimpleXML(Чисто phpшная разработка)</b>:</p>
    <ul class="list">
        <li>Чтение и изменение XML-документов</li>
    </ul>
    <p><b>XMLReader и XMLWriter</b>:</p>
    <ul class="list">
        <li>Чтение и изменение XML-документов</li>
    </ul>
    <p><b>XSL/T(Extensible StylesheetLanguage Transformations)</b>:</p>
    <ul class="list">
        <li>Преобразование XML-документов в другие форматы</li>
    </ul>
    <p>Начнём с <b>SAX</b>.</p>
    <div class="code-style">
        <pre>
            <span class="vue-g">
                //<span class="vue-or">создание парсера</span>
                <span class="vue-b">$sax</span> = <span class="vue-b">xml_parser_create</span>(<span class="vue-r">"utf-8"</span>);
                
                //<span class="vue-or">объявление функций обработки событий</span>
                function <span class="vue-b">onStart</span>(<span class="vue-b">$parser</span>, <span class="vue-b">$tag</span>, <span class="vue-b">$attributes</span>){}
                function <span class="vue-b">onEnd</span>(<span class="vue-b">$parser</span>, <span class="vue-b">$tag</span>){}
                function <span class="vue-b">onText</span>(<span class="vue-b">$parser</span>, <span class="vue-b">$text</span>){}
                
                //<span class="vue-or">регистрация функций как обработчиков событий</span>
                <span class="vue-b">xml_set_element_handler</span>(<span class="vue-b">$sax</span>, <span class="vue-r">"onStart"</span>, <span class="vue-r">"onEnd"</span>);
                <span class="vue-b">xml_set_character_data_handler</span>(<span class="vue-b">$sax</span>, <span class="vue-r">"onText"</span>);
                
                //<span class="vue-or">запуск парсера</span>
                <span class="vue-b">xml_parse</span>(<span class="vue-b">$sax</span>, <span class="vue-r">file_get_contents("catalog.xml")</span>);
                //<span class="vue-or">обработка ошибок</span>
                <span class="vue-g">echo <span class="vue-b">xml_error_string</span>(<span class="vue-b">xml_get_error_code</span>(<span class="vue-b">$sax</span>));</span>
                //дальше описывается пример как считать xml документ в таблицу
            </span>
        </pre>
    </div>
    
    <p>Далее идёт <b>DOM</b>.</p>
    <p>Создаём RSS документ с помощью DOM</p>
    
    <p>Далее идёт <b>SimpleXML</b>.</p>
    <p></p>
    <p>закончил на 02:22:10 в уроке Уровень 3, день 2. Потом допишу если нужно будет</p>
    
    
    
    
    
    <h3 class="header-style2">Как работать в php с XML Web Services</h3>
    <p>Уровень 3, день 3 начинается с 00:37:08</p>
    <p>На самом деле мы часто используем XML технологии в интернете и сами того не замечая. Даже когда мы зачитываем какой то документ сделанный в Exel, то он просто трансформируется с помощью XSL/T из XML в понятный нам например HTML.</p>
    <p>В чём идея веб служб? Общая идея служб заключается в том, чтобы предоставить пользователю какую то услугу. Например Яндекс поиск или Гугл поиск это и есть услуга про поиску информации в сети. Или например Яндекс показывает у себя курсы валют, но это не значит что Яндекс каждый день ходит к банкам и запрашивает у них эти курсы. Просто существует какая то услуга в инете, которая занимается этим, она сама собирает эти данные по банками и подсоединяясь к этой услуге Яндекс получает от них в автоматическом режиме эти курсы валют. К этой услуге может подключится любой.</p>
    <p>Чем характерна XML веб служба?</p>
    <ul class="list">
        <li>Программы, доступ к которым осуществляется по протоколу HTTP</li>
        <li>Обмен данными происходит в формате XML</li>
        <li>Независимы от платформы, языка программирования</li>
        <li>Просты в разработке и отладке</li>
        <li>Используются открытые протоколы и стандарты</li>
        <li>Есть возможность описать услуги, предоставляемые службой и способы обращения к ним</li>
        <li></li>
    </ul>
    <p>история появления веб служб:</p>
    <ul class="list">
        <li>Remote Procedure Call
            <ul class="list">
                <li>подход, позволяющий программе вызывать процедуры из другого адресного пространтсва</li>
            </ul>
        </li>
        <li>Реализации RPC
            <ul class="list">
                <li><b>XML-RPC</b> - текстовый протокол на базе HTTP(RFC-3529)</li>
                <li><b>SOAP</b> - текстовый протокол на базе HTTP(RFC-3529)</li>
                <li><b>XML-RPC</b> - текстовый протокол на базе HTTP(RFC-4227)</li>
                <li><b>JSON-RPC</b> - текстовый протокол на базе HTTP(RFC-4627)</li>
                <li><b>.NET-Remoting</b> - бинарный протокол на базе TCP, UPD, HTTP</li>
                <li><b>DCOM</b> - MSRPC Microsoft Remote Procedure Call</li>
                <li><b>Java RMI</b></li>
            </ul>
        </li>
    </ul>
    <p>Идея RPC в том, что я кодируя у себя могу получить доступ к другому куску кода в инете, и тот кусок кода, как будто будет находится у меня в файле. Тот чужой кусок кода даже может быть на другом языке программирования. И вот такая идея получила реализацию в разных стандартах, которые перечислены выше. Стандарты которые обмениваются с помощью XML их 2: это XML-RPC и SOAP. XML-RPC более старый стандарт. SOAP это можно сказать XML-RPC 2. Поговорим о SOAP</p>
    
    
    
    
    
    <h3 class="header-style2">SOAP</h3>
    <p><b>Simple Object Access Protocol</b></p>
    <p></p>
    <ul class="list">
        <li>Простой протокол доступа к объекту</li>
        <li>Запросы посылаются HTTP методом POST</li>
        <li>Строка, которая передаётся от сервера к клиенту и наоборот это XML строка. Корневой элемент это Envelope, внутри него Header и Body. Header не обязателен. Структура SOAP сообщения:
            <ul class="list">
                <li>Envelope</li>
                <li>Header</li>
                <li>Body</li>
            </ul>
        </li>
        <li>SOAP запрос:
            <div class="code-style">
                <pre>
                    //<span class="vue-or">клиент запрашивает у сервера функцию или метод getStock передавая ей параметр num</span>
                    <span class="vue-g"><span class="vue-b">&lt;soap:Envelop</span>
                            <span class="vue-r">xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/"</span>
                        <span class="vue-b">&lt;soap:Body></span>
                            <span class="vue-b">&lt;getStock <span class="vue-r">xmlns="http://site.ru/ws"</span></span>
                                <span class="vue-b">&lt;num></span>1234<span class="vue-b">&lt;/num></span>
                            <span class="vue-b">&lt;/getStock></span>
                        <span class="vue-b">&lt;/soap:Body></span>
                    <span class="vue-b">&lt;/soap:Envelop></span></span>
                </pre>
            </div>
        </li>
        <li>SOAP ответ:
            <div class="code-style">
                <pre>
                    <span class="vue-g"><span class="vue-b">&lt;soap:Envelop</span>
                            <span class="vue-r">xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/"</span>
                        <span class="vue-b">&lt;soap:Body></span>
                            <span class="vue-b">&lt;getStockDetailsResponse <span class="vue-r">xmlns="http://site.ru/ws"</span></span>
                                <span class="vue-b">&lt;getStockDetailsResult></span>
                                    <span class="vue-b">&lt;id></span>12345<span class="vue-b">&lt;/id></span>
                                    <span class="vue-b">&lt;productName></span>Стакан<span class="vue-b">&lt;/productName></span>
                                    <span class="vue-b">&lt;description></span>Стакан гранённый, 250мл.<span class="vue-b">&lt;/description></span>
                                    <span class="vue-b">&lt;price></span>9.95<span class="vue-b">&lt;/price></span>
                                <span class="vue-b">&lt;/getStockDetailsResult></span>
                            <span class="vue-b">&lt;/getStockDetailsResponse></span>
                       <span class="vue-b">&lt;/soap:Body></span>
                    <span class="vue-b">&lt;/soap:Envelop></span></span>
                </pre>
            </div>
        </li>
    </ul>
    <p>В php для работы с SOAP есть модуль php_soap.dll.  Основные SOAP классы: SoapServer и SoapClient</p>
    <p>Напишем небольшой пример SOAP службы. Ещё раз что такое по сути служба? Это код на сервере, который принимает данные и вычисляя возвращает какой то результат. Например наша служба будет состоять из одной функции getStock() на сервере, которая возвращает количество товара на складе по id:</p>
    <div class="code-style">
        <pre>
            //описание функции нашей веб услуги
            function getStock($id)
            {
                $stock = [
                    '1' => 100,
                    '2' => 200,
                    '3' => 300,
                    '4' => 400,
                ];
                if(isset($stock[$id]))
                {
                    return $stock[$id];
                }else
                {
                    throw new SoapFault("Server", "Нет такого id товара");
                }
            }
            
            //затем создаём SOAP сервер и передаём ему в конструктор адрес документа wsdl(web services descriptor language - язык описания веб службы, в которой автор этой службы описывает её)
            $server = new SoapServer("http://mysite.local/stock.wsdl");
            
            //регестрируем в объекте сервера нашу функцию getStock, так как у нас могут быть и вспомогательные функции, но запрашивать будут именно getStock, поэтому и добавляем её 
            $server->addFunction("getStock");
            
            //ну и запускаем сервер
            $server->handle();
        </pre>
    </div>
    <p>Но как клиент узнает где находится наша служба? какие функции нам дуступны? какие параметры нужно отправлять и т.д. Нам как авторам службы нужно обязательно описать наш сервер в файле ***.wsdl, это очень важный файл, потому что тот кто будет писать  Soap клиент должен знать где находится этот .wsdl файл</p>
    <p><b>Немного о wsdl файле</b>:</p>
    <ul class="list">
        <li>Язык описания веб служб</li>
        <li>WSDL документ - XML документ</li>
        <li>Описывает:
            <ul class="list">
                <li>Где находится служба</li>
                <li>Какие операции(функции) доступны клиенту</li>
                <li>Кол-во аргументов функций</li>
                <li>Типы аргументов функций</li>
                <li>Типы возвращаемых функциями значений</li>
                <li>Описание пользовательских типов для параметров функций</li>
            </ul>
        </li>
    </ul>
    <p>Вот примерный вид такого документа:</p>
    <div class="code-style">
        <pre>
            &lt;?xml version='1.0' encoding='UTF-8' ?>
            &lt;defenitions name='Stock'>
                &lt;binding name='StockBinding' type='tns:StockPortType'>
                    &lt;soap:binding style='rpc' transport='http://schemas.xmlsoap.org/soap/http' />
                    &lt;operation name='getStock' />
                &lt;/binding>
                &lt;service name='StockService'>
                    &lt;port name='StockPort' binding='StockBinding'>
                        &lt;soap:address location='http://mysite.local/server.php'>
                    &lt;/port>
                &lt;/service>
            &lt;/defenitions>
        </pre>
    </div>
    <p>Тут элементы нужно просматривать как бы снизу вверх.</p>
    <p>Внутри элемента <b>service</b> в soap:address атрибута location содержится адрес сервера с веб службой. Далее у элемента port внутри service есть атрибут binding и в нём указано имя binding элемента выше, в котором указаны все функции, доступные клиенту. Идём выше к элементу binding с указанным именем.</p>
    <p>У элемента <b>binding</b> внутри есть элемент operation и вот этот элемент говорит, что у нашей службы всего одна операция-функция getStock. Есть функции, которые возвращают значение, есть не возвращают и нам надо узнать какого плана функции нам доступны, для этого у binding есть атрибут type в значении которого указано имя элемента portType и в этом элементе и будет указано какого плана функции нам длступны.</p>
    <p>Идём выше к элементу <b>portType</b></p>
    
    
    
    
</div>
