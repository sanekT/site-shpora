<div class="wrap">
   
    <h2 class="header-style">Зарплата и всё что сней связанно.</h2>

    <p>Фиолетовым цветом в ссылках показаны</p>
    <ul class="list">
        <li>Курс Камкова, видео 6.1. делаю в базе - Камков - основные объекты.</li>
        <li><a href="#1a">00:07:00 - (1) что такое сложные периодические расчёты</a></li>
        <li><a href="#2a">00:10:00 - (2) начинаем первый пример этого курса. Рассмотрим простой расчёт оклада, оклада на выезде и процент за квалификацию, чтобы посмотреть на механизмы расчёта. Что такое оклад, ставка оклада. Создаём план расчёта и добавляем эти три вида расчёта.</a></li>
        <li><a href="#3a">00:26:00 - (3) итак, мы создали три вида расчёта, теперь нам нужно расчитывать их и хранить результаты в регистре расчёта.</a></li>
        <li><a href="#4a">00:36:20 - (4) далее мы начнём заполнять регистр расчёта данными через документ "РасчетЗарплаты" в обработке проведения</a></li>
        <li><a href="#5a">01:10:30 - (5) документ провели, данные в регистр записали, теперь нужно посчитать ресурс "Результат" в регистре. Используем виртуальную таблицу <span class="фиолетовый">"ДанныеГрафика"</span>.</a></li>
        <li><a href="#6a">01:49:00 - (6) практическое задание. Нужно сделать другой способ расчёта "ЧасовойТариф". Формула расчёта = Фактическое отработанное время в часах * Часовая тарифная ставка. Создать вид расчёта "ПоТарифу"</a></li>
        <li><a href="#7a">02:04:10 - (7) ещё практическое задание. Добавить способ расчёта "СвободныйГрафик". Формула расчёта = Фактически отработтаное время в днях * Дневная тарифная ставка. Если фактически отработанное время составляет 80% и более от планового рабочего времени, то дневная тарифная ставка увеличивается на 10%. Создать вид расчёта "По свободному графику"</a></li>
        <li><a href="#8a">02:14:50 - (8) ещё практическое задание. Добавить способ расчёта "Штраф за прогул". Формула расчёта = -[Штраф за день] * [Количество дней]. [Штраф за день] надо хранить в константе. Создать вид расчёта "Штраф", который вытесняет вид расчёта "Оклад".</a></li>
        <li><a href="#9a">02:27:30 - (9) в консоли запросов смотрим виртуальную таблицу регистра расчёта - <span class="фиолетовый">"ФактическийПериодДействия"</span></a></li>
        <li><a href="#10a">02:30:20 - (10) продолжаем решать наш пример. Нам осталось разобраться с видом расчёта "Доплата за квалификацию". Т.е. мы подошли к базовым периодам. Будем использовать вирт. таблицу <span class="фиолетовый">"База&lt;ИмяРегистраРасчета>"</span></a></li>
        <li><a href="#11a">03:03:30 - (11) практическое задание. Добавить способ расчёта "Вечернее дежурство".Продолжительность дежурства не учитывается. Формула: Сумма базы * 1.1. База: "Оклад", "По тарифу". Создать вид расчёта "Вечернее дежурство".</a></li>
        <li><a href="#12a">03:18:30 - (12) рассказывает, когда указывать и не указывать базовый период</a></li>
        <li><a href="#">03:20:10 - кратенько на примере с рисованием показывает что такое "период действия" и базовые периоды.</a></li>
        <li><a href="#13a">03:22:15 - (13) практическое задание. Начинаем второй пример этого курса. Вводим ещё четыре новых вида расчёта, которые не требуют ввода конкретного периода действия. Будем выплачивать премии в каком-то месяце и не нужно указывать какую-то часть месяца. Эти вида расчёта будут в отдельном плане видов расчёта. Начнём с добавления нового плана видов расчёта. Для премий мы будем использовать только одну виртуальную таблицу - <span class="фиолетовый">"База&lt;ИмяРегистраРасчета>"</span></a></li>
        <li>Курс Камкова, видео 6.2. делаю в базе - Камков - основные объекты.</li>
        <li><a href="#14a">00:00:00 - (14) начинаем описание обработки проведения документа "РасчетЗарплаты". Расчитываем фиксированную премию(Персональная премия). Формула проста, мы просто записываем в рузультат эту премию</a></li>
        <li><a href="#15a">00:25:00 - (15) считаем "Месячные премии". Формула - способ расчёта "процентом"</a></li>
        <li><a href="#16a">00:57:10 - (16) практическое задание. У нас на данный миг есть процедура "РасчитатьПремии" и в ней есть запрос. Нужно вместо соединения использовать объединение.</a></li>
        <li><a href="#17a">01:11:30 - (17) рассчитываем оставшиеся две премии, одна "зависимое первого уровня", вторая "зависимое второго уровня".</a></li>
        <li><a href="#18a">01:14:40 - (18) дальше по плану создать план видов расчёта и регистр расчёта "Удержания".</a></li>
        <li><a href="#19a">01:24:30 - (19) после создания нужно в коде написать логику для записи данных в регистр. Нужно будет создать вид расчёта "Алименты" по способу расчёта - "Процентом". Базой для него будут все основные начисления и премии, кроме штрафа за прогул.</a></li>
        <li><a href="#20a">01:50:00 - (20) практика. Нужно описать способ расчёта "Пропорционально базе". Формула: [Сумма базовых начислений] * [Фактически отработанное время] / [Плановое рабочее время]. База: Оклад, Доплата за квалификацию. Добавить вид расчёта "Пропорционально базе". Будем использовать виртуальные таблицы - <span class="фиолетовый">"База&lt;ИмяРегистраРасчета>"</span> и <span class="фиолетовый">"ДанныеГрафика"</span></a></li>
        <li><a href="#21a">02:14:30 - (12) практическая задача. Нужно организовать расчёт спецкомандировки. Вид расчёта "Спецкомандировка". Оплачивается она фиксированно и вытесняет оклад</a></li>
        <li><a href="#22a">02:19:00 - показывает, что за параметр "Разрезы" в виртуальной таблице <span class="фиолетовый">"База&lt;ИмяРегистраРасчета>"</span></a></li>
        <li><a href="#23a">02:25:30 - практика с применением параметра "Разрезы".</a></li>
        <li><a href="#24a">02:36:10 - [отчёт]. Нужно вывести всё что мы сохранили в регистрах в отчёт. Изготавливаем отчёт по начислениям (ОсновныеНачиления и НачисленияПремий).</a></li>
        <li>Курс Камкова, видео 6.3. делаю в базе - Камков - основные объекты.</li>
        <li><a href="#">00:00:00 - [отчёт]. Начнём с того, что добавим в прошлый отчёт таблицу по удержаниям (Удержания). Тут всё просто, поэтому описывать не буду. Такой отчёт уже мало будет похож на начисления, потому что появились удержания. Больше уже отчёт похож на расчётную ведомость.</a></li>
        <li><a href="#26a">00:04:30 - вернёмся к вытеснениям. Добавим новый документ расчёта зарплаты и укажем месяц февраль.</a></li>
        <li><a href="#27a">00:00:00 - </a></li>
        <li><a href="#28a">00:00:00 - </a></li>

        <li>Формулы расчёта</li>
        <li><a href="#1b">Формула расчёта оклада</a></li>
        <li><a href="#1b"></a></li>
        <li><a href="#1b"></a></li>
        <li><a href="#1b"></a></li>
        <li><a href="#1b"></a></li>
        <li><a href="#1b"></a></li>
    </ul>


    <div class="">
        <h3 class="header-style2" id="1a">(1) Что такое сложные периодические расчёты</h3>
        <p>В чём сложность этих расчётов? Когда мы занимаемся расчётом заработной платы, мы делим её на какие то части (оклады, премии и прочее) и эти части между собой взаимосвязаны. Например, чтобы посчитать премию, нам нужны расчёты оклада или премии за другой какой-то период. Нам нужно найти их, сложить вместе, получить некую расчётную базу и зная процент этой самой премии расчитать её. Т.е. для расчёта одних видов расчёта нам нужны расчёты других видов расчёта.</p>
        <p>Ещё сложность в том, что это нужно выполнять в какой-то определённой последовательности. Мы считаем сначала оклад строго, потом одни премии, потом другие премии.</p>
        <p>Ещё сложность в том, что когда мы вводим виды расчёта, то наблюдается воздействие друг на друга. Например, когда виды расчёта воздействуют друг на друга по периоду их действия.Допустим, мы считаем оклад за месяц и потом мы вычисляем, что одну неделю сотрудник в этом месяце был в командировке, то оклад уже будет не за весь месяц, а за те дни, когда он был на работе, т.е минусуем командировку.</p>
        <p>Чтобы учитывать все эти сложности, есть универсальные механизмы конфигурации - это план видов расчёта и регистр расчёта.</p>
        <p></p>
    </div>


    <div class="">
        <h3 class="header-style2" id="2a">(2) Рассмотрим простой подсчёт, чтобы посмотреть на механизмы расчёта</h3>
        <p>Будем считать оклад.</p>
        <p>Оклад — это фиксированный размер оплаты труда работника за исполнение трудовых (должностных) обязанностей определённой сложности за календарный месяц без учёта компенсационных, стимулирующих и социальных выплат.</p>
        <p>Ставка — оплата труда за единицу времени или работы. Ставка может быть почасовой, за количество проданной продукции, выполненных работ или оказанных услуг. Например, если сотруднику установили почасовую ставку, ему оплачивают количество отработанных часов.</p>
        <p>Итак, создадим 3 вида расчёта с формулами:</p>
        <img src="../img/1С-ЗУП/2025-02-28_09-54-21.png" class="screen" alt="">
        <p>Как видим, у видов расчёта "Оклад" и "Оклад на выезде" имеют одинаковый способ расчёта. Способ расчёта это название формулы расчёта. Хоть формулы у них одинаковые, но скорее всего ставка будет разной. Поэтому мы и разделили их на два вида расчёта.</p>
        <p>Из таблички видно, что у нас есть потребность где-то хранить эти данные в конфигурации. Способы расчёта можно сохранить в перечислении, сделаем это:</p>
        <img src="../img/1С-ЗУП/2025-02-28_10-05-37.png" class="screen-2" alt="">
        <p>Виды расчёта можно было бы сохранить в справочнике, но сложность в чём. У нас есть вид расчёта "Доплата за квалификацию" и в формуле у неё указана "Сумма базы", этой базой может быть и сам "оклад" или "оклад + оклад на выезде" или ещё что-то. И нам нужно сразу указать, что в качестве базы используются такие то виды расчёта.</p>
        <p>Для хранения видов расчёта у нас есть объект конфигурации "План видов расчета", вот в него и сохраним все наши виды расчёта.</p>
        <p>Добавим план видов расчёта и назовём "ОсновныеНачисления". На закладке "Данные" длину кода 5 знаков. И добавим сразу реквизит, который будет отображать способ расчёта, так его и назовём "Способ Расчета" с типом данных - перечисление "Способы расчета".</p>
        <p>Теперь нам нужно решить, как задавать последовательность расчётов. Будет ли он первычным или каким то зависимым. Значения порядка(последовательностей) мы запишем в справочник "КатегорииРасчета". Создадим его, причём элементы мы создадим предопределённые:</p>
        <img src="../img/1С-ЗУП/2025-03-01_10-02-21.png" class="screen" alt="">
        <p>В справочнике мы их создали потому, что пользователь при желании может добавлять ещё значение порядка для расчётов.</p>
        <p>Далее добавим ещё реквизит в план счетов "ОсновныеНачисления" - "КатегорияРсчёта" и укажем типом созданный справочник "КатегорииРасчета". Т.е. мы как бы указываем способ расчёта и рядом указываем какой он по порядку выполнения будет.</p>
        <p>Откроем 1с:Предприятие и нажмём создать вид расчёта. Теперь у нас есть возможность задать какой-то вид расчёта, задать способ его вычисления и порядок вычисления. Ниже реквизитов уже по умолчанию система добавила какую-то таблицу "ВедущиеВидыРасчета". Я пока не знаю, для его она. Вот две картинки как выглядит эта таблица в режимах:</p>
        <img src="../img/1С-ЗУП/2025-03-01_11-15-40.png" class="screen" alt="">
        <p>Также нужно задать для вида расчёта какой то список, в котором мы перечислим другие виды расчёта, которые будут воздействовать на наш вид расчёта. Для в этого в конфигураторе в созданном нами плане видов расчёта перейдём на закладку "Расчет":</p>
        <img src="../img/1С-ЗУП/2025-03-01_10-18-26.png" class="screen" alt="">
        <p>На этой закладке мы должны решить следующее, если мы предполагаем, что описываемый нами вид расчёта будет длительным во времени, например, оклад, который имеет начало периода действия и конец периода действия, то включаем галочку "Использует период действия". Теперь в таблице формы появилась ещё одна "закладка, страница" с вытесняющими видами расчёта:</p>
        <img src="../img/1С-ЗУП/2025-03-01_11-18-48.png" class="screen-2" alt="">
        <p>Также в нашем примере есть вид расчёта("Допдата за квалификацию"), которому нужна некая база, на основании которой он будет расчитываться, поэтому нам нужно добавить ещё одну закладку в таблицу формы с базовыми видами расчёта.</p>
        <p>На той же закладке "Расчет" мы ещё установим галочку у пункта "Зависмость от базы" > "Зависит по периоду действия". Также чуть ниже для свойства "Базовые планы видов расчета" установим галочку для нашего плана. Это мы указываем в каком плане находятся базовые виды расчёта:</p>
        <img src="../img/1С-ЗУП/2025-03-01_11-25-43.png" class="screen-2" alt="">
        <p>Соответственно появилась 3я закладка в таблице формы:</p>
        <img src="../img/1С-ЗУП/2025-03-01_11-26-59.png" class="screen-2" alt="">
        <p>Позже будет понятно чем они отличаются между собой.</p>
        <p>Далее заполняем в ПР виды расчёта нужные для рассматриваемого примера.</p>
        <p>Первый это "Оклад", этот вид расчёта для своего расчёта не требует других видов расчёта, он считается сам по себе, поэтому для него категория расчёта "Первичная", а способ расчёта "По окладу".</p>
        <p>Второй вид расчёта это "Оклад на выезде". Способ расчёта "По кладу", категория тоже первичная, потому что оклад на выезде тоже не зависит от расчёта других видов расчёта. Это можно посмотреть по формуле, где ставка нам заранее известа и период дней тоже. Но этот вид расчёта влияет на сам оклад, потому что оклад на выезде будет вытеснять из оклада определённый период. Для этого нужно пойти в вид расчёта "Оклад" и там в таблице на закладке "Вытесняющие виды расчёта" выбрать только что созданный вид расчёта "Оклад на выезде". Теперь система самостоятельно будет вычитать из периода действия вида расчёта "Оклад" тот период, которому равен "Оклад на выезде". </p>
        <p>И третий вид расчёта "Доплата за квалификацию". Способ расчёта - "Процентом"(смотрим на формулу). И преждем чем заполнять категорию, давайте заполним таблицу "Базовые виды расчёта", ведь нам нужно посчитать процент от какой то базы. У нас есть два вида расчёта, которые будут базой для расчёта процента - это "Оклад" и "Оклад на выезде". И уже видя эти базовые виды расчёта, мы понимаем, что сначала нужно расчитать оклад или оклад на выезде, а потом уже процент. Значит категория для вида расчёта "Процент за квалификацию" будет "Зависимое первого уровня".</p>
        <p>Если что, то смотреть в инфобазе Камкова- Основные объекты.</p>
    </div>
    


    <div class="">
        <h3 class="header-style2" id="3a">(3) Рассчитаем эти виды расчёта и сохраним результат в регистре расчёта</h3>
        <p>Регистр расчёта не просто хранит в себе результаты расчёта видов расчёта, но и помогает собрать данные необходимые для расчётов. Этот регистр ключевой объект в расчётных механизмах.</p>
        <p>Создадим регистр расчёта и также назовём "ОсновныеНачисления". В каждой записи регистра указывается вид расчёта, который считается в этой записи. Поэтому в свойстве "План видов расчёта" укажем наш план "ОсновныеНачисления", из которого мы будем брать виды расчёта. Для одного регистра выбирается один план видов расчёта.</p>
        <p>Далее смотрим по логике работы регистра. У нас есть вид расчёта "Оклад", который имеет протяжённость во времени, поэтому в регистре ставим галочку у свойства "Период действия".Теперь в регистре будут колонки для указания периода.</p>
        <p>Одновременно с галочкой стали доступны три свойства - "График", "Значение графика" и "Дата графика".</p>
        <p>Раз мы указали период действия, значит нужно знать, сколько рабочих дней было за этот период. Обычно эти данные хранятся в регистре сведений и вот через свойство "График" есть возможность указать регистр сведений с такими данными. Тут Камков в графике выбрал регистр сведений "ГрафикиРаботы".</p> 
        <p>Затем в свойстве "Значение графика" мы указываем ресурс из выбранного регистра сведений, в котором хранятся значения рабочих и не рабочих дней. Обычно 1 это рабочий, 0 не рабочий. Ресурс называется "Значение".</p>
        <p>Ну и в свойстве "Дата графика" мы указываем измерение регистра сведений, где прописана дата:</p>
        <img src="../img/1С-ЗУП/2025-03-02_10-32-51.png" class="screen-2" alt="">
        <p>Регистр сведений заполнен на месяц и выглядит так:</p>
        <img src="../img/1С-ЗУП/2025-03-02_16-32-07.png" class="screen" alt="">
        <p>Также у нас есть виды расчёта являющиеся базой для других расчётов, поэтому ставим галочку у свойства "Базовый период" в регистре расчёта.</p>
        <p>Теперь перейдём на закладку "Данные" регистра расчёта и укажем ресурсы и измерения. Как и сказано в названии этой шпоры, мы хотим в регистре хранить результат расчёта вида расчёта, поэтому создадим ресурс "Результат" с типом Число (15Длина-2Точность).</p>
        <p>Дальше мы должны определить результат в разрезе чего мы будем делать. Ну первое, это для кого мы расчитываем, для сотрудника, поэтому добавляем измерение "Сотрудник". Второе измерение это должность. Допустим на нашем предприятии, сотрудники могут занимать разные должности и нам нужно отслеживать на какой должности и когда работал сотрудник, чтобы правильно высчитать результат. "Должность" имеет тип справочник "Должности".</p>
        <p>Казалось бы нужно ещё добавить такой реквизит как "Вид расчёта", ведь он один из главных измерений, но его не нужно создавать, он уже есть в стандартных реквизитах. Также все периоды тоже есть в стандартных реквизитах.</p>
        <p>Ещё на для расчёта нужен некий реквизит, который будет хранить, например, если мы считаем оклад, то нужна ставка оклада, если считаем премию, то нужен процент премии. Создадим реквизит "Размер" с типом число и вот он будет выступать в качестве таких данных.И ещё добавим один реквизит "ГрафикРаботы" с типом справочник "ГрафикиРаботы". В этом регистре мы будем получать сам график ("Пятидневка" или "Шестидневка").</p>
        <p>Если я выше не упоминал, то есть ещё и справочник "ГрафикиРаботы", который содержит именно названия этих графиков ("Почасовая", "Пятидневка", "Шестидневка"). Почему именно в справочнике мы храним, наверно, чтобы быыла возможность у пользователя добавлять новые графики.</p>
        <p>Итак, при добавлениие реквизита "ГрафикРаботы" и задания у него типа данных соответсвующего справочника на этом ещё не всё, нужно указать связь этого значения справочника с измерением регистра сведений "ГрафикРабот". Для этого есть свойство "Связь с графиком" на закладке "Данные" у реквизита регистра расчёта. Выберем там Измерение "ГрафикРабот":</p>
        <img src="../img/1С-ЗУП/2025-03-02_18-07-25.png" class="screen" alt="">
        <p>Связь графика из справочника с измерением регистра сведений важно установить для системы, чтобы она понимала при расчёте записи регистра растчёта, что это за значение в реквизите лежит.</p>
        <p>Далее укажем для регистра расчёта регистратор документ "РасчетЗрплаты"</p>
    </div>
    

    <div class="">
        <h3 class="header-style2" id="4a">(4) Далее мы начнём заполнять регистр расчёта данными через документ "РасчетЗрплаты"</h3>
        <p>Чтобы наш механзм расчёта мог работать нужно наполниьть данными регистр расчёта.</p>
        <p>Создадим документ "РасчетЗрплаты" с одним реквизитом "ПериодРегистрации". Этот реквизит нужен для даты записи данных в регистр расчёта. Хотя мне тут не понятно, почему дата документа это не делает, зачем ещё реквизит похожий создавать.</p>
        <p>Также добавим табличную часть "ОсновныеНачисления" в документ. Табличная часть будет с реквизитами "Сотрудник", "Должность", "ВидРасчета"(что мы собираемся расчитывать). Если вид расчёта оклад, то нужно указать период времени, который сотрудник работал, значит добавим два реквизита: "ПериодДействияНачало" и "ПериодДействияКонец". Ещё нужно указать базовый период, он не всегда должен совпадать с началои и концом периода действия. Пока не понял для чего нужен базовый и как он используется.</p>
        <p>Для базового периода тоже будет и начало и конец, поэтому добавим ещё две колонки: "БазовыйПериодНачало" и "БазовыйПериодКонец".</p>
        <p>Что ещё нам нужно знать, перед тем как рассчитывать? Размер. Если мы считаем оклад, то нужна ставка оклада, поэтому добавим ещё колонку "Размер"с типом Число.</p>
        <p>Также нужно указать график работы, добавляем колонку "ГрафикРаботы"с типом данных СпраовнчикСсылка.ГрафикРаботы.</p>
        <p>Ну и ещё нужно указать, пока новое для меня, признак сторно записи типа Булево.</p>
        <p>На этом описание документа закончено, перейдём в форму документа.</p>
        <p>В форме документа немного опишем папки в элементах формы. Сделаем группу "Страницы" с именем "Начисления", а в ней три страницы с именами "ЗакладкаОсновныеНачисления", "ЗакладкаПремии" и "ЗакладкаУдержания". Табличную часть перенесём в страницу "ЗакладкаОсновныеНачисления":</p>
        <img src="../img/1С-ЗУП/2025-03-02_20-58-15.png" class="screen-2" alt="">
        <p>Затем внутри табличной части сгруппируем немного колонки, чтобы они так в ширь не были растянуты:</p>
        <img src="../img/1С-ЗУП/2025-03-03_09-24-23.png" class="screen-2" alt="">
        <p>На форме пока всё. Теперь нужно описать обработку проведения в документе, чтобы он делал записи в регистр расчёта. Напишем такой код, все действия я поясняю в коде:</p>
        <div class="code-style">
            <pre>
                --модуль объекта документа "РасчетЗарплаты"
                <span class="светло_синий">Процедура ОбработкаПроведения(Отказ, РежимПроведения)
                    <span class="зелёный">//основные начисления</span>
                    НаборОсновныеНачисления = Движения.ОсновныеНачисления;
    
                    <span class="зелёный">//сформируем текст запроса. Т.к. набор записей будем многократно заполнять,
                    //то функционал заполнения мы вынесли в общий модуль "Расчёты" в функцию "ЗаполнитьНаборЗаписей"</span>
                    ТекстЗапроса = 
                        <span class="серый">"ВЫБРАТЬ
                        |	РасчетЗарплатыОсновныеНачиления.Ссылка.ПериодРегистрации КАК ПериодРегистрации,
                        |	РасчетЗарплатыОсновныеНачиления.Сотрудник КАК Сотрудник,
                        |	РасчетЗарплатыОсновныеНачиления.Должность КАК Должность,
                        |	РасчетЗарплатыОсновныеНачиления.ВидРасчёта КАК ВидРасчёта,
                        |	РасчетЗарплатыОсновныеНачиления.ПериодДействияНачало КАК ПериодДействияНачало,
                        |	РасчетЗарплатыОсновныеНачиления.ПериодДействияКонец КАК ПериодДействияКонец,
                        |	РасчетЗарплатыОсновныеНачиления.БазовыйПериодНачало КАК БазовыйПериодНачало,
                        |	РасчетЗарплатыОсновныеНачиления.БазовыйПериодКонец КАК БазовыйПериодКонец,
                        |	МИНИМУМ(РасчетЗарплатыОсновныеНачиления.Размер) КАК Размер,
                        |	РасчетЗарплатыОсновныеНачиления.ГрафикРаботы КАК ГрафикРаботы,
                        |	РасчетЗарплатыОсновныеНачиления.Сторно КАК Сторно
                        |ИЗ
                        |	Документ.РасчетЗарплаты.ОсновныеНачиления КАК РасчетЗарплатыОсновныеНачиления
                        |ГДЕ
                        |	РасчетЗарплатыОсновныеНачиления.Ссылка = &Ссылка
                        |
                        |СГРУППИРОВАТЬ ПО
                        |	РасчетЗарплатыОсновныеНачиления.Сотрудник,
                        |	РасчетЗарплатыОсновныеНачиления.Должность,
                        |	РасчетЗарплатыОсновныеНачиления.ВидРасчёта,
                        |	РасчетЗарплатыОсновныеНачиления.ПериодДействияНачало,
                        |	РасчетЗарплатыОсновныеНачиления.ПериодДействияКонец,
                        |	РасчетЗарплатыОсновныеНачиления.БазовыйПериодНачало,
                        |	РасчетЗарплатыОсновныеНачиления.БазовыйПериодКонец,
                        |	РасчетЗарплатыОсновныеНачиления.ГрафикРаботы,
                        |	РасчетЗарплатыОсновныеНачиления.Ссылка.ПериодРегистрации,
                        |	РасчетЗарплатыОсновныеНачиления.Сторно"</span>;
                    
                    <span class="зелёный">//вызываем функцию общего модуля, чтобы заполнить набор записями</span>
                    Расчеты.ЗаполнитьНаборЗаписей(ТекстЗапроса, Ссылка, НаборОсновныеНачисления);
                    
                    <span class="зелёный">//после того как набор заполнен его нужно записать. Мы будем использовать у метода
                    //Записать() второй параметр, который поставим явно в Ложь, что означает не только запись.
                    //По умолчанию и так стоит Ложь, но мы явно это показываем, чтобы не запутаться. Что означает
                    //этот параметр? Он означает, что помимо самой записи система ещё будет дополнительно
                    //производить пересчет фактического периода действия и ввод записей перерасчетов.
                    //В нашем случае как раз есть вид расчёта "Оклад на выезде", который вытесняет из периода
                    //действия вида расчёта "Оклад" какой то период, в результате которого мы получаем фактический
                    //период действия оклада.</span>
                    НаборОсновныеНачисления.Записать(, Ложь);
    
                КонецПроцедуры</span>    
            </pre>
        </div>
        <p><span class="светло_красный">Код функции из общего модуля смотреть в базе.</span></p>
        <p>Теперь попробуем заполнить документ и провести его. В поле "Период регистрации" мы ставим дату месяца, в котором мы ведём расчёт. Пусть это будет 1 января. Заполним табличную часть:</p>
        <img src="../img/1С-ЗУП/2025-03-03_18-20-06.png" class="screen" alt="">
        <p>Если посмотреть в регистр расчёта из текущего документа, то увидем, что документ сделал записи в регистре, но есть некоторые недочёты. Первое, это дата в поле "Дата окончания периода действия":</p>
        <img src="../img/1С-ЗУП/2025-03-03_18-33-48.png" class="screen-2" alt="">
        <p>Как видим 31 число не захватится в период, потому что стоит ровно начало этого дня, а нам нужно конец дня. Сделать это можно несколькими способами. Например, в обработчике модуля объекта "ПередЗаписью" изменим поле добавив нужное время. Но мы будем делать в тексте запроса:</p>
        <img src="../img/1С-ЗУП/2025-03-03_18-50-37.png" class="screen" alt="">
        <p>Теперь нужно сделать то же самое с полем "Дата окончания базового периода", но тут есть одна мелочь, а вдруг, как сейчас, базовый период будет не заполнен, тогда функция конца периода выдаст такую дату для этого поля - '01.01.0001 23:59:59'. Нужно где-то прописать условие, что если базовый пустой, то не надо применять функцию, если нет, тогда надо. Опять пропишем это в запросе:</p>
        <img src="../img/1С-ЗУП/2025-03-03_20-58-01.png" class="screen" alt="">
        <p>Мы проведением документа записали данные в регистр. Расчёт результата продолжим в следующей главе</p>  
    </div>


    <div class="">
        <h3 class="header-style2" id="5a">(5) Документ провели, данные в регистр записали, теперь нужно посчитать результат в регистре</h3>
        <p>Смотрим регистр расчёта и пытаемся понять, всё ли у нас есть для расчёта результата. Посмотрим на формулу расчёта оклада:</p>
        <div class="code-style">
            <pre>
                Результат = Ставка оклада * Число отработанных дней / Число рабочих дней
            </pre>
        </div>
        <p>Ставка оклада у нас есть, хранится в поле "Размер".</p> 
        <p>"Число рабочих дней" мы будем высчитывать, в регистре расчёта у нас есть период, за который мы считаем, а число рабочих дней будем получать из регистра сведений. Делаем запрос в регистр сведений, указываем за какой промежуток нам нужны данные, ставим отбор по графику и суммируем количество дней или часов.</p>
        <p>Связь регистра расчёта с регистром сведений мы установили не просто так. Регистр расчёта благодаря этой связи может сам расчитать количество рабочих дней на период. Для этого нужно обратиться к виртуальной таблице регистра расчёта - "ДанныеГрафика":</p>
        <img src="../img/1С-ЗУП/2025-03-04_17-48-49.png" class="screen" alt="">
        <p>В красной рамке это те поля, которые система сама расчитала, имея связь с регистром сведений "ГрафикиРабот". Нам нужны верхние два поля - "ЗначениеПериодДействия" и "ЗначениеФактическийПериодДействия". Они уже будут иметь подсчитанные рабочие дни за период. Пока у этих полей одинаковое число - 23. Но как я понимаю, второе поле будет другим, когда мы будем отслеживать отработанные дни.</p> 
        <p>Количество рабочих дней мы можем считать по разному. В нашем случае система берёт даты из колонок регистра расчёта - "ПериодДействияНачало" и "ПериодДействияКонец" и вид расчёта и по ним делает запрос в регистр сведений и получает подсчитанные значения. Нам этого способа хватить пока.</p> 
        <p>Итак, выбрав эти поля из виртуальной талицы получим результат:</p> 
        <img src="../img/1С-ЗУП/2025-03-04_18-03-43.png" class="screen" alt="">
        <p>Сейчас у нас получается, что количество рабочих дней в январе равно 23 и количество отработанных дней тоже равно 23, потому что мы никак не отслеживаем отработанные дни, вернее нет у нас видов расчёта, которые вытесняли бы из рабочих дней какой то период, например, больничный, командировка или ещё что-то.</p> 
        <p>У нас предусмотреть харанее вид расчёта "Оклад на выезде", я так понимаю это командировка. Давайте допишем в проведённый документ 4 запись, где укажем, что бухгалтер был в командировке:</p> 
        <img src="../img/1С-ЗУП/2025-03-04_20-12-22.png" class="screen" alt="">
        <p>И в результате виртуальной таблицы получим теперь такую таблицу:</p>
        <img src="../img/1С-ЗУП/2025-03-04_20-21-00.png" class="screen" alt=""> 
        <p>Правда не понятно, почему 6 дней в командировке записало, если была с 20 по 27. По идее должно было быть 7 дней. И ещё одно упрощение, мы не считаем сколько рабочих дней было в командировке. Считаем что все дни были рабочими.</p> 
        <p>Как система посчитали отработанные дни? Я так понимаю это из-за указания в табличной части в закладке "Вытесняющие виды расчетов" расчёта "Оклад на выезде" в элементе плана расчёта "Оклад":</p>
        <img src="../img/1С-ЗУП/2025-03-05_09-41-38.png" class="screen" alt=""> 
        <p>Выше все запросы были просто для показа, что и как. Теперь опишем запрос, который нам поможет расчитать результат для каждой записи. Обращаться мы будем к той же виртуальной таблице ДанныеГрафика.</p> 
        <p>Какие поля нам нужны? Нам нужно поле "НомерСтроки", из "ВидРасчета" нам нужен "СпособРасчета"(по какой формуле мы расчитываем), также нам понадобятся вот эти два расчитанных поля "ЗначениеПериодДействия" и "ЗначениеФактическийПериодДействия". Но этот запрос не учитывает некоторых мелочей. Что случится, если регистр сведений с графиками не заполнен? Мы получим пустую таблицу с данными графика. Но нам бы хотелось, в случае пустой таблицы, всё равно возвращать номер строки и способ расчёта, потому что они то точно будут.</p> 
        <p>Тогда нужно пересобрать запрос по другому. Берём за основу основную таблицу регистра расчёта "ОсновныеНачиления", там всегда будут номер строки и способ оплаты. Также установим отбор по регистратору и категории расчёта. Категория расчёта важный отбор, потому что нам нужно сначала расчитать записи первого уровня, потом зависимые от него второго уровня. И нас на этом этапе интересуют пока первычные виды расчёта.</p> 
        <p>Далее нам нужны те два поля "ЗначениеПериодДействия" и "ЗначениеФактическийПериодДействия". Мы их через левое соединение получаем из вирт. таблицы "ДанныеГрафика". Если их не будет, то теперь не страшно, поля будут просто пусты, а номер строки и способ оплаты мы получим из основной таблицы.</p> 
        <p>Вот такой запрос мы получили в итоге, выполним его и обход выборки тоже перенаправим в общий модуль:</p>
        <div class="code-style">
            <pre>
                --моудль объекта документа "РасчетЗарплаты"
                ...
                <span class="светло_синий"><span class="зелёный">//далее расчитаем результат записей с первичным видом расчёта. Для запроса нам понадобится
                //основная таблица регистра и виртуальная, значит набор выше нужно записать, мы записали.</span>
                Запрос = Новый Запрос;
                Запрос.Текст = 
                    <span class="серый">"ВЫБРАТЬ
                    |	ОсновныеНачисления.НомерСтроки КАК НомерСтроки,
                    |	ОсновныеНачисления.ВидРасчета.СпособРасчета КАК СпособРасчета,
                    |	ЕСТЬNULL(ОсновныеНачисленияДанныеГрафика.ЗначениеПериодДействия, 0) КАК План,
                    |	ЕСТЬNULL(ОсновныеНачисленияДанныеГрафика.ЗначениеФактическийПериодДействия, 0) КАК Отработано
                    |ИЗ
                    |	РегистрРасчета.ОсновныеНачисления КАК ОсновныеНачисления
                    |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрРасчета.ОсновныеНачисления.ДанныеГрафика(
                    |				Регистратор = &Регистратор
                    |					И ВидРасчета.КатегорияРасчета = &КатегорияРасчета) КАК ОсновныеНачисленияДанныеГрафика
                    |		ПО ОсновныеНачисления.НомерСтроки = ОсновныеНачисленияДанныеГрафика.НомерСтроки
                    |ГДЕ
                    |	ОсновныеНачисления.Регистратор = &Регистратор
                    |	И ОсновныеНачисления.ВидРасчета.КатегорияРасчета = &КатегорияРасчета"</span>;
            
                Запрос.УстановитьПараметр("Регистратор", Ссылка);
                Запрос.УстановитьПараметр("КатегорияРасчета", Справочники.КатегорииРасчета.Первичное);
                Выборка = Запрос.Выполнить().Выбрать();
            
                <span class="зелёный">//у нас есть выборка и есть набор записей НаборОсновныеНачисления, нам нужно
                //для каждого набора записей расчитать поле "Результат" </span>
                РасчитатьЗаписиРегистраРасчета(НаборОсновныеНачисления, Выборка);
            
                <span class="зелёный">//ну и опять записываем набор записей с уже расчитанным результатом. Теперь значение 
                //торого параметра укажем в Истина, нам не нужно пересчитывать фактический период действия</span>
                НаборОсновныеНачисления.Записать(, Истина);</span>
                ...

                --общий модуль "Расчеты"
                <span class="светло_синий">Функция РасчитатьЗаписиРегистраРасчета(НаборЗаписей, Выборка) Экспорт
                    <span class="зелёный">//Как можно сопоставить запись из выборки записи из набора. Вот способы

                    ////первый
                    //Для каждого Запись Из НаборЗаписей Цикл
                    //	Выборка.Сбросить();
                    //	Пока Выборка.Следующий() Цикл
                    //		Если Запись.НомерСтроки = Выборка.НомерСтроки Тогда
                    //			Запись.Результат = ;	
                    //		КонецЕсли;
                    //	КонецЦикла;
                    //
                    //КонецЦикла;	

                    //второй. Можно выгрузить в таблицы значений обе коллекции, упорядочить по номеру записи
                    //в каждой таблице и потом в первой таблице высчитат и заполнить колонку "Результат" и 
                    //вернуть её опять в набор записей


                    //третий, который и есть у Камкова. Выше два способа не совсем верны, как оказалось
                    //не нужно соответствие по номеру строки. Просто берём первую запись из выборки
                    //и по ней берём первую запись из набора.</span>
                    Результат = 0;

                    Пока Выборка.Следующий() Цикл
                        ЗаписьРегистра = НаборЗаписей[Выборка.НомерСтроки - 1];

                        <span class="зелёный">//расчитываем Результат</span>
                        Если Выборка.СпособРасчета = Перечисления.СпособыРасчета.ПоОкладу Тогда
                            <span class="зелёный">//мы выполняем расчёт, только если поля из виртуальной таблицы заполнены	</span>
                            Если Выборка.План > 0 Тогда
                                Результат = ЗаписьРегистра.Размер * Выборка.Отработано / Выборка.План;							
                            КонецЕсли;	
                        ИначеЕсли Выборка.СпособРасчета =  Перечисления.СпособыРасчета.Процентом Тогда
                                
                        КонецЕсли;
                        
                        ЗаписьРегистра.Результат = Результат;
                    КонецЦикла;	
                КонецФункции</span>
            </pre>
        </div> 
        <p>Перепроведём ещё раз документ "РасчетЗарплаты" и получим в ресурс "Результат" нужные нам значения.</p> 
        <p></p> 
        <p></p> 
        <p></p> 
        <p></p> 
        <p></p> 
        <p></p> 
        <p></p> 
        <p></p> 
    </div>


    <div class="">
        <h3 class="header-style2" id="6a">(6) Практическое задание</h3>
        <p>Первое, это добавим новый способ расчёта в перечисление. Второе, в пользовательском режиме добавим новый вид расчёта. Затем в общем модуле в функции РасчитатьЗаписиРегистраРасчета() добавим новое условие и расчёт результата:</p>
        <div class="code-style">
            <pre>
                Пока Выборка.Следующий() Цикл
                    ЗаписьРегистра = НаборЗаписей[Выборка.НомерСтроки - 1];

                    //расчитываем Результат
                    Если Выборка.СпособРасчета = Перечисления.СпособыРасчета.ПоОкладу Тогда
                        //мы выполняем расчёт, только если поля из виртуальной таблицы заполнены	
                        Если Выборка.План > 0 Тогда
                            Результат = ЗаписьРегистра.Размер * Выборка.Отработано / Выборка.План;							
                        КонецЕсли;	
                    ИначеЕсли Выборка.СпособРасчета =  Перечисления.СпособыРасчета.Процентом Тогда
                    
                    <span class="светло_красный">ИначеЕсли Выборка.СпособРасчета = Перечисления.СпособыРасчета.ПоТарифу Тогда
                        Если Выборка.План > 0 Тогда
                            Результат = ЗаписьРегистра.Размер * Выборка.Отработано;							
                        КонецЕсли;	</span>	
                    КонецЕсли;
                    
                    ЗаписьРегистра.Результат = Результат;
                КонецЦикла;
            </pre>
        </div>
        <p>Только я наоборот назвал - вид расчёта это "Часовой тариф", а способ расчёта - "ПоТарифу".</p>
    </div>


    <div class="">
        <h3 class="header-style2" id="7a">(7) Практическое задание</h3>
        <p>В формуле "Дневная тарифная ставка" это уже не как в окладе ставка за период, а тут ставка за день.</p>
        <p>Сдесь также добавляем способ расчёта, затем в ПР добавлем вид расчёта и в общем модуле в той же функции РасчитатьЗаписиРегистраРасчета() мы добавим условие:</p>
        <div class="code-style">
            <pre>
                Пока Выборка.Следующий() Цикл
                    ЗаписьРегистра = НаборЗаписей[Выборка.НомерСтроки - 1];

                    <span class="зелёный">//расчитываем Результат</span>
                    Если Выборка.СпособРасчета = Перечисления.СпособыРасчета.ПоОкладу Тогда
                        <span class="зелёный">//мы выполняем расчёт, только если поля из виртуальной таблицы заполнены	</span>
                        Если Выборка.План > 0 Тогда
                            Результат = ЗаписьРегистра.Размер * Выборка.Отработано / Выборка.План;							
                        КонецЕсли;	
                    ИначеЕсли Выборка.СпособРасчета =  Перечисления.СпособыРасчета.Процентом Тогда
                    
                    ИначеЕсли Выборка.СпособРасчета = Перечисления.СпособыРасчета.ПоТарифу Тогда
                        Если Выборка.План > 0 Тогда
                            Результат = ЗаписьРегистра.Размер * Выборка.Отработано;							
                        КонецЕсли;
                    <span class="светло_красный">ИначеЕсли Выборка.СпособРасчета = Перечисления.СпособыРасчета.СвободныйГрафик Тогда
                        Если Выборка.План > 0 Тогда
                            Соотношение = Выборка.Отработано / Выборка.План * 100;

                            <span class="зелёный">//либо 
                            //Если Выборка.Отработано >= Выборка.План * 0.8 Тогда</span>
                            Если Соотношение >= 80 Тогда
                                Результат = (ЗаписьРегистра.Размер * 1.1) * Выборка.Отработано;
                            Иначе
                                Результат = ЗаписьРегистра.Размер * Выборка.Отработано;
                            КонецЕсли;							
                        КонецЕсли;</span>		
                    КонецЕсли;
                    
                    ЗаписьРегистра.Результат = Результат;
                КонецЦикла;	
            </pre>
        </div>
        <p></p>
        <p></p>
    </div>


    <div class="">
        <h3 class="header-style2" id="8a">(8) Практическое задание</h3>
        <p>Добавляем в перечисление способ расчёта "ШтрафЗаПрогул". Добавим константу и назовём её "ШтрафЗаДень".</p>
        <p>Щатем в общий модуль в функцию РасчитатьЗаписиРегистраРасчета() добавим ещё одно условие проверки способа расчёта:</p>
        <div class="code-style">
            <pre>
                ИначеЕсли Выборка.СпособРасчета = Перечисления.СпособыРасчета.ШтрафЗаПрогул Тогда
                    Если Выборка.План > 0 Тогда
                        ШтрафЗаДень = Константы.ШтрафЗаДень.Получить();
                        <span class="зелёный">//Штраф за день мы умножаем на количество фактических дней, которые
                        //прогулял сотрудник</span>
                        Результат = (-ШтрафЗаДень) * Выборка.Отработано;
                    КонецЕсли
            </pre>
        </div>
        <p>Затем в ПР создадим вид расчёта "Штраф", с первичной категорией расчёта. Зайдём в вид расчёта "Оклад" и там в табличной части на закладке "ВытесняющиеВидыРасчета" добавим "Штраф".</p>
        <p>Дельше зайдём во всё тот же один документ и добавим кому-нибудь из сотрудников штраф:</p>
        <img src="../img/1С-ЗУП/2025-03-07_22-46-43.png" class="screen" alt="">
        <p>Проведём и получим результат в регистре:</p>
        <img src="../img/1С-ЗУП/2025-03-07_22-48-41.png" class="screen" alt="">
        <p></p>
        <p></p>
    </div>


    <div class="">
        <h3 class="header-style2" id="9a">(9) Виртуальная таблица регистра расчёта - ФактическийПериодДействия</h3>
        <p>У нас уже есть документ, в котором есть виды расчёта, такие как "Штраф" или "Оклад на выезде", которые вытесняют период из периода действия других видов расчёта.</p>
        <p>Эта виртуальная таблица показывает фактический период действия, т.е. показывает то, что осталось от периода действия после вытеснения из него другого периода.</p>
        <p>Задач, которые будут использовать эту вирт. таблицу не будет, но мы посмотрим что это за таблица.</p>
        <p>Зайдём в консоль запросов и наберём там получение сотрудников, у которых есть вытесняющие виды расчёта, также выберем периоды действия начала и конца:</p>
        <img src="../img/1С-ЗУП/2025-03-09_08-59-58.png" class="screen" alt="">
        <p>Как видим период действия отображается по другому. Теперь для видов расчёта, из которых были вытеснения, период действия разделился на две записи. Промежуток до вытесняющего периода и после него.</p>
        <p>Пока на этом всё.</p>
    </div>


    <div class="">
        <h3 class="header-style2" id="10a">(10) Описываем вид расчёта "Доплата за квалификацию"</h3>
        <p>У нас уже ранее был введён вид расчёта "Доплата за квалификацию", как и способ расчёта "Процентом":</p>
        <img src="../img/1С-ЗУП/2025-03-09_09-37-42.png" class="screen-2" alt="">
        <p>Теперь в наш единственный документ добавим ещё одну строку с этим видом расчёта. Только теперь нужно указать поля "БазовыйПериодНачало" и "БазовыйПериодКонец". Базовый период это период за который мы будем собирать базу. Этот период может не совпадать в периодом действия, но тут укажем, что собирать будем тоже за весь январь, процент мы будем писать в реквизит "Размер", а график работы тут не важен:</p>
        <img src="../img/1С-ЗУП/2025-03-09_09-51-24.png" class="screen" alt="">
        <p>Идём  модуль объекта документа и теперь нам нужно создать запрос для вторичных видов расчёта, т.е. тех видов расчёта, которые зависимы от первичных.</p>
        <p>Нам также в запросе понадобится основная таблица регистра "ОсновныеНачиления" и к ней присоединим вирт. таблицу "БазаОсновныеНачисления", потому что как и у предыдущего запроса, может не быть данных в виртуальной таблице. Итак, соберём запрос:</p>
        <img src="../img/1С-ЗУП/2025-03-09_19-06-14.png" class="screen" alt="">
        <p>В этом запросе установили ещё общее условие запроса, где сделали отбор по регистратору  и категории расчёта(нам нужна вторичная категория).</p>
        <p>Отдельно остановимся на параметрах вирт. таблицы - "ИзмеренияОсновногоРегистра" и "ИзмеренияБазовогоРегистра". <span class="светло_красный">Пока не понял объяснений.</span></p>
        <p>Пока просто впишем параметр &Измерения в оба этих параметра. Получился такой текст запроса:</p>
        <div class="code-style">
            <pre>
                <span class="светло_синий"><span class="зелёный">//зависимое 1 уровня. Теперь будем расчитывать результат для видов расчёта зависимых от других видов расчёта</span>
                Запрос.Текст = 
                    <span class="серый">"ВЫБРАТЬ
                    |	ОсновныеНачисления.НомерСтроки КАК НомерСтроки,
                    |	ОсновныеНачисления.ВидРасчета.СпособРасчета КАК СпособРасчета,
                    |	ЕСТЬNULL(ОсновныеНачисленияБазаОсновныеНачисления.РезультатБаза, 0) КАК СуммаБазы
                    |ИЗ
                    |	РегистрРасчета.ОсновныеНачисления КАК ОсновныеНачисления,
                    |	РегистрРасчета.ОсновныеНачисления.БазаОсновныеНачисления(
                    |			&Измерения,
                    |			&Измерения,
                    |			,
                    |			Регистратор = &Регистратор
                    |				И ВидРасчета.КатегорияРасчета = &КатегорияРасчета) КАК ОсновныеНачисленияБазаОсновныеНачисления
                    |ГДЕ
                    |	ОсновныеНачисления.Регистратор = &Регистратор
                    |	И ОсновныеНачисления.ВидРасчета.КатегорияРасчета = &КатегорияРасчета
                    |
                    |УПОРЯДОЧИТЬ ПО
                    |	НомерСтроки"</span>;</span>
            </pre>
        </div>
        <p>Из чего складывается "СуммаБазы"? На рисунке выше в табличной части мы добавили расчёт процента для бухгалтера. Как я понял, то вот эти параметры &Измерения, в которые мы передаём массив строк названий измерений "Сотрудник, Должность", они как раз и помогают определить, что база собирается за базовый период с указанного сотрудника. Если мы указали конкретного бухгалтера, значит для этого бухгалтера и будет расчитана базовая сумма. Из чего складывается эта сумма? Для вида расчёта "ДоплатаЗаКвалификацию" в табличной части на закладке "Базовые виды расчета" мы указывали два базовых вида - "Оклад" и "Оклад на выезде", значит система возьмёт из поля "Результат" сумму, где вид расчёта "Оклад" и где вид расчёта "Оклад на выезде" и просуммирует её и запишет в поле "СуммаБазы". Вот так примерно нарисовал на рисунке ригистра расчёта:</p>
        <img src="../img/1С-ЗУП/2025-03-09_20-49-18.png" class="screen" alt="">
        <p>Далее установим параметры для запроса и вызовем функцию РасчетЗарплатыОсновныеНачиления().</p>
        <div class="code-style">
            <pre>
                Пока Выборка.Следующий() Цикл
                    ЗаписьРегистра = НаборЗаписей[Выборка.НомерСтроки - 1];
                    Результат = 0;

                    <span class="зелёный">//расчитываем Результат</span>
                    Если Выборка.СпособРасчета = Перечисления.СпособыРасчета.ПоОкладу Тогда
                        <span class="зелёный">//мы выполняем расчёт, только если поля из виртуальной таблицы заполнены</span>	
                        Если Выборка.План > 0 Тогда
                            Результат = ЗаписьРегистра.Размер * Выборка.Отработано / Выборка.План;							
                        КонецЕсли;	
                    ИначеЕсли Выборка.СпособРасчета = Перечисления.СпособыРасчета.ПоТарифу Тогда
                        Если Выборка.План > 0 Тогда
                            Результат = ЗаписьРегистра.Размер * Выборка.Отработано;							
                        КонецЕсли;
                    ИначеЕсли Выборка.СпособРасчета = Перечисления.СпособыРасчета.СвободныйГрафик Тогда
                        Если Выборка.План > 0 Тогда
                            Соотношение = Выборка.Отработано / Выборка.План * 100;

                            <span class="зелёный">//либо 
                            //Если Выборка.Отработано >= Выборка.План * 0.8 Тогда</span>
                            Если Соотношение >= 80 Тогда
                                Результат = (ЗаписьРегистра.Размер * 1.1) * Выборка.Отработано;
                            Иначе
                                Результат = ЗаписьРегистра.Размер * Выборка.Отработано;
                            КонецЕсли;							
                        КонецЕсли;
                    ИначеЕсли Выборка.СпособРасчета = Перечисления.СпособыРасчета.ШтрафЗаПрогул Тогда
                        Если Выборка.План > 0 Тогда
                            ШтрафЗадень = Константы.ШтрафЗаДень.Получить();
                            Результат = (-ШтрафЗадень) * Выборка.Отработано;
                        КонецЕсли	
                    <span class="светло_красный">ИначеЕсли Выборка.СпособРасчета = Перечисления.СпособыРасчета.Процентом Тогда
                        Если Выборка.СуммаБазы > 0 Тогда
                            Результат = ЗаписьРегистра.Размер * Выборка.СуммаБазы / 100;
                        КонецЕсли</span>	
                    КонецЕсли;
                    
                    ЗаписьРегистра.Результат = Результат;
                КонецЦикла;
            </pre>
        </div>
        <p></p>
        <p></p>
    </div>


    <div class="">
        <h3 class="header-style2" id="11a">(11) Практическое задание</h3>
        <p>Добавим в перечисление новый способ расчёта - "Вечернее дежурство". В ПР добавим вид расчёта "Вечернее дежурство" и в закладку "Базовые виды расчёта" добавим "Оклад" и "По тарифу". Категория расчёта - "Зависимое первого уровня"</p>
        <p>Зайдём в общий модуль Расчеты и в фунции РасчитатьЗаписиРегистраРасчета() добавим ещё один способ расчёта и формулу в нём. Покажу малеьникий кусочек кода, что именно добавил:</p>
        <div class="code-style">
            <pre>
                ИначеЕсли Выборка.СпособРасчета = Перечисления.СпособыРасчета.Процентом Тогда
                    Если Выборка.СуммаБазы > 0 Тогда
                        Результат = Выборка.СуммаБазы * 1.1;
                    КонецЕсли	
                КонецЕсли;
            </pre>
        </div>
        <p>Далее открываем документ и добавляем в таличную часть ещё один элемент:</p>
        <img src="../img/1С-ЗУП/2025-03-11_08-10-25.png" class="screen" alt="">
        <p>Базовый период мы задали в пол месяца, значит от базовых видов расчёта(у директора это только оклад) система от их результата отсчитает примерно половину.</p>
        <p>Не понятно, зачем в задаче упоминалось про "продолжительность дежурства не учитывается". Мы вроде как учли, указали базовый период. Может чего не понял.</p>
    </div>


    <div class="">
        <h3 class="header-style2" id="12a">(12) Когда указывать и не указывать базовый период</h3>
        <p>В предыдущей задаче мы расчитывали вечернее дежурство и указывали базовый период, т.е. этим периодом мы указывали сколько дней шло дежурство, и по этому же периоду система брала базовые виды расчёта и пропорционально высчитывала от их результата наш базовый результат. Т.е. брала базовый вид расчёта "оклад", который задан за месяц и смотрела, сколько мы задали базовый период, например, где-то пол месяца, значит высчитывалась примерно половина от оклада.</p>
        <p>Но есть такие виды расчёта как "Доплата за квалификацию" и там мы всегда считаем за весь период действия базовых видов расчёта, значит мы всегда указываем базовый период равный периоду действия. Чтобы каждый раз не указывать базовый период, когда он всегда будет равен периоду действия, в элементе вида расчёта есть галка "Базовый период как период действия", устанавливаем её и система сама будет понимать, что базовый равен периоду действия:</p>
        <img src="../img/1С-ЗУП/2025-03-11_08-37-25.png" class="screen-2" alt="">
        <p></p>
        <p></p>
    </div>


    <div class="">
        <h3 class="header-style2" id="13a">(13) Для новых четырёх видов расчёта вводим свой план видов расчёта</h3>
        <p>Добавим новый план видов расчёта - "Премии". Также нам тут понадобятся реквизиты - "СпособРасчета" и "КатегорияРасчета".</p>
        <p>На закладке "Расчет" нам нужно определить, как будут расчитываться эти виды расчёта. Премии не будут использовать графики расчёта, а значит и период расчёта не понадобится, мы не будем считать количество рабочих дней. Периода действия не будет, а значит и никаких вытеснений не будет.</p>
        <p>Но зависимость от базы, которая вычисляется по периоду действия включим, установив галку "Зависит по периоду действия".</p>
        <p>Какие базовые планы нам понадобятся? Нам нужен будет оклад и сами премии будут выступать в роли базы, значит выбираем оба плана видов расчёта в виде базы:</p>
        <img src="../img/1С-ЗУП/2025-03-11_09-39-33.png" class="screen-2" alt="">
        <p>Добавим ещё два способа расчёта: "Фиксированно" и "От оборота". Можем перейти к добавлению видов расчёта в ПР в плане видов расчёта "Премии".</p>
        <p>Первый вид расчёта:</p>
        <img src="../img/1С-ЗУП/2025-03-11_20-56-22.png" class="screen-2" alt="">
        <p>Второй вид расчёта:</p>
        <img src="../img/1С-ЗУП/2025-03-11_21-03-02.png" class="screen-2" alt="">
        <p>Третий вид:</p>
        <img src="../img/1С-ЗУП/2025-03-11_21-06-51.png" class="screen-2" alt="">
        <p>И червёртый вид. Отличительной чертой этого вида в том, что период может быть не месяц, а часть месяца:</p>
        <img src="../img/1С-ЗУП/2025-03-11_21-09-32.png" class="screen-2" alt="">
        <p>Теперь нам нужен новый регистр для подсчёта премий. Добавим и назовём "Премии", я назову "НачислениеПремий", потому что уже есть план с названием "Премии", чтобы не путаться. Вот так настроим его:</p>
        <img src="../img/1С-ЗУП/2025-03-11_21-16-29.png" class="screen-2" alt="">
        <p>Добавим измерения и ресурсы с реквизитами те же:</p>
        <img src="../img/1С-ЗУП/2025-03-11_21-20-13.png" class="screen-2" alt="">
        <p>Посмотрим, что включилось в стандартных реквизитах:</p>
        <img src="../img/1С-ЗУП/2025-03-11_21-23-52.png" class="screen-2" alt="">
        <p>Документ, который будет писать в регистр будет тот же - "РасчетЗарплаты", но чтобы писать отдельно от основных начислений, мы добавим ещё одну табличную часть "Премии", я как и регистр расчёта назову "НачисленияПремий". Добавим реквизиты в табличную часть, скопировав все реквизиты из табличной части "ОсновныеНачиления", кроме периодов действия и у вида расчёта выбрать другой план расчёта.</p>
        <p>В форме документа вынесем в элементы табличную часть. Также поместим её в страницу "ЗакладкаПермии" и сгруппируем колонки сотрудника с должностью и базовые периоды.</p>
        <p>На этом видео закончилось.</p>
    </div>


    <div class="">
        <h3 class="header-style2" id="14a">(14) Начинаем описание обработки проведения для премий. Расчитываем фиксированную премию(Персональная премия)</h3>
        <p>Также как и для основных начислений мы начинаем также получение набора записей премий, заполняем и записываем его в БД. Пишем текст запроса, в котором также для поля "БазовыйПериодКонец" зададим конец периода. И ещё также у нас может быть так, что базовые периоды будут пусты и чтобы система не записывала в них потом ерунду, мы в запросе через выбор определим, когда и что будет в этих полях:</p>
        <div class="code-style">
            <pre>
                <span class="светло_синий"><span class="зелёный">//премии.</span>
                НаборПремии = Движения.НачисленияПремий;

                <span class="зелёный">//составим текст запроса, где сгруппируем строки табличной части и зададим</span>
                //концу базового периода конец дня
                ТекстЗапроса =
                    <span class="серый">"ВЫБРАТЬ
                    |	РасчетЗарплатыНачислениеПремий.Ссылка.ПериодРегистрации КАК ПериодРегистрации,
                    |	РасчетЗарплатыНачислениеПремий.Сотрудник КАК Сотрудник,
                    |	РасчетЗарплатыНачислениеПремий.Должность КАК Должность,
                    |	РасчетЗарплатыНачислениеПремий.ВидРасчета КАК ВидРасчета,
                    |	РасчетЗарплатыНачислениеПремий.БазовыйПериодНачало КАК БазовыйПериодНачало,
                    |	ВЫБОР
                    |		КОГДА РасчетЗарплатыНачислениеПремий.БазовыйПериодКонец = ДАТАВРЕМЯ(1, 1, 1)
                    |			ТОГДА РасчетЗарплатыНачислениеПремий.БазовыйПериодКонец
                    |		ИНАЧЕ КОНЕЦПЕРИОДА(РасчетЗарплатыНачислениеПремий.БазовыйПериодКонец, ДЕНЬ)
                    |	КОНЕЦ КАК БазовыйПериодКонец,
                    |	РасчетЗарплатыНачислениеПремий.Размер КАК Размер
                    |ИЗ
                    |	Документ.РасчетЗарплаты.НачислениеПремий КАК РасчетЗарплатыНачислениеПремий
                    |ГДЕ
                    |	РасчетЗарплатыНачислениеПремий.Ссылка = &Ссылка"</span>;

                <span class="зелёный">//вызываем функцию общего модуля, чтобы заполнить набор записями</span>
                Расчеты.ЗаполнитьНаборЗаписей(ТекстЗапроса, Ссылка, НаборПремии);
                <span class="зелёный">//после того как набор заполнен его нужно записать. Мы будем использовать у метода
                //Записать() второй параметр, который поставим явно в Ложь, что означает не только запись.
                //По умолчанию и так стоит Ложь, но мы явно это показываем, чтобы не запутаться. Что означает
                //этот параметр? Он означает, что помимо самой записи система ещё будет дополнительно
                //производить пересчет фактического периода действия и ввод записей перерасчетов.
                //В нашем случае как раз есть вид расчёта "Оклад на выезде", который вытесняет из периода
                //действия вида расчёта "Оклад" какой то период, в результате которого мы получаем фактический
                //период действия оклада.</span>
                НаборПремии.Записать(, Ложь);</span>
            </pre>
        </div>
        <p>Идём в ПР и создадим второй документ, укажем период регистрации на 1 января и добавим двух сотрудников. Обоим начислим фиксированную премию. Базовый период тут не обязательно указывать, потому что у этого вида расчёта нет базы, это первичная категория. Проводим, сейчас всё что делает документ это пишет в регистр расчёта введённы данные:</p>
        <img src="../img/1С-ЗУП/2025-03-12_21-58-01.png" class="screen" alt="">
        <p>Далее, нам также нужно расчитать поле "Результат" для каждой записи регистра. Расчитывать будем там же в общем модуле, но теперь вынесем запросы для премий в отдельную процедуру тут же в модуле объекта:</p>
        <div class="code-style">
            <pre>
                --модуль объекта
                <span class="светло_синий">Процедура ОбработкаПроведения()
                    ...
                    <span class="зелёный">//первичные.</span> 
                    РассчитатьПремии(НаборПремии, Запрос, Справочники.КатегорииРасчета.Первичное);
                    ...
                КонецПроцедуры

                Процедура РассчитатьПремии(НаборЗаписей, Запрос, КатегорияРасчета)
                    Запрос.Текст = 
                        <span class="серый">"ВЫБРАТЬ
                        |	НачисленияПремий.НомерСтроки КАК НомерСтроки,
                        |	НачисленияПремий.ВидРасчета.СпособРасчета КАК СпособРасчета
                        |ИЗ
                        |	РегистрРасчета.НачисленияПремий КАК НачисленияПремий
                        |ГДЕ
                        |	НачисленияПремий.Регистратор = &Регистратор
                        |	И НачисленияПремий.ВидРасчета.КатегорияРасчета = &КатегорияРасчета
                        |
                        |УПОРЯДОЧИТЬ ПО
                        |	НомерСтроки"</span>;

                    Запрос.УстановитьПараметр(<span class="серый">"Регистратор"</span>, Ссылка);
                    Запрос.УстановитьПараметр(<span class="серый">"КатегорияРасчета"</span>, КатегорияРасчета);
                    Выборка = Запрос.Выполнить().Выбрать();

                    Расчеты.РасчитатьЗаписиРегистраРасчета(НаборЗаписей, Выборка);
                КонецПроцедуры</span>

                --общий модуль
                <span class="светло_синий">Функция РасчитатьЗаписиРегистраРасчета(НаборЗаписей, Выборка) Экспорт
                    ...
                    ИначеЕсли Выборка.СпособРасчета = Перечисления.СпособыРасчета.Фиксированно Тогда
                        Результат = ЗаписьРегистра.Размер;
                    ...
                КонецФункции</span>
            </pre>
        </div>
        <p></p>
        <p></p>
    </div>


    <div class="">
        <h3 class="header-style2" id="15a">(15) Считаем "Месячные премии"</h3>
        <p>Зайдём в ПР и введём во втором документе в табличной части "Начисление премий" ещё данные. Добавим бухгалтеру "Месячную премию" в размере 20 процентов:</p>
        <img src="../img/1С-ЗУП/2025-03-13_08-18-00.png" class="screen" alt="">
        <p>Проведём, резулттат будет конечно же пустой. Теперь нужно подумать как расчитать результут. Сложность тут в том, что для месячной премии установлены 3 базовых вида расчёта "Оклад, Оклад на выезде и Персональная премия". "Оклад и Оклад на выезде" как помним находятся в другом регистре расчёта. Нам нужно как то взять результат базы из двух регистров расчёта.</p>
        <p><span class="светло_красный">Когда я пытался сам составить запрос, то не получалось взять результат базы из виртульной таблицы другого регистра. Оказывается, я не внимательно посмотрел на виртуальные таблицы регистра "НачисленияПремий". Там уже система сама предоставила виртуальные таблицы по сбору базы:</span></p>
        <img src="../img/1С-ЗУП/2025-03-13_08-28-00.png" class="screen-2" alt="">
        <p><span class="светло_красный">Видимо система посмотрела, что для данного плана видов расчёта установлены как базы два плана видов расчёта, поэтому она так и отобразила виртуальные таблицы:</span></p>
        <img src="../img/1С-ЗУП/2025-03-11_09-39-33.png" class="screen-2" alt="">
        <p>Итак вот такой запрос получился:</p>
        <div class="code-style">
            <pre>
                --модуль объекта "РасчетЗарплаты"
                <span class="светло_синий">Процедура ОбработкаПроведения()
                    <span class="зелёный">//зависимое первого уровня</span>
                    Запрос.Текст = 
                        <span class="серый">"ВЫБРАТЬ
                        |	НачисленияПремий.НомерСтроки КАК НомерСтроки,
                        |	НачисленияПремий.ВидРасчета.СпособРасчета КАК СпособРасчета,
                        |	ЕСТЬNULL(НачисленияПремийБазаНачисленияПремий.РезультатБаза, 0) + ЕСТЬNULL(НачисленияПремийБазаОсновныеНачисления.РезультатБаза, 0) КАК СуммаБазы
                        |ИЗ
                        |	РегистрРасчета.НачисленияПремий КАК НачисленияПремий
                        |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрРасчета.НачисленияПремий.БазаОсновныеНачисления(
                        |				&Измерения,
                        |				&Измерения,
                        |				,
                        |				Регистратор = &Регистратор
                        |					И ВидРасчета.КатегорияРасчета = &КатегорияРасчета) КАК НачисленияПремийБазаОсновныеНачисления
                        |		ПО НачисленияПремий.НомерСтроки = НачисленияПремийБазаОсновныеНачисления.НомерСтроки
                        |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрРасчета.НачисленияПремий.БазаНачисленияПремий(
                        |				&Измерения,
                        |				&Измерения,
                        |				,
                        |				Регистратор = &Регистратор
                        |					И ВидРасчета.КатегорияРасчета = &КатегорияРасчета) КАК НачисленияПремийБазаНачисленияПремий
                        |		ПО НачисленияПремий.НомерСтроки = НачисленияПремийБазаНачисленияПремий.НомерСтроки
                        |ГДЕ
                        |	НачисленияПремий.Регистратор = &Регистратор
                        |	И НачисленияПремий.ВидРасчета.КатегорияРасчета = &КатегорияРасчета
                        |
                        |УПОРЯДОЧИТЬ ПО
                        |	НомерСтроки"</span>;	

                    Запрос.УстановитьПараметр(<span class="серый">"Измерения"</span>, МассивИзмерений);
                    Запрос.УстановитьПараметр(<span class="серый">"Регистратор"</span>, Ссылка);
                    Запрос.УстановитьПараметр(<span class="серый">"КатегорияРасчета"</span>, Справочники.КатегорииРасчета.ЗависимоеПервогоУровня);
                    Выборка = Запрос.Выполнить().Выбрать();

                    Расчеты.РасчитатьЗаписиРегистраРасчета(НаборПремии, Выборка);
                КонецПроцедуры</span>


                --общий модуль "Расчеты"
                <span class="светло_синий">Функция РасчитатьЗаписиРегистраРасчета(НаборПремии, Выборка) Экспорт
                ...
                    ИначеЕсли Выборка.СпособРасчета = Перечисления.СпособыРасчета.Процентом Тогда
                        Если Выборка.СуммаБазы > 0 Тогда
                            Результат = ЗаписьРегистра.Размер * Выборка.СуммаБазы / 100;
                        КонецЕсли
                ...
                КонецФункции</span>
            </pre>
        </div>
        <p>До этого мы расчитывали "Персональную премию" и код вынесли в отдельную процедуру. Там запрос конечно немного другой, но Камков хочет в этой процедуре переписать запрос на новый, который получился при расчёте "Месячной премии". Если мы по этому запросу получим данные для персональной премии, то там в принципе ничего страшного не будет, нам для персональной премии нужно всего лишь номер строки и способ расчёта и всё. Поэтому принято решение в процедуре "РасчитатьПремии" заменить текст запроса на этот, что выше описан. В итоге код бутет такой:</p>
        <div class="code-style">
            <pre>
                --модуль объекта "РасчетЗарплаты"
                <span class="светло_синий">Процедура ОбработкаПроведения()
                    ...
                    <span class="зелёный">//первичные. </span>
                    РассчитатьПремии(НаборПремии, Запрос, Справочники.КатегорииРасчета.Первичное);
                    Расчеты.РасчитатьЗаписиРегистраРасчета(НаборПремии, Выборка);

                    <span class="зелёный">//зависимое первого уровня</span>
                    РассчитатьПремии(НаборПремии, Запрос, Справочники.КатегорииРасчета.ЗависимоеПервогоУровня);
                    Расчеты.РасчитатьЗаписиРегистраРасчета(НаборПремии, Выборка);
                    ...
                КонецПроцедуры


                Процедура РассчитатьПремии(НаборЗаписей, Запрос, КатегорияРасчета)
                    Запрос.Текст = 
                        <span class="серый">"ВЫБРАТЬ
                            |	НачисленияПремий.НомерСтроки КАК НомерСтроки,
                            |	НачисленияПремий.ВидРасчета.СпособРасчета КАК СпособРасчета,
                            |	ЕСТЬNULL(НачисленияПремийБазаНачисленияПремий.РезультатБаза, 0) + ЕСТЬNULL(НачисленияПремийБазаОсновныеНачисления.РезультатБаза, 0) КАК СуммаБазы
                            |ИЗ
                            |	РегистрРасчета.НачисленияПремий КАК НачисленияПремий
                            |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрРасчета.НачисленияПремий.БазаОсновныеНачисления(
                            |				&Измерения,
                            |				&Измерения,
                            |				,
                            |				Регистратор = &Регистратор
                            |					И ВидРасчета.КатегорияРасчета = &КатегорияРасчета) КАК НачисленияПремийБазаОсновныеНачисления
                            |		ПО НачисленияПремий.НомерСтроки = НачисленияПремийБазаОсновныеНачисления.НомерСтроки
                            |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрРасчета.НачисленияПремий.БазаНачисленияПремий(
                            |				&Измерения,
                            |				&Измерения,
                            |				,
                            |				Регистратор = &Регистратор
                            |					И ВидРасчета.КатегорияРасчета = &КатегорияРасчета) КАК НачисленияПремийБазаНачисленияПремий
                            |		ПО НачисленияПремий.НомерСтроки = НачисленияПремийБазаНачисленияПремий.НомерСтроки
                            |ГДЕ
                            |	НачисленияПремий.Регистратор = &Регистратор
                            |	И НачисленияПремий.ВидРасчета.КатегорияРасчета = &КатегорияРасчета
                            |
                            |УПОРЯДОЧИТЬ ПО
                            |	НомерСтроки"</span>;

                    Запрос.УстановитьПараметр(<span class="серый">"Измерения"</span>, МассивИзмерений);
                    Запрос.УстановитьПараметр(<span class="серый">"Регистратор"</span>, Ссылка);
                    Запрос.УстановитьПараметр(<span class="серый">"КатегорияРасчета"</span>, КатегорияРасчета);
                    Выборка = Запрос.Выполнить().Выбрать();

                    <span class="зелёный">//у нас есть выборка и есть набор записей НаборПремии, нам нужно
                    //для каждого набора записей расчитать поле "Результат" </span>
                    Расчеты.РасчитатьЗаписиРегистраРасчета(НаборЗаписей, Выборка);
                КонецПроцедуры</span>



                --общий модуль "Расчеты"
                <span class="светло_синий">Функция РасчитатьЗаписиРегистраРасчета(НаборПремии, Выборка) Экспорт
                ...
                    ИначеЕсли Выборка.СпособРасчета = Перечисления.СпособыРасчета.Процентом Тогда
                        Если Выборка.СуммаБазы > 0 Тогда
                            Результат = ЗаписьРегистра.Размер * Выборка.СуммаБазы / 100;
                        КонецЕсли
                ...
                КонецФункции</span>
            </pre>
        </div>
        <p>Такое вынесение кода с запросом нам нужно для того, чтобы для всех 4х видов премий использовать один и тот же запрос. Хотя я бы для первичного вида расчёта оставил первый запрос и по условию выполнял бы первый или второй запрос. А то для первисной премии получается мы будем выполянть два левых соединения не нужных.</p>
    </div>


    <div class="">
        <h3 class="header-style2" id="16a">(16) Практическое задание. Переписать запрос процедуры "РасчитатьПремии" так, чтобы вместо "соединения" использовалось "объединение".</h3>
        <p>Получится вот такой запрос:</p>
        <div class="code-style">
            <pre>
                <span class="светло_синий">Запрос.Текст = 
                    <span class="серый">"ВЫБРАТЬ
                    |	ВложеннаяТаблица.НомерСтроки КАК НомерСтроки,
                    |	ВложеннаяТаблица.СпособРасчета КАК СпособРасчета,
                    |	СУММА(ВложеннаяТаблица.СуммаБазы) КАК СуммаБазы
                    |ИЗ
                    |	(ВЫБРАТЬ
                    |		НачисленияПремий.НомерСтроки КАК НомерСтроки,
                    |		НачисленияПремий.ВидРасчета.СпособРасчета КАК СпособРасчета,
                    |		0 КАК СуммаБазы
                    |	ИЗ
                    |		РегистрРасчета.НачисленияПремий КАК НачисленияПремий
                    |	ГДЕ
                    |		НачисленияПремий.Регистратор = &Регистратор
                    |		И НачисленияПремий.ВидРасчета.КатегорияРасчета = &КатегорияРасчета
                    |	
                    |	ОБЪЕДИНИТЬ ВСЕ
                    |	
                    |	ВЫБРАТЬ
                    |		НачисленияПремийБазаНачисленияПремий.НомерСтроки,
                    |		НачисленияПремийБазаНачисленияПремий.ВидРасчета.СпособРасчета,
                    |		НачисленияПремийБазаНачисленияПремий.РезультатБаза
                    |	ИЗ
                    |		РегистрРасчета.НачисленияПремий.БазаНачисленияПремий(
                    |				&Измерения,
                    |				&Измерения,
                    |				,
                    |				Регистратор = &Регистратор
                    |					И ВидРасчета.КатегорияРасчета = &КатегорияРасчета) КАК НачисленияПремийБазаНачисленияПремий
                    |	
                    |	ОБЪЕДИНИТЬ ВСЕ
                    |	
                    |	ВЫБРАТЬ
                    |		НачисленияПремийБазаОсновныеНачисления.НомерСтроки,
                    |		НачисленияПремийБазаОсновныеНачисления.ВидРасчета.СпособРасчета,
                    |		НачисленияПремийБазаОсновныеНачисления.РезультатБаза
                    |	ИЗ
                    |		РегистрРасчета.НачисленияПремий.БазаОсновныеНачисления(
                    |				&Измерения,
                    |				&Измерения,
                    |				,
                    |				Регистратор = &Регистратор
                    |					И ВидРасчета.КатегорияРасчета = &КатегорияРасчета) КАК НачисленияПремийБазаОсновныеНачисления) КАК ВложеннаяТаблица
                    |
                    |СГРУППИРОВАТЬ ПО
                    |	ВложеннаяТаблица.НомерСтроки,
                    |	ВложеннаяТаблица.СпособРасчета"</span>;</span>
            </pre>
        </div>
        <p>Как описать такой запрос в конструкторе запроса? Я опишу это в разделе шпоры "Язык запросов в 1С(первая часть)" внизу в статье про объединение таблиц.</p>
        <p></p>
        <p></p>
        <p></p>
    </div>


    <div class="">
        <h3 class="header-style2" id="17a">(17) Рассчитываем оставшиеся две премии, одна "зависимое первого уровня", вторая "зависимое второго уровня"</h3>
        <p>Для премии зависомой от первого уровня у нас уже описано действие, осталось описать для пермии зависимой от второго уровня.</p>
        <p>Точно также вызываем процедуру "РассчитатьПремии". Запрос внутри подойдёт у нас для всех 4х видов премий:</p>
        <div class="code-style">
            <pre>
                --модуль объекта "РасчетЗарплаты"

                <span class="светло_синий">Процедура ОбработкаПроведения()
                    ...
                    <span class="зелёный">//зависимое второго уровня</span>
		            РассчитатьПремии(НаборПремии, Запрос, Справочники.КатегорииРасчета.ЗависимоеВторогоУровня);
                    ...
                КонецПроцедуры</span>
            </pre>
        </div>
        <p>В ПР добавим во второй документ ещё одну премию "Поощрительная надбавка" для бухгалтера. Эта премия "зависимое второго уровня", расчитывается на базе месячной премии по формуле также процентом.</p>
    </div>


    <div class="">
        <h3 class="header-style2" id="18a">(18) Создадим план видов расчёта "Удержания" и регистр расчёта</h3>
        <p>"Удержания" по сути своей немного другая разновидность видов расчёта. Добавим новый план видов расчётов "Удержания". Реквизиты такие же - "СпособРасчета" и "КатегорииРасчета".</p>
        <p>На закладке "Расчет" мы отметим также как и для премий. Мы будем считать в целом за месяц, не будет никаих частей в месяце, значит галку "Использует период действия" не включаем. Но в отличии от премий мы базу буем собирать по периоду регистрации, а не по периоду действия. Это особенность удержаний.</p>
        <p>Также отметим базовые планы видов расчета:</p>
        <img src="../img/1С-ЗУП/2025-03-14_17-46-27.png" class="screen-2" alt="">
        <p>Дальше добавим регистр расчёта "Удержания". Можно скопировать регистр "НачисленияПремий", потому что похож по измерениям, ресурсу и реквизиту. Настроим так:</p>
        <img src="..//img/1С-ЗУП/2025-03-14_17-51-48.png" class="screen-2" alt="">
        <p>Далее тоже копированием от премий мы добавим табличную часть "Удержания" в документе "РасчетЗарплаты". В форме документа вынесем таблицу в элементы формы. По колонкам раскидаем некоторые поля таблицы.</p>
        <p></p>
        <p></p>
        <p></p>
        <p></p>
    </div>


    <div class="">
        <h3 class="header-style2" id="19a">(19) Описать код, создать вид расчёта "Алименты", указать способ расчёта "Процентом" и указать базовые виды расчёта.</h3>
        <p>Начнём с кода. Мы также в обработке проведения сначала запишем данные в регистр расчёта:</p>
        <div class="code-style">
            <pre>
                <span class="светло_синий"><span class="зелёный">//удержания</span>
                НаборУдержания = Движения.Удержания;

                <span class="зелёный">//составим текст запроса, где сгруппируем строки табличной части и зададим
                //концу базового периода конец дня</span>
                ТекстЗапроса =
                    <span class="серый">"ВЫБРАТЬ
                    |	РасчетЗарплатыУдержания.Ссылка.ПериодРегистрации КАК ПериодРегистрации,
                    |	РасчетЗарплатыУдержания.Сотрудник КАК Сотрудник,
                    |	РасчетЗарплатыУдержания.Должность КАК Должность,
                    |	РасчетЗарплатыУдержания.ВидРасчета КАК ВидРасчета,
                    |	РасчетЗарплатыУдержания.БазовыйПериодНачало КАК БазовыйПериодНачало,
                    |	ВЫБОР
                    |		КОГДА РасчетЗарплатыУдержания.БазовыйПериодКонец = ДАТАВРЕМЯ(1, 1, 1)
                    |			ТОГДА РасчетЗарплатыУдержания.БазовыйПериодКонец
                    |		ИНАЧЕ КОНЕЦПЕРИОДА(РасчетЗарплатыУдержания.БазовыйПериодКонец, ДЕНЬ)
                    |	КОНЕЦ КАК БазовыйПериодКонец,
                    |	РасчетЗарплатыУдержания.Размер КАК Размер
                    |ИЗ
                    |	Документ.РасчетЗарплаты.Удержания КАК РасчетЗарплатыУдержания
                    |ГДЕ
                    |	РасчетЗарплатыУдержания.Ссылка = &Ссылка"</span>;

                <span class="зелёный">//вызываем функцию общего модуля, чтобы заполнить набор записями</span>
                Расчеты.ЗаполнитьНаборЗаписей(ТекстЗапроса, Ссылка, НаборПремии);
                <span class="зелёный">//после того как набор заполнен его нужно записать. Мы будем использовать у метода
                //Записать() второй параметр, который поставим явно в Ложь, что означает не только запись.
                //По умолчанию и так стоит Ложь, но мы явно это показываем, чтобы не запутаться. Что означает
                //этот параметр? Он означает, что помимо самой записи система ещё будет дополнительно
                //производить пересчет фактического периода действия и ввод записей перерасчетов.</span>
                НаборУдержания.Записать(, Ложь);</span>
            </pre>
        </div>
        <p>Ранее для премий мы создавали проведуру "РасчитатьПремии", для удержаний создадим такую же процедуру, потому что расчёты будут похожими. Скопируем эту процедуру. Откроем запрос в конструкторе и изменим вложенный запрос. Во вложенном запросе в каждом пакете запроса заменим таблицы.</p>
        <p>Вместо основной таблицы премий укажем удержания, а вместо виртуальных таблиц базы укажем базы для удержания. Указывать тут код не буду, там всё похоже на премии, если что посмотреть в инфобазе. И добавим к агрегатной функции суммы минус, чтобы сумма базы была с минусом.</p>
        <p>Затем в общем модуле "Расчеты" нужно обработать способ расчёта. Как помним способ "Процентом" уже обработан, поэтому тут ничего менять не нужно.</p>
        <p>Ну и запускаем ПР и в нём добавим вид расчёта "Алименты" и добавим базовые виды расчёта.</p>
        <p>Так как в базе имеются виды расчёта с категорией зависимости второго уровня, значит наш вид расчёта будет зависим от второго уровня и будет иметь категорию "Зависимость тетьего уровня":</p>
        <img src="../img/1С-ЗУП/2025-03-15_10-15-06.png" class="screen" alt="">
        <p>Ну и попробуем добавить какое-нибудь удержание во втором документе расчёта зарплаты:</p>
        <img src="../img/1С-ЗУП/2025-03-15_10-19-14.png" class="screen" alt="">
        <p>Результат не посчитается, потому что в коде мы не указали, что пользователь ввёл новый вид категории расчёта. Мы упрощаем себе задачу и вводим эту категорию как предопределённый элемент справочника, ну или можно получить ссылку на него через метод НайтиПоНаименованию("Зависимое третьего уровня"). Я сделал по второму способу. Понятное дело что в коде так не получится, если в жизни пользователь добавит какую то свою категорию, в этом случае нам нужно будет тогда перебирать все категории и получать на них ссылки.</p>
    </div>


    <div class="">
        <h3 class="header-style2" id="20a">(20) Практическое задание</h3>
        <p>О чём, как я понял, этот вид расчёта? Мы для этого вида даже размер не задаём, тут просто считается пропорция. Например, мы хотим знать сколько получится денег за 8 отработанных дней от базы(а база у нас за месяц). Или сколько получится денег за 8 отработанных дней за пол месяца от базы. Т.е. это какой-то вспомогательный вид расчёта.</p>
        <p>Ну первым делом добавим в перерчисление новый способ расчёта "Пропорционально базе". Затем опишем в коде очередное условие способа расчёта. Формула похожа на способ "По окладу", только тут ещё и база нужна, как и данные графика.</p>
        <p>Добавим вид расчёта "Пропорционально базе" в плане "Основные начисления". Т.к. в базовых вида расчёта есть зивисимое первого уровня, значит этот вид будет "зависимое второго уровня":</p>
        <img src="../img/1С-ЗУП/2025-03-16_08-11-27.png" class="screen-2" alt="">
        <p>Почему мы добавили в плане "Основные начисления"? Наверно, потому, что этот план является планом для регистра расчёта "Основные начисления", а только в этом регистре будут виртуальные таблицы с фактически отработанными днями и база. В остальных регистрах есть только база.</p>
        <p>Создадим в области основного начисления ещё один запрос данных "зависимое второго уровня". Описывать код не буду, смотреть в базе. В запросе мы получаем данные из трёх таблиц: основной и двух виртуальных.</p>
        <p>Добавим во втором документе для бухгалтера строку:</p>
        <img src="../img/1С-ЗУП/2025-03-16_09-43-05.png" class="screen" alt="">
        <p>Если посмотреть в то, что вернул запрос:</p>
        <img src="../img/1С-ЗУП/2025-03-16_09-44-26.png" class="screen" alt="">
        <p>То увидим, что база собралась за весь месяц: "Оклад"(44 341) + "Доплата за квалификацию"(6 325), потому что мы указали базовый период в месяц. А период действия указали 10 календарных дней и обязательно указали график работы, из этого система посчитала, что плановых рабочих дней 23(по пятидневке), а отработанных дней 8:</p>
        <img src="../img/1С-ЗУП/2025-03-16_09-48-29.png" class="screen-2" alt="">
        <p>Я всё не мог понять, для чего мы указываем период действия, ведь для оклада там уже указан какой то перио и он даже посчитан, но этот период действия не имеет отношения к периоду действия оклада. Этот период действия мы задаём и виртуальная таблица считает для этого вида расчёта. Как в этой строке мы укажем период и график, так и покажет система данные для неё.</p>
        <p>А вот базовый период уже смотрит на оклад и доплату. И от базового периода, который мы укажем в этой строке и посчитается оклад. Если оклад за месяц 50 000 и мы укажем базовый за месяц, то получим 50 000, а если мы укажем базовый за пол месяца, то и оклад получим 25 000.</p>
        
    </div>


    <div class="">
        <h3 class="header-style2" id="21a">(21) Практическое задание</h3>
        <p>Способ расчёта "Фиксированно" у нас уже есть. Вид расчёта "Спецкомандировка" явно будет в плане "Основные начисления", потому что это не премии и удержания. Добавим этот вид расчёта:</p>
        <img src="../img/1С-ЗУП/2025-03-16_10-55-45.png" class="screen-2" alt="">
        <p>Этот вид похож на вид "Оклад на выезде", только с формулой другой. Нужно в окладе указать, что спецкомандировка является вытесняющим видом. Также этот вид будет первичной категории.</p>
        <p>У нас уже есть запрос для первичной категории, но там мы получаем плани отработанные дни, они нам не мешают, для фиксированной формулы нам достаточно номер строки и способ расчёта.</p>
        <p>В 2м документе зададим строку с этим видом и указав период действия для этого вида, мы указали по сути сколько дней была командировка. Т.е. эти дни будут вычтены из оклада:</p>
        <img src="../img/1С-ЗУП/2025-03-16_12-23-38.png" class="screen" alt="">
        <p>Нужно запомнить, как я понимаю, задавая периоды действия или базовые, мы их задаём конкретно для данного вида расчёта в данной строке табличной части. Вот если брать этот пример, то указав период действия, мы указали период, который будет вычтен из периода оклада.</p>
    </div>


    <div class="">
        <h3 class="header-style2" id="22a">(22) Смотрим, что за параметр "Разрезы" в виртуальной таблице "База&lt;ИмяРегистраРасчета>"</h3>
        <img src="../img/1С-ЗУП/2025-03-17_07-58-47.png" class="screen-2" alt="">
        <p>Допустим мы в консоле смотрим базу для конкретного сотрудника по его премии:</p>
        <img src="../img/1С-ЗУП/2025-03-17_08-00-06.png" class="screen" alt="">
        <p>Как нам известно, база собирается по результатам тех базовых видов расчёта, которые входят в данную премию:</p>
        <img src="../img/1С-ЗУП/2025-03-11_21-03-02.png" class="screen-2" alt="">
        <p>Но этих базовых видов расчёта не видно в выборке на первом рисунке. Для этого есть такой параметр как "Разрезы", который позволяет развернуть базу по значениям.</p>
        <p>"Разрезы" это массив с именами неких разрезов. Какие есть разрезы? Их можно посмотреть в виртуальной таблице:</p>
        <img src="../img/1С-ЗУП/2025-03-17_08-09-15.png" class="screen-2" alt="">
        <p>Мы хотим посмотреть в разрезе "ВидРасчета". Для начала нужно указать сам параметр в вирт. таблице - &Разрезы, а затем выбрать поле "ВидРасчетаРазрез" в правую колонку. В параметре &Разрезы указываем, что это массив или список значений, значения строкового типа - названия разрезов. В нашем случае строка "ВидРасчета":</p>
        <img src="../img/1С-ЗУП/2025-03-17_08-41-47.png" class="screen" alt="">
        <p>Как видим общая база разделилась по базовым видам расчёта данной премии и теперь можно анализировать из чего она состоит. Тут нет базового вида расчёта "Персональные премии", потому что они находятся в другой вирт. таблице База.НачислениеПремий</p>
        <p></p>
        <p></p>
    </div>


    <div class="">
        <h3 class="header-style2" id="23a">(23)</h3>
        <p>Никуда ничего не записываем, просто смотрим. В примере мы создали нескольких бухгалтеров, дали им оклады и одному конкретному бухгалтеру назначили месячную премию. Если собрать запрос по базе, которая посчитается для этой премии, то получим базу только конкретно для этого человека по его окладу, а мы хотим собрать базу всех окладов всех бухгалтеров. Для этого в параметре &Измерения вирт. таблицы мы уберем "Сотрудник" и оставим только "Должность". И теперь для нашего конкретного сотрудника в базе соберутся все оклады всех бухгалтеров. А дальше можно посмотреть из оклада каких сотрудников собразась база, для этого добавим параметр &Разрез, составим массив или список с одним элементом - "Сотрудник" и вынесем поле "СотрудникРазрез" в выборку. Теперь мы видим всех сотрудников бухгалтеров, чьи оклады составляют базу:</p>
        <img src="../img/1С-ЗУП/2025-03-17_09-25-59.png" class="screen" alt="">
        <p>Сильно смысла искать не нужно в запросе, просто смотрим возможности.</p>
        <p></p>
    </div>


    <div class="">
        <h3 class="header-style2" id="24a">(24) Отчёт "ОтчетПоНачислениям"</h3>
        <p>Вот такого вида отчёт нужно сделать:</p>
        <img src="../img/1С-ЗУП/2025-03-17_09-35-20.png" class="screen-2" alt="">
        <p>Вот такой отчёт сделал я сам как смог. Называется он "ВидыРасчетов" в базе. Этот отчёт очень простой и мало отражает суть задачи:</p>
        <img src="../img/1С-ЗУП/2025-03-18_08-10-22.png" class="screen-2" alt="">
        <p>Этот отчёт будет по Камкову. Назовём отчёт "ОтчетПоНачислениям". Набор данных будет использовать "Объединение". Нам нужны данные из основных начислений и из премий.</p>
        <p>Добавим объединение и в первый набор объединения выберем данные из основной таблицы "ОсновныеНачисления". Выберем поля "Сотрудник, Должность, ВидРасчет и Результат".</p>
        <p>В условиях конструктора мы выберем отбор по полю "ПериодРегистрации", чтобы пользователь мог задать дату и отчёт строился по месяцу. Период регистрации в регистре это всегда начало месяца. Но для параметра мы зададим функцию НАЧАЛОПЕРИОДА(), чтобы пользовательский параметр приводился к началу месяца.</p>
        <p>Как видно из рисунка задачи, нам нужно выводить название регистра расчёта. Это можно сделать через поле запроса. В запросе мы выведем вот так:</p>
        <img src="../img/1С-ЗУП/2025-03-18_09-18-02.png" class="screen" alt="">
        <p>Добавим второй набор в объединение. Можно скопировать текст запроса, потому что он похож.</p>
        <p>Далее на закладке "Ресурсы" выводи единственный ресурс "Результат"</p>
        <p>В параметрах снимает галочку "Ограничение доступности" с параметра "ПериодРегистрации". А для параметров "ОсновныеНачисления" и "НачисленияПремий" мы сразу задаём строковые значения.</p>
        <p>В настройках добавим новую группировку по сотруднику, затем через контекстное меню сотрудника нажмём "Изменить" и добавим к нему ещё группировку "Должность".</p>
        <p>Затем по рисунку у нас вложенная групппировка названия регистра расчета, добавим такую группировку в сотрудника.</p>
        <p>Затем в регистр влаживаем группировку по виду расчёта:</p>
        <img src="../img/1С-ЗУП/2025-03-18_09-36-08.png" class="screen-2" alt="">
        <p>И в выбранных полях перетащим ресурс "результат"</p>
        <p>Добавим параметр периода в пользоательские настройки.</p>
        <p>Дадим пользователю возможность редактировать группировки. Для этого выделим корневой отчёт, откроем свойства элемента пользовательских настроек и поставим галку "Группировки":</p>
        <img src="../img/1С-ЗУП/2025-03-18_09-40-17.png" class="screen" alt="">
    </div>


    <div class="">
        <h3 class="header-style2" id="26a">(26) Вернёмся к вытеснениям. Будем расчитывать за февраль.</h3>
        <p>Создадим новый документ расчёта зарплаты и укажем период регистрации - февраль. Добавим сотрудника:</p>
        <img src="../img/1С-ЗУП/2025-03-19_21-42-13.png" class="screen" alt="">
        <p></p>
        <p></p>
        <p></p>
        <p></p>
    </div>





    <h3 class="header-style2" id=""></h3>





    <div class="">
        <h3 class="header-style2" id="1b">Формулы расчёта оклада</h3>
        <div class="code-style">
            <pre>
                <span class="светло_синий">Оклад = Ставка оклада * Количество отработанных дней / Количество рабочих дней</span>

                *Ставка оклада - это та сумма, которая установлена за все рабочие дни в периоде.
                *Количество отработанных дней - это те дни, которые реально отработаны в месяце
                *Количество рабочих дней - это количество всего рабочих дней в периоде

                Пример: Ставка оклада 70 000 т.р., т.е. это деньги на все рабочее время в периоде
                Допустим в месяце у нас 23 рабочих дня, а отработали реально 15 дней, рпасчитаем по формуле
                Результат = 70 000 * 15 / 23;    // = 45 652 руб.
            </pre>
        </div>
    </div>

    <h3 class="header-style2" id=""></h3>

</div>
