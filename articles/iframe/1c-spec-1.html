<div class="wrap">
   
    <h2 class="header-style">Подготовка к спецу по Леонтьеву</h2>

    <ul class="list">       
        <li><b id="doc.6">Для экзаменов от Леонтьева на Специалиста 8.3. Идём от простого к сложному</b></li>
        <li>Перед ссылками буду кратко описывать о чём видео, чтобы не переходить по каждой ссылке ища что-то</li>
        <li><a href="#spec-a">(Спец.) Методика оперативного проведения и управляемые блокировки. Устное объяснение.</a></li>
        <li><span class="фиолетовый">Занятие 1</span>. Посвещено интерфейсу, настраиваем подсистемы и заполняем их. Настраиваем панели. Нужно уметь запустить обработку "Консоль запросов", она сделана так, что для её работы нужен толстый клиент и разрешение на запуск обычных форм в управляемом приложении. Но в конце, когда задачи решены, нужно переключить на тонкий клиент. Также для работы обработки нужен модальный режим, но также в конце нужно вернуться к не модальному режиму. Или можно зайти в код обработки и поменять модальный метод на асинхронный. Также пересчёт суммы сделали, его в каркасной конфе нет.</li>
        <li>-------------------------------------------------------------------------</li>

        <li><span class="фиолетовый">Занятие 2</span>. Начинает с того, что оптимизируем пересчёт сумм. Суть в том, что вместо подсчёта суммы документа при каждом чихе, мы в подвале табличной части для колонки "Сумма" будем выводить подсчитанные системой Объект.ИтогСумма. Немного про панели интерфейса. Описываем проведение приходной накладной, учитываем склады. Показывает 2 способа вытащить гиперссылку на регистр в панель навигации, куда пишет документ. Описываем проведение расходной накладной, учитываем остатки. Рассказ про свойства документа "Проведение", "Оперативное проведение" и "Удаление движений". Далее контроль остатков описываем. Ну и блокировки описываем.</li>
        <li><a href="#spec-c">(Спец.) Код приходной накладной. <span class="фиолетовый">Занятие 2</span>.</a></li>
        <li><a href="#spec-1">(Спец.) <b>Контроль остатков</b>. Старая методика. <span class="фиолетовый">Занятие 2</span></a></li>
        <li>-------------------------------------------------------------------------</li>

        <li><span class="фиолетовый">Занятие 3</span>. Схлопываем повторяющиеся строки в таб. части в приходной разными способами. Пишем новую методику. На 35 мин. объясняет, зачем свойство "БлокироватьДляИзменения" отключает "Разделение итогов". Хорошо объяснил, более менее понятно стало.</li>
        <li><a href="#spec-2">(Спец.) <b>Контроль остатков</b>. Новая методика. <span class="фиолетовый">Занятие 3</span></a></li>
        <li>-------------------------------------------------------------------------</li>

        <li><span class="фиолетовый">Занятие 4</span>. До 8 мин. кратко рассказал что такое ФИФО и ЛИФО. Далее рассчитываем по средней.</li>
        <li><a href="#spec-3">(Спец.) Расчёт <b>себестоимости по средней</b>. <span class="фиолетовый">Занятие 4</span></a></li>
        <li>-------------------------------------------------------------------------</li>

        <li><span class="фиолетовый">Занятие 5</span>. Обращает внимание на то, что лучше длину числовых измерений делать одинаковой с длинами заданными в реквизитах документов. В начале опять рассказывает про ФИФО, ЛИФО. 00:05:30 - В билетах встречается 2 способа задания учётной политики: напрямую в регистре и документом, т.е. можно напрямую писать в регистре, а можно через документ записать в регистр текущую учётную политику. Сделаем их. Ну дальше реализуем ФИФО и ЛИФО.</li>
        <li><a href="#spec-4">(Спец.) Расчёт себестоимости по <b>ФИФО и ЛИФО</b> по каждому складу. <span class="фиолетовый">Занятие 5</span></a></li>
        <li>-------------------------------------------------------------------------</li>

        <li><span class="фиолетовый">Занятие 6</span>. Решаем Билет 1. Нужно вести учёт количества товаров в разрезе складов, а себестоимость расчитывать по всему предприятию в целом. Значит делаем 2 регистра накопления. Но в обоих регистрах у нас будет ресурс "Количество" для отслеживания того, чтобы данные количества были одинаковыми в обоих регистрах. Если будет разное количество, значит где то не правильно посчитали. Регистр с остаками количества имеет все данные, поэтому проводим по новой методике, а 2й регистр по старой, потому что там нужно вычислять себестоимость и партию. Также помимо товаров нужно ввести и услуги. Отображаться они должны вместе с товарами в одной ТЧ. Более подробно описано по ссылке ниже.</li>
        <li><a href="#spec-5">(Спец.)(ОУ) Расчёт себестоимости в целом по складам методом ФИФО, ЛИФО. <span class="фиолетовый">Занятие 6</span>. Билет №1</a></li>
        <li>-------------------------------------------------------------------------</li>

        <li><span class="фиолетовый">Занятие 7</span>. Делаем отчёт для Билет 1. Вначале работа над ошибками по прошлому видео, не всё доделали по услугам. Дла приходной мы для реквизита "Товар" указали параметр выбора, а для расходной так нельзя, потому что нужна возможность выбирать услугу, но при проведении услуга не должна мелькать при записи в регистры. Услуга нужна только для записи в регистр продажи, но его у нас нет. Далее отчёт. Раздвигаем поля группировки по разным колонкам. Переименновываем поля группировки. Делаем заголовок отчёта 2мя способами. Указываем в параметрах для параметра выражение, чтобы дата бралась на конец дня. Ещё разбираемся с датой в заголовке отчёта, а именно, чтобы пользователь открывал отчёт, не задавал никакой даты и выводились самые последние остатки. Отступ слева для заголовка отчёта. Убираем итоги для группировки "Склад". Делаем жирными имена полей группировки через условное оформление. Убираем оформление у ячеек заголовка отчёта, чтобы не видны были грани ячейки. Показывает 2й способ(программный) как задать заголовок отчёта с датой. На экзамене программным способ делать не обязательно, достаточно и первого способа.</li>
        <li><span class="фиолетовый">Занятие 8</span>. Делаем отчёт для Билет 1. Исправление недоделок из предыдущего занятия. Прижимаем влево остатки. Переделываем отображение итогов у группировки "Склад". Рассказывает что можно указывать период по умолчанию на закладке "Параметры" в настройках отчёта. Ещё раз про выражение для параметра, что нужно на конец дня получать остатки и плюс ещё одну секунду нужно прибавить. Но тут возникает новая проблема. Период, который мs поставили по умолчанию имеет тип "СтандартнаяДатаНачала" и у него есть возможность указвать словами дату, например, "Начало этого дня", но мы же только что в выражении параметра привели к концу дня, получается пользователь выбирает начало этого дня, а видит результат на конец дня, решаем эту проблему. Далее разные способы работы с датой для отчёта. В итоге пришли к самому простому решению, его можно посмотреть в отчёте в базе. На последок говорим про процедуру "ПриКомпоновкеРезультата".</li>
        <li><span class="фиолетовый">Занятие 9</span>. Делаем отчёт для Билет 1. Опять вернулись в дате отчёта. Хотим, чтобы при выборе пользователем значения даты - "Начало этого дня", "Начало этой недели" и так далее, выбирались остатки на указанное значение, но если пользователь указал "Произвольная дата" или саму дату в виде "01.12.2025", то приводить эту дату к концу дня. В статье описал это в последнем абзаце. Ничего не описывал, там такой геморой, что Леонтьев сам сказал, что лучше не трогать программный код, на экзамене достаточно простого решения. Т.е. мы даже в вырадении параметра даты не приводим к концу дня, а просто для даты указываем состав даты со временем и пусть пользователь сам выставялет время, если ему хочется получить на конец дня.</li>
        <li><a href="#spec-6">(Спец.)(ОУ) <b>Отчёт</b> "Остатки товаров". Занятие 7/8/9. Билет №1</a></li>
        <li>-------------------------------------------------------------------------</li>

        <li><span class="фиолетовый">Занятие 10</span>. В начале рассказ как убрать в отчёте пустую строку между заголовком отчёта и самой таблицей с данными. Как утверждает, это не важно на экзамене, есть строка между или нет. Далее мы решаем задачу. Нам нужно два регистра накопления с остатками и для учёта проданных товаров и услуг. В регистре продажи вместе с ресурсами Количество и СуммаПродажи, мы добавим и ресурс "Себестоимость", чтобы у нас все данные для отчёта хранились в одном регистре. Леонтьев говорит, что так же сделано и в типовых и это правильно. А то получается из-за одного поля мы бы делали соединение с другой таблицей, чтобы получить себестоимость для отчёта. Конечно у такого подхода есть небольшой минус, у нас появляется 2 поля "Себестоимость" в двух регистрах и данные могут разойтись в процессе работы кода. В одно поле мы запишем одно значение, а в другое может в коде что то высчитываться и записать уже другое значение, поэтому риск такой естьи  за этим нужно следить.</li>
        <li><a href="#spec-7">(Спец.)(ОУ) Контроль остатков в разрезе партии. Занятие 10. Билет №2</a></li>
        <li>-------------------------------------------------------------------------</li>

        <li><span class="фиолетовый">Занятие 11</span>. Продолжаем убирать косяки из прошлого занятия в обработке проведения. Мы в остатки и в продажи записывали из детальных записей, и так как есть партии, то одинаковые товары не схлопывались в регистре продажи. Мы сделали итоги в запросе, чтобы из них брать схлопнутые данные для продаж, а детальные нам нужны для списания по партиям в остатки.</li>
        <li><a href="#spec-8">(Спец.)(ОУ) <b>Отчёт</b> "Продажи товаров". Занятие 10/11. Билет №2</a></li>
        <li>-------------------------------------------------------------------------</li>

        <li><a href="#spec-9">(Спец.) Расчёт себестоимости по средней и ФИФО. Занятие 12. Билет №3(Оперативный учёт)</a></li>
        <li><a href="#spec-10">(Спец.) <b>Отчёт</b>. "ДвижениеТоваровЗаПериод_Билет3". В макете рисуем весь отчёт. Занятие 13. Билет №3(Оперативный учёт)</a>
            <ul class="list-2">
                <li><a href="#spec-10.1">Заголовки полей. Убираем лишние заголовки в поле, когда они друг под другом размещаются</a></li>
            </ul>    
        </li>
        <li><a href="#spec-11">(Спец.) Списание с учётом приоритетов складов. Занятие 14. Билет №4(Оперативный учёт)</a></li>
        <li><a href="#spec-12">(Спец.) <b>Отчёт</b> "ДвижениеТоваровЗаПериод_Билет4". Занятие 14. Билет №4(Оперативный учёт).</a></li>
        <li><a href="#spec-13">(Спец.) Дополнительные затраты. Занятие 15. Билет №15(Оперативный учёт).</a></li>
        <li><a href="#spec-14">(Спец.) <b>Отчёт</b> "Продажи_Билет15". Занятие 15. Билет №15(Оперативный учёт).</a></li>
        <li><a href="#spec-15">(Спец.) Учёт в двух валютах. Занятие 16. Билет №7(Оперативный учёт).</a></li>
        <li><a href="#spec-16">(Спец.) <b>Отчёт</b> "Продажи_Билет7". Занятие 16. Билет №7(Оперативный учёт).</a></li>
        <li><a href="#spec-17">(Спец.) Стелажи и составляющие(комплектующие). Занятие 17. Билет №6(Оперативный учёт).</a></li>
        <li><a href="#spec-18">(Спец.) <b>Отчёт</b> "НаличиеСтеллажей_Билет6". Занятие 17. Билет №6(Оперативный учёт).</a></li>
        <li><a href="#spec-19">(Спец.) Индексирование таблиц. Это не билет, просто область знаний из 1с. Занятие 18.</a></li>
        <li><a href="#spec-20">(Спец.) Продукты, наборы и готовые блюда. Более менее описал устройство ПВХ(<b>план видов характеристик</b>). Занятие 19/20. Билет 10(Оперативный учёт).</a></li>
        <li><a href="#spec-21">(Спец.) <b>Отчёт</b> "ВедомостьПродуктов". Занятие 20. Билет 10(Оперативный учёт).</a></li>
        <li><a href="#spec-22">(Спец.) Новый <b>отчёт</b> "ВедомостьПродуктов" с характеристиками. Занятие 21. Билет 10(Оперативный учёт).</a></li>
        <li><a href="#spec-23">(Спец.) Поступление и отгрузка по заказам покупателя. Занятие 22. Билет 12(Оперативный учёт).</a></li>
        <li><a href="#spec-24">(Спец.) <b>Отчёт</b> "АнализНедоотгруженныхЗаказов_Билет12". Занятие 23. Билет 12(Оперативный учёт).</a></li>
        <li><a href="#spec-25">(Спец.) Учёт сроков годности и использования. Занятие 24. Билет 13(Оперативный учёт)</a></li>
        <li><a href="#spec-26">(Спец.) <b>Отчёт "СостояниеОборудованияВИспользовании_Билет13"</b>. Занятие 24. Билет 13(Оперативный учёт)</a></li>
    </ul>


    <div class="spac-a">
        <p class="title-size16"><b id="spec-a">Методика оперативного проведения и управляемые блокировки. Устное объяснение.</b></p>
        <p><a href="https://курсы-по-1с.рф/articles/2017-02-13-realtimeposting-and-datalock/">Читать тут</a></p>
    </div>


    <div class="spac-b">
        <p class="title-size16"><b id="spec-b">Как вытащить в форму документа в панель навигации гиперссылку на записи регистра, в которые он сделал движения. 2 способа</b></p>
        <p>Первый способ</p>
        <p>Заходим в конфигураторе в форму документа, влево на закладку "Командный интерфейс" и разделе "Перейти" находим нужный регитср и ставим ему видимость.</p>
        <p>Второй способ</p>
        <p>Мы можем в пользовательском режиме открыть форму документа, в правом углу сверху нажимаем на три вертикальные точки -> Окно -> Настройка панели навигации формы. В открывшемся окне слева переносим нужный регистр в право. Всё.</p>
        <p>Есть ещё один способ. Открываем нужный регистр в пользовательском режиме, в нём мы увидим все наборы записей для всех документов. Найдём нужные записи для нашего документа, выделим запись, откроем контекстное меню и выберем пункт "Найти: Регистратор - ....". И платформа сама сделает отбор по выделенному документу.</p>
        <p>Обычно так для документа не делают, чтобы посмотреть его записи в регистре, делают отдельно отчёт по регистру. Поэтому если вдруг пользователю захотелось посмотреть движения, то пусть лучше в пользовательком режиме вытащит гиперссылку на записи и смотрит и не делать такого в конфигураторе. Всё потому, что документ может делать движения по 20 регистрам и если их все вытащить, то они не поместятся в панели навигации, да и запутаться в них можно.</p>
    </div>


    <div class="spec-c">
        <p class="title-size16"><b id="spec-c">Пример кода обработки проведения приходной накладной. Полезно посмотреть.</b></p>
        <p>В коде есть 3 способа свернуть повторяющиеся строки табличной части. Считается что 3й способ самый лучший, из-за того, что РезультатВыборки легче по объёму, чем таблица значений. Вот из сети некоторое объяснение.</p>
        <p>Результат выборки с данными в 1С обычно легче по объёму, чем таблица значений.
        <p>Это связано с тем, что при использовании выборки в случае превышения размера имеющейся памяти данные будут размещены во временных файлах и будут считываться при вызовах метода обхода выборки. В то время как при выгрузке результата запроса в таблицу значений он сразу помещается в оперативную память, что может привести к нехватке памяти при большой выборке данных.</p>
        <p>Однако в сложных алгоритмах таблица значений с возможностью непосредственного доступа к её строкам может оказаться быстрее, если это не приведёт к чрезмерной нагрузке на оперативную память.</p>
        <p>Таким образом, выбор между этими вариантами зависит от конкретной задачи и условий использования 1С.</p>
        <div class="code-style">
            <pre>
                <span class="светло_синий">Процедура ОбработкаПроведения(Отказ, Режим) 
                    <span class="зелёный">////первый способ свернуть повторяющиеся строки в табличной части 
                    //ТЗ = СписокНоменклатуры.Выгрузить(, "Номенклатура, Количество");
                    //ТЗ.Свернуть("Номенклатура", "Количество");
    
                    ////второй способ, можно не обращаться в БД за табличной частью, 
                    ////а сразу получить её из документ объекта, в контексте
                    ////которого мы находимся. Этот способ по сути то же самое, что и
                    ////способ выше, только через запрос
                    //Запрос = Новый Запрос;
                    //Запрос.Текст = 
                    //	"ВЫБРАТЬ
                    //	|	ПриходнаяНакладнаяСписокНоменклатуры.Номенклатура КАК Номенклатура,
                    //	|	ПриходнаяНакладнаяСписокНоменклатуры.Количество КАК Количество
                    //	|ПОМЕСТИТЬ ВТ
                    //	|ИЗ
                    //	|	&СписокНоменклатуры КАК ПриходнаяНакладнаяСписокНоменклатуры
                    //	|;
                    //	|/////////////////////////////////////////////////////////////////
                    //	|ВЫБРАТЬ
                    //	|	ВТ.Номенклатура КАК Номенклатура,
                    //	|	СУММА(ВТ.Количество) КАК Количество
                    //	|ИЗ
                    //	|	ВТ КАК ВТ
                    //	|
                    //	|СГРУППИРОВАТЬ ПО
                    //	|	ВТ.Номенклатура";
    
                    //Запрос.УстановитьПараметр("СписокНоменклатуры", СписокНоменклатуры);
                    //РезультатЗапроса = Запрос.Выполнить();
                    //Выборка = РезультатЗапроса.Выбрать();
                    
    
                    //третий способ свернуть строки с обращением в БД. Этот способ лучше всего</span>
                    Запрос = Новый Запрос;
                    Запрос.Текст = 
                        <span class="серый">"ВЫБРАТЬ
                        |	ПриходнаяНакладнаяСписокНоменклатуры.Номенклатура КАК Номенклатура,
                        |	СУММА(ПриходнаяНакладнаяСписокНоменклатуры.Количество) КАК Количество
                        |ИЗ
                        |	Документ.ПриходнаяНакладная.СписокНоменклатуры КАК ПриходнаяНакладнаяСписокНоменклатуры
                        |ГДЕ
                        |	ПриходнаяНакладнаяСписокНоменклатуры.Ссылка = &Ссылка
                        |
                        |СГРУППИРОВАТЬ ПО
                        |	ПриходнаяНакладнаяСписокНоменклатуры.Номенклатура"</span>;
                    
                    Запрос.УстановитьПараметр(<span class="серый">"Ссылка"</span>, Ссылка);
                    РезультатЗапроса = Запрос.Выполнить();
                    Выборка = РезультатЗапроса.Выбрать();
                        
                    Движения.ОстаткиНоменклатуры.Записывать = Истина;
                    Пока Выборка.Следующий() Цикл
                        Движение = Движения.ОстаткиНоменклатуры.Добавить();
                        Движение.ВидДвижения = ВидДвиженияНакопления.Приход;
                        Движение.Период = Дата;
                        Движение.Номенклатура = Выборка.Номенклатура;
                        Движение.Склад = Склад;   
                        Движение.Количество = Выборка.Количество;		
                    КонецЦикла;
    
                КонецПроцедуры </span>
            </pre>
        </div>
    </div>
    

    <div class="spec-1">
        <p class="title-size16"><b id="spec-1">Контроль остатков. Старая методика от Леонтьева.</b></p>
        <p>Этот способ проведения старого образца, соответствует для использования на экзамене на специалиста, если там требуется старый способ. Старая методика всё равно используется. Когда её можно использовать, а когда новую? Если в документе есть все данные для записи в регистр, то используем новую методику, а если данных не хватает и нужно будет вычислять ещё дополнительно поля, например, себестоимость, чтобы её тоже записать в регистр, то используем старую методику.</p>
        <p><span class="светло_красный">Кстати в статье <a href="https://курсы-по-1с.рф/articles/2017-02-13-realtimeposting-and-datalock/">тут</a>, вычитал, что можно в старой методике чуть ещё позже установить блокировку на записи регистра. Например в коде ниже мы установили блокировку и пошли получать продаваемые товары из табличной части документа, а затем полезли в остатки регистра. Можно сначала во временную таблицу получить продаваемые товары, получить их из временной таблицы, затем уже установить блокировку и потом получать остатки. Т.е. мы как бы убираем время на получение товаров из табличной части, чтобы всё это время пока мы получаем товары из табличной части блокировка была ещё не установлена. Пример такой можно найти в статье ниже "Контроль остатков в разрезе партии. Занятие 10. Билет №2(Оперативный учёт)."</span></p>
        <p>Способ такой же как и у Чистова.</p>
        <p>Нужно выставлять и для реквизитов и табличной части документа и для измерений регистров запрет на ненаполненые значения, иначе снимут баллы на экзамене.</p>
        <p>Также из примера видно, что у нас есть все данные в документе для записи в регистр, а потому можно использовать и новую методику контроля остаков, но мы смотрим как выглядит старая методика. В следующей статье уже будет новая методика.</p>
        <div class="code-style">
            <pre>
                --модуль объекта документа "ПродажаТоваров"
                <span class="светло_синий"><span class="светло_красный">Процедура</span> ОбработкаПроведения<span class="светло_красный">(</span>Отказ<span class="светло_красный">,</span> РежимПроведения<span class="светло_красный">)</span> 
                    <span class="зелёный">//очищаем записи в регистре.
                    //Этот способ флаг Записывать не сбрасывает</span>
                    Движения<span class="светло_красный">.</span>ОстаткиНоменклатуры<span class="светло_красный">.</span>Записать<span class="светло_красный">();</span>
    
                    <span class="зелёный">//Либо так. Флаг истиности записи сбросится в Ложь после записи
                    Движения.ОстаткиНоменклатуры.Записывать = Истина;
                    Движения.Записать();</span>
    
                    <span class="зелёный">//указываем, что по окончании процедуры нужно записать набор записей</span>
                    Движения<span class="светло_красный">.</span>ОстаткиНоменклатуры<span class="светло_красный">.</span>Записывать <span class="светло_красный">=</span> Истина<span class="светло_красный">;</span>
    
                    <span class="зелёный">//Если что, то подробно про блокировку описано в контролях остатков у Камкова
                    //Блокировку нужно ставить как можно позже, чтобы как можно меньше времени мы блокировали записи в регистре
                    //Вот перед запросом на остатки самое место.
                    //Также в файловом способе БД мы не можем блокировать отдельные записи, платформой блокируется вся таблица
                    //и пока первый пользователь проводит документ, другие сидят и ждут пока он не проведёт его.
                    //Что мы тут описали это для клиент-серверного взаимодействия
                    //Также эта блокировка называется управляемой и при запуске может возникнуть ошибка
                    //что нельзя использовать блокировки в управляемом режиме, это потому что по умолчанию
                    //в платформе установлен режим блокировки автоматический. У корня конфигурации в свойствах нужно
                    //поменять на управляемые</span>
                    Блокировка <span class="светло_красный">= Новый</span> БлокировкаДанных<span class="светло_красный">;</span>
    
                    <span class="зелёный">//Объект Блокировка может заблокировать от 1й до нескольких таблиц
                    //или отдельные записи в таблице. Укажем таблицу для блокировки</span>
                    ЭлементБлокировки <span class="светло_красный">=</span> Блокировка<span class="светло_красный">.</span>Добавить<span class="светло_красный">(</span><span class="серый">"РегистрНакопления.ОстаткиНоменклатуры"</span><span class="светло_красный">);</span>
    
                    <span class="зелёный">//Режим "Разделяемый" запрещает остальным пользователям изменять данные в этой же записи,
                    //читать можно, а "Исключительный" запрещает и изменять и даже читать данные из блокируемой записи </span>
                    ЭлементБлокировки<span class="светло_красный">.</span>Режим <span class="светло_красный">=</span> РежимБлокировкиДанных<span class="светло_красный">.</span>Исключительный<span class="светло_красный">;</span> 
    
                    <span class="зелёный">//создадим источник данных для элемента блокировки
                    //это может быть "РезультатЗапроса", "Табличная часть" или "ТаблицаЗначений"
                    //в нашем случае при выгрузке из табличной части вернётся таблица значений</span>
                    ДанныеБлокировки <span class="светло_красный">=</span> СписокНоменклатуры<span class="светло_красный">.</span>Выгрузить<span class="светло_красный">(</span>, <span class="серый">"Номенклатура"</span><span class="светло_красный">);</span>
    
                    <span class="зелёный">//первый способ добавить склад</span>
                    ДанныеБлокировки<span class="светло_красный">.</span>Колонки<span class="светло_красный">.</span>Добавить<span class="светло_красный">(</span><span class="серый">"Склад"</span><span class="светло_красный">);</span>
                    ДанныеБлокировки<span class="светло_красный">.</span>ЗаполнитьЗначения<span class="светло_красный">(</span>Склад<span class="светло_красный">,</span> <span class="серый">"Склад"</span><span class="светло_красный">);</span> 
    
                    <span class="зелёный">//второй способ добавить склад
                    //ЭлементБлокировки.УстановитьЗначение("Склад", Склад);</span>
    
                    ЭлементБлокировки<span class="светло_красный">.</span>ИсточникДанных <span class="светло_красный">=</span> ДанныеБлокировки<span class="светло_красный">;</span> 
                    ЭлементБлокировки<span class="светло_красный">.</span>ИспользоватьИзИсточникаДанных<span class="светло_красный">(</span><span class="серый">"Номенклатура"</span><span class="светло_красный">,</span> <span class="серый">"Номенклатура</span><span class="светло_красный">);</span>	
                    ЭлементБлокировки<span class="светло_красный">.</span>ИспользоватьИзИсточникаДанных<span class="светло_красный">(</span><span class="серый">"Склад"</span><span class="светло_красный">,</span> <span class="серый">"Склад"</span><span class="светло_красный">);</span>
                    Блокировка<span class="светло_красный">.</span>Заблокировать<span class="светло_красный">();</span>             
    
                    <span class="зелёный">//во 2м пакете запроса указана функция ЕСТЬNULL(). Если мы продадим товар, который ещё не поступал на склад
                    //то в остатках будет значение NULL, вот мы и меняем это значение на 0, чтобы не было ошибок</span> 
                    Запрос <span class="светло_красный">= Новый</span> Запрос<span class="светло_красный">;</span>
                    Запрос<span class="светло_красный">.</span>Текст <span class="светло_красный">=</span>
                        <span class="серый">"ВЫБРАТЬ
                            |	РасходнаяНакладнаяСписокНоменклатуры.Номенклатура КАК Номенклатура,
                            |	СУММА(РасходнаяНакладнаяСписокНоменклатуры.НомерСтроки) КАК НомерСтроки,
                            |	СУММА(РасходнаяНакладнаяСписокНоменклатуры.Количество) КАК КоличествоПродажи
                            |ПОМЕСТИТЬ ВТ
                            |ИЗ
                            |	Документ.РасходнаяНакладная.СписокНоменклатуры КАК РасходнаяНакладнаяСписокНоменклатуры
                            |ГДЕ
                            |	РасходнаяНакладнаяСписокНоменклатуры.Ссылка = &Ссылка
                            |
                            |СГРУППИРОВАТЬ ПО
                            |	РасходнаяНакладнаяСписокНоменклатуры.Номенклатура
                            |
                            |ИНДЕКСИРОВАТЬ ПО
                            |	Номенклатура
                            |;
                            |
                            |////////////////////////////////////////////////////////////////////////////////
                            |ВЫБРАТЬ
                            |	ОстаткиНоменклатурыОстатки.КоличествоОстаток КАК КоличествоОстаток,
                            |	ОстаткиНоменклатурыОстатки.Номенклатура КАК Номенклатура
                            |ПОМЕСТИТЬ ВТ2
                            |ИЗ
                            |	РегистрНакопления.ОстаткиНоменклатуры.Остатки(
                            |			&ДатаДокумента,
                            |			Склад = &Склад
                            |				И Номенклатура В
                            |					(ВЫБРАТЬ
                            |						ВТ.Номенклатура КАК Номенклатура
                            |					ИЗ
                            |						ВТ КАК ВТ)) КАК ОстаткиНоменклатурыОстатки
                            |
                            |ИНДЕКСИРОВАТЬ ПО
                            |	Номенклатура
                            |;
                            |
                            |////////////////////////////////////////////////////////////////////////////////
                            |ВЫБРАТЬ
                            |	ВТ.Номенклатура КАК Номенклатура,
                            |	ПРЕДСТАВЛЕНИЕ(ВТ.Номенклатура) КАК НоменклатураП,
                            |	ВТ.НомерСтроки КАК НомерСтроки,
                            |	ВТ.КоличествоПродажи КАК КоличествоПродажи,
                            |	ЕСТЬNULL(ВТ2.КоличествоОстаток, 0) КАК КоличествоОбщ
                            |ИЗ
                            |	ВТ КАК ВТ
                            |		ЛЕВОЕ СОЕДИНЕНИЕ ВТ2 КАК ВТ2
                            |		ПО ВТ.Номенклатура = ВТ2.Номенклатура</span><span class="светло_красный">;</span>
                    
                    Запрос<span class="светло_красный">.</span>УстановитьПараметр<span class="светло_красный">(</span><span class="серый">"Ссылка"</span><span class="светло_красный">,</span> Ссылка<span class="светло_красный">);</span>
                    Запрос<span class="светло_красный">.</span>УстановитьПараметр<span class="светло_красный">(</span><span class="серый">"Склад"</span><span class="светло_красный">,</span> Склад<span class="светло_красный">);</span>
                    <span class="зелёный">//если режим проведения оперативный, то не передаём дату документа  
                    //передадим значение Неопределено, а если передать дату в параметр, ошибки не будет, но системе нужно
                    //потратить время на вычисление даты из момента времени, потом найти по этой дате в таблице остатков
                    //сами остатки, это всё время занимает. Проще ничего не передавать и система сама поймёт, что нужно
                    //вернуть последние остатки и она просто пойдёт и возмёт остатки на 3999 год(т.е. самые последние)
                    //без вычисления всяких дат.
                    //Дату мы обычно передаём при неоперативном режиме, потому что там нам нужны не последние данные вообще, 
                    //а данные на конкретную дату</span>    
                    <span class="светло_красный">Если</span> РежимПроведения<span class="светло_красный">=</span> РежимПроведенияДокумента<span class="светло_красный">.</span>Неоперативный <span class="светло_красный">Тогда</span>
                        Запрос<span class="светло_красный">.</span>УстановитьПараметр<span class="светло_красный">(</span><span class="серый">"ДатаДокумента"</span><span class="светло_красный">,</span> МоментВремени<span class="светло_красный">());</span>
                    <span class="светло_красный">Иначе</span>
                        Запрос<span class="светло_красный">.</span>УстановитьПараметр<span class="светло_красный">(</span><span class="серый">"ДатаДокумента"</span><span class="светло_красный">, Неопределено);	
                    КонецЕсли;</span>
                    РезультатЗапроса <span class="светло_красный">=</span> Запрос<span class="светло_красный">.</span>Выполнить<span class="светло_красный">();</span>
    
                    <span class="зелёный">//Это пишу от себя. А если у нас также 1000 строк в таб. части и не хватает товара где-то на 900м товаре
                    //Получается мы будем гонять код 899 раз и в цикле каждый раз заполнять движения в регистре.
                    //Получается, что мы зря гоняли круги? Тут я предлагаю сделать ещё один цикл,
                    //в котором мы пробежимся до первого нехватающего товара, этого будет достаточно, и запишем Отказ = Истина. 
                    //И уже в след. цикле мы не будем зря заполнять движения, потому что Отказ уже с самого начала будет
                    //в значении Истина. Такой цикл проверяющий не везде подходит, нужно смотреть по обстановке
                    //Пока Выборка.Следующий() Цикл
                    //    Если Выборка.Количество > Выборка.КоличествоОбщ Тогда
                    //        Отказ = Истина;
                    //        Прервать;
                    //    КонецЕсли;
                    //КонецЦикла;</span>
                    
                    Выборка <span class="светло_красный">=</span> РезультатЗапроса<span class="светло_красный">.</span>Выбрать<span class="светло_красный">(); </span>
                    
                    <span class="светло_красный">Пока</span> Выборка<span class="светло_красный">.</span>Следующий<span class="светло_красный">() Цикл</span>
                        <span class="светло_красный">Если</span> Выборка<span class="светло_красный">.</span>КоличествоПродажи <span class="светло_красный">></span> Выборка<span class="светло_красный">.</span>КоличествоОбщ <span class="светло_красный">Тогда</span>
                            СообщениеП <span class="светло_красный">= Новый</span> СообщениеПользователю<span class="светло_красный">;</span>
                            СообщениеП<span class="светло_красный">.</span>Текст <span class="светло_красный">=</span> СтрШаблон<span class="светло_красный">(</span><span class="серый">"Не хвататет товара %1 в количестве %2"</span>,
                                                                Выборка<span class="светло_красный">.</span>НоменклатураП<span class="светло_красный">,</span> 
                                                                Выборка<span class="светло_красный">.</span>КоличествоПродажи <span class="светло_красный">-</span> Выборка<span class="светло_красный">.</span>КоличествоОбщ<span class="светло_красный">);</span>
                            СообщениеП<span class="светло_красный">.</span>Поле <span class="светло_красный">=</span> <span class="серый">"Товары["</span> <span class="светло_красный">+</span> <span class="светло_красный">(</span>Выборка<span class="светло_красный">.</span>НомерСтроки <span class="светло_красный">-</span> 1<span class="светло_красный">)</span> <span class="светло_красный">+</span> <span class="серый">"].Количество"</span><span class="светло_красный">;</span> 
                            СообщениеП<span class="светло_красный">.</span>УстановитьДанные<span class="светло_красный">(</span>ЭтотОбъект<span class="светло_красный">);</span>
                            СообщениеП<span class="светло_красный">.</span>Сообщить<span class="светло_красный">();</span>
    
                            Отказ <span class="светло_красный">=</span> Истина<span class="светло_красный">;</span>
                        <span class="светло_красный">КонецЕсли;</span>
    
                        <span class="зелёный">//Допустим у нас 1000 строк в таб. части и из этой 1000 товаров не хватает только в 
                        //3й строке. Мы зайдём на 3м круге цикла в условие и в Отказ запишем Истина. Пошли след. круги
                        //цикла и на 4м круге, допустим, у нас хватает товаров, но нет смысла гонять код и записывать данные
                        //в набор записей регистра, потому что Отказ уже Истина, значит документ не будет записан. Поэтому
                        //мы просто пропускаем круг, нам нужно теперь просто выдать пользователю все нехватающие товары и всё</span>
                        <span class="светло_красный">Если</span> Отказ <span class="светло_красный">Тогда</span>
                            <span class="светло_красный">Продолжить;
                        КонецЕсли;</span>
    
                        Движение <span class="светло_красный">=</span> Движения<span class="светло_красный">.</span>ОстаткиНоменклатуры<span class="светло_красный">.</span>Добавить<span class="светло_красный">();</span> 
                        Движение<span class="светло_красный">.</span>ВидДвижения <span class="светло_красный">=</span> ВидДвиженияНакопления<span class="светло_красный">.</span>Расход<span class="светло_красный">;</span>
                        Движение<span class="светло_красный">.</span>Период <span class="светло_красный">=</span> Дата<span class="светло_красный">;</span>
                        Движение<span class="светло_красный">.</span>Номенклатура <span class="светло_красный">=</span> Выборка<span class="светло_красный">.</span>Номенклатура<span class="светло_красный">;</span>
                        Движение<span class="светло_красный">.</span>Количество <span class="светло_красный">=</span> Выборка<span class="светло_красный">.</span>КоличествоПродажи<span class="светло_красный">;                      
                    КонецЦикла;
                КонецПроцедуры</span></span>
            </pre>
        </div>
    </div>


    <div class="spec-2">
        <p class="title-size16"><b id="spec-2">Контроль остатков. Новая методика от Леонтьева.</b></p>
        <p>Повторю тут, что новая методика используется тогда, когда достаточно данных в документе для записи в движения.</p>
        <p>В чём старая методика считаетеся менее отлаженой? В том что мы накладываем блокировку на записи таблицы регистра перед запросом, потом идёт запись в движения документа и всё это время блокировка висит и только в конце процедуры она снимается. Это и есть основная причина, почему придумали новую методику. В ней мы идём как бы задом наперёд, сначала идёт процесс записи в движения и только после заполнения наборов записи мы записывем этот набор и накладываем блокировку.</p>
        <p>Несмотря на то, что новая методика лучше, используется она значительно реже, чем старая. Одна из причин это то, что мало бывает случаев, когда есть все данные в документе и ничего вычислять не нужно. Почти всегда нужно вычислять для каких то измерений что-то.</p>
        <div class="code-style">
            <pre>
                --модуль объекта, процедура "ОбработкаПроведения" документа "РасходнаяНакладная"
                <span class="светло_синий"><span class="светло_красный">Процедура</span> ОбработкаПроведения<span class="светло_красный">(</span>Отказ<span class="светло_красный">,</span> РежимПроведения<span class="светло_красный">)</span>
                    <span class="зелёный">//В этом способе контроля остатков мы не будем удалять предыдущие записи
                    //в регистре, потому что мы не используем запрос на остатки до влияния документа на записи, а сразу
                    //записываем набор записей. При перепроведении система сама перезапишет
                    //набор записей, и без разницы с новой датой будут или нет, всё равно перезапишет
    
                    //Итак, сначала записываем товары в регистр остатков товаров, но
                    //для начала нам нужно свернуть повторяющиеся товары из табличной части.
                    //Можно свернуть двумя способами:</span>
                    
                    <span class="зелёный">////Это первый способ как получить и свернуть одинаковые товары
                    ////В первом параметре указываем колонки для свёртывания, во втором 
                    ////параметре колонки для суммирования. Колонки которые мы не указали
                    ////не войдут в новую свёрнутую таблицу.
                    //ТЗ = Товары.Выгрузить();
                    //ТЗ.Свернуть("Товар", "Количество"); 
    
    
                    //Это второй способ получить и свернуть товары, через запрос 
                    //Советуют второй способ. Почему так, можно почитать в статье выше 
                    //"Пример кода обработки проведения приходной накладной"
                    //Кстати!!! Вот так можно посмотреть что лежит во временной таблице
                    //Запрос.МенеджерВременныхТаблиц.Таблицы[0].ПолучитьДанные().Выгрузить();</span>
                    Запрос <span class="светло_красный">= Новый</span> Запрос<span class="светло_красный">;</span>  
                    МенеджерВТ <span class="светло_красный">= Новый</span> МенеджерВременныхТаблиц<span class="светло_красный">;</span>
                    Запрос<span class="светло_красный">.</span>МенеджерВременныхТаблиц <span class="светло_красный">=</span> МенеджерВТ<span class="светло_красный">;</span>
                    Запрос<span class="светло_красный">.</span>Текст <span class="светло_красный">=</span> <span class="серый">"
                        |ВЫБРАТЬ 
                        |	РасходнаяНакладнаяСписокНоменклатуры.Номенклатура КАК Номенклатура,
                        |	СУММА(РасходнаяНакладнаяСписокНоменклатуры.Количество) КАК Количество
                        |ПОМЕСТИТЬ ВТ
                        |ИЗ
                        |	Документ.РасходнаяНакладная.СписокНоменклатуры КАК РасходнаяНакладнаяСписокНоменклатуры
                        |ГДЕ
                        |	РасходнаяНакладнаяСписокНоменклатуры.Ссылка = &Ссылка
                        |
                        |СГРУППИРОВАТЬ ПО
                        |	РасходнаяНакладнаяСписокНоменклатуры.Номенклатура
                        |
                        |ИНДЕКСИРОВАТЬ ПО
                        |   Номенклатура
                        |;
                        |
                        |////////////////////////////////////////////////////////////////////////////////
                        |ВЫБРАТЬ
                        |	ВТ.Номенклатура КАК Номенклатура,
                        |	ВТ.Количество КАК Количество
                        |ИЗ
                        |	ВТ КАК ВТ"</span><span class="светло_красный">;</span>
    
                    Запрос<span class="светло_красный">.</span>УстановитьПараметр<span class="светло_красный">(</span><span class="серый">"Ссылка"</span><span class="светло_красный">,</span> Ссылка<span class="светло_красный">);</span>
                    РезультатЗапроса <span class="светло_красный">=</span> Запрос<span class="светло_красный">.</span>Выполнить<span class="светло_красный">();</span>
                    Выборка <span class="светло_красный">=</span> РезультатЗапроса<span class="светло_красный">.</span>Выбрать<span class="светло_красный">();</span>
    
                    <span class="зелёный">//После того как мы получили либо таблицу значений, 
                    //либо выборку со свёртнутыми товарами, мы записываем эти товары в регистр</span>
    
                    Движения<span class="светло_красный">.</span>ОстаткиНоменклатуры<span class="светло_красный">.</span>Записывать <span class="светло_красный">=</span> Истина<span class="светло_красный">;</span> 
                    <span class="светло_красный">Пока</span> Выборка<span class="светло_красный">.</span>Следующий<span class="светло_красный">() Цикл</span> 
                        <span class="зелёный">// регистр ОстаткиНоменклатуры Расход</span>
                        Движение <span class="светло_красный">=</span> Движения<span class="светло_красный">.</span>ОстаткиНоменклатуры<span class="светло_красный">.</span>Добавить<span class="светло_красный">();</span>
                        Движение<span class="светло_красный">.</span>ВидДвижения <span class="светло_красный">=</span> ВидДвиженияНакопления<span class="светло_красный">.</span>Расход<span class="светло_красный">;</span>
                        Движение<span class="светло_красный">.</span>Период <span class="светло_красный">=</span> Дата<span class="светло_красный">;</span>
                        Движение<span class="светло_красный">.</span>Склад <span class="светло_красный">=</span> Склад<span class="светло_красный">;</span>
                        Движение<span class="светло_красный">.</span>Номенклатура <span class="светло_красный">=</span> Выборка<span class="светло_красный">.</span>Товар<span class="светло_красный">;</span>
                        Движение<span class="светло_красный">.</span>Количество <span class="светло_красный">=</span> Выборка<span class="светло_красный">.</span>Количество<span class="светло_красный">; 
                    КонецЦикла;</span>
                    
                    <span class="зелёный">//Свойство «БлокироватьДляИзменения» отключает разделение итогов для предотвращения взаимоблокировки.
                    //Это свойство не имеет отношения к управляемой блокировке.</span>
                    Движения<span class="светло_красный">.</span>ОстаткиНоменклатуры<span class="светло_красный">.</span>БлокироватьДляИзменения <span class="светло_красный">=</span> Истина<span class="светло_красный">;</span>
                    
                    <span class="зелёный">//Когда мы указываем вот так записать, то происходит запись наборов записей во
                    //все регистры подчинённые данному документу. И запись произойдёт только
                    //если для этих наборов установлен флаг Записывать в Истина
                    //Например, для такой строки - Движения.ОстаткиНоменклатуры.Записать() флаг можно в истину не ставить 
                    //После записи флаг опять у всех регистров сбрасывается в Ложь
                    //При этом методе система сама произведёт управляемую блокировку записей</span>      
                    Движения<span class="светло_красный">.</span>Записать<span class="светло_красный">();</span>
                    
                    <span class="зелёный">//выше мы записали сразу в регистр количество товаров, которые хотим продать
                    //и теперь в запросе получаем из него остатки, которые ушли в минус
                    //если такие есть, то документ не проводим
                    //Вместо вложенного запроса можно указать параметр, но тогда нам нужно в параметр
                    //поместить массив с ссылками на товары из табличной части текущего документа, это можно сделать 
                    //выгрузив из табличной части колонку, вот так:
                    //МассивТоваров = СписокНоменклатуры.ВыгрузитьКолонку("Номенклатура");
                    //Запрос.УстановитьПараметр("МассивТоваров", МассивТоваров); Но такой подход менее отлажен</span>
                    Запрос <span class="светло_красный">= Новый</span> Запрос<span class="светло_красный">;</span>  
                    Запрос<span class="светло_красный">.</span>МенеджерВременныхТаблиц <span class="светло_красный">=</span> МенеджерВТ<span class="светло_красный">;</span>
                    Запрос<span class="светло_красный">.</span>Текст <span class="светло_красный">=</span> 
                        <span class="серый">"ВЫБРАТЬ	
                        |	ПРЕДСТАВЛЕНИЕ(ОстаткиНоменклатурыОстатки.Номенклатура) КАК НоменклатураП,
                        |	ОстаткиНоменклатурыОстатки.КоличествоОстаток КАК КоличествоОстаток
                        |ИЗ
                        |	РегистрНакопления.ОстаткиНоменклатуры.Остатки(
                        |			&ДатаДокумента,
                        |			Склад = &Склад И 
                        |			Номенклатура В
                        |				(ВЫБРАТЬ
                        |					ВТ.Номенклатура КАК Номенклатура
                        |				ИЗ
                        |					ВТ КАК ВТ)) КАК ОстаткиНоменклатурыОстатки 
                        |ГДЕ
                        |	ОстаткиНоменклатурыОстатки.КоличествоОстаток &lt; 0"</span><span class="светло_красный">;</span>
                    
                    Граница <span class="светло_красный">= Новый</span> Граница<span class="светло_красный">(</span>МоментВремени<span class="светло_красный">(),</span> ВидГраницы<span class="светло_красный">.</span>Включая<span class="светло_красный">);</span>
                    <span class="зелёный">//если режим проведения оперативный, то не передаём дату документа  
                    //передадим значение Неопределено, а если передать дату в параметр, ошибки не будет, но системе нужно
                    //потратить время на вычисление даты из момента времени, потом найти по этой дате в таблице остатков
                    //сами остатки, это всё время занимает. Проще ничего не передавать и система сама поймёт, что нужно
                    //вернуть последние остатки и она просто пойдёт и возмёт остатки на 3999 год(т.е. самые последние)
                    //без вычисления всяких дат.
                    //Дату мы обычно передаём при неоперативном режиме, потому что там нам нужны не последние данные вообще, 
                    //а данные на конкретную дату </span>   
                    <span class="светло_красный">Если</span> РежимПроведения <span class="светло_красный">=</span> РежимПроведенияДокумента<span class="светло_красный">.</span>Неоперативный <span class="светло_красный">Тогда</span>
                        Запрос<span class="светло_красный">.</span>УстановитьПараметр<span class="светло_красный">(</span><span class="серый">"ДатаДокумента"</span><span class="светло_красный">,</span> Граница<span class="светло_красный">);</span>
                    <span class="светло_красный">Иначе</span>
                        Запрос<span class="светло_красный">.</span>УстановитьПараметр<span class="светло_красный">(</span><span class="серый">"ДатаДокумента"</span><span class="светло_красный">, Неопределено);
                    КонецЕсли;</span>	
                    Запрос<span class="светло_красный">.</span>УстановитьПараметр<span class="светло_красный">(</span><span class="серый">"Склад"</span><span class="светло_красный">,</span> Склад<span class="светло_красный">);</span>
                    РезультатЗапроса <span class="светло_красный">=</span> Запрос<span class="светло_красный">.</span>Выполнить<span class="светло_красный">();</span>
                    
                    <span class="светло_красный">Если НЕ</span> РезультатЗапроса<span class="светло_красный">.</span>Пустой<span class="светло_красный">() Тогда</span>
                        Выборка <span class="светло_красный">=</span> РезультатЗапроса<span class="светло_красный">.</span>Выбрать<span class="светло_красный">();</span>
    
                        Отказ <span class="светло_красный">=</span> Истина<span class="светло_красный">;</span>
                    
                        <span class="светло_красный">Пока</span> Выборка<span class="светло_красный">.</span>Следующий<span class="светло_красный">() Цикл</span>
                            СообщениеП <span class="светло_красный">= Новый</span> СообщениеПользователю<span class="светло_красный">;</span>
                            СообщениеП<span class="светло_красный">.</span>Текст <span class="светло_красный">=</span> <span class="серый">"Не хватает товара "</span> <span class="светло_красный">+</span> Выборка.НоменклатураП <span class="светло_красный">+</span> <span class="серый">" в количестве "</span> <span class="светло_красный">+ (-</span>Выборка<span class="светло_красный">.</span>КоличествоОстаток<span class="светло_красный">);</span>
                            СообщениеП<span class="светло_красный">.</span>Сообщить<span class="светло_красный">();
                        КонецЦикла;</span>
                    КонецЕсли;
                КонецПроцедуры</span></span>
            </pre>
        </div>
    </div>


    <div class="spec-3">
        <p class="title-size16"><b id="spec-3">Расчёт себестоимости по средней.</b></p>
        <p>У нас уже был регистр "ОстаткиНоменклатуры" с двумя измерениями - "Номенклатура" и "Склад", а также одним ресурсом "Количество". Теперь добавим ещё один ресурс "Себестоимость". Для измерения себестоимости нужно обязательно указать 2 знака после запятой, потому что в неё будет рассчитываться число делением и будут дроби. Говорит, будет ошибкой если не указать. Свойство "Неотрицательное" не ставим, потому что система тихо преврати наше минусовое число в 0 и слова не скажет, а у нас будут проблемы.</p>
        <div class="code-style">
            <pre>
                --модуль объекта "ПриходнаяНакладная"
    
                <span class="светло_синий">Процедура ОбработкаПроведения(Отказ, Режим)  
                    Запрос = Новый Запрос;
                    Запрос.Текст = 
                        <span class="серый">"ВЫБРАТЬ
                        |	ПриходнаяНакладнаяСписокНоменклатуры.Номенклатура КАК Номенклатура,
                        |	СУММА(ПриходнаяНакладнаяСписокНоменклатуры.Количество) КАК Количество
                        |ИЗ
                        |	Документ.ПриходнаяНакладная.СписокНоменклатуры КАК ПриходнаяНакладнаяСписокНоменклатуры
                        |ГДЕ
                        |	ПриходнаяНакладнаяСписокНоменклатуры.Ссылка = &Ссылка
                        |
                        |СГРУППИРОВАТЬ ПО
                        |	ПриходнаяНакладнаяСписокНоменклатуры.Номенклатура"</span>;
                    
                    Запрос.УстановитьПараметр(<span class="серый">"Ссылка"</span>, Ссылка);
                    РезультатЗапроса = Запрос.Выполнить();
                    Выборка = РезультатЗапроса.Выбрать();
                        
                    Движения.ОстаткиНоменклатуры.Записывать = Истина;
                    Пока Выборка.Следующий() Цикл
                        Движение = Движения.ОстаткиНоменклатуры.Добавить();
                        Движение.ВидДвижения = ВидДвиженияНакопления.Приход;
                        Движение.Период = Дата;
                        Движение.Номенклатура = Выборка.Номенклатура;
                        Движение.Склад = Склад;
                        Движение.Количество = Выборка.Количество;	
                        <span class="светло_красный">Движение.Себестоимость = Выборка.Сумма;</span>	
                    КонецЦикла;
    
                КонецПроцедуры</span>
            </pre>
        </div>
        <p>А вот какую методику мы будем использовать в расходной накладной? Старую или новую? Допустим будем использовать новую, как мы помним мы сначала записываем данные в регистр остатков, а значит нужно заполнить ресурс "Себестоимость". Чтобы его заполнить нужно выполнить перед записью в регистр запрос к остаткам номенклатуры и получить данные количества и суммы товаров, значит нужно также заблокировать эту таблицу, чтобы ничего там не дописали одновременно. Это уже не совсем то, что нужно делать в новой методике. Поэтому используем старую методику.</p>
        <p>Можно конечно и новую притулить, но только если количество и себестоимость будут по разным регистрам записываться.</p>
        <div class="code-style">
            <pre>
                --модуль объекта "РасходнаяНакладная"
    
                <span class="светло_синий">Процедура ОбработкаПроведения(Отказ, РежимПроведения) 
                    <span class="зелёный">//напоминаю, что мы очищаем записи регистра данного документа только при старом способе
                    //получения остатков перед получением этих остатков</span>
                    Движения.ОстаткиНоменклатуры.Записать();
    
                    Блокировка = Новый БлокировкаДанных;
                    ЭлементБлокировки = Блокировка.Добавить(<span class="серый">"РегистрНакопления.ОстаткиНоменклатуры"</span>);
                    ЭлементБлокировки.Режим = РежимБлокировкиДанных.Исключительный; 
                    ДанныеБлокировки = СписокНоменклатуры.Выгрузить(, <span class="серый">"Номенклатура"</span>);
                    ДанныеБлокировки.Колонки.Добавить(<span class="серый">"Склад"</span>);
                    ДанныеБлокировки.ЗаполнитьЗначения(Склад, <span class="серый">"Склад"</span>); 
                    ЭлементБлокировки.ИспользоватьИзИсточникаДанных(<span class="серый">"Номенклатура"</span>, <span class="серый">"Номенклатура"</span>);	
                    ЭлементБлокировки.ИспользоватьИзИсточникаДанных(<span class="серый">"Склад"</span>, <span class="серый">"Склад"</span>);
                    ЭлементБлокировки.ИсточникДанных = ДанныеБлокировки; 
                    Блокировка.Заблокировать();             
    
    
                    Запрос = Новый Запрос;
                    Запрос.Текст =
                        <span class="серый">"ВЫБРАТЬ
                        |	РасходнаяНакладнаяСписокНоменклатуры.Номенклатура КАК Номенклатура,
                        |	СУММА(РасходнаяНакладнаяСписокНоменклатуры.НомерСтроки) КАК НомерСтроки,
                        |	СУММА(РасходнаяНакладнаяСписокНоменклатуры.Количество) КАК КоличествоПродажи
                        |ПОМЕСТИТЬ ВТ
                        |ИЗ
                        |	Документ.РасходнаяНакладная.СписокНоменклатуры КАК РасходнаяНакладнаяСписокНоменклатуры
                        |ГДЕ
                        |	РасходнаяНакладнаяСписокНоменклатуры.Ссылка = &Ссылка
                        |
                        |СГРУППИРОВАТЬ ПО
                        |	РасходнаяНакладнаяСписокНоменклатуры.Номенклатура
                        |
                        |ИНДЕКСИРОВАТЬ ПО
                        |	Номенклатура
                        |;
                        |
                        |////////////////////////////////////////////////////////////////////////////////
                        |ВЫБРАТЬ
                        |	ВТ.Номенклатура КАК Номенклатура,
                        |	ПРЕДСТАВЛЕНИЕ(ВТ.Номенклатура) КАК НоменклатураП,
                        |	ВТ.НомерСтроки КАК НомерСтроки,
                        |	ВТ.КоличествоПродажи КАК Количество,
                        |	ЕСТЬNULL(ОстаткиНоменклатурыОстатки.КоличествоОстаток, 0) КАК КоличествоОбщ,
                        |	<span class="светло_красный">ЕСТЬNULL(ОстаткиНоменклатурыОстатки.СебестоимостьОстаток, 0) КАК СебестоимостьОбщ</span>
                        |ИЗ
                        |	ВТ КАК ВТ
                        |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ОстаткиНоменклатуры.Остатки(
                        |				&ДатаДокумента,
                        |				Склад = &Склад
                        |					И Номенклатура В
                        |						(ВЫБРАТЬ
                        |							ВТ.Номенклатура
                        |						ИЗ
                        |							ВТ КАК ВТ)) КАК ОстаткиНоменклатурыОстатки
                        |		ПО ВТ.Номенклатура = ОстаткиНоменклатурыОстатки.Номенклатура"</span>;
                    
                    Запрос.УстановитьПараметр("Ссылка", Ссылка);
                    <span class="зелёный">//если режим проведения оперативный, то не передаём дату документа  
                    //передадим значение Неопределено, а если передать дату в параметр, ошибки не будет, но системе нужно
                    //потратить время на вычисление даты из момента времени, потом найти по этой дате в таблице остатков
                    //сами остатки, это всё время занимает. Проще ничего не передавать и система сама поймёт, что нужно
                    //вернуть последние остатки и она просто пойдёт и возмёт остатки на 3999 год(т.е. самые последние)
                    //без вычисления всяких дат.
                    //Дату мы обычно передаём при неоперативном режиме, потому что там нам нужны не последние данные вообще, 
                    //а данные на конкретную дату</span>    
                    Если РежимПроведения = РежимПроведенияДокумента.Неоперативный Тогда
                        Запрос.УстановитьПараметр(<span class="серый">"ДатаДокумента"</span>, МоментВремени());
                    Иначе
                        Запрос.УстановитьПараметр(<span class="серый">"ДатаДокумента"</span>, Неопределено);	
                    КонецЕсли;
                    Запрос.УстановитьПараметр(<span class="серый">"Склад"</span>, Склад);
                    РезультатЗапроса = Запрос.Выполнить();
                    
                    Если НЕ РезультатЗапроса.Пустой() Тогда
                        Выборка = РезультатЗапроса.Выбрать(); 
    
                        Движения.ОстаткиНоменклатуры.Записывать = Истина;
                        
                        Пока Выборка.Следующий() Цикл
                            Если Выборка.Количество > Выборка.КоличествоОбщ Тогда
                                СообщениеП = Новый СообщениеПользователю;
                                СообщениеП.Текст = СтрШаблон(<span class="серый">"Не хватает товара %1 в количестве %2 в строке с номером %3"</span>,
                                                            Выборка.НоменклатураП,
                                                            Выборка.Количество - Выборка.КоличествоОбщ,
                                                            Выборка.НомерСтроки);
                                СообщениеП.Поле = <span class="серый">"Товары["</span> + (Выборка.НомерСтроки - 1) + <span class="серый">"].Количество"</span>; 
                                СообщениеП.УстановитьДанные(ЭтотОбъект);
                                СообщениеП.Сообщить();
    
                                Отказ = Истина;
                            КонецЕсли;
    
                            Если Отказ Тогда
                                Продолжить;
                            КонецЕсли;
    
                            <span class="зелёный">////1й способ - неправильный, тут буд тостатки дробей
                            //Себестоимость = Выборка.СебестоимостьОбщ / Выборка.КоличествоОбщ * Выборка.Количество;
    
                            ////2й способ - приемлемый, тут уже не будет остатков дробей
                            //Себестоимость = Выборка.Количество / Выборка.КоличествоОбщ * Выборка.СебестоимостьОбщ;
                            //или так
                            Себестоимость = Выборка.СебестоимостьОбщ * Выборка.Количество / Выборка.КоличествоОбщ;</span>
    
                            <span class="зелёный">////3й способ - оптимальный. Называется способ - "условие последнего списания"
                            ////Если мы списываем весь остаток товара, то себестоимость не рассчитываем вообще</span>
                            Если Выборка.Количество = Выборка.КоличествоОбщ Тогда
                                Себестоимость = Выборка.СебестоимостьОбщ;
                            Иначе
                                <span class="зелёный">//вот этот 1й способ обрамлённый условием становится правильным</span>	
                                Себестоимость = Выборка.СебестоимостьОбщ / Выборка.КоличествоОбщ * Выборка.Количество;
                            КонецЕсли;
    
    
                            <span class="зелёный">////4й способ - сверхнадёжный.
                            //Если Выборка.Количество = Выборка.КоличествоОбщ Тогда
                            //	Себестоимость = Выборка.СебестоимостьОбщ;
                            //Иначе
                            //	//теперь тут 2 способ	
                            //    Себестоимость = Выборка.СебестоимостьОбщ * Выборка.Количество / Выборка.КоличествоОбщ;
                            //КонецЕсли;
    
                            //По итогу для вычисления себестоимости используем либо 2й, либо 3й способ, либо 4й 
                            //Если списание идёт по средней, то подойдёт 2й способ, но если списание по ФИФО или ЛИФО,
                            //то надо использовать 3й или 4й
                            //Но на экзамене по спецу желательно использовать 3й способ даже при списании
                            //себестоимости по средней, чтобы показать учителю что мы знаем о способе "условие последнего списания"</span>
    
                            Движение = Движения.ОстаткиНоменклатуры.Добавить(); 
                            Движение.ВидДвижения = ВидДвиженияНакопления.Расход;
                            Движение.Период = Дата;
                            Движение.Номенклатура = Выборка.Номенклатура;
                            Движение.Склад = Склад;
                            Движение.Количество = Выборка.Количество; 
                            <span class="светло_красный">Движение.Себестоимость = Себестоимость;</span>                     
                        КонецЦикла;
                    КонецЕсли; 
                КонецПроцедуры</span>
            </pre>
        </div>
    </div>


    <div class="spec-4">
        <p class="title-size16"><b id="spec-4">Расчёт себестоимости по ФИФО и ЛИФО по каждому складу.</b></p>
        <p>Тут мы будем высчитывать себестоимость товара с каждого склада отдельно. Т.е. если у нас лежит на одном складе 15 ложек и на втором складе 5 ложек, то при проводке мы хотим продать 16 ложек, мы смотрим на первом складе, что их не хватает(там всего 15) и значит отказываемся от проводки.</p>
        <p>У нас в каркасной конфигурации, поставляемой для экзамена есть перечисление "УчетнаяПолитика", которая содержит два значения "ФИФО" и "ЛИФО". Система нам уже предоставляет справочную информацию о методах списания товаров. Теперь нужно выполнить опредение учётной политики с помощью регистра сведений и с помощью документа.</p>
        <p>Что это значит? Для нашего предприятия нужно место, где мы будем указывать, какая методика списания сейчас действует, по которой и будут проводится документы. Первое место это регистр сведений. Создадим новый регистр сведений "УчетнаяПолитика" переодический в пределах года, независимый. Т.е. мы раз в год ручками выбираем на текущий год какая методика списания будет действовать. В регистре будет всего один ресурс без измерений - "МетодСписанияСебестоимости" с типом данных "Перечисление.УчетнаяПолитика". Всё, это первый способ, когда мы руками выставляем в регистре метод списания.</p>
        <p>Во втором способе мы назначаем методику списания с помощью документа, который будет устанавливать в регистре новое значение. То мы руками указывали в регистре новое значение, а теперь через документ. Итак нужно создать новый объект конфигурации типа Документ с именем "НазначениеУчетнойПолитики". Добавляем документу единственный реквизит "МетодСписанияСебестоимости" с типом данных "Перечисление.УчетнаяПолитика". И для ресурса регистра и для реквизита документа ставим проверку ошибки - "Выдавать ошибку", нам нужно обязательно заполнять эти поля, иначе нет смысла в этих механизмах.</p>
        <p>Теперь подчиним бывший независимый регистратор "УчетнаяПолитика" этому документу, чтобы мы через документ через проводку записывали в регистр метод списания. Укажем либо в конструкторе движений, либо сами код напишем, где мы в ресурс регисра в обработке проведения будем записывать значение из реквизита документа. Запустим пользовательский режим и попробуем провести первое значение, например, "ФИФО". Всё, в регистре появилась запись на начало года, что метод списания на ближайший год это "ФИФО".</p>
        <p>Ещё можно сделать, чтобы дата в документе была тоже установлена на начало года. Сделаем это в обработке модуля объекта "ПередЗаписью". В обработке дату документа сбросим на начало года.</p>
        <p>Итак, далее нам нужно добавить новое измерение в регистр накопления "ОстаткиНоменклатуры". Назовём его "Партия" с типом данных "ДокументСсылка.ПриходнаяНакладная". Галочку запрета не заполненного значения для этого измерения ставить не будем, потому что могут возникнуть случаи, когда это измерение может быть пустым.</p>
        <p>Доработаем немного обработку проведения документа приходной накладной, нужно добавить измерение "Партия" и заполнить его ссылкой:</p>
        <div class="code-style">
            <pre>
                --модуль объекта "ПриходнаяНакладная" процедура "ОбработкаПроведения"
    
                ...
                Движение.Партия = Ссылка;
                ...
            </pre>
        </div>
        <p>Далее нужно определиться какую методику проведения документа мы будем использовать. У нас есть 2 измерения в регистре, данных для которых у нас нет в расходной накладной и их нужно получать из остатков, а значить устанавливать управляему блокировку. С установкой блокировки раньше времени мы теряем преимущества новой методики, а значит будем использовать старую.</p>
        <div class="code-style">
            <pre>
                --модуль объекта документа "РасходнаяНакладная"
    
                <span class="светло_синий"><span class="светло_красный">Процедура</span> ОбработкаПроведения<span class="светло_красный">(</span>Отказ<span class="светло_красный">,</span> РежимПроведения<span class="светло_красный">)</span> 
                    Движения<span class="светло_красный">.</span>ОстаткиНоменклатуры<span class="светло_красный">.</span>Записать<span class="светло_красный">();</span>
    
                    Движения<span class="светло_красный">.</span>ОстаткиТоваров<span class="светло_красный">.</span>Записывать <span class="светло_красный">=</span> Истина<span class="светло_красный">;</span>
                    
                    <span class="зелёный">//У нас есть в системе документ, который меняет метод списания себестоимости
                    //и записывает этот метод в регистр сведений.
                    //Здесь нам при проведении расходного документа нужно получить этот метод
                    //списания из регистра сведений "УчетнаяПолитика" и по полученному
                    //методу будем упорядочивать партии в остатках
                    //НАЧАЛО</span>
                    Запрос <span class="светло_красный">= Новый</span> Запрос<span class="светло_красный">;</span>
                    Запрос<span class="светло_красный">.</span>Текст <span class="светло_красный">=</span> 
                        <span class="серый">"ВЫБРАТЬ
                        |	УчетнаяПолитикаСрезПоследних.МетодСписанияСебестоимости КАК МетодСписанияСебестоимости
                        |ИЗ
                        |	РегистрСведений.УчетнаяПолитика.СрезПоследних(&Период, ) КАК УчетнаяПолитикаСрезПоследних</span>"<span class="светло_красный">;</span>
                    
                    Запрос<span class="светло_красный">.</span>УстановитьПараметр<span class="светло_красный">(</span><span class="серый">"Период"</span><span class="светло_красный">,</span> Дата<span class="светло_красный">);</span>
                    РезультатЗапроса <span class="светло_красный">=</span> Запрос<span class="светло_красный">.</span>Выполнить<span class="светло_красный">();</span> 
                    
                    <span class="светло_красный">Если</span> РезультатЗапроса<span class="светло_красный">.</span>Пустой<span class="светло_красный">() Тогда</span>
                        Сообщение <span class="светло_красный">= Новый</span> СообщениеПользователю<span class="светло_красный">;</span>
                        Сообщение<span class="светло_красный">.</span>Текст <span class="светло_красный">=</span> <span class="серый">"Не указан метод списания"</span><span class="светло_красный">;</span>
                        Сообщение<span class="светло_красный">.</span>Сообщить<span class="светло_красный">();</span>
                        
                        Отказ <span class="светло_красный">=</span> Истина<span class="светло_красный">;
                        Возврат;
                    Иначе</span>
                        ВыборкаМетода <span class="светло_красный">=</span> РезультатЗапроса<span class="светло_красный">.</span>Выбрать<span class="светло_красный">();</span>
                        ВыборкаМетода<span class="светло_красный">.</span>Следующий<span class="светло_красный">();</span>
                        <span class="светло_красный">Если</span> ВыборкаМетода<span class="светло_красный">.</span>МетодСписанияСебестоимости <span class="светло_красный">=</span> Перечисления<span class="светло_красный">.</span>УчетнаяПолитика<span class="светло_красный">.</span>ФИФО <span class="светло_красный">Тогда</span>
                            ПараметрСписания <span class="светло_красный">=</span> <span class="серый">"ВОЗР"</span><span class="светло_красный">;
                        Иначе</span>	
                            ПараметрСписания <span class="светло_красный">=</span> <span class="серый">"УБЫВ"</span><span class="светло_красный">;
                        КонецЕсли;
                    КонецЕсли;</span> 
                    <span class="зелёный">//КОНЕЦ</span>
    
    
                    <span class="зелёный">//партии мы не будем блокировать, потому что нам не известны документы поступления, которые нужно
                    //заблокировать. Товар и склад известны, вот их и блокируем.</span>
                    Блокировка <span class="светло_красный">= Новый</span> БлокировкаДанных<span class="светло_красный">;</span>
                    ЭлементБлокировки <span class="светло_красный">=</span> Блокировка<span class="светло_красный">.</span>Добавить<span class="светло_красный">(</span><span class="серый">"РегистрНакопления.ОстаткиНоменклатуры"</span><span class="светло_красный">);</span>
                    ЭлементБлокировки<span class="светло_красный">.</span>Режим <span class="светло_красный">=</span> РежимБлокировкиДанных<span class="светло_красный">.</span>Исключительный<span class="светло_красный">;</span> 
    
                    ДанныеБлокировки <span class="светло_красный">=</span> СписокНоменклатуры<span class="светло_красный">.</span>Выгрузить<span class="светло_красный">(</span>, <span class="серый">"Номенклатура"</span><span class="светло_красный">);</span>
    
                    ЭлементБлокировки<span class="светло_красный">.</span>УстановитьЗначение<span class="светло_красный">(</span><span class="серый">"Склад"</span><span class="светло_красный">,</span> Склад<span class="светло_красный">);</span>
                    ЭлементБлокировки<span class="светло_красный">.</span>ИсточникДанных <span class="светло_красный">=</span> ДанныеБлокировки<span class="светло_красный">;</span> 
                    ЭлементБлокировки<span class="светло_красный">.</span>ИспользоватьИзИсточникаДанных<span class="светло_красный">(</span><span class="серый">"Номенклатура"</span><span class="светло_красный">,</span> <span class="серый">"Номенклатура</span><span class="светло_красный">);</span>	
                    ЭлементБлокировки<span class="светло_красный">.</span>ИспользоватьИзИсточникаДанных<span class="светло_красный">(</span><span class="серый">"Склад"</span><span class="светло_красный">,</span> <span class="серый">"Склад"</span><span class="светло_красный">);</span>
                    Блокировка<span class="светло_красный">.</span>Заблокировать<span class="светло_красный">();</span>             
    
    
                    Запрос <span class="светло_красный">= Новый</span> Запрос<span class="светло_красный">;</span>
                    Запрос<span class="светло_красный">.</span>Текст <span class="светло_красный">=</span>
                        <span class="серый">"ВЫБРАТЬ
                        |	РасходнаяНакладнаяСписокНоменклатуры.Номенклатура КАК Номенклатура,
                        |	СУММА(РасходнаяНакладнаяСписокНоменклатуры.НомерСтроки) КАК НомерСтроки,
                        |	СУММА(РасходнаяНакладнаяСписокНоменклатуры.Количество) КАК КоличествоПродажи
                        |ПОМЕСТИТЬ ВТ
                        |ИЗ
                        |	Документ.РасходнаяНакладная.СписокНоменклатуры КАК РасходнаяНакладнаяСписокНоменклатуры
                        |ГДЕ
                        |	РасходнаяНакладнаяСписокНоменклатуры.Ссылка = &Ссылка
                        |
                        |СГРУППИРОВАТЬ ПО
                        |	РасходнаяНакладнаяСписокНоменклатуры.Номенклатура
                        |
                        |ИНДЕКСИРОВАТЬ ПО
                        |	Номенклатура
                        |;
                        |
                        |////////////////////////////////////////////////////////////////////////////////
                        |ВЫБРАТЬ
                        |	ВТ.Номенклатура КАК Номенклатура,
                        |	ВТ.НомерСтроки КАК НомерСтроки,
                        |	ВТ.КоличествоПродажи КАК Количество,
                        |	ОстаткиНоменклатурыОстатки.Партия КАК Партия,
                        |	ЕСТЬNULL(ОстаткиНоменклатурыОстатки.КоличествоОстаток, 0) КАК КоличествоОбщ,
                        |	ЕСТЬNULL(ОстаткиНоменклатурыОстатки.СебестоимостьОстаток, 0) КАК СебестоимостьОбщ
                        |ИЗ
                        |	ВТ КАК ВТ
                        |	ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ОстаткиНоменклатуры.Остатки(
                        |		&ДатаДокумента,
                        |		Номенклатура В
                        |			(ВЫБРАТЬ
                        |				ВТ.Номенклатура
                        |			ИЗ
                        |				ВТ КАК ВТ)
                        |		И Склад = &Склад) КАК ОстаткиНоменклатурыОстатки) КАК ОстаткиНоменклатурыОстатки
                        |	ПО ВТ.Номенклатура = ОстаткиНоменклатурыОстатки.Номенклатура
                        |
                        |УПОРЯДОЧИТЬ ПО
                        |	ОстаткиНоменклатурыОстатки.Партия.МоментВремени " <span class="светло_красный">+</span> <span class="светло_синий">ПараметрСписания</span> <span class="светло_красный">+</span> "
                        |ИТОГИ
                        |	МИНИМУМ(Количество), СУММА(КоличествоОбщ), МИНИМУМ(НомерСтроки)
                        |ПО
                        |	Номенклатура"</span><span class="светло_красный">;</span>
                    
                    Запрос<span class="светло_красный">.</span>УстановитьПараметр<span class="светло_красный">(</span><span class="серый">"Ссылка"</span><span class="светло_красный">,</span> Ссылка<span class="светло_красный">);</span>
                    <span class="зелёный">//если режим проведения оперативный, то не передаём дату документа  
                    //передадим значение Неопределено, а если передать дату в параметр, ошибки не будет, но системе нужно
                    //потратить время на вычисление даты из момента времени, потом найти по этой дате в таблице остатков
                    //сами остатки, это всё время занимает. Проще ничего не передавать и система сама поймёт, что нужно
                    //вернуть последние остатки и она просто пойдёт и возмёт остатки на 3999 год(т.е. самые последние)
                    //без вычисления всяких дат.
                    //Дату мы обычно передаём при неоперативном режиме, потому что там нам нужны не последние данные вообще, 
                    //а данные на конкретную дату</span>    
                    <span class="светло_красный">Если</span> РежимПроведения<span class="светло_красный">=</span> РежимПроведенияДокумента<span class="светло_красный">.</span>Неоперативный <span class="светло_красный">Тогда</span>
                        Запрос<span class="светло_красный">.</span>УстановитьПараметр<span class="светло_красный">(</span><span class="серый">"ДатаДокумента"</span><span class="светло_красный">,</span> МоментВремени<span class="светло_красный">());</span>
                    <span class="светло_красный">Иначе</span>
                        Запрос<span class="светло_красный">.</span>УстановитьПараметр<span class="светло_красный">(</span><span class="серый">"ДатаДокумента"</span><span class="светло_красный">, Неопределено);	
                    КонецЕсли;</span>
                    Запрос<span class="светло_красный">.</span>УстановитьПараметр<span class="светло_красный">(</span><span class="серый">"Склад"</span><span class="светло_красный">,</span> Склад<span class="светло_красный">);</span>
                    РезультатЗапроса <span class="светло_красный">=</span> Запрос<span class="светло_красный">.</span>Выполнить<span class="светло_красный">();</span>
    
                    <img src="../img/1С-1/2024-06-01_18-25-38.png" class="screen-2" style="margin-left:90px;margin-bottom:0px" alt="">
                    
                    ВыборкаГрупп <span class="светло_красный">=</span> РезультатЗапроса<span class="светло_красный">.</span>Выбрать<span class="светло_красный">(</span>ОбходРезультатаЗапроса<span class="светло_красный">.</span>ПоГруппировкам<span class="светло_красный">);</span>
    
                    <span class="зелёный">//Это я от себя сочиняю. Меня смущает тот случай, когда мы проходим
                    //по группировочным записям выборки и проверяем наличие товара, и если
                    //все первые товары есть, а вот последнего товара нет, то в итоге
                    //мы проведение документа отменим, но пока код дойдёт до последнего
                    //товара, мы всё это время будем дёргать код вычисления детальных записей.
                    //Хорошо если мы где то в начале обнаружим недостающего товара, на этот случай мы
                    //подстраховались, когда пропускаем круг цикла если Отказ = Истина, но а в случае
                    //если недостающий товар где то внизу, то будем гонять детальные записи.
                    //Поэтому хочу сделать цикл, который первоначально просто проверит наличие 
                    //товаров по группировкам и если хоть одного товара не будет хватать, то
                    //сразу Отказ = Истина, а затем сбразываем цикл и начинаем формировать
                    //сообщения о нехватке товаров, но уже детальные записи не будут затронуты 
                    //вообще.</span>
                    <span class="светло_красный">Пока</span> ВыборкаГрупп<span class="светло_красный">.</span>Следующий<span class="светло_красный">() Цикл</span> 
                        <span class="светло_красный">Если</span> ВыборкаГрупп<span class="светло_красный">.</span>Количество <span class="светло_красный">></span> ВыборкаГрупп<span class="светло_красный">.</span>КоличествоОбщ <span class="светло_красный">Тогда</span>
                            Отказ <span class="светло_красный">=</span> Истина<span class="светло_красный">;
                        КонецЕсли;
                    КонецЦикла;</span>
                    
                    ВыборкаГрупп<span class="светло_красный">.</span>Сбросить<span class="светло_красный">();</span>
                    <span class="светло_красный">Пока</span> ВыборкаГрупп<span class="светло_красный">.</span>Следующий<span class="светло_красный">() Цикл</span> 
                        <span class="светло_красный">Если</span> ВыборкаГрупп<span class="светло_красный">.</span>Количество <span class="светло_красный">></span> ВыборкаГрупп<span class="светло_красный">.</span>КоличествоОбщ <span class="светло_красный">Тогда</span>
                            СообщениеП <span class="светло_красный">= Новый</span> СообщениеПользователю<span class="светло_красный">;</span>
                            <span class="зелёный">////первый способ задать текст через сложение строк, менее отлаженный
                            //СообщениеП.Текст = "Не хватает товара " 
                            //                    + ВыборкаГрупп.НоменклатураП 
                            //                    + " в количестве " 
                            //                    + (ВыборкаГрупп.Количество - ВыборкаГрупп.КоличествоОбщ) 
                            //                    + " в строке с номером " 
                            //                    + ВыборкаГрупп.НомерСтроки;
    
                            //второй способ задать текст, более отлаженный</span>
                            СообщениеП<span class="светло_красный">.</span>Текст <span class="светло_красный">=</span> СтрШаблон<span class="светло_красный">(</span><span class="серый">"Не хватает товара %1 в количестве %2 в строке с номером %3"</span><span class="светло_красный">,</span>
                                                            ВыборкаГрупп<span class="светло_красный">.</span>НоменклатураП<span class="светло_красный">,</span>
                                                            <span class="светло_красный">(</span>ВыборкаГрупп<span class="светло_красный">.</span>Количество <span class="светло_красный">-</span> ВыборкаГрупп<span class="светло_красный">.</span>КоличествоОбщ<span class="светло_красный">),</span>
                                                            ВыборкаГрупп<span class="светло_красный">.</span>НомерСтроки<span class="светло_красный">);</span> 
    
                            СообщениеП<span class="светло_красный">.</span>Поле <span class="светло_красный">=</span> <span class="серый">"Товары["</span> <span class="светло_красный">+ (</span>ВыборкаГрупп<span class="светло_красный">.</span>НомерСтроки <span class="светло_красный">-</span> 1<span class="светло_красный">) +</span> <span class="серый">"].Количество"</span><span class="светло_красный">;</span> 
                            СообщениеП<span class="светло_красный">.</span>УстановитьДанные<span class="светло_красный">(</span>ЭтотОбъект<span class="светло_красный">);</span>
                            СообщениеП<span class="светло_красный">.</span>Сообщить<span class="светло_красный">();</span>
    
                            Отказ <span class="светло_красный">=</span> Истина<span class="светло_красный">;			
                        КонецЕсли;</span>     
    
                        <span class="светло_красный">Если</span> Отказ <span class="светло_красный">Тогда
                            Продолжить;
                        КонецЕсли;</span>
    
                        СписываемоеКоличество <span class="светло_красный">=</span> ВыборкаГрупп<span class="светло_красный">.</span>Количество<span class="светло_красный">;</span> 
    
                        ВыборкаДетальных <span class="светло_красный">=</span> ВыборкаГрупп<span class="светло_красный">.</span>Выбрать<span class="светло_красный">();</span>   
                        <span class="светло_красный">Пока</span> ВыборкаДетальных<span class="светло_красный">.</span>Следующий<span class="светло_красный">() Цикл</span>
                            <span class="светло_красный">Если</span> СписываемоеКоличество <span class="светло_красный">></span> 0 <span class="светло_красный">Тогда</span>
                                Движение <span class="светло_красный">=</span> Движения<span class="светло_красный">.</span>ОстаткиНоменклатуры<span class="светло_красный">.</span>Добавить<span class="светло_красный">();</span> 
                                Движение<span class="светло_красный">.</span>ВидДвижения <span class="светло_красный">=</span> ВидДвиженияНакопления<span class="светло_красный">.</span>Расход<span class="светло_красный">;</span>
                                Движение<span class="светло_красный">.</span>Период <span class="светло_красный">=</span> Дата<span class="светло_красный">;</span>
                                Движение<span class="светло_красный">.</span>Склад <span class="светло_красный">=</span> Склад<span class="светло_красный">;</span>
                                Движение<span class="светло_красный">.</span>Номенклатура <span class="светло_красный">=</span> ВыборкаДетальных<span class="светло_красный">.</span>Номенклатура<span class="светло_красный">;</span>
                                Движение<span class="светло_красный">.</span>Партия <span class="светло_красный">=</span> ВыборкаДетальных<span class="светло_красный">.</span>Партия<span class="светло_красный">;</span>
                            
                                <span class="светло_красный">Если</span> СписываемоеКоличество <span class="светло_красный">&lt;</span> ВыборкаДетальных<span class="светло_красный">.</span>КоличествоОбщ <span class="светло_красный">Тогда</span>
                                    Движение<span class="светло_красный">.</span>Количество <span class="светло_красный">=</span> СписываемоеКоличество<span class="светло_красный">;</span>
                                    Движение<span class="светло_красный">.</span>Себестоимость <span class="светло_красный">=</span> СписываемоеКоличество <span class="светло_красный">/</span> ВыборкаДетальных<span class="светло_красный">.</span>КоличествоОбщ <span class="светло_красный">*</span> ВыборкаДетальных<span class="светло_красный">.</span>СебестоимостьОбщ<span class="светло_красный">;</span>
                                    СписываемоеКоличество <span class="светло_красный">=</span> СписываемоеКоличество <span class="светло_красный">-</span> СписываемоеКоличество<span class="светло_красный">;</span> 
                                <span class="светло_красный">Иначе</span>
                                    Движение<span class="светло_красный">.</span>Количество <span class="светло_красный">=</span> ВыборкаДетальных<span class="светло_красный">.</span>КоличествоОбщ<span class="светло_красный">;</span>
                                    Движение<span class="светло_красный">.</span>Себестоимость <span class="светло_красный">=</span> ВыборкаДетальных<span class="светло_красный">.</span>СебестоимостьОбщ<span class="светло_красный">;</span>
                                    СписываемоеКоличество <span class="светло_красный">=</span> СписываемоеКоличество <span class="светло_красный">-</span> ВыборкаДетальных<span class="светло_красный">.</span>КоличествоОбщ<span class="светло_красный">;
                                КонецЕсли;
                            КонецЕсли;		
                        КонецЦикла; 
                    КонецЦикла;
                КонецПроцедуры</span></span>
            </pre>
        </div>
    </div>


    <div class="spec-5">
        <p class="title-size16"><b id="spec-5">(ОУ) Расчёт себестоимости в целом по предприятию. Билет №1</b></p>
        <p>Здесь уже стоит задача высчитывать себестоимость товара общую по всем складам.</p>
        <p>Нужно вести учёт себестоимости товаров без учёта по складам. В прошлой статье мы учитывали себестоимость по одному складу, у нас был регистр накопления "ОстаткиНоменклатуры" и в нём было измерение "Склад" и ресурс "Себестоимость". Теперь же нужно создать ещё один регистр накопления "СебестоимостьТоваров", который будет считать себестоимость товаров без учёта по складам. Мы создаём те же измерения и ресурсы, что и в регистре "ОстаткиНоменклатуры", но без склада. А вот в регистре "ОстаткиНоменклатуры" мы удалим ресурс "Себестоимость" и измерение "Партия", потому что без себестоимости она там уже не нужна. Вот такая картина получится: </p>
        <img src="../img/1С-1/2024-06-02_06-43-25.png" class="screen-2" alt="">
        <p>В билете также сказано, что помимо продажи товаров нужно учесть продажу услуги - "ДоставкаТоваров". Для этого у нас в каркасной конфе уже есть перечисление "ВидыНоменклатуры", теперь нужно в справочнике "Номенклатура" создать реквизит "ВидНоменклатуры" с типом данных этого перечисления. Если читать билет, то сказано что услуга только продаётся, значит нам нужно пойти в документ "ПриходнаяНакладная" и в табличной части "СписокНоменклатуры" для поля "Номенклатура" запретить показ услуг. Ведь мы не будем приходовать услуги, а только товары. Вспоминаем как запретить показ услуги при выборе номенклатуры. Для этого используется свойство поля "Номенклатура" - "ПараметрыВыбора". Добавляем новый параметр выбора, в левой части выбираем "Отбор.ВидНоменклатуры", а в правой части выбираем тип "ПеречислениеСсылка.ВидыНоменклатуры" и его значение "Товар". Теперь мы можем в пользовательской части добавить новую номенклатуру "Доставка товаров" и указать для неё "Услуга" и для другой номенклатуры заполнить поле "ВидНоменклатуры" значением "Товар". Если теперь посмотреть в поле "Номенклатура" приходной накладной и расходной, то в приходной услуги в приборе товара нет, а в расходной есть. </p>
        <p>Как сказал Леонтьев, то в дальнейшем мы не будем учитывать услуги в остатках номенклатуры и в себестоимости товаров тоже. Тогда где мы будем услуги учитывать? В дальнейшем когда будет регистр "Продажи", вот туда и будем записывать услуги.</p>
        <p>Итак, перепишем по новому обработку проведения приходного документа. Раньше мы получали из запроса только сгруппированные товары табличной части, а остальное в регистр дописывали из данных самого документа - "Склад", "Ссылка(Партия)", "Дата". Теперь давайте передадим в запрос все эти данные документа с помощью параметров и получим ответ уже со всеми данными. Этот способ просто для показа того, как параметрами можно закидать все данные в запрос и кучкой их получить в выборке или в ТЗ, а потом одним методом раскидать данные в записи набора.</p>
        <div class="code-style">
            <pre>
                --модуль объекта документа "ПриходнаяНакладная"
    
                <span class="светло_синий">Процедура ОбработкаПроведения(Отказ, РежимПроведения)
                    Запрос = Новый Запрос;
                    Запрос.Текст = 
                        <span class="серый">"ВЫБРАТЬ
                        |	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
                        |	&Дата КАК Период,
                        |	ПриходнаяНакладнаяСписокНоменклатуры.Номенклатура КАК Номенклатура,
                        |	&Склад КАК Склад,
                        |	ПриходнаяНакладнаяСписокНоменклатуры.Ссылка КАК Партия,
                        |	СУММА(ПриходнаяНакладнаяСписокНоменклатуры.Количество) КАК Количество,
                        |	СУММА(ПриходнаяНакладнаяСписокНоменклатуры.Сумма) КАК Себестоимость
                        |ИЗ
                        |	Документ.ПриходнаяНакладная.СписокНоменклатуры КАК ПриходнаяНакладнаяСписокНоменклатуры
                        |ГДЕ
                        |	ПриходнаяНакладнаяСписокНоменклатуры.Ссылка = &Ссылка
                        |
                        |СГРУППИРОВАТЬ ПО
                        |	ПриходнаяНакладнаяСписокНоменклатуры.Номенклатура,
                        |	ПриходнаяНакладнаяСписокНоменклатуры.Ссылка"</span>;
                    
                    Запрос.УстановитьПараметр(<span class="серый">"Ссылка"</span>, Ссылка);
                    Запрос.УстановитьПараметр(<span class="серый">"Склад"</span>, Склад);
                    Запрос.УстановитьПараметр(<span class="серый">"Дата"</span>, Дата);
                    РезультатЗапроса = Запрос.Выполнить();
                    Выборка = РезультатЗапроса.Выбрать();
                    
                    <span class="зелёный">//из-за того, что в выборке теперь есть все данные, то мы можем
                    //через метод заполнить данными движения</span>     
                    Движения.ОстаткиНоменклатуры.Записывать = Истина;
                    Движения.СебестоимостьТоваров.Записывать = Истина;
                    Пока Выборка.Следующий() Цикл
                        <span class="зелёный">//регистр ОстаткиНоменклатуры</span>
                        Движение = Движения.ОстаткиНоменклатуры.Добавить();
                        ЗаполнитьЗначенияСвойств(Движение, Выборка);
    
                        <span class="зелёный">//регистр СебестоимостьТоваров</span>
                        Движение = Движения.СебестоимостьТоваров.Добавить();
                        ЗаполнитьЗначенияСвойств(Движение, Выборка);		
                    КонецЦикла;
                    
                КонецПроцедуры</span>
            </pre>
        </div>
        <p>Далее опишем обработку проведения расходной накладной. Из-за того, что мы вынесли себестоимость и партию в другой регистр, то остатки товара по регистру "ОстаткиНоменклатуры" мы проведём по новой методике, потому что там теперь хватает всех данных из документа, а затем последовательно запишем данные в регистр "СебестоимостьТоваров" по старой методике. По старой, потому что нужно вычислять себестоимость. Вот и получается что проведение документа у нас будет из двух методик для разных регистров. У Чистова в статье про многоскладской учёт мы записывали в оба регистра по старой методике. Здесь видим что идёт разделение.</p>
        <p>Ещё я заметил, что при новой методике очищать регистр самому не надо при перепроведении, а вот в старой методике надо самому очищать регистр, это при условии что у свойства "Удаление движений" установленно по умолчанию значение "Удалять автоматически при отмене проведения".</p>
        <div class="code-style">
            <pre>
                --модуль объекта "ПриходнаяНакладная"
                <span class="светло_синий">Процедура ОбработкаПроведения(Отказ, РежимПроведения) 
                    <span class="зелёный">//У нас есть в системе документ, который меняет метод списания себестоимости
                    //и записывает этот метод в регистр сведений.
                    //Здесь нам при проведении расходного документа нужно получить этот метод
                    //списания из регистра сведений "УчетнаяПолитика" и по полученному
                    //методу будем упорядочивать партии в остатках</span>
                    Запрос = Новый Запрос;
                    Запрос.Текст = 
                        <span class="серый">"ВЫБРАТЬ
                        |	УчетнаяПолитикаСрезПоследних.МетодСписанияСебестоимости КАК МетодСписанияСебестоимости
                        |ИЗ
                        |	РегистрСведений.УчетнаяПолитика.СрезПоследних(&Период, ) КАК УчетнаяПолитикаСрезПоследних"</span>;
                    
                    Запрос.УстановитьПараметр(<span class="серый">"Период"</span>, Дата);
                    РезультатЗапроса = Запрос.Выполнить(); 
                    
                    Если РезультатЗапроса.Пустой() Тогда
                        Сообщение = Новый СообщениеПользователю;
                        Сообщение.Текст = <span class="серый">"Не указан метод списания"</span>;
                        Сообщение.Сообщить();
                        
                        Отказ = Истина;
                        Возврат;
                    Иначе
                        ВыборкаМетода = РезультатЗапроса.Выбрать();
                        ВыборкаМетода.Следующий();
                        Если ВыборкаМетода.МетодСписанияСебестоимости = Перечисления.УчетнаяПолитика.ЛИФО Тогда
                            ПараметрСписания = <span class="серый">"УБЫВ"</span>;
                        КонецЕсли;
                    КонецЕсли;
    
    
    
                    <span class="зелёный">//по остаткам товаров проводим
                
                    //сворачиваем товары из табличной части документа</span>
                    Запрос = Новый Запрос;
                    Запрос.МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц;
                    Запрос.Текст = <span class="серый">"
                        |ВЫБРАТЬ 
                        |	РасходнаяНакладнаяСписокНоменклатуры.Номенклатура КАК Номенклатура,
                        |	СУММА(РасходнаяНакладнаяСписокНоменклатуры.Количество) КАК Количество
                        |ПОМЕСТИТЬ ВТ
                        |ИЗ
                        |	Документ.РасходнаяНакладная.СписокНоменклатуры КАК РасходнаяНакладнаяСписокНоменклатуры
                        |ГДЕ
                        |	РасходнаяНакладнаяСписокНоменклатуры.Ссылка = &Ссылка 
                        |	И РасходнаяНакладнаяСписокНоменклатуры.Номенклатура.ВидНоменкладутры = ЗНАЧЕНИЕ(Перечисление.ВидыНоменклатуры.Товар)
                        |
                        |СГРУППИРОВАТЬ ПО
                        |	РасходнаяНакладнаяСписокНоменклатуры.Номенклатура 
                        |
                        |ИНДЕКСИРОВАТЬ ПО
                        |	Номенклатура
                        |;
                        |
                        |////////////////////////////////////////////////////////////////////////////////
                        |ВЫБРАТЬ 
                        |	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
                        |	&Период КАК Период,
                        |	&Склад КАК Склад,
                        |	ВТ.Номенклатура КАК Номенклатура,
                        |	ВТ.Количество КАК Количество
                        |ИЗ
                        |	ВТ КАК ВТ"</span>;
    
                    Запрос.УстановитьПараметр(<span class="серый">"Ссылка"</span>, Ссылка);
                    Запрос.УстановитьПараметр(<span class="серый">"Период"</span>, Дата);
                    Запрос.УстановитьПараметр(<span class="серый">"Склад"</span>, Склад);
                    РезультатЗапроса = Запрос.Выполнить();
                    
                    <span class="зелёный">//заполняем движения регистра остатков</span>
                    Выборка = РезультатЗапроса.Выбрать();
                    Пока Выборка.Следующий() Цикл 
                        <span class="зелёный">// регистр ОстаткиТоваров Приход</span>
                        Движение = Движения.ОстаткиНоменклатуры.Добавить();
                        ЗаполнитьЗначенияСвойств(Движение, Выборка); 
                    КонецЦикла;      
    
                    <span class="зелёный">//записываем данные в регистр остатков, и убираем возможность разделения итогов
                    //тем самым блокируем возможность записать или прочитать данные по текущим товарам</span>
                    Движения.ОстаткиНоменклатуры.БлокироватьДляИзменения = Истина;
                    Движения.ОстаткиНоменклатуры.Записывать = Истина;     
                    Движения.Записать();
                    
                    <span class="зелёный">//запросом смотрим есть ли отрицательные остатки после записи в регистр</span>
                    Запрос.Текст = 
                        <span class="серый">"ВЫБРАТЬ	
                        |	ПРЕДСТАВЛЕНИЕ(ОстаткиНоменклатурыОстатки.Номенклатура) КАК НоменклатураП,
                        |	ОстаткиНоменклатурыОстатки.КоличествоОстаток КАК КоличествоОстаток
                        |ИЗ
                        |	РегистрНакопления.ОстаткиНоменклатуры.Остатки(
                        |			&МоментВремени,
                        |			Склад = &Склад И 
                        |			Номенклатура В
                        |				(ВЫБРАТЬ
                        |					ВТ.Номенклатура КАК Номенклатура
                        |				ИЗ
                        |					ВТ КАК ВТ)) КАК ОстаткиНоменклатурыОстатки 
                        |ГДЕ
                        |	ОстаткиНоменклатурыОстатки.КоличествоОстаток &lt; 0"</span>;
                    
                    Граница = Новый Граница(МоментВремени(), ВидГраницы.Включая);
                    Если РежимПроведения = РежимПроведенияДокумента.Неоперативный Тогда
                        Запрос.УстановитьПараметр(<span class="серый">"МоментВремени"</span>, Граница);	
                    Иначе	
                        Запрос.УстановитьПараметр(<span class="серый">"МоментВремени"</span>, Неопределено);
                    КонецЕсли;	
                    Запрос.УстановитьПараметр(<span class="серый">"Склад"</span>, Склад);
                    РезультатЗапроса = Запрос.Выполнить();
                    
                    <span class="зелёный">//если есть отрицательные остатки, то мы выводим сообщения о нехватающих товарах</span>
                    Если НЕ РезультатЗапроса.Пустой() Тогда
                        Выборка = РезультатЗапроса.Выбрать();
                    
                        Пока Выборка.Следующий() Цикл
                            СообщениеП = Новый СообщениеПользователю;
                            СообщениеП.Текст = СтрШаблон(<span class="серый">"Не хватает товара %1 в количестве %2"</span>, Выборка.НоменклатураП, -Выборка.КоличествоОстаток);
                            СообщениеП.Сообщить();
                        КонецЦикла;
    
                        Отказ = Истина;
                    КонецЕсли;
    
                    <span class="зелёный">//если в остатках первого регистра у нас не хватает товаров, то дальше не нужно идти</span>
                    Если Отказ Тогда
                        Возврат;
                    КонецЕсли;
    
    
                    <span class="зелёный">//-------------------------------------------------------------------------------------------------------------------------------------
                    //теперь по остаткам себестоимости проводим
                    //для начала очистим регистр</span>
                    Движения.СебестоимостьНоменклатуры.Очистить();
                    Движения.СебестоимостьНоменклатуры.Записать();
    
                    
                    <span class="зелёный">//накладываем управляемую блокировку на записи с продаваемым товаром в регистре</span>
                    Блокировка = Новый БлокировкаДанных;
                    ЭлементБлокировки = Блокировка.Добавить("РегистрНакопления.СебестоимостьНоменклатуры");
                    ЭлементБлокировки.Режим = РежимБлокировкиДанных.Исключительный; 
                    ЭлементБлокировки.ИсточникДанных = СписокНоменклатуры;
                    ЭлементБлокировки.ИспользоватьИзИсточникаДанных(<span class="серый">"Номенклатура"</span>, <span class="серый">"Номенклатура"</span>);	
                    Блокировка.Заблокировать(); 
    
                    
                    <span class="зелёный">//выше в новой методике мы уже получали товары во временную таблицу
                    //поэтому берём её оттуда</span>
                    Запрос.Текст = 
                        <span class="серый">"ВЫБРАТЬ
                        |	ВТ.Номенклатура КАК Номенклатура,
                        |	ВТ.Номенклатура.Представление КАК НоменклатураП,
                        |	ВТ.Количество КАК Количество,
                        |	СебестоимостьНоменклатурыОстатки.Партия КАК Партия,
                        |	ЕСТЬNULL(СебестоимостьНоменклатурыОстатки.КоличествоОстаток, 0) КАК КоличествоОстаток,
                        |	ЕСТЬNULL(СебестоимостьНоменклатурыОстатки.СебестоимостьОстаток, 0) КАК СебестоимостьОстаток
                        |ИЗ
                        |	ВТ КАК ВТ
                        |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.СебестоимостьНоменклатуры.Остатки(
                        |				&ДатаДокумента,
                        |				Номенклатура В
                        |					(ВЫБРАТЬ
                        |						ВТ.Номенклатура КАК Номенклатура
                        |					ИЗ
                        |						ВТ КАК ВТ)) КАК СебестоимостьНоменклатурыОстатки
                        |		ПО ВТ.Номенклатура = СебестоимостьНоменклатурыОстатки.Номенклатура
                        |
                        |УПОРЯДОЧИТЬ ПО
                        |	СебестоимостьНоменклатурыОстатки.Партия.МоментВремени %1
                        |ИТОГИ
                        |	МИНИМУМ(Количество),
                        |	СУММА(КоличествоОстаток)
                        |ПО
                        |	Номенклатура"</span>; 
    
                    
                    Если ПараметрСписания = <span class="серый">"УБЫВ"</span> Тогда
                        Запрос.Текст = СтрШаблон(Запрос.Текст, <span class="серый">"УБЫВ"</span>);
                    Иначе	
                        Запрос.Текст = СтрШаблон(Запрос.Текст, <span class="серый">"ВОЗР"</span>);
                    КонецЕсли;
                    
                    Если РежимПроведения = РежимПроведенияДокумента.Неоперативный Тогда
                        Запрос.УстановитьПараметр(<span class="серый">"ДатаДокумента"</span>, МоментВремени());
                    Иначе	
                        Запрос.УстановитьПараметр(<span class="серый">"ДатаДокумента"</span>, Неопределено);
                    КонецЕсли;
                    Результатзапроса = Запрос.Выполнить();
                    ВыборкаГрупп = РезультатЗапроса.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
    
                    Пока ВыборкаГрупп.Следующий() Цикл 
                        Если ВыборкаГрупп.Количество > ВыборкаГрупп.КоличествоОстаток Тогда
                            Отказ = Истина;
                        КонецЕсли;
                    КонецЦикла;
                    
                    ВыборкаГрупп.Сбросить();
                    Пока ВыборкаГрупп.Следующий() Цикл
                        Если ВыборкаГрупп.Количество > ВыборкаГрупп.КоличествоОстаток Тогда
                            Сообщение = Новый СообщениеПользователю;
                            Сообщение.Текст = СтрШаблон(<span class="серый">"Недостаточно товара %1 в количестве %2"</span>, ВыборкаГрупп.НоменклатураП, (ВыборкаГрупп.Количество - ВыборкаГрупп.КоличествоОстаток));
                            Сообщение.Сообщить();
    
                            Отказ = Истина;	
                        КонецЕсли;
                        
                        Если Отказ Тогда
                            Продолжить;
                        КонецЕсли;
    
                        СписываемоеКоличество = ВыборкаГрупп.Количество;
                        ВыборкаДетальных = ВыборкаГрупп.Выбрать();
                        Пока ВыборкаДетальных.Следующий() Цикл
                            Если СписываемоеКоличество > 0 Тогда
                                Движение = Движения.СебестоимостьНоменклатуры.Добавить(); 
                                Движение.ВидДвижения = ВидДвиженияНакопления.Расход;
                                Движение.Период = Дата;
                                Движение.Номенклатура = ВыборкаДетальных.Номенклатура;
                                Движение.Партия = ВыборкаДетальных.Партия;
                            
                                Если СписываемоеКоличество &lt; ВыборкаДетальных.КоличествоОстаток Тогда
                                    Движение.Количество = СписываемоеКоличество;
                                    Движение.Себестоимость = СписываемоеКоличество / ВыборкаДетальных.КоличествоОстаток * ВыборкаДетальных.СебестоимостьОстаток;
                                    СписываемоеКоличество = СписываемоеКоличество - СписываемоеКоличество; 
                                Иначе
                                    Движение.Количество = ВыборкаДетальных.КоличествоОстаток;
                                    Движение.Себестоимость = ВыборкаДетальных.СебестоимостьОстаток;
                                    СписываемоеКоличество = СписываемоеКоличество - ВыборкаДетальных.КоличествоОстаток;
                                КонецЕсли;
                            КонецЕсли;
                        КонецЦикла;
                    КонецЦикла;
                            
                    Движения.СебестоимостьНоменклатуры.Записывать = Истина;
                КонецПроцедуры</span>
            </pre>
        </div>
    </div>


    <div class="spec-6">
        <p class="title-size16"><b id="spec-6">(ОУ)Сделать отчёт "ОстаткиТоваров". Занятие 7, 8, 9. Билет №1.</b></p>
        <p>Сортировку обязательно нужно делать для отчётов.</p>
        <p>Нужно в точности повторить таблицу, которая будет в билете. Допустим в билете номер 1 такая таблица:</p>
        <img src="../img/1С-1/2024-06-07_19-57-35.png" class="screen-2" alt="">
        <p>Итак если по быстрому накидать отчёт, то получится у нас такая картина:</p>
        <img src="../img/1С-1/2024-06-07_20-03-50.png" class="screen-2" alt="">
        <p>Начнём исправлять несоответствия. Нужно разнести поля группировок(Склад и Номенклатура) по отдельным колонкам. Делается это на вкладке "Настройки" - "Другие настройки" - "Расположение полей группировок" - "Отдельно". Получится вот такое:</p>
        <img src="../img/1С-1/2024-06-07_20-07-07.png" class="screen-2" alt="">
        <p>Но нам не нужно чтобы склад повторялся в каждой строке для товара, поэтому нужно задать для расположения группировок значение не "Отдельно", а "Отдельно и только в итогах".</p>
        <p>Дальше нужно убрать общие итоги(строка с итогами внизу таблицы). Для этого в "других настройках" ищем свойство "Расположение общих итогов по вертикали" и  ставим значение "Нет".</p>
        <p>Затем надо задать заголовок для поля "КоличествоОстаток" не такой как есть сейчас, а "Кол-во". Первый способ это на закладке "Набор данных" в "Автозаголовок" поставить галочку и поменять на тот заголовок, который нужен. Второй способ это на закладке "Настройки" - "Выбранные поля" у поля "КоличествоОстаток" вызвать контекстное меню и выбрать "Установить заголовок" и в появившемся окошке пишем нужный заголовок.</p>
        <p>На данный миг имеем уже вот такую табличку:</p>
        <img src="../img/1С-1/2024-06-07_20-19-14.png" class="screen-2" alt="">
    
        <p><b>Теперь разберёмся как делать заголовок отчёта. Способ 1й</b>.</p> 
        <p>Заголовок можно задать перейдя на закладку "Другие настройки" - "Заголовок" и зададим заголовок "Остатки товаров", но тут нельзя добавить дату к этому заголовку. Поэтому пойдём по другому пути.</p> 
        <p>Нам понадобится закладка "Макет" отчёта, но для начала нам в у корня отчёта нужно создать ещё одну группировку, пусть это будет просто детальные записи, перенсём эту группировку вверх списка отчёта:</p>
        <img src="../img/1С-1/2024-06-09_08-16-18.png" class="screen-2" alt="">
        <p>Потом у этой группировки вызываем контекстное меню и выбираем пункт "Установить имя", в появившемся окне пишем "Заголовок" и ОК. Далее выберем эту группировку для отдельной настройки:</p>
        <img src="../img/1С-1/2024-06-09_08-20-49.png" class="screen-2" alt="">
        <p>И перейдём на закладку "Другие настройки" и в самом конце списка настроек видим пункт "Вариант использования группировки", выберем значение "Дополнительная информация". Теперь эта группировка не будет выводить детальные записи отчёта, выбором этого значения мы определим её для вывода заголовка отчёта.</p>
        <p>Теперь идём на закладку "Макет", где мы будем определять что конкретно мы хотим вывести вместо этой группировки. Напишем в первой ячейке текст "Остатки товаров", можно сделать жирным, поменять размер начертания и т.д.</p>
        <p>Затем нам нужно связать ячейку, где мы только что написали текст, с созданной группировкой. Для этого в левой части окна нажмём кнопку добавления макетов и выберем пункт "Добавить макет группировки", т.е. мы создаём макет для созданной группировки "Заголовок". В открывшемся окне выберем пункт "Имя группировки" и выпадающем списке найдём ранее созданную группировку с именем "Заголовок":</p>
        <img src="../img/1С-1/2024-06-09_08-33-59.png" class="screen-2" alt="">
        <p>Слева под кнопкой у нас добавится группировка, а чуть правее в поле нужно написать адрес ячейки, где мы написали текст заголовка. Эта ячейка и будет макетом для группировки. Пишем "R1C1":</p>
        <img src="../img/1С-1/2024-06-09_08-37-59.png" class="screen" alt="">
        <p>Если теперь пойти в пользовательский режим и посмотреть что получилось, то увидим это:</p>
        <img src="../img/1С-1/2024-06-09_08-44-31.png" class="screen-2" alt="">
        <p>У нас оказалось 2 заголовка. Первый это тот что мы для всего отчёта задавали(зелёный), а второй показан из макета для группировки. Первый нам теперь не нужен, мы там дату не можем приписать, поэтому в настройках для всего отчёта снимем галочку с пункта "Заголовок" на закладке "Другие настройки". Далее нам нужно добавить дату, идём опять в макет и в ячейке к тексту допишем "на [Период]". Выберем для этой ячейки пункт "Свойства" в контекстном меню и на закладке "Макет" для свойства "Заполнение" укажем "Шаблон", потому что кроме параметра "Период" в ячейке есть просто текст. Как только мы указали, что это шаблон, в котором есть параметр, то слева ниже появилась строка с этим параметром:</p>
        <img src="../img/1С-1/2024-06-09_08-53-08.png" class="screen" alt="">
        <p>Нам нужно задать значение для этого параметра. Нажимает на "..." и в окне выберем из "ПараметрыДанных" - "Период":</p>
        <img src="../img/1С-1/2024-06-09_08-55-20.png" class="screen-2" alt="">
        <p>Это мы берём тот период, который у нас в схеме указан на закладке "Параметры". Если мы теперь запустим пользовательский режим и запустим отчёт, то система выдаст ошибку, что период не задан. Нам нужно задать первоначальное значение периода установив галочку в настройках на закладке "Параметры" у поля "Период" и назначив значение по умолчанию. Или же мы это поле добавим в пользовательские настройки в быстрый доступ и когда пользователь откроет отчёт, ему нужно быдет сначала указать период, а затем запустить отчёт. Зайдём в пользовательский режим, откроем отчёт, добавим дату или выберем по умолчанию предлагаемые периоды, или просто поставим флажок радом с периодом, говоря, что мы выбираем самую последнюю дату и запустим отчёт:</p>
        <img src="../img/1С-1/2024-06-09_09-05-54.png" class="screen-2" alt="">
        <p>Как видим сверху заголовка отчёта отображаются параметры и период. Их нужно убрать если этого нет на таблице из билета. Выключить их можно на закладках отчёта "Настройки" - "Другие настройки" - "Выводить параметры" - "Не выводить". Также в заголовке в дате нужно убрать время. Для этого на закладке "Макет" для значения параметра "Период" нужно применить формат даты. Для этого выделим ячеку с заголовком, в контекстном меню выберем свойства и в свойствах на закладке "Значения" через свойство "Формат" зададим формат для даты:</p>
        <img src="../img/1С-1/2024-06-09_11-40-39.png" class="screen" alt="">
        <p>Запустим предприятие и посмотрим отчёт, вот такой получился:</p>
        <img src="../img/1С-1/2024-06-09_11-43-02.png" class="screen-2" alt="">
        <p>Далее в билете у заголовка таблицы есть <b>отступ слева у заголовка</b>. Для этого идём на закладку "Макет" и просто в ячейке пробелами делаем отступ.</p>
        <p>Ещё у заголовка, если присмотреться, есть <b>обводка ячейки у заголовка</b></p>
        <img src="../img/1С-1/2024-06-10_10-05-26.png" class="screen-2" alt="">
        <p>Чтобы убрать эту обводку, можно на закладке "Макет" в свойствах ячейки найти свойство "Цвет рамки" на закладке "Оформление" и задать ей белый цвет и тогда рамки не будет видно.</p>
        <p>Или второй способ убрать обводку, это на закладке "Настройки" выбрать нашу группировку с заголовком и на закладке "Другие настройки" для свойства "Макет оформления" указать "Без оформления".</p>
        <p>Этот способ подходит для экзамена, не нужно мудрить с программным заданием заголовка.</p>
    
        <p><b>Как делать заголовок отчёта. Способ 2й</b>.</p> 
        <p>Леонтьев взялся делать заголовок другим способом потому что его доставало, что заголовок зависел от значения периода и временами выдавало ошибку, что период не задан. Не знаю я решил это тем, что указал на закладке "настройки"  - "Параметры" значение перида по умолчанию, поставив галочку и задав значение, например, "Начало этого дня" и всё, хорошо отрабатывало с заголовком и подставлялась дата. Но он решил переделать по другому. Ну ничего, зато посмотрим другой(программный) способ задать заголовок и присоединить к нему дату из пользовательских настроек. </p>
        <p>Всё дело в том, что мы выставляли свойство "Использование" в значение "Всегда", что лишало пользователя возможности не указывать период. Можно поставить "авто", но тогда если пользователь не ставил галочку применения периода вылетала ошибка, это всё из-за заголовка, в котором есть параметр периода и туда надо что то программе писать. Если отключить в структуре отчёта группировку заголовка, то ошбика не возникает даже если не указана галочка для периода. Вот мы и взялись программно исправить это всё.</p>
        <p>Мы можем снять галочку с группировки отчёта, котрую мы выше создавали для отображения заголовка и задать заголовок программно. Приведу тут уже ранее мной добавленные картинки:</p>
        <img src="../img/1С-1/2024-05-02_08-35-56.png" class="screen" alt="">
        <img src="../img/1С-1/2024-05-04_10-32-28.png" class="screen" alt="">
        <p>Мы будем использовать последнее событие "ПриКомпоновкеРезультата" в модуле объекта отчёта. В этом событии у нас есть такой объект как "КомпоновщикНастроек", он содержит настройки варианта отчёта и пользовательские настройки. Мы можем присоединить к заголовку дату из пользовательских настроек, если она там есть или самим задать текущую дату и присоединить.</p>
        <div class="code-style">
            <pre>
                --модуль объекта отчёта "ОстаткиТоваров_Билет1"
                <span class="светло_синий">Процедура ПриКомпоновкеРезультата(ДокументРезультат, ДанныеРасшифровки, СтандартнаяОбработка)  
                    <span class="зелёный">//1 способ получения параметра "Период". Способ Ханевича</span>
                    ПараметрПериод = Новый ПараметрКомпоновкиДанных(<span class="серый">"Период"</span>); 
                    ЗначениеПериода = Неопределено;
                    
                    Для каждого Элемент Из КомпоновщикНастроек.ПользовательскиеНастройки.Элементы Цикл
    
                        Если ТипЗнч(Элемент) = Тип(<span class="серый">"ЗначениеПараметраНастроекКомпоновкиДанных"</span>)
                            И Элемент.Параметр = ПараметрПериод 
                            И Элемент.Использование Тогда  
    
                            Если Дата(Элемент.Значение) = '00010101' Тогда
                                ЗначениеПериода = Формат(ТекущаяДата(), <span class="серый">"ДФ=dd.MM.yyyy"</span>);
                            Иначе
                                ЗначениеПериода = Формат(Дата(Элемент.Значение), <span class="серый">"ДФ=dd.MM.yyyy"</span>); 
                            КонецЕсли;
                            
                            Заголовок = СтрШаблон(<span class="серый">"Остатки товара %1"</span>, ЗначениеПериода);
                            КомпоновщикНастроек.Настройки.ПараметрыВывода.УстановитьЗначениеПараметра(<span class="серый">"Заголовок"</span>, Заголовок);
                            Прервать;		
                        КонецЕсли;	
                    КонецЦикла; 
    
                    <span class="зелёный">//2 способ получения параметра "Период". Способ из чата
                    
                    ВсеНастройки = КомпоновщикНастроек.ПолучитьНастройки();
                    Элемент = ВсеНастройки.ПараметрыДанных.УстановитьЗначениеПараметра(Новый ПараметрКомпоновкиДанных("Период"));
                    Если Элемент &lt;> Неопределено И Элемент.Использование Тогда
                        Если Дата(Элемент.Значение) = '00010101' Тогда
                            ЗначениеПериода = Формат(ТекущаяДата(), "ДФ=dd.MM.yyyy");
                        Иначе
                            ЗначениеПериода = Формат(Дата(Элемент.Значение), "ДФ=dd.MM.yyyy"); 
                        КонецЕсли;
                        
                        Заголовок = СтрШаблон("Остатки товара %1", ЗначениеПериода);
                        КомпоновщикНастроек.Настройки.ПараметрыВывода.УстановитьЗначениеПараметра("Заголовок", Заголовок);
                    КонецЕсли;  
    
    
                    //3й способ получения параметра "Период". Способ из типовой конфы
                    Параметр = КомпоновщикНастроек.Настройки.ПараметрыДанных.Элементы.Найти("Период");
                    Если Параметр &lt;> Неопределено Тогда
                        Элемент = КомпоновщикНастроек.ПользовательскиеНастройки.Элементы.Найти(Параметр.ИдентификаторПользовательскойНастройки);
                    КонецЕсли; 
                    Если Элемент &lt;> Неопределено И Элемент.Использование Тогда
                        Если Дата(Элемент.Значение) = '00010101' Тогда
                            ЗначениеПериода = Формат(ТекущаяДата(), "ДФ=dd.MM.yyyy");
                        Иначе
                            ЗначениеПериода = Формат(Дата(Элемент.Значение), "ДФ=dd.MM.yyyy"); 
                        КонецЕсли;
                        
                        Заголовок = СтрШаблон("Остатки товара %1", ЗначениеПериода);
                        КомпоновщикНастроек.Настройки.ПараметрыВывода.УстановитьЗначениеПараметра("Заголовок", Заголовок);
                    КонецЕсли;</span>	
                
                КонецПроцедуры</span>
            </pre>
        </div>
        <p>Единственное что отличается от таблицы в билете, это то что вот таким способом заголовок будет зелёныи и большим, как ему изменить начертание поменьше и цвет сменить, я не знаю, поэтому первый способ предпочтительнее.</p>
    
        <p><b>Как указывать дату для периода</b></p>
        <p>Ещё одной важной особенностью этого отчёта является то, что мы получаем остатки на начало дня указанной даты. Нам же нужно чтобы мы получали на конец дня. Как это делать мы знаем и также нужно прибавить одну секунду к концу дня. Потому что если у нас товар поступил или продали в 23:59:59, то система получит остатки только на 23:59:58 включительно, поэтому и прибавляем секунду. Для этого в параметрах для параметра "Период" в поле "Выражение" пишем:</p>
        <div class="code-style">
            <pre>
                ДобавитьКДате(КонецПериода(&Период, "День"), "Секунда", 1)
            </pre>
        </div>
        <p>Но тут возникают следующие сложности. Период, который му поставили по умолчанию имеет тип "СтандартнаяДатаНачала" и у него есть возможность указывать словами дату, например, "Начало этого дня", но мы же только что в выражении параметра привели к концу дня, получается пользователь выбирает начало этого дня, а видит результат на конец дня. Что можно предпринять? Можно создать свою форму отчёта и там задать свой реквизит "Период", задать ему тип "Дата" и вынести в элементы формы:</p>
        <img src="../img/1С-1/2025-04-10_09-43-09.png" class="screen" alt="">
        <p>Затем в схеме ограничим видимость параметра "Период", но связи между реквизитом "Период" и параметром "Период" нет. Чтобы их связать нужно лезть куда то в код, но мы не видим кода у кнопки "Сформировать". Можно открыть свойства группы "ОсновнаяКоманднаяПанель", очистить её путь "Источник команд", затем создать свою кнопку "Сформировать", разместить её в элементах формы и написать код для неё и в этом коде привязать реквизит "Период" к параметру, но на экзамене всё это делать долго. Поэтому откатимся обратно как было.</p>
        <p>Решением будет то что мы убираем всё выражение для параметра и не приводим к концу дня. И для параметра "Период" мы укажем состав даты "Дата и время". Пусть пользователь сам контролирует временем что он хочет получить. И получается это лучшее решение, как по умолчанию всё есть так пусть и будет.</p>
        <p>Но в сообщениях предложили и другое решение, можно поиграться с типом "СтандартныйПериод". Типо создать ещё один параметр, задать ему тип "СтандартныйПериод", этот параметр появится на закладке "Параметры" в настройках отчёта и у этого параметра будет 2 поля для задания начала и конца даты и вот как то тут можно это обыграть. Вот для сравнения какие различия между типами данных "СтандартнаяДатаНачала" и "СтандартныйПериод":</p>
        <img src="../img/1С-1/2025-04-10_10-15-15.png" class="screen-2" alt="">
        <p>Но с другой стороны начало и окончание нужно для оборотов, а у нас остатки.</p>
        <p>Далее доп информация. Тут могут какие то данные повторяться, я в разное время описывал.</p>
        <p>Есть одна особенность связанная с тем, что для периода есть возможность не дату указывать, а значения типа "СтандартнаяДатаНачала": "Начало этого дня", "Начало этой недели" и т.д. Если поставить "Начало этого дня", то из за того выражения, в котором мы приводим день в концу дня, мы уже получим не начало этого дня, а начало следующего дня, что уже не верно, потому что сказано же на начало этого дня нужно получить остатки. Поэтому уберём выражение выше(приводящее к концу дня) и стандартные даты будут работать как надо.</p> 
        <p>Тогда встаёт вопрос как быть с датами заданными вручную или выбранные в календаре? Они то должны учитывать остатки на конец дня. Выходом может быть указание вместе с датой времени, т.е. нужно в параметрах задать для периода состав даты с верменем. И когда пользователь будет выбирать дату, то он увидит по времени, какое время суток он выбирает. Если хочет на конец дня, то пусть временем укажет 23:59:59.</p>
        <p>Кстати, по умолчанию система как раз таки и не добавляет сама выражение привода к концу дня и состав даты тоже по умолчанию дата со временем, получается что это самое отлаженное состояние, пусть так и остаётся.</p>
        <p>И ещё случай опишу связанный с периодом отчёта. Когда мы используем заголовок из макета, а не программно описанный выше, то при снятии флажка в пользовательском режиме с периода приведёт к тому, что система посчитает период неопределённым и получит актуальные остатки из итогов. А что у нас за актуальные остатки есть в таблице итогов? Это остатки на 31 декабря 3999 года. Т.е. если у нас в системе есть документы проведённые будущим временем, то при отсутсвии флажка или указанной даты мы получим остатки и тех товаров, которые будуим временем проведённые, но их по факту ещё нет на складе. Тогда в этом случае мы на закладке "Параметры" для периода ещё поставим галочку "Запрещать незаполненные значения" и для поля "Ипользование" указать значение "Всегда". Это мы убрали флажок включение выключение периода вообще и заставляем пользователя ввести дату в поле ввода. Вот таки образом мы решили проблему получения актуальных остатков.</p>
    
        <p><b>Как указывать дату для заголовка, чтобы пользователь не вводя дату формировал самые последние остатки</b></p>
        <p>Во-первых нужно для параметра "Период" задать значение "Всегда" у свойства "Использование". Это скажется на том, что при открытии отчёта уже не нужно ставить галочку использования периода:</p>
        <img src="../img/1С-1/2025-04-09_10-23-11.png" class="screen-2" alt="">
        <p>Во-вторых в выражении параметра укажем такое выражение:</p>
        <div class="code-style">
            <pre>
                ВЫБОР 
                    КОГДА &Период = ДатаВремя(1,1,1) ТОГДА КонецПериода(ТекущаяДата(), "ДЕНЬ") 
                    ИНАЧЕ КонецПериода(&Период, "ДЕНЬ")    
                КОНЕЦ
            </pre>
        </div>
        <p>Если пользователь не водит дату, то там по умолчанию  стоит дата 01.01.0001, но на эту дату нет остатков, поэму мы в условии говорим, что если дата пустая, то вместо неё подставить текущую дату, да ещё и приведённую к концу дня. Получим такой результат:</p>
        <img src="../img/1С-1/2025-04-09_10-27-17.png" class="screen-2" alt="">
        <p>Второй способ как можно такого добиться. Этот способ, как представлял себе я. Я думал, что можно указать для параметра галочку, типо применять указанную дату по умолчанию и задать в дате "Начало завтрашнего дня" словами или датой, но почему то не работает, надо узнать:</p>
        <img src="../img/1С-1/2025-04-09_10-40-59.png" class="screen-2" alt="">
        <p>Узнал, просто до этого уже были сохранены какие то пользовательские настройки и они перебивают то что в конфигураторе я поставил, но пользователь может откатиться к стандартным настройкам через "Еще" - "Установить стандартные настройки" и мы увидим установленый по умолчанию период. Пользователь может перебить наше значение по умолчанию своим значением, просто выставляет свою дату и закрывает отчёт, система сама сохранит.</p>
    
        <p><b>Как сделать отступ слева для заголовка отчёта</b></p>
        <p>Показал 2 способа. Первый в макете просто добавляем слева пробелы для заголовка. Второй можно слева одну ячейку оставить пустой, а во второй указать заголовок и свяжем эти 2 ячейки с макетом группировки и теперь отступ слева можно настраивать растягивая первую ячейку как нам удобно.</p>
    
        <p><b>Как убрать итоги по складу</b></p>
        <p>Способ 1</p>
        <p>В билете в таблице нет итогов по складам:</p>
        <img src="../img/1С-1/2024-06-07_20-19-15.png" class="screen-2" alt="">
        <p>Как их убрать. Если у нас склад это группировочное поле, а всё остальное выводится через "Детальные записи"</p> 
        <img src="../img/1С-1/2024-06-10_09-38-34.png" class="screen-2" alt="">
        <p>то можно убрать поле "КоличествоОстаток" на закладке "Ресурсы" и тогда итог по складу уберётся</p>
        <img src="../img/1С-1/2024-06-10_09-42-46.png" class="screen-2" alt="">
        <p>Если же мы выводим без детальных записей, т.е. Склад и Номенклатура у нас как группировка</p> 
        <img src="../img/1С-1/2024-06-10_09-38-52.png" class="screen-2" alt="">
        <p>и в ресурсах мы убрали КоличествоОстаток, то в отчёте мы вообще не увидем остатки товаров.</p> 
        <img src="../img/1С-1/2024-06-10_09-43-26.png" class="screen-2" alt="">
        <p>Способ 2</p>
        <p>Так что пока только первый способ. Но это не очень правильный способ, ресурсы всё таки должны присутсвовать в отчёте. Как же убрать итог по складу? Да просто. Выносим количество, на закладке "Ресурсы", в правую сторону и в поле "Рассчитывать по ..." нужно выбрать по какому полю мы будем этот итог показывать. Сейчас не выбранно ни одно поле, а значит выводится итог для всех полей. Выберем рассчитывать по номенклатуре и всё, у склада итог уберётся.</p>
        <img src="../img/1С-1/2024-06-11_12-39-04.png" class="screen-2" alt="">
        <p>Способ 3</p>
        <p>Но у этого способа, как и у способа выше есть минус, пользователь никак не сможет поменять это, например, если ему всё же захочется вывести итог по складу. Понятно что этого достаточно для экзамена, но не экзаменом одним единым, как говорится. Нужно знать разные способы.</p>
        <p>Вообще пользователь имеет в своём распоряжении только закладку "Настройки", значит надо найти способ на этой закладке как то убрать итог по складу, чтобы пользователь мог вернуть итог. Такой способ есть.</p>
        <p>Для этого на закладке "Настройки" выберем группировку "Склад", прям там по середине окна настроек, выделим Склад, а не Отчёт и для склада на закладке "Другие настройки" в свойстве "Расположение итогов" выберем значение "Нет". Вот при этом способе пользователь уже сможет отключить наш запрет на показ итогов по складу.</p>
    
        <p><b>Как сделать жирными заголовки полей и отцентрировать их</b>.</p> 
        <p>Делается это через условное оформление отчёта. Выбираем отчёт в настройках, открываем вкладку "Условное оформление", добавляем новое оформление. В первом поле "Оформление" выберем наше оформление, это жирное начертание у свойства "Шрифт" и у свойства "Горизонтальное положение" поставить "Центрировать". Затем в поле "Оформляемые поля" выберем все наши поля - "Склад", "Номенклатура" и "Кол-во". А вдруг добавится ещё какое-то поле или поля, нам опять нужно будет лезть в это поле и добавлять вновь появившееся поля. Поэтому оставим пустым поле "Оформляемые поля", система будет понимать что все поля нужно включить. И сама фишка это поле "Область использования". Открываем её окошко, снимаем все галочки и выбираем только использование "в заголовке полей". Всё.</p>
        <img src="../img/1С-1/2024-06-10_10-25-58.png" class="screen-2" alt="">
        <p>Также можно это сделать и в макете, если мы описали заголовки в макете. Просто выделяем ячейки с заголовками полей и выравниваем их по центру и делаем жирными.</p>
    
        <p><b>Как сделать невидимыми грани заголовка отчёта</b>.</p> 
        <p>Выделяем группировку заголовка в структуре отчёта и в закладке "Другие настройки" для свойства "Макет оформления" укажем "Без оформления". Всё, видимые грани ячейки станут бесцветными. Можем сделать эти грани любого цвета теперь. В макете выделяем ячейку с заголовком и в панели иснтрументов укажем грани и зададим цвет в палитре свойств.</p>
    
        <p><b>Как сделать отступ у значений полей</b>.</p>
        <p>Не буду описывать как это делать, просто оставлю картинку, на ней будет понятно, принцип такой же через условное оформление. На начальной таблице, которая у нас как пример как нужно сделать не совсем точна, там ещё есть доработки которые надо делать, вот и делаем их. Нужно отступить у значений полей слева на 0.5. Количество будет не реагировать, потому что оно прижато к правому краю, её нужно прижать к левому и дать отступ:</p>
        <img src="../img/1С-1/2024-06-10_10-45-01.png" class="screen" alt="">
        <img src="../img/1С-1/2024-06-10_10-51-02.png" class="screen-2" alt="">
    
        <p><b>Делаем так, чтобы при указании пользователем даты по типу - "Начало ..." указывалась эта дата, в остальных случаях приводим дату к концу дня.</b></p>
        <p>Тут я хотел записать что мы делаем в 9м занятии, но там такой запутанная тема, что пришли к выводу, что не надо заморачиваться так сильно с программным кодом в обработчике "ПриКомпоновкеРезультата". Лучше оставить по простому как сейчас есть в настоящий миг в отчёте. Но если что, то код можно посмотреть в модуле объекта отчёта.</p>
    </div>

    
    <div class="spec-7">
        <p class="title-size16"><b id="spec-7">(ОУ) Контроль остатков в разрезе партии. Занятие 10. Билет №2.</b></p>
        <p>Описание задания из билета.</p>
        <p><span class="светло_синий">Компания занимается оптовой торговлей. Поступление товаров отражается документом «Приходная накладная», продажа -«Расходная накладная». Помимо продажи товара, могут оказываться дополнительные услуги, например по доставке. И услуги и товары указываются в одной табличной части.</span></p>
        <p><span class="светло_синий">Складской учет товаров не ведется.</span></p>
        <p><span class="светло_синий">В документе «Расходная накладная», в табличной части для каждого товара пользователь указывает партию, из которой необходимо списать. В том случае, если товара по указанной партии не хватает, документ не проводится и выводится соответствующее сообщение о нехватке.</span></p>
        <p>Итак, учёт в разрезе складов не ведётся. Удаляем из регистра "ОстаткиНоменклатуры" измерение "Склад". И В белете говорится, что теперь остатки номенклатуры хранятся в разрезе партии. Т.е. если в партии пришло 2 холодильника, то теперь партия выступает вместо склада, а значит в регистр "ОстаткиНоменклатуры" добавим измерение "Партия" с типом "ДокументСсылка.ПриходнаяНакладная". Когда мы будем списывать холодильники, то программно будем смотреть остатки холодильника в конкретной партии и если его не хватает, то отказываемся от проведения. </p>
        <p>Создадим регистр накопления "ОстаткиНоменклатуры_Билет2" в режиме остатков с измерениями "Номенклатура" и "Партия", а также 2 есурса - "Количество", "Себестоимость".</p>
        <p>Далее уберём реквизит "Склад" из документов приходной и расходной. В расходной накладной в табличную часть добавим реквизит "Партия". Не забываем для полей "Количество" и "Сумма" поставить проверку заполнения "Выдывать ошибку". </p>
        <p>Код приходной накладной:</p>
        <div class="code-style">
            <pre>
                <span class="светло_синий">Процедура ОбработкаПроведения(Отказ, РежимПроведения)
                    Запрос = Новый Запрос;
                    Запрос.Текст = 
                        <span class="серый">"ВЫБРАТЬ   
                        |	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
                        |	&Дата КАК Период,
                        |	ПриходнаяНакладная_Билет2СписокНоменклатуры.Номенклатура КАК Номенклатура,
                        |	ПриходнаяНакладная_Билет2СписокНоменклатуры.Ссылка КАК Партия,
                        |	СУММА(ПриходнаяНакладная_Билет2СписокНоменклатуры.Количество) КАК Количество,
                        |	СУММА(ПриходнаяНакладная_Билет2СписокНоменклатуры.Сумма) КАК Себестоимость
                        |ИЗ
                        |	Документ.ПриходнаяНакладная_Билет2.СписокНоменклатуры КАК ПриходнаяНакладная_Билет2СписокНоменклатуры
                        |ГДЕ
                        |	ПриходнаяНакладная_Билет2СписокНоменклатуры.Ссылка = &Ссылка
                        |
                        |СГРУППИРОВАТЬ ПО
                        |	ПриходнаяНакладная_Билет2СписокНоменклатуры.Номенклатура,
                        |	ПриходнаяНакладная_Билет2СписокНоменклатуры.Ссылка"</span>;
                    
                    Запрос.УстановитьПараметр(<span class="серый">"Ссылка"</span>, Ссылка);
                    Запрос.УстановитьПараметр(<span class="серый">"Дата"</span>, Дата);
                    РезультатЗапроса = Запрос.Выполнить();
                    Выборка = РезультатЗапроса.Выбрать();
                    
                    <span class="зелёный">//из-за того, что в выборке теперь есть все данные, то мы можем
                    //через метод ЗаполнитьЗначенияСвойств() заполнить данными движения</span>     
                    Движения.ОстаткиНоменклатуры_Билет2.Записывать = Истина;
                    Пока Выборка.Следующий() Цикл
                        <span class="зелёный">//регистр ОстаткиНоменклатуры_Билет2</span>
                        Движение = Движения.ОстаткиНоменклатуры_Билет2.Добавить();
                        ЗаполнитьЗначенияСвойств(Движение, Выборка);		
                    КонецЦикла;
                КонецПроцедуры</span>
            </pre>
        </div>
        <p>Теперь опишем обработчик проведения расходной накладной. Тут я по примеру одного из курсов разделил запрос. Пока мы получаем данные из табличной части, блокировку незачем ставить, вот когда получим данные и приступим к получению остатков, вот прям перед остаткими и поставим блок:</p>
        <div class="code-style">
            <pre>
                --модуль объекта документа "РасходнаяНакладная_Билет2"
                <span class="светло_синий">Процедура ОбработкаПроведения(Отказ, РежимПроведения)  
                    Движения.ОстаткиНоменклатуры_Билет2.Записать();
    
                    Движения.ОстаткиНоменклатуры_Билет2.Записывать = Истина;
                    Движения.Продажи_Билет2.Записывать = Истина;
    
                    Запрос = Новый Запрос;
                    Запрос.МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц;
                    Запрос.Текст = 
                        <span class="серый">"ВЫБРАТЬ
                        |	РасходнаяНакладная_Билет2СписокНоменклатуры.Номенклатура КАК Номенклатура,
                        |	РасходнаяНакладная_Билет2СписокНоменклатуры.Номенклатура.ВидНоменклатуры КАК ВидНоменклатуры,
                        |	РасходнаяНакладная_Билет2СписокНоменклатуры.Партия КАК Партия,
                        |	СУММА(РасходнаяНакладная_Билет2СписокНоменклатуры.Количество) КАК КоличествоПродажи,
                        |	СУММА(РасходнаяНакладная_Билет2СписокНоменклатуры.Сумма) КАК СуммаПродажи
                        |ПОМЕСТИТЬ ВТ
                        |ИЗ
                        |	Документ.РасходнаяНакладная_Билет2.СписокНоменклатуры КАК РасходнаяНакладная_Билет2СписокНоменклатуры
                        |ГДЕ
                        |	РасходнаяНакладная_Билет2СписокНоменклатуры.Ссылка = &Ссылка
                        |
                        |СГРУППИРОВАТЬ ПО
                        |	РасходнаяНакладная_Билет2СписокНоменклатуры.Номенклатура,
                        |	РасходнаяНакладная_Билет2СписокНоменклатуры.Партия,
                        |	РасходнаяНакладная_Билет2СписокНоменклатуры.Номенклатура.ВидНоменклатуры
                        |
                        |ИНДЕКСИРОВАТЬ ПО
                        |	Номенклатура,
                        |	Партия"</span>;
    
                    Запрос.УстановитьПараметр(<span class="серый">"Ссылка"</span>, Ссылка);
                    РезультатЗапроса = Запрос.Выполнить();
    
                    <span class="зелёный"></span>//теперь партии можно заблокировать, потому что нам известны эти партии
                    //из табличной части</span>
                    Блокировка = Новый БлокировкаДанных;
                    ЭлементБлокировки = Блокировка.Добавить(<span class="серый">"РегистрНакопления.ОстаткиНоменклатуры_Билет2"</span>);
                    ЭлементБлокировки.Режим = РежимБлокировкиДанных.Исключительный; 
                    ДанныеБлокировки = СписокНоменклатуры.Выгрузить(, <span class="серый">"Номенклатура, Партия"</span>);
                    ЭлементБлокировки.ИсточникДанных = ДанныеБлокировки; 
                    ЭлементБлокировки.ИспользоватьИзИсточникаДанных(<span class="серый">"Номенклатура"</span>, <span class="фиолетовый">"Номенклатура"</span>);	
                    ЭлементБлокировки.ИспользоватьИзИсточникаДанных(<span class="серый">"Партия"</span>, <span class="фиолетовый">"Партия"</span>);	
                    Блокировка.Заблокировать();             
    
                    <span class="зелёный">//итоги нам тут нужны только для регистра "Продажи"</span>
                    Запрос.Текст =
                        <span class="серый">"ВЫБРАТЬ
                        |	ВТ.Номенклатура КАК Номенклатура,
                        |	ВТ.ВидНоменклатуры КАК ВидНоменклатуры,
                        |	ПРЕДСТАВЛЕНИЕ(ВТ.Номенклатура) КАК НоменклатураП,
                        |	ВТ.Партия КАК Партия,
                        |	ВТ.Партия.Представление КАК ПартияП,
                        |	ВТ.КоличествоПродажи КАК Количество,
                        |	ВТ.СуммаПродажи КАК СуммаПродажи,
                        |	ЕСТЬNULL(ОстаткиНоменклатуры_Билет2Остатки.КоличествоОстаток, 0) КАК КоличествоОбщ,
                        |	ЕСТЬNULL(ОстаткиНоменклатуры_Билет2Остатки.СебестоимостьОстаток, 0) КАК СебестоимостьОбщ
                        |ИЗ
                        |	ВТ КАК ВТ
                        |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ОстаткиНоменклатуры_Билет2.Остатки(
                        |				&ДатаДокумента,
                        |				(Номенклатура, Партия) В
                        |					(ВЫБРАТЬ
                        |						ВТ.Номенклатура,
                        |						ВТ.Партия
                        |					ИЗ
                        |						ВТ КАК ВТ)) КАК ОстаткиНоменклатуры_Билет2Остатки
                        |		ПО ВТ.Номенклатура = ОстаткиНоменклатуры_Билет2Остатки.Номенклатура
                        |			И ВТ.Партия = ОстаткиНоменклатуры_Билет2Остатки.Парти
                        |ИТОГИ
                        |	СУММА(Количество),
                        |	СУММА(СуммаПродажи)
                        |ПО
                        |	Номенклатура"</span>;
                       
                    Если РежимПроведения= РежимПроведенияДокумента.Неоперативный Тогда
                        Запрос.УстановитьПараметр(<span class="серый">"ДатаДокумента"</span>, МоментВремени());
                    Иначе
                        Запрос.УстановитьПараметр(<span class="серый">"ДатаДокумента"</span>, Неопределено);	
                    КонецЕсли;
                    РезультатЗапроса = Запрос.Выполнить(); 
                    ВыборкаГрупп = РезультатЗапроса.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);

                    //получим значение "Товар" из перечисления "ВидыНоменклатуры"
                    ВидНоменклатурыТовар = Перечисления.ВидыНоменклатуры.Товар;
                    
                    Пока ВыборкаГрупп.Следующий() Цикл
                        ВыборкаДетальных = ВыборкаГрупп.Выбрать();
                        ИтогоСебестоимость = 0;
                        Пока ВыборкаДетальных.Следующий() Цикл
                            <span class="зелёный">//для проверки количества в партии нам нужны только товары
                            //поэтому делаем отбор только по товарам</span>
                            Если ВыборкаДетальных.ВидНоменклатуры = ВидНоменклатурыТовар Тогда
                                Если ВыборкаДетальных.Количество > ВыборкаДетальных.КоличествоОбщ Тогда
                                    СообщениеП = Новый СообщениеПользователю;
                                    СообщениеП.Текст = СтрШаблон("Не хвататет товара %1 в партии %2 в количестве %3",
                                                                ВыборкаДетальных.НоменклатураП, 
                                                                ВыборкаДетальных.ПартияП,
                                                                ВыборкаДетальных.Количество - ВыборкаДетальных.КоличествоОбщ);
                                    СообщениеП.Сообщить();
    
                                    Отказ = Истина;
                                КонецЕсли;
    
                                Если Отказ Тогда
                                    Продолжить;
                                КонецЕсли;  
                                
                                <span class="зелёный">//применяем методику "условие последнего списания"</span>
                                Если ВыборкаДетальных.Количество = ВыборкаДетальных.КоличествоОбщ Тогда
                                    Себестоимость = ВыборкаДетальных.СебестоимостьОбщ;
                                Иначе	
                                    Себестоимость = ВыборкаДетальных.Количество / ВыборкаДетальных.КоличествоОбщ * ВыборкаДетальных.СебестоимостьОбщ;
                                КонецЕсли;
    
                                Движение = Движения.ОстаткиНоменклатуры_Билет2.Добавить(); 
                                Движение.ВидДвижения = ВидДвиженияНакопления.Расход;
                                Движение.Период = Дата;
                                Движение.Номенклатура = ВыборкаДетальных.Номенклатура;
                                Движение.Партия = ВыборкаДетальных.Партия;
                                Движение.Количество = ВыборкаДетальных.Количество; 
                                Движение.Себестоимость = Себестоимость;	
                                
                                <span class="зелёный">//Прибавляем Движение.Себестоимость потому что
                                //там уже число будет приведено к тому формату, котрый мы указали в свойствах
                                //для себестоимости в регистре</span> 
                                ИтогоСебестоимость = ИтогоСебестоимость + Движение.Себестоимость;
                            КонецЕсли;	 	
                        КонецЦикла; 
    
                            
                        <span class="зелёный">//запись в регистр Продажи_Билет2</span>
                        Движение = Движения.Продажи_Билет2.Добавить(); 
                        Движение.Период = Дата;
                        Движение.Номенклатура = ВыборкаГрупп.Номенклатура;
                        Движение.Количество = ВыборкаГрупп.Количество; 
                        Движение.СуммаПродажи = ВыборкаГрупп.СуммаПродажи; 
                        Движение.Себестоимость = ИтогоСебестоимость;               
                    КонецЦикла;
                КонецПроцедуры</span>
            </pre>
        </div>
    </div>



    <div class="spec-8">
        <p class="title-size16"><b id="spec-8">Отчёт "Продажи". Занятие 10/11. Билет №2(Оперативный учёт).</b></p>
        <p>Сортировку обязательно нужно делать для отчётов. Чтобы отсортировать по полю "Номенклатура" нужно выбрать не отчёт, а группировку "Детальные записи" и в ней уже на закладке "Сортировка" перенести поле "Номенклатура" вправо и выбрать метод упорядочивания. По умолчанию по возрастанию. Ну конечно нужно по отчёту в билете понять, нужно его отсортировать по какому то полю или нет. Если посмотреть на таблицу отчёта этого билета, то на первый взгляд покажется, что ничего не отсортировано по номенклатуре, но это не так, тут упорядочено сначала по виду номенклатуры, а потом по номенклатуре. </p>
        <p>Итак, смотрим что нам нужно получить в отчёте в билете 2.</p>
        <p>Чтобы составить такой отчёт, нам нужен регистр накопления "Продажи" в режиме "обороты". Будем получать количество и сумму продажи в разрезе номенклатуры.</p>
        <p>Далее укажем, кто будет регистратором для этого регистра. Это будет расходная накладная. Идём в модуль объекта расходной и в обработке проведения добавим записи в этот регистр. Нужно будет добавить в запросе получение суммы продажи из табличной части и сделать записи в регистр. Описано это будет в конфе, в названии документа будет указан билет, вот там и смотреть.</p>
        <p>Как сказал Леонтьев, то для этого регистра не надо делать очищение дввижение и блокировки тоже не нужны. Я тут немного понял для чего мы очищаем движения при контроле остатков. На самом деле при перепроведении документа система удаляет старые движения и записывает новые, но делает это наверно под конец процедуры обработка проведения. Проэтому при контроле остатков нам уже в начале процедуры нужно очистить движения, чтобы запросом мы не учитывали старые записи в регистре. Из регистра продажи мы никаких данных не получаем, а потому и нет необходимости в начале очищать движения.</p>
        <p>Также если посомтреть на таблицу отчёта в билете, то видим там есть услуга, которая тоже должна быть в регистре продажи. Для этого придётся немного изменить запрос, чтобы мы получали услуги тоже. Из старого запроса уберём условие, где мы получали только товар, затем добавим получение такого поля как "ВидНоменклатуры", который нам будет говорить, что за номенклатура в записи. И также сделаем отбор только по товарам из виртуальной таблицы. Вобщем смотреть в конфе в модуле объекта расходной накладной для билета 2.</p>
        <p>Почитал сообщения под видео и там один человек сказал, что отбор в виртуальной таблице только товаров не нужен. Если так подумать, то он и вправду не нужен, потому что в регистре остатков в принципе нет номенклатуры с видом "услуга". При приходовании мы услуги туда не пишем, а в расходной мы пишем в остатки тоже только товары, благодаря условию проверки на товар.</p>
        <p>Далее в отчёте в таблице видно, что есть поле "Себестоимость" и это поле есть в регистре "ОстаткиНоменклатуры". Чтобы нам было легко построить отчёт "Продажи" мы добавим в регистр такое поле. Это решение кажется спорным, но зато нам уже не надо соединять 2 таблицы для получения полей, все поля будут в одном регистре, т.е. это мы сделали для отладки получения отчёта. </p>
        <p>Вот так обработка проведения изменилась после добавления регистра продажи:</p>
        <div class="code-style">
            <pre>
                Процедура ОбработкаПроведения(Отказ, РежимПроведения)  
                    Движения.ОстаткиНоменклатуры_Билет2.Очистить();
                    Движения.ОстаткиНоменклатуры_Билет2.Записать();
    
                    Движения.ОстаткиНоменклатуры_Билет2.Записывать = Истина;
                    Движения.Продажи_Билет2.Записывать = Истина;
    
                    Запрос = Новый Запрос;
                    Запрос.МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц;
                    Запрос.Текст = 
                        <span class="фиолетовый">"ВЫБРАТЬ
                        |	РасходнаяНакладная_Билет2СписокНоменклатуры.Номенклатура КАК Номенклатура,
                        |	РасходнаяНакладная_Билет2СписокНоменклатуры.Номенклатура.ВидНоменклатуры КАК ВидНоменклатуры,
                        |	РасходнаяНакладная_Билет2СписокНоменклатуры.Партия КАК Партия,
                        |	СУММА(РасходнаяНакладная_Билет2СписокНоменклатуры.Количество) КАК КоличествоПродажи,
                        |	СУММА(РасходнаяНакладная_Билет2СписокНоменклатуры.Сумма) КАК СуммаПродажи
                        |ПОМЕСТИТЬ ВТ
                        |ИЗ
                        |	Документ.РасходнаяНакладная_Билет2.СписокНоменклатуры КАК РасходнаяНакладная_Билет2СписокНоменклатуры
                        |ГДЕ
                        |	РасходнаяНакладная_Билет2СписокНоменклатуры.Ссылка = &Ссылка
                        |
                        |СГРУППИРОВАТЬ ПО
                        |	РасходнаяНакладная_Билет2СписокНоменклатуры.Номенклатура,
                        |	РасходнаяНакладная_Билет2СписокНоменклатуры.Партия,
                        |	РасходнаяНакладная_Билет2СписокНоменклатуры.Номенклатура.ВидНоменклатуры"</span>;
    
                    Запрос.УстановитьПараметр(<span class="фиолетовый">"Ссылка"</span>, Ссылка);
                    РезультатЗапроса = Запрос.Выполнить();
    
                    Блокировка = Новый БлокировкаДанных;
                    ЭлементБлокировки = Блокировка.Добавить(<span class="фиолетовый">"РегистрНакопления.ОстаткиНоменклатуры_Билет2"</span>);
                    ЭлементБлокировки.Режим = РежимБлокировкиДанных.Исключительный; 
                    ДанныеБлокировки = СписокНоменклатуры.Выгрузить(, <span class="фиолетовый">"Номенклатура, Партия"</span>);
                    ЭлементБлокировки.ИсточникДанных = ДанныеБлокировки; 
                    ЭлементБлокировки.ИспользоватьИзИсточникаДанных(<span class="фиолетовый">"Номенклатура"</span>, <span class="фиолетовый">"Номенклатура"</span>);
                    <span class="зелёный">//в этом решении партии обязательно нужно блокировать</span>	
                    ЭлементБлокировки.ИспользоватьИзИсточникаДанных(<span class="фиолетовый">"Партия"</span>, <span class="фиолетовый">"Партия"</span>);	
                    Блокировка.Заблокировать();             
    
                
                    Запрос.Текст =
                        <span class="фиолетовый">"ВЫБРАТЬ
                        |	ВТ.Номенклатура КАК Номенклатура,
                        |	ВТ.ВидНоменклатуры КАК ВидНоменклатуры,
                        |	ПРЕДСТАВЛЕНИЕ(ВТ.Номенклатура) КАК НоменклатураП,
                        |	ВТ.Партия КАК Партия,
                        |	ВТ.Партия.Представление КАК ПартияП,
                        |	ВТ.КоличествоПродажи КАК Количество,
                        |	ВТ.СуммаПродажи КАК СуммаПродажи,
                        |	ЕСТЬNULL(ОстаткиНоменклатуры_Билет2Остатки.КоличествоОстаток, 0) КАК КоличествоОбщ,
                        |	ЕСТЬNULL(ОстаткиНоменклатуры_Билет2Остатки.СебестоимостьОстаток, 0) КАК СебестоимостьОбщ
                        |ИЗ
                        |	ВТ КАК ВТ
                        |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ОстаткиНоменклатуры_Билет2.Остатки(
                        |				&ДатаДокумента,
                        |				(Партия, Номенклатура) В
                        |					(ВЫБРАТЬ
                        |						ВТ.Партия,
                        |						ВТ.Номенклатура
                        |					ИЗ
                        |						ВТ КАК ВТ)) КАК ОстаткиНоменклатуры_Билет2Остатки
                        |		ПО ВТ.Номенклатура = ОстаткиНоменклатуры_Билет2Остатки.Номенклатура
                        |ИТОГИ
                        |	СУММА(Количество),
                        |	СУММА(СуммаПродажи)
                        |ПО
                        |	Номенклатура"</span>;
                    
                    Запрос.УстановитьПараметр(<span class="фиолетовый">"Ссылка"</span>, Ссылка);   
                    Если РежимПроведения= РежимПроведенияДокумента.Неоперативный Тогда
                        Запрос.УстановитьПараметр(<span class="фиолетовый">"ДатаДокумента"</span>, МоментВремени());
                    Иначе
                        Запрос.УстановитьПараметр(<span class="фиолетовый">"ДатаДокумента"</span>, Неопределено);	
                    КонецЕсли;
                    РезультатЗапроса = Запрос.Выполнить(); 
    
                        
                    Если НЕ РезультатЗапроса.Пустой() Тогда
                        ВыборкаГрупп = РезультатЗапроса.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
                
                        Пока ВыборкаГрупп.Следующий() Цикл
                            ВыборкаДетальных = ВыборкаГрупп.Выбрать();
                            ИтогоСебестоимость = 0;
                            Пока ВыборкаДетальных.Следующий() Цикл
                                Если ВыборкаДетальных.ВидНоменклатуры = Перечисления.ВидыНоменклатуры.Товар Тогда
                                    Если ВыборкаДетальных.Количество > ВыборкаДетальных.КоличествоОбщ Тогда
                                        СообщениеП = Новый СообщениеПользователю;
                                        СообщениеП.Текст = СтрШаблон("Не хвататет товара %1 в партии %2 в количестве %3",
                                                                    ВыборкаДетальных.НоменклатураП, 
                                                                    ВыборкаДетальных.ПартияП,
                                                                    ВыборкаДетальных.Количество - ВыборкаДетальных.КоличествоОбщ);
                                        СообщениеП.Сообщить();
    
                                        Отказ = Истина;
                                    КонецЕсли;
    
                                    Если Отказ Тогда
                                        Продолжить;
                                    КонецЕсли;  
                                    
                                    <span class="зелёный">//применяем методику "условие последнего списания"</span>
                                    Если ВыборкаДетальных.Количество = ВыборкаДетальных.КоличествоОбщ Тогда
                                        Себестоимость = ВыборкаДетальных.СебестоимостьОбщ;
                                    Иначе	
                                        Себестоимость = ВыборкаДетальных.СебестоимостьОбщ / ВыборкаДетальных.КоличествоОбщ * ВыборкаДетальных.Количество;
                                    КонецЕсли;
    
                                    Движение = Движения.ОстаткиНоменклатуры_Билет2.Добавить(); 
                                    Движение.ВидДвижения = ВидДвиженияНакопления.Расход;
                                    Движение.Период = Дата;
                                    Движение.Номенклатура = ВыборкаДетальных.Номенклатура;
                                    Движение.Партия = ВыборкаДетальных.Партия;
                                    Движение.Количество = ВыборкаДетальных.Количество; 
                                    Движение.Себестоимость = Себестоимость;	
    
                                    <span class="зелёный">//можно для регистра "продажи" и отдельно посчитать себестоимость, 
                                    //но тогда нужно будет и итогги по ней получить, а можно вот так
                                    //просто накопить себестоимость из всех детальным и записать </span>
                                    ИтогоСебестоимость = ИтогоСебестоимость + Себестоимость;					
                                КонецЕсли;	 	
                            КонецЦикла; 
    
                                
                            <span class="зелёный">//запись в регистр Продажи_Билет2</span>
                            Движение = Движения.Продажи_Билет2.Добавить(); 
                            Движение.Период = Дата;
                            Движение.Номенклатура = ВыборкаГрупп.Номенклатура;
                            Движение.Количество = ВыборкаГрупп.Количество; 
                            Движение.СуммаПродажи = ВыборкаГрупп.СуммаПродажи; 
                            Движение.Себестоимость = ИтогоСебестоимость;               
                        КонецЦикла;
                    КонецЕсли;
                КонецПроцедуры
            </pre>
        </div>
        <p>Всё готово, чтобы начать составлять отчёт. Для отчёта все данные мы подготовили в одном регистре "Продажи". Остальные поля вычисляемые. Опишу что это за поля.</p>
        <p>В системе 2 проведённых документа "РасходнаяНакладная". В обоих документах мы продали рыбу "Абудефдуф" и "Бодиан дианы". </p>
        <p><span class="светло_синий">Интервал</span> - это промежуток между продажами одного товара. Вычисляется по формуле: («Дата первой отгрузки» -«Дата последней отгрузки») / «количество отгрузок». Чтобы посмотреть когда товар был продан, нужно в запросе у виртуальной таблицы "Продажи.Обороты" в параметре "Периодичность" установить "Авто" и тогда нам станут доступны другие поля. Если выбрать "ПериодДень", то увидим дату приведённую к началу дня, когда товар продали. Выберем это поле и получим такую таблицу:</p>
        <img src="../img/1С-1/2024-06-17_08-58-34.png" class="screen" alt="">
        <p>В таблице видим поле "ПериодДень", который показывает день отгрузки товара. Если смотреть на формулу получения промежутка, то нам нужно день первой отгрузки и день последней отгрузки. Как получить такие поля? Для начала получим день первой отгрузки. День первой отгрузки это самая меньшая дата отгрузки для товара, значит нам нужно к полю "ПериодДня" применить агрегатную функцию МИНИМУМ(), а это значит нам нужно сгруппировать запрос и остальные поля тоже куда то притулить. Напишем такой запрос:</p>
        <div class="code-style">
            <pre>
                ВЫБРАТЬ
                    Продажи_Билет2Обороты.Номенклатура КАК Номенклатура,
                    СУММА(Продажи_Билет2Обороты.КоличествоОборот) КАК КоличествоОборот,
                    СУММА(Продажи_Билет2Обороты.СуммаПродажиОборот) КАК СуммаПродажиОборот,
                    СУММА(Продажи_Билет2Обороты.СебестоимостьОборот) КАК СебестоимостьОборот,
                    МИНИМУМ(Продажи_Билет2Обороты.ПериодДень) КАК ДеньПервойОтгрузки
                ИЗ
                    РегистрНакопления.Продажи_Билет2.Обороты(, , Авто, ) КАК Продажи_Билет2Обороты
    
                СГРУППИРОВАТЬ ПО
                    Продажи_Билет2Обороты.Номенклатура
            </pre>
        </div>
        <p>Му просуммировали все поля, к периоду дня применили функцию минимум и сгруппировали по единственному измерению "Номенклатура". Дадим полю "ПериодДня" псевдоимя "ДатаПервойОтгрузки": </p>
        <img src="../img/1С-1/2024-06-17_09-10-47.png" class="screen" alt="">
        <p>Видим, что таблица сгруппировалась и для каждого товара указана самая меньшая дата проведения расходной накладной, а значит это дата первой отгрузки товара.</p>
        <p>Дату последней отгрузки товара делаем через добавление ещё одного поля "ПериодДня", только уже применяем функцию МАКСИМУМ() и называем это поле "ДеньПоследнейОтгрузки": </p>
        <img src="../img/1С-1/2024-06-17_09-31-57.png" class="screen" alt="">
        <p>Так для формулы мы получили день первой отгрузки и день последней отгрузки, также для формулы нужно "количество отгрузок". Что это такое? Это количество расходных документов, которые продали данные товары. У нас также после включения периодичности в "Авто" теперь доступно поле "Регистратор", это и есть документ отгрузки. Добавим его и применим к нему функцию КОЛИЧЕСТВО РАЗЛИЧНЫЕ. Это позволит нам указать для каждого товара количество документов, которые их провели, но без повторений: </p>
        <img src="../img/1С-1/2024-06-17_09-40-29.png" class="screen" alt="">
        <p>Итоговый запрос у нас такой:</p>
        <div class="code-style">
            <pre>
                ВЫБРАТЬ
                    Продажи_Билет2Обороты.Номенклатура КАК Номенклатура,
                    СУММА(Продажи_Билет2Обороты.КоличествоОборот) КАК КоличествоОборот,
                    СУММА(Продажи_Билет2Обороты.СуммаПродажиОборот) КАК СуммаПродажиОборот,
                    СУММА(Продажи_Билет2Обороты.СебестоимостьОборот) КАК СебестоимостьОборот,
                    МИНИМУМ(Продажи_Билет2Обороты.ПериодДень) КАК ДеньПервойОтгрузки,
                    МАКСИМУМ(Продажи_Билет2Обороты.ПериодДень) КАК ДеньПоследнейОтгрузки,
                    КОЛИЧЕСТВО(РАЗЛИЧНЫЕ Продажи_Билет2Обороты.Регистратор) КАК КоличествоОтгрузок
                ИЗ
                    РегистрНакопления.Продажи_Билет2.Обороты(, , Авто, ) КАК Продажи_Билет2Обороты
    
                СГРУППИРОВАТЬ ПО
                    Продажи_Билет2Обороты.Номенклатура
            </pre>
        </div>
        <p>Всё, мы получили все поля для вычисления поля "Интервал". Также в условии задачи написано, что если отгрузка была всего одна, то заменяем на слово "Разовая".</p>
    
        <p><span class="светло_синий">Срок</span> - это показатель в днях, как давно прошла последняя отгрузка от конечной даты сформированного отчёта. Вычисляется по формуле: «Конец периода отчета» -«Дата последнего документа отгрузки». Если в отчёте стоит дата "конца периода" на текущий миг, то значит нужно высчитать сколько дней прошло от последней отгрузки до текущего дня. Дата последней отгрузки у нас уже есть, дата конца периода отчёта тоже есть. </p>
        <hr>
        <p>Далее в самом отчёте нам нужно сделать вычисляемые поля. С полем "Прибыль" ничего сложного. А вот для поля "Интервал" для вычитания дат применим выражение языка СКД - "РазностьДат()". Третьим параметром этого выражения указывается тип результата(секунда, минута, день и т.д.). Чтобы не путаться, какая дата первым параметром, какая вторым, нужно первым параметром указывать меньшую дату, вторым парамтером дату старше. Также у нас есть условие, когда отгрузка одна, значит нужно применить ВЫБОР КОГДА: </p>
        <div class="code-style">
            <pre>
                ВЫБОР 
                    КОГДА  КоличествоОтгрузок = 1 ТОГДА 
                        "Разовая" 
                    ИНАЧЕ 
                        РазностьДат(ДеньПервойОтгрузки, ДеньПоследнейОтгрузки, "День") / КоличествоОтгрузок 
                КОНЕЦ 
            </pre>
        </div>
        <p>Для вычисления поля "Срок" нужны данные конца периода отчёта, их можно взять из параметра вирт. таблицы "КонецПериода", но вот просто таким словом "КонецПериода" нельзя тут пользоваться, система не поймёт, нужно указать, что это не поле, а параметр и добавить амперсанд. Хоть и в формуле и говорится, что нужно от конца периода отнять последнюю отгрузку, но в выражении РазностьДат() первым параметром мы указываем меньшую дату, а это последняя отгрузка, затем дату старше, это конец периода отчёта. Ошибки прям не будет, если мы поменяем местами, просто получится число с минусом: </p>
        <div class="code-style">
            <pre>
                РазностьДат(ДеньПоследнейОтгрузки, &КонецПериода, "День")
            </pre>
        </div>
        <p>Вот такие вычисляемые поля получились:</p>
        <img src="../img/1С-1/2024-06-17_10-37-26.png" class="screen" alt="">
        <p>Кстати, можно слово "Разовая" выводить в поле через условное оформление на закладке "Настройки". Я не понял как это сделать, ну через оформление можно по условию поменять шрифт, цвет, размер, отступы и так далее, но чтобы задавать текст такого не встречал. Леонтьев тоже не показал как это делать. </p>
        <hr>
        <p>Теперь по вкладке "Ресурсы". Если посмотреть на таблицу в билете, то там нет никаких итогов, а значит и ресурсы никакие выбирать не нужно. Но когда в настоящей жизни встречается такой случай, когда нет итогов, то всё равно нужно вынести главные ресурсы, чтобы у пользователя была возможность их включить. Какие тут ресурсы самые главные? Это "КоличествоОборот", "Прибыль", "СуммаПродажиОборот" и "СебестоимостьОборот". Выберем их. </p>
        <p>Далее идём в закладку "Параметры", у нас тут по умолчанию система вывела 2 параметра виртуально таблицы Обороты - "НачалоПериода" и "КонецПериода". Если вынести эти параметры в пользовательские настройки, то как говорит Леонтьев, они не очень удобны для выбирания дат. Лучше всего добавить ещё один параметр, наш, назвать его "Период" и дать ему тип данных "СтандартныйПериод". Вот так выглядит выбор из этого периода в пользовательских настройках: </p>
        <img src="../img/1С-1/2024-06-17_16-28-07.png" class="screen" alt="">
        <p>Но у нас запрос берёт данные дат именно из параметров "НачалоПериода" и "КонецПериода", поэтому нужно связать наш параметр с этими двумя параметрами. Для этого в поле "Выражение" у параметров вирт. таблицы пишем следующее: </p>
        <img src="../img/1С-1/2024-06-17_16-36-21.png" class="screen" alt="">
        <p>Из-за того, что наш параметр имеет тип данных "СтандартныйПериод", у него теперь есть определённые свойства такие как - "ДатаНачала" и "ДатаОкончания". Эти свойства будут содержать те даты, которые мы укажем в поле "Период" на картинке выше. И мы эти значения свойств передаём в параметры вирт. таблицы вот таким образом, как показано на картинке. Естественно нам теперь нужно спрятать параметры вирт. таблицы "НачалоПериода" и "КонецПериода" поставив у них галочки в поле "Ограничение доступности". Также запретим пользователю указывать пустой период и сделаем так, чтобы наш период всегда был включен.  </p>
        <hr>
        <p>Теперь идём на закладку "Настройки" и выводим просто детальные записи, затем выбираем поля вправо, которые мы хотим видеть в отчёте. Кстати, в полях в левой колонке:</p>
        <img src="../img/1С-1/2024-06-17_19-12-42.png" class="screen" alt="">
        <p>мы видим поля, которые мы получили для вычисления других полей. Но нам они в этой колонке в принципе не нужны, чтобы глаз не мозолили, да и пользователю они тоже не нужны, поэтому можно сделать так, чтобы мы их не видели в этой колонке. Это делается на закладке "НаборДанных":</p>
        <img src="../img/1С-1/2024-06-17_20-14-59.png" class="screen-2" alt="">
        <hr>
        <p>Итак сходим посомтрим, что там за отчёт у нас получается. Заголовок я уже ранее сделал через макет, как показывал Леонтьев в первом отчёте по остаткам:</p>
        <img src="../img/1С-1/2024-06-17_20-46-57.png" class="screen" alt="">
        <p>Видим, что "Интервал" и "Срок" почему то стоят после "Номенклатуры", хотя в выбранных полях они стоят последние. Если посмотреть на пиктограмму у этих полей, то они отмечены как измерения:  </p>
        <img src="../img/1С-1/2024-06-17_20-52-30.png" class="screen-2" alt="">
        <p>И также посмотрим вот на это свойство на закладке "Другие настройки" у отчёта:  </p>
        <img src="../img/1С-1/2024-06-17_20-54-18.png" class="screen-2" alt="">
        <p>Это свойство говорит о том, что ресурсы(с пиктограммой зелёного столбика) находятся после всех полей(с пиктограммой синей полоски). А "Интервал" и "Срок" как то попали в измерения, хотя поле "Прибыль" стало ресурсом. Пока я не понимаю как это происходит. Могу предположить, что для вычисления поля "Прибыль" использовались поля ресурсы, а для вычисления "Интервал" и "Срок" использовались просто добавочные поля, которые ресурсами не являются, поэтому так их и пометила система. </p>
        <p>Всё, он объяснил как они системой определяются, что поля, а что ресурсы. Моё предположение не правильное. Ресурсы это те поля, которые выбраны у нас на закладке "Ресурсы", а у нас там выбрано 4 поля, вот они системой и обозначаются как ресурсы, все остальные просто поля.</p>
        <p>Итак выбираем значение "Не использовать" у этого свойства и тогда поля разместятся так, как они выбранны в выбранных полях. Теперь если запустить отчёт, то увидим правильный порядок полей.  </p>
        <p>Дальше делаем разные условные оформления для заголовков полей, для полей.</p>
        <p>Ещё отмечу, что если мы в условном оформлении указали формат, то он будет перебивать тот формат, что задан для ячейки заголовка в макете. Поэтому либо в условном более точечно нужно формат задавать, чтобы заголовок отчёта не затрагивался, либо  в макете для заголовка задать формат конкретно для каждого параметра заголовка. Если что смотреть в конфе в отчёте "Продажи".</p>
        <p>На этом по этому отчёту пока всё.</p>
        <hr>
        <p>Ещё один миг, в чате сказали, что нужно поле "Срок" указывать только для товаров. Мы в запросе получаем вид номенклатуры и затем в выражении вычисляемого поля через условие пишем, что для товаров отображать срок, для услуг нет. </p>
        <p>Под конец сделали сортировку по номенклатуре.</p>
    </div>



    <div class="spec-9">
        <p class="title-size16"><b id="spec-9">Расчёт себестоимости по средней и ФИФО. Занятие 12. Билет №3(Оперативный учёт).</b></p>
        <p>Итак, у нас в билете задача такая, чтобы при выборе учётной политики проводить документ и списывать товары в соотвествии с данными учётной политики. Списывать товары нужно либо по средней, либо по ФИФО. Первое что приходит в голову это по условию в обработке проведения выполнять код списания по средней или по ФИФО. Вот этот код:</p>
        <div class="code-style">
            <pre>
                Процедура ОбработкаПроведения(Отказ, РежимПроведения)   
                    <span class="зелёный">//получаем метод списания товаров. Этот код вынесли в общий модуль "УчетнаяПолитика"
                    Запрос = Новый Запрос;
                    Запрос.Текст = 
                        "ВЫБРАТЬ
                        |	УчетнаяПолитика_Билет3СрезПоследних.МетодСписанияСебестоимости КАК МетодСписанияСебестоимости
                        |ИЗ
                        |	РегистрСведений.УчетнаяПолитика_Билет3.СрезПоследних(&Период, ) КАК УчетнаяПолитика_Билет3СрезПоследних";
                    
                    Запрос.УстановитьПараметр("Период", Дата);
                    РезультатЗапроса = Запрос.Выполнить(); 
                    
                    Если РезультатЗапроса.Пустой() Тогда
                        Сообщение = Новый СообщениеПользователю;
                        Сообщение.Текст = "Не указан метод списания";
                        Сообщение.Сообщить();
                        
                        Отказ = Истина;
                        Возврат;
                    Иначе
                        ВыборкаМетода = РезультатЗапроса.Выбрать();
                        ВыборкаМетода.Следующий();
                        Если ВыборкаМетода.МетодСписанияСебестоимости = Перечисления.УчетнаяПолитика_Билет3.ФИФО Тогда
                            ПараметрСписания = "ФИФО";
                        Иначе
                            ПараметрСписания = "ПоСредней";
                        КонецЕсли;
                    КонецЕсли;</span>
    
                    МетодСписания = УчетнаяПолитика.ПолучитьМетодСписанияСебестоимости(Дата);
    
                    Если МетодСписания = Неопределено Тогда
                        Сообщить("Не указан метод списания");  
                        Отказ = Истина;
                        Возврат;
                    КонецЕсли;
    
    
                    Движения.ОстаткиНоменклатуры_Билет3.Очистить();
                    Движения.ОстаткиНоменклатуры_Билет3.Записать();
    
                    Движения.ОстаткиНоменклатуры_Билет3.Записывать = Истина;
    
    
                    Запрос = Новый Запрос;
                    Запрос.МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц;
                    Запрос.Текст = 
                        <span class="фиолетовый">"ВЫБРАТЬ
                        |	РасходнаяНакладная_Билет3СписокНоменклатуры.Номенклатура КАК Номенклатура,
                        |	РасходнаяНакладная_Билет3СписокНоменклатуры.Номенклатура.ВидНоменклатуры КАК ВидНоменклатуры,
                        |	СУММА(РасходнаяНакладная_Билет3СписокНоменклатуры.Количество) КАК КоличествоПродажи
                        |ПОМЕСТИТЬ ВТ
                        |ИЗ
                        |	Документ.РасходнаяНакладная_Билет3.СписокНоменклатуры КАК РасходнаяНакладная_Билет3СписокНоменклатуры
                        |ГДЕ
                        |	РасходнаяНакладная_Билет3СписокНоменклатуры.Ссылка = &Ссылка
                        |
                        |СГРУППИРОВАТЬ ПО
                        |	РасходнаяНакладная_Билет3СписокНоменклатуры.Номенклатура,
                        |	РасходнаяНакладная_Билет3СписокНоменклатуры.Номенклатура.ВидНоменклатуры"</span>;
    
                    Запрос.УстановитьПараметр(<span class="фиолетовый">"Ссылка"</span>, Ссылка);
                    РезультатЗапроса = Запрос.Выполнить();
    
                    Блокировка = Новый БлокировкаДанных;
                    ЭлементБлокировки = Блокировка.Добавить(<span class="фиолетовый">"РегистрНакопления.ОстаткиНоменклатуры_Билет3"</span>);
                    ЭлементБлокировки.Режим = РежимБлокировкиДанных.Исключительный; 
                    ДанныеБлокировки = СписокНоменклатуры.Выгрузить(, <span class="фиолетовый">"Номенклатура"</span>);
                    ЭлементБлокировки.ИсточникДанных = ДанныеБлокировки; 
                    ЭлементБлокировки.ИспользоватьИзИсточникаДанных(<span class="фиолетовый">"Номенклатура"</span>, <span class="фиолетовый">"Номенклатура"</span>);
                    Блокировка.Заблокировать();             
    
                    ТекстЗапросаПоСредней = 
                        <span class="фиолетовый">"ВЫБРАТЬ
                        |	ВТ.Номенклатура КАК Номенклатура,
                        |	ВТ.ВидНоменклатуры КАК ВидНоменклатуры,
                        |	ПРЕДСТАВЛЕНИЕ(ВТ.Номенклатура) КАК НоменклатураП,
                        |	ВТ.КоличествоПродажи КАК Количество,
                        |	ЕСТЬNULL(ОстаткиНоменклатуры_Билет3Остатки.КоличествоОстаток, 0) КАК КоличествоОбщ,
                        |	ЕСТЬNULL(ОстаткиНоменклатуры_Билет3Остатки.СебестоимостьОстаток, 0) КАК СебестоимостьОбщ
                        |ИЗ
                        |	ВТ КАК ВТ
                        |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ОстаткиНоменклатуры_Билет3.Остатки(
                        |				&ДатаДокумента,
                        |				Номенклатура В
                        |					(ВЫБРАТЬ
                        |						ВТ.Номенклатура
                        |					ИЗ
                        |						ВТ КАК ВТ)) КАК ОстаткиНоменклатуры_Билет3Остатки
                        |		ПО ВТ.Номенклатура = ОстаткиНоменклатуры_Билет3Остатки.Номенклатура"</span>;   
    
                    ТекстЗапросаФИФО = 
                        <span class="фиолетовый">"ВЫБРАТЬ
                        |	ВТ.Номенклатура КАК Номенклатура,
                        |	ВТ.ВидНоменклатуры КАК ВидНоменклатуры,
                        |	ПРЕДСТАВЛЕНИЕ(ВТ.Номенклатура) КАК НоменклатураП,
                        |	ВТ.КоличествоПродажи КАК Количество,  
                        |	ОстаткиНоменклатуры_Билет3Остатки.Партия КАК Партия,
                        |	ЕСТЬNULL(ОстаткиНоменклатуры_Билет3Остатки.КоличествоОстаток, 0) КАК КоличествоОбщ,
                        |	ЕСТЬNULL(ОстаткиНоменклатуры_Билет3Остатки.СебестоимостьОстаток, 0) КАК СебестоимостьОбщ
                        |ИЗ
                        |	ВТ КАК ВТ
                        |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ОстаткиНоменклатуры_Билет3.Остатки(
                        |				&ДатаДокумента,
                        |				Номенклатура В
                        |					(ВЫБРАТЬ
                        |						ВТ.Номенклатура
                        |					ИЗ
                        |						ВТ КАК ВТ)) КАК ОстаткиНоменклатуры_Билет3Остатки
                        |		ПО ВТ.Номенклатура = ОстаткиНоменклатуры_Билет3Остатки.Номенклатура 
                        |
                        |УПОРЯДОЧИТЬ ПО
                        |	ОстаткиНоменклатуры_Билет3Остатки.Партия.МоментВремени
                        |ИТОГИ
                        |	МИНИМУМ(Количество),
                        |	СУММА(КоличествоОбщ)
                        |ПО
                        |	Номенклатура"</span>;
    
                    Если МетодСписания = <span class="фиолетовый">"ФИФО"</span> Тогда
                        Запрос.Текст = ТекстЗапросаФИФО;
                    Иначе
                        Запрос.Текст = ТекстЗапросаПоСредней;
                    КонецЕсли;
                    
                    Запрос.УстановитьПараметр(<span class="фиолетовый">"Ссылка"</span>, Ссылка);   
                    Если РежимПроведения= РежимПроведенияДокумента.Неоперативный Тогда
                        Запрос.УстановитьПараметр(<span class="фиолетовый">"ДатаДокумента"</span>, МоментВремени());
                    Иначе
                        Запрос.УстановитьПараметр(<span class="фиолетовый">"ДатаДокумента"</span>, Неопределено);	
                    КонецЕсли;
                    РезультатЗапроса = Запрос.Выполнить(); 
    
                        
                    Если НЕ РезультатЗапроса.Пустой() Тогда 
                        Если МетодСписания = <span class="фиолетовый">"ФИФО"</span> Тогда
                            ВыборкаГрупп = РезультатЗапроса.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
                            Пока ВыборкаГрупп.Следующий() Цикл 
                                Если ВыборкаГрупп.Количество > ВыборкаГрупп.КоличествоОбщ Тогда
                                    СообщениеП = Новый СообщениеПользователю;
                                    СообщениеП.Текст = СтрШаблон(<span class="фиолетовый">"Не хватает товара %1 в количестве %2"</span>,
                                                                    ВыборкаГрупп.НоменклатураП,
                                                                    (ВыборкаГрупп.Количество - ВыборкаГрупп.КоличествоОбщ)); 
                                    СообщениеП.Сообщить();
    
                                    Отказ = Истина;			
                                КонецЕсли;     
    
                                Если Отказ Тогда
                                    Продолжить;
                                КонецЕсли;
    
                                СписываемоеКоличество = ВыборкаГрупп.Количество; 
    
                                ВыборкаДетальных = ВыборкаГрупп.Выбрать();   
                                Пока ВыборкаДетальных.Следующий() Цикл 
                                    Если ВыборкаДетальных.ВидНоменклатуры = Перечисления.ВидыНоменклатуры.Товар Тогда 
                                        Если СписываемоеКоличество > 0 Тогда
                                            Движение = Движения.ОстаткиНоменклатуры_Билет3.Добавить(); 
                                            Движение.ВидДвижения = ВидДвиженияНакопления.Расход;
                                            Движение.Период = Дата;
                                            Движение.Номенклатура = ВыборкаДетальных.Номенклатура;
                                            Движение.Партия = ВыборкаДетальных.Партия;
                                        
                                            Если СписываемоеКоличество &lt; ВыборкаДетальных.КоличествоОбщ Тогда
                                                Движение.Количество = СписываемоеКоличество;
                                                Движение.Себестоимость = СписываемоеКоличество / ВыборкаДетальных.КоличествоОбщ * ВыборкаДетальных.СебестоимостьОбщ;
                                                СписываемоеКоличество = СписываемоеКоличество - СписываемоеКоличество; 
                                            Иначе
                                                Движение.Количество = ВыборкаДетальных.КоличествоОбщ;
                                                Движение.Себестоимость = ВыборкаДетальных.СебестоимостьОбщ;
                                                СписываемоеКоличество = СписываемоеКоличество - ВыборкаДетальных.КоличествоОбщ;
                                            КонецЕсли;
    
                                        КонецЕсли;
                                    КонецЕсли;		
                                КонецЦикла; 
                            КонецЦикла;	
                        Иначе   
                            ВыборкаДетальных = РезультатЗапроса.Выбрать();
                            Пока ВыборкаДетальных.Следующий() Цикл
                                Если ВыборкаДетальных.ВидНоменклатуры = Перечисления.ВидыНоменклатуры.Товар Тогда
                                    Если ВыборкаДетальных.Количество > ВыборкаДетальных.КоличествоОбщ Тогда
                                        СообщениеП = Новый СообщениеПользователю;
                                        СообщениеП.Текст = СтрШаблон(<span class="фиолетовый">"Не хвататет товара %1 в количестве %3"</span>,
                                                                    ВыборкаДетальных.НоменклатураП,
                                                                    ВыборкаДетальных.Количество - ВыборкаДетальных.КоличествоОбщ);
                                        СообщениеП.Сообщить();
    
                                        Отказ = Истина;
                                    КонецЕсли;
    
                                    Если Отказ Тогда
                                        Продолжить;
                                    КонецЕсли;  
                                    
                                    //применяем методику "условие последнего списания"
                                    Если ВыборкаДетальных.Количество = ВыборкаДетальных.КоличествоОбщ Тогда
                                        Себестоимость = ВыборкаДетальных.СебестоимостьОбщ;
                                    Иначе	
                                        Себестоимость = ВыборкаДетальных.СебестоимостьОбщ / ВыборкаДетальных.КоличествоОбщ * ВыборкаДетальных.Количество;
                                    КонецЕсли;
    
                                    Движение = Движения.ОстаткиНоменклатуры_Билет3.Добавить(); 
                                    Движение.ВидДвижения = ВидДвиженияНакопления.Расход;
                                    Движение.Период = Дата;
                                    Движение.Номенклатура = ВыборкаДетальных.Номенклатура;
                                    Движение.Количество = ВыборкаДетальных.Количество; 
                                    Движение.Себестоимость = Себестоимость;						
                                КонецЕсли;	 	
                            КонецЦикла;
                        КонецЕсли;               
                    КонецЕсли;
                КонецПроцедуры
            </pre>
        </div>
        <p>При выполнении этого кода правильно будет работать только метод списания ФИФО, по средней будет уходить в минус в остатках. Всё потому, что по средней нет партий и мы в движения их не записываем, а потому эти записи не взаимозачетаются с приходными. В приходных записях есть партия, а в расходных по средней нет и получаются это разные записи. Чтобы исправить этот случай давайте в приходных тоже получать значение учётной политики и от значения добавлять значение в поле партия и не добавлять.</p>
        <div class="code-style">
            <pre>
                --модуль объекта приходной накладной 
    
                Процедура ОбработкаПроведения(Отказ, РежимПроведения) 
                    МетодСписания = УчетнаяПолитика.ПолучитьМетодСписанияСебестоимости(Дата); 
    
                    Если МетодСписания = Неопределено Тогда
                        Сообщить(<span class="фиолетовый">"Не указан метод списания"</span>);  
                        Отказ = Истина;
                        Возврат;
                    КонецЕсли;
    
                    Запрос = Новый Запрос;
                    Запрос.Текст = 
                        <span class="фиолетовый">"ВЫБРАТЬ   
                        |	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
                        |	&Дата КАК Период,
                        |	ПриходнаяНакладная_Билет3СписокНоменклатуры.Номенклатура КАК Номенклатура,
                        |	ПриходнаяНакладная_Билет3СписокНоменклатуры.Ссылка КАК Партия,
                        |	СУММА(ПриходнаяНакладная_Билет3СписокНоменклатуры.Количество) КАК Количество,
                        |	СУММА(ПриходнаяНакладная_Билет3СписокНоменклатуры.Сумма) КАК Себестоимость
                        |ИЗ
                        |	Документ.ПриходнаяНакладная_Билет3.СписокНоменклатуры КАК ПриходнаяНакладная_Билет3СписокНоменклатуры
                        |ГДЕ
                        |	ПриходнаяНакладная_Билет3СписокНоменклатуры.Ссылка = &Ссылка
                        |
                        |СГРУППИРОВАТЬ ПО
                        |	ПриходнаяНакладная_Билет3СписокНоменклатуры.Номенклатура,
                        |	ПриходнаяНакладная_Билет3СписокНоменклатуры.Ссылка"</span>;
                    
                    Запрос.УстановитьПараметр(<span class="фиолетовый">"Ссылка"</span>, Ссылка);
                    Запрос.УстановитьПараметр(<span class="фиолетовый">"Дата"</span>, Дата);
                    РезультатЗапроса = Запрос.Выполнить();
                    Выборка = РезультатЗапроса.Выбрать();
                    
                    //из-за того, что в выборке теперь есть все данные, то мы можем
                    //через метод ЗаполнитьЗначенияСвойств() заполнить данными движения     
                    Движения.ОстаткиНоменклатуры_Билет3.Записывать = Истина;
                    Пока Выборка.Следующий() Цикл
                        //регистр ОстаткиНоменклатуры_Билет3
                        Движение = Движения.ОстаткиНоменклатуры_Билет3.Добавить();
                        ЗаполнитьЗначенияСвойств(Движение, Выборка);
                        
                        Если МетодСписания = <span class="фиолетовый">"ПоСредней"</span> Тогда
                            Движение.Партия = <span class="фиолетовый">Документы.ПриходнаяНакладная.ПустаяСсылка()</span>;
                        КонецЕсли;		
                    КонецЦикла;
                КонецПроцедуры
            </pre>
        </div>
        <p>Теперь код работает правильно, но не совсем. Если всё сделать как написано в билете, провести все документы по тем указаным датам, то в итоге при последнем расходном документе мы получим минус в остатках, хотя товары будут. Всё из-за того, что все 3 приходных документа у нас пришли с заполнением партии, потому что такая была цчётная политика в январе, мы списали в январе только одну куртку. Наступил февраль и мы поменяли учётную политику списания по средней. Помним что у нас ещё 2 куртки на складе. Пытаемся провести документ и продать 1 куртку и он проводится, но если в этот миг посмотреть в остатки, то там образовался отрицательный остаток. Да всё потому, что у нас с прошлого месяца 2 записи с заполненной партией, а списывем мы уже в феврале без партий, поэтому система и не может сопоставить записи, потому что они разные и не совпадают по полю "Партия", чтобы их списать. </p>
        <p>Нам нужно как то перенести январьские партийные записи на февраль, но так, чтобы по средней можно было с ними рабюотать. Т.е. январьские записи в полем "Партия" должны перенестись на февраль, но поле "Партия" должно стать с пустой ссылкой. </p>
        <p>В общем нам нужно подправить записи регистра при переходе с одной учётной политики на другую. Делать это будет документ учётной политики "НазначениеУчётнойПолитики_Билет3". Нам нужно этим документом списать все оставшиеся приходные записи. Какие именно с партией или без. Это зависит от того на какую методику списания мы переключаемся. Сейчас мы переключаемся на методику по средней, значит нужно списать все записи, у которых заполненно поле "Партия". Вот такой код у обработки проведения документа "НазначениеУчетнойПолитики_Билет3":</p>
        <div class="code-style">
            <pre>
                --модуль объекта документа "НазначениеУчетнойПолитики_Билет3"
    
                Процедура ОбработкаПроведения(Отказ, Режим)
                    <span class="зелёный">// регистр УчетнаяПолитика</span>
                    Движения.УчетнаяПолитика_Билет3.Записывать = Истина;
                    Движение = Движения.УчетнаяПолитика_Билет3.Добавить();
                    Движение.Период = Дата;<span class="фиолетовый">
                    Движение.МетодСписанияСебестоимости = МетодСписанияСебестоимости;
                            
    
                    <span class="зелёный">//тут мы подправляем регистр "ОстаткиНоменклатуры_Билет3" при переходе
                    //с одной учётной политики на другую</span>
                    //для начала очищаем от записей в случае перепроведения документа  
                    Если МетодСписанияСебестоимости = Перечисления.УчетнаяПолитика_Билет3.ПоСредней Тогда
                        Движения.ОстаткиНоменклатуры_Билет3.Очистить();
                        
                        Движения.ОстаткиНоменклатуры_Билет3.Записывать = Истина; 
                        
    
                        <span class="зелёный">//пока мы переводим все записи из прошлого месяца в новый, нужно заблокировать
                        //всю таблицу, чтобы никто там в минус не ушёл, пока мы проводим документ.</span>
                        Блокировка = Новый БлокировкаДанных;
                        ЭлементБлокировки = Блокировка.Добавить(<span class="фиолетовый">"РегистрНакопления.ОстаткиНоменклатуры_Билет3"</span>);
                        ЭлементБлокировки.Режим = РежимБлокировкиДанных.Исключительный; 
                        Блокировка.Заблокировать();
                
    
                        Запрос = Новый Запрос;
                        Запрос.Текст = 
                            <span class="фиолетовый">"ВЫБРАТЬ
                            |	ОстаткиНоменклатуры_Билет3Остатки.Номенклатура КАК Номенклатура,
                            |	ОстаткиНоменклатуры_Билет3Остатки.Партия КАК Партия,
                            |	ОстаткиНоменклатуры_Билет3Остатки.КоличествоОстаток КАК КоличествоОстаток,
                            |	ОстаткиНоменклатуры_Билет3Остатки.СебестоимостьОстаток КАК СебестоимостьОстаток
                            |ИЗ
                            |	РегистрНакопления.ОстаткиНоменклатуры_Билет3.Остатки(&НаДату, НЕ Партия = ЗНАЧЕНИЕ(Документ.ПриходнаяНакладная.ПустаяСсылка)) КАК ОстаткиНоменклатуры_Билет3Остатки
                            |ИТОГИ
                            |	СУММА(КоличествоОстаток),
                            |	СУММА(СебестоимостьОстаток)
                            |ПО
                            |	Номенклатура"</span>;  
                        
                        Запрос.УстановитьПараметр(<span class="фиолетовый">"НаДату"</span>, МоментВремени());
                        РезультатЗапроса = Запрос.Выполнить();
                        ВыборкаГрупп = РезультатЗапроса.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
                        
    
                        Пока ВыборкаГрупп.Следующий() Цикл
                            ВыборкаДетальных = ВыборкаГрупп.Выбрать();
                            Пока ВыборкаДетальных.Следующий() Цикл
                                Движение = Движения.ОстаткиНоменклатуры_Билет3.Добавить();
                                Движение.ВидДвижения = ВидДвиженияНакопления.Расход;
                                Движение.Период = Дата;
                                Движение.Номенклатура = ВыборкаДетальных.Номенклатура; 
                                Движение.Партия = ВыборкаДетальных.Партия;
                                Движение.Количество = ВыборкаДетальных.КоличествоОстаток;
                                Движение.Себестоимость = ВыборкаДетальных.СебестоимостьОстаток;
                            КонецЦикла;
                            
                            ДвижениеД = Движения.ОстаткиНоменклатуры_Билет3.Добавить();
                            ДвижениеД.ВидДвижения = ВидДвиженияНакопления.Приход;
                            ДвижениеД.Период = Дата;
                            ДвижениеД.Номенклатура = ВыборкаГрупп.Номенклатура;	
                            ДвижениеД.Партия = Документы.ПриходнаяНакладная_Билет3.ПустаяСсылка();	
                            ДвижениеД.Количество = ВыборкаГрупп.КоличествоОстаток;	
                            ДвижениеД.Себестоимость = ВыборкаГрупп.СебестоимостьОстаток;	
                        КонецЦикла;
                    КонецЕсли;
                    
                КонецПроцедуры
            </pre>
        </div>
        <p>Но это мы подправляем регистр при переходе на средний метод списания. А если наоборот, нам нужно переходить со среднего на ФИФО? А ничего не нужно, всё будет работать как есть. При выполнении кода, который списывает по фифо мы из остатков получим пустую ссылку в партиях и пустую ссылку и запишем, так что всё хорошо отработает.</p>
        <p>И ещё один важный вывод, из кода обработки проведения расходной накладной убираем весь код списания по средней, потому что списание по фифо отработает правильно и там и там.</p>
        <p>Вот конечный правильный код обработки проведения расходной накладной:</p>
        <div class="code-style">
            <pre>
                Процедура ОбработкаПроведения(Отказ, РежимПроведения)   
    
                    МетодСписания = УчетнаяПолитика.ПолучитьМетодСписанияСебестоимости(Дата); 
    
                    Если МетодСписания = Неопределено Тогда
                        Сообщить(<span class="фиолетовый">"Не указан метод списания"</span>);
                        Отказ = Истина; 
                        Возврат;
                    КонецЕсли;
    
    
                    Движения.ОстаткиНоменклатуры_Билет3.Очистить();
                    Движения.ОстаткиНоменклатуры_Билет3.Записать();
    
                    Движения.ОстаткиНоменклатуры_Билет3.Записывать = Истина;
    
    
                    Запрос = Новый Запрос;
                    Запрос.МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц;
                    Запрос.Текст = 
                        <span class="фиолетовый">"ВЫБРАТЬ
                        |	РасходнаяНакладная_Билет3СписокНоменклатуры.Номенклатура КАК Номенклатура,
                        |	СУММА(РасходнаяНакладная_Билет3СписокНоменклатуры.Количество) КАК КоличествоПродажи
                        |ПОМЕСТИТЬ ВТ
                        |ИЗ
                        |	Документ.РасходнаяНакладная_Билет3.СписокНоменклатуры КАК РасходнаяНакладная_Билет3СписокНоменклатуры
                        |   И РасходнаяНакладная_Билет3СписокНоменклатуры.Номенклатура.ВидНоменклатуры = ЗНАЧЕНИЕ(Перечисление.ВидыНоменклатуры.Товар)
                        |ГДЕ
                        |	РасходнаяНакладная_Билет3СписокНоменклатуры.Ссылка = &Ссылка
                        |
                        |СГРУППИРОВАТЬ ПО
                        |	РасходнаяНакладная_Билет3СписокНоменклатуры.Номенклатура,
                        |	РасходнаяНакладная_Билет3СписокНоменклатуры.Номенклатура.ВидНоменклатуры"</span>;
    
                    Запрос.УстановитьПараметр(<span class="фиолетовый">"Ссылка"</span>, Ссылка);
                    РезультатЗапроса = Запрос.Выполнить();
    
                    Блокировка = Новый БлокировкаДанных;
                    ЭлементБлокировки = Блокировка.Добавить(<span class="фиолетовый">"РегистрНакопления.ОстаткиНоменклатуры_Билет3"</span>);
                    ЭлементБлокировки.Режим = РежимБлокировкиДанных.Исключительный; 
                    ДанныеБлокировки = СписокНоменклатуры.Выгрузить(, <span class="фиолетовый">"Номенклатура"</span>);
                    ЭлементБлокировки.ИсточникДанных = ДанныеБлокировки; 
                    ЭлементБлокировки.ИспользоватьИзИсточникаДанных(<span class="фиолетовый">"Номенклатура"</span>, <span class="фиолетовый">"Номенклатура"</span>);
                    Блокировка.Заблокировать();               
    
                    Запрос = Новый Запрос;
                    Запрос.Текст =  
                        <span class="фиолетовый">"ВЫБРАТЬ
                        |	ВТ.Номенклатура КАК Номенклатура,
                        |	ПРЕДСТАВЛЕНИЕ(ВТ.Номенклатура) КАК НоменклатураП,
                        |	ВТ.КоличествоПродажи КАК Количество,  
                        |	ОстаткиНоменклатуры_Билет3Остатки.Партия КАК Партия,
                        |	ЕСТЬNULL(ОстаткиНоменклатуры_Билет3Остатки.КоличествоОстаток, 0) КАК КоличествоОбщ,
                        |	ЕСТЬNULL(ОстаткиНоменклатуры_Билет3Остатки.СебестоимостьОстаток, 0) КАК СебестоимостьОбщ
                        |ИЗ
                        |	ВТ КАК ВТ
                        |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ОстаткиНоменклатуры_Билет3.Остатки(
                        |				&ДатаДокумента,
                        |				Номенклатура В
                        |					(ВЫБРАТЬ
                        |						ВТ.Номенклатура
                        |					ИЗ
                        |						ВТ КАК ВТ)) КАК ОстаткиНоменклатуры_Билет3Остатки
                        |		ПО ВТ.Номенклатура = ОстаткиНоменклатуры_Билет3Остатки.Номенклатура 
                        |
                        |УПОРЯДОЧИТЬ ПО
                        |	ОстаткиНоменклатуры_Билет3Остатки.Партия.МоментВремени
                        |ИТОГИ
                        |	МИНИМУМ(Количество),
                        |	СУММА(КоличествоОбщ)
                        |ПО
                        |	Номенклатура"</span>;
    
                    
                    Запрос.УстановитьПараметр(<span class="фиолетовый">"Ссылка"</span>, Ссылка);   
                    Если РежимПроведения= РежимПроведенияДокумента.Неоперативный Тогда
                        Запрос.УстановитьПараметр(<span class="фиолетовый">"ДатаДокумента"</span>, МоментВремени());
                    Иначе
                        Запрос.УстановитьПараметр(<span class="фиолетовый">"ДатаДокумента"</span>, Неопределено);	
                    КонецЕсли;
                    РезультатЗапроса = Запрос.Выполнить(); 
    
                        
                    Если НЕ РезультатЗапроса.Пустой() Тогда 
                        ВыборкаГрупп = РезультатЗапроса.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
                        Пока ВыборкаГрупп.Следующий() Цикл 
                            Если ВыборкаГрупп.Количество > ВыборкаГрупп.КоличествоОбщ Тогда
                                СообщениеП = Новый СообщениеПользователю;
                                СообщениеП.Текст = СтрШаблон(<span class="фиолетовый">"Не хватает товара %1 в количестве %2"</span>,
                                                                ВыборкаГрупп.НоменклатураП,
                                                                (ВыборкаГрупп.Количество - ВыборкаГрупп.КоличествоОбщ)); 
                                СообщениеП.Сообщить();
    
                                Отказ = Истина;			
                            КонецЕсли;     
    
                            Если Отказ Тогда
                                Продолжить;
                            КонецЕсли;
    
                            СписываемоеКоличество = ВыборкаГрупп.Количество; 
    
                            ВыборкаДетальных = ВыборкаГрупп.Выбрать();   
                            Пока ВыборкаДетальных.Следующий() Цикл 
                                Если СписываемоеКоличество > 0 Тогда
                                    Движение = Движения.ОстаткиНоменклатуры_Билет3.Добавить(); 
                                    Движение.ВидДвижения = ВидДвиженияНакопления.Расход;
                                    Движение.Период = Дата;
                                    Движение.Номенклатура = ВыборкаДетальных.Номенклатура;
                                    Движение.Партия = ВыборкаДетальных.Партия;
                                
                                    Если СписываемоеКоличество &lt; ВыборкаДетальных.КоличествоОбщ Тогда
                                        Движение.Количество = СписываемоеКоличество;
                                        Движение.Себестоимость = СписываемоеКоличество / ВыборкаДетальных.КоличествоОбщ * ВыборкаДетальных.СебестоимостьОбщ;
                                        СписываемоеКоличество = СписываемоеКоличество - СписываемоеКоличество; 
                                    Иначе
                                        Движение.Количество = ВыборкаДетальных.КоличествоОбщ;
                                        Движение.Себестоимость = ВыборкаДетальных.СебестоимостьОбщ;
                                        СписываемоеКоличество = СписываемоеКоличество - ВыборкаДетальных.КоличествоОбщ;
                                    КонецЕсли;
                                КонецЕсли;	
                            КонецЦикла; 
                        КонецЦикла;	   
                    КонецЕсли;
                КонецПроцедуры
            </pre>
        </div>
        <p>Из-за чего мы удалили код списания по средней, потому что код списания по фифо нормально списывает, когда даже партии не заполнены, т.е. пустые. Допустим к нам пришли товары и метод списания у нас стоит "ПоСредней", значит партии будут пустые. Когда выполняется код по фифо, то мы получаем из регистра остатки товары и партии, но партии пусты, значит в Выборка.Партия будет пустая ссылка, мы спишем нормально товар и запишем в Движение.Партия эту же пустую ссылку. Так что код по фифо хорошо отрабатывает в обоих случаях, потому и убрали код по средней.</p>
        <p>Для примера так будет выглядеть результат запроса при проверке контроля остатков, как видим партии пусты, но это не мешает списывать по методу ФИФО:</p>
        <img src="../img/1С-1/2024-06-19_22-06-28.png" class="screen" alt="">
        <p><span class="светло_красный">В билете есть такое предложение - "Считается, что документы задним числом не вводятся, но старые документы могут неоперативно перепроводиться." . Не обращаем на него внимания.</span></p>
    </div>



    <div class="spec-10">
        <p class="title-size16"><b id="spec-10">Отчёт. Движения товаров за период. Занятие 13. Билет №3(Оперативный учёт).</b></p>
        <p><span class="светло_красный">Из нового это группировка полей в одной ячейке и переделывание представления для ссылки документа, а также убираем лишние названия ресурсов из заголовка полей через макет.</span></p>
        <p>Вот такие отчёты, где есть начальные и конечные остатки, приходы и расходы, называются ведомостями. Для построения таких отчётов всегда используется виртуальная таблица "ОстаткиИОбороты".</p>
        <p>Составили запрос, во вкладке "Ресурсы" можно выбрать всё или не выбирать ничего, потому что в билете как видно нет никаких итоговых значений. Но для дальнейшей работы с отчётом пользователю могут понадобится ресурсы, поэтому добавим все ресурсы и отключим итоги в настройках.</p>
        <p>Далее на закладке "Параметры" мы точно также как и в предыдущем отчёте создаём свой параметр "Период":</p>
        <img src="../img/1С-1/2024-06-17_16-36-21.png" class="screen" alt="">
        <p>Далее определяем заголовок также через макет.</p>
        <p>Кстати я не заметил, но поле "Номенклатура" является группировкой, а в ней детальные записи. </p>
        <p>Произвели первоначальные настройки отчёта и получилось так:</p>
        <img src="../img/1С-1/2024-06-21_08-33-45.png" class="screen" alt="">
        <p>Первая задача, как разместить в одной ячейке и кодичество и сумму. Для этого в настройках на закладке "Выбранные поля" выделяем нужные поля и вызываем контекстное меню, в котором выбираем пункт "Сгруппировать поля": </p>
        <img src="../img/1С-1/2024-06-22_07-21-43.png" class="screen-2" alt="">
        <p>При группировке поле помещаются в группировку и можно дать имя этой групировке и расположить поля внурти вертикально друг под другом. Группируем поля вот так: </p>
        <img src="../img/1С-1/2024-06-22_07-28-52.png" class="screen-2" alt="">
        <p>Сейчас у нас получится вот такой отчёт:</p>
        <img src="../img/1С-1/2024-06-22_07-31-52.png" class="screen" alt="">
        <p>Дальше пока оставим поля ресурсы и обратим внимание на поле "Партия". Нам нужно вместо текущего представления ссылки на документ вывести как в билете. Я попробовал это сделать через два события, которые позволяют создать собственное представление для ссылки, вот код: </p>
        <div class="code-style">
            <pre>
                --модуль менеджера документа "ПриходнаяНакладная"
    
                Процедура ОбработкаПолученияПолейПредставления(Поля, СтандартнаяОбработка)
                    СтандартнаяОбработка = Ложь;
    
                    Поля.Добавить("Дата");
                    Поля.Добавить("Номер");
                КонецПроцедуры
    
                Процедура ОбработкаПолученияПредставления(Данные, Представление, СтандартнаяОбработка) 
                    СтандартнаяОбработка = Ложь;
    
                    Представление = СтрШаблон("ПН № %1 от %2%3", Число(Данные.Номер), Символы.ПС, Формат(Данные.Дата, "ДФ=dd.MM.yyyy"));
                КонецПроцедуры
            </pre>
        </div>
        <p>Но есть ещё проще способ. Сама схема компоновки данных предоставляет нам такую возможность. На закладке "Наборы данных" у полей справа есть такое поле "Выражение представления", вот в этом поле мы можем составить представление для ссылки документа. Для поля "Партия" напишем такое выражение:</p>
        <img src="../img/1С-1/2024-06-22_08-27-20.png" class="screen-2" alt="">
        <p>Если так и оставить, то получится неплохо, но с номером нужно что то сделать, а именно убрать лидирующие нули. В выражениях СКД можно вызывать функции из общих модулей. Создадим общий модуль "НумерацияОбъектов". Кстати в типовых такой общий модуль называется "ПерфиксацияОбъектов". В модуле моздадим функцию НомерНаПечать() где и будем убирать нули.</p>
        <p>Добавим в выражение вызов функцию из общего модуля:</p>
        <img src="../img/1С-1/2024-06-22_08-38-41.png" class="screen-2" alt="">
        <p>Кстати партия может быть пустой, это как мы помним, из-за того, что товар поступил тогда, когда учётная политика была по средней, ну или при переходе на среднюю в записях регистра поле партия стала пустой. В таком случае в выражении "Партия.Номер" или "Партия.Дата" может быть равна Null. Это нужно предусмотреть. Можно воспользоваться условием ВЫБОР КОГДА: </p>
        <img src="../img/1С-1/2024-06-22_17-24-01.png" class="screen-2" alt="">
        <p><b id="spec-10.1">Заголовоки полей</b>. Теперь попробуем убрать из заголовка ресурсов столько названий. Как видим система друг под другом разместила аж 3 заголовка для одной сущности. Нам нужно всего один заголовок оставить, самый верхний, это тот что мы дали название группировке полей. Делать будем через макет.</p>
        <p>Так как вся таблица находится внутри группировки "Номенклатура", то для этой группировки через контекстное меню задаём имя группировки: </p>
        <img src="../img/1С-1/2024-06-22_19-16-12.png" class="screen-2" alt="">
        <p>Идём на закладку "Макет" и добавляем новый макет "Добавить макет заголовка группировки". В открывшейся форме выбираем пункт "Имя группировки", по имени ищем нагу группировку "Номенклатура" и жмём ОК. Затем в табличном документе спарава нужно нарисовать заголовок для всей таблицы: </p>
        <img src="../img/1С-1/2024-06-22_19-24-14.png" class="screen" alt="">
        <p>Получился такой отчёт:</p>
        <img src="../img/1С-1/2024-06-23_09-10-09.png" class="screen" alt="">
        <p>Если присмотреться, то слева в каждой ячейки есть отступ, давайте сделаем это через условное оформление для всего отчёта.</p>
        <p>Также давайте сделаем высоту для группировки "Номенклатура" и для детальных записей повыше, как это показано в билете. Сделаем это через макет. Для группировки "Детальные записи" дадим имя "Детальные записи". Затем идём в макеты и сощдаём новый макет группировки "Добавить макет группировки". В окне выбираем пунк "Имя группировки" - сначала "Номенклатура". Высота для номенклатуры примерно 2 строки. Объединим ячейки для номенклатуры и партии(Ctrl + M):</p>
        <img src="../img/1С-1/2024-06-23_09-31-23.png" class="screen" alt="">
        <p>Затем для детальных записей также добавялем "Добавить макет группировки", по имени выбираем группировку "Детальные запси". В макете теперь сделаем высоту в 3 строки:</p>
        <img src="../img/1С-1/2024-06-23_09-35-31.png" class="screen" alt="">
        <p>Выделим ячеки с параметром "Номенклатура" и "Партия" и в свойствах во вкладке "Основные" в свойстве "Размещение текста" выберем "Переносить", чтобы текст в этих ячейках переносился.</p>
        <p>Посмотрим какая красота получилась:</p>
        <img src="../img/1С-1/2024-06-23_09-46-07.png" class="screen" alt="">
        <p>Можно убрать межу значениями ресурсов разделительные полосы, объединив ячеки с этими параметрами в макете. Но можно и выключить макет оформления для всего отчёта. Давайте выключим: "Настройки" - "Другие настройки" - "Макет оформления" - "Без оформления". Если помсотреть отчёт, то уберутся все границы. Теперь в макете можно добавить свои границы. Выделяем разные ячейки и добавляем кграницы где надо, получается вот такое:</p>
        <img src="../img/1С-1/2024-06-23_09-59-22.png" class="screen" alt="">
        <p>Не забываем сделать сортировку для всего отчёта. Сначала по номенклатуре, потом по партии.</p>
        <p>На этом всё.</p>
    </div>



    <div class="spec-11">
        <p class="title-size16"><b id="spec-11">Списание с учётом приоритетов складов. Занятие 14. Билет №4(Оперативный учёт).</b></p>
        <p>Описал решение этого билета в базе "ПодготовкаКСпецуЛеонтьев" в объектах конфигурации с добавлением к именам "_Билет4".</p>
        <p>Создали один регистр накопления "ОстаткиНоменклатуры_Билет4" с измерениями "Номенклатура" и "Склад", а также с ресурсами "Количество" и "Себестоимость". Нам достаточно одного регистра накопления, потому что расчитывать себестоимость будем по средней для каждого склада. Вот если бы расчитывать нужно было в общем по всем складам себестоимость, то тогда понадобился второй регистр(многоскладской учёт). </p>
        <p>Также нужно создать регистр сведений "ПриоритетыСкладов_Билет4",  чтобы хранить приоритеты складов. У меня приоритеты в виде строк: "А", "Б", "В", где "А" это наивысший приоритет и далее на снижение. Леонтьев сделал числовыми приоритеты. Ещё он оставил этот регистр независимым, значит будем вручную добавлять приоритеты, я же сделал добавление приоритетов через документ "НазначениеПриоритетов_Билет4". </p>
        <p>Вот такой код будет в обработке проведения расходной накладной:</p>
        <div class="code-style">
            <pre>
                Процедура ОбработкаПроведения(Отказ, РежимПроведения)   
    
                    Движения.ОстаткиНоменклатуры_Билет4.Очистить();
                    Движения.ОстаткиНоменклатуры_Билет4.Записать();
    
                    Движения.ОстаткиНоменклатуры_Билет4.Записывать = Истина;
    
    
                    Запрос = Новый Запрос;
                    Запрос.МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц;
                    Запрос.Текст = 
                        <span class="фиолетовый">"ВЫБРАТЬ
                        |	РасходнаяНакладная_Билет4СписокНоменклатуры.Номенклатура КАК Номенклатура,
                        |	РасходнаяНакладная_Билет4СписокНоменклатуры.Номенклатура.ВидНоменклатуры КАК ВидНоменклатуры,
                        |	СУММА(РасходнаяНакладная_Билет4СписокНоменклатуры.Количество) КАК Количество
                        |ПОМЕСТИТЬ ВТ
                        |ИЗ
                        |	Документ.РасходнаяНакладная_Билет4.СписокНоменклатуры КАК РасходнаяНакладная_Билет4СписокНоменклатуры
                        |ГДЕ
                        |	РасходнаяНакладная_Билет4СписокНоменклатуры.Ссылка = &Ссылка
                        |	И РасходнаяНакладная_Билет4СписокНоменклатуры.Номенклатура.ВидНоменклатуры = ЗНАЧЕНИЕ(Перечисление.ВидыНоменклатуры.Товар)
                        |
                        |СГРУППИРОВАТЬ ПО
                        |	РасходнаяНакладная_Билет4СписокНоменклатуры.Номенклатура,
                        |	РасходнаяНакладная_Билет4СписокНоменклатуры.Номенклатура.ВидНоменклатуры,
                        |	РасходнаяНакладная_Билет4СписокНоменклатуры.Ссылка.Склад
                        |
                        |ИНДЕКСИРОВАТЬ ПО
                        |	Номенклатура"</span>;
    
                    Запрос.УстановитьПараметр(<span class="фиолетовый">"Ссылка"</span>, Ссылка);
                    РезультатЗапроса = Запрос.Выполнить();
    
                    Блокировка = Новый БлокировкаДанных;
                    ЭлементБлокировки = Блокировка.Добавить(<span class="фиолетовый">"РегистрНакопления.ОстаткиНоменклатуры_Билет4"</span>);
                    ЭлементБлокировки.Режим = РежимБлокировкиДанных.Исключительный; 
                    ДанныеБлокировки = СписокНоменклатуры.Выгрузить(, <span class="фиолетовый">"Номенклатура"</span>);
                    ЭлементБлокировки.ИсточникДанных = ДанныеБлокировки; 
                    ЭлементБлокировки.ИспользоватьИзИсточникаДанных(<span class="фиолетовый">"Номенклатура"</span>, <span class="фиолетовый">"Номенклатура"</span>);   
                    <span class="зелёный">//Склады не указываем, тем самым блокируем все склады, так сказал Леонтьев
                    //Мне опять не понятен этот миг, могу предположить, что заблокируются все
                    //записи с этими указанными товарами, а у этих товаров могут быть разные склады
                    //Вот допустим мы указали заблокировать товар "Куртка замш" и склад из шапки "Основной"
                    //В этом случае заблокируется только запись с товаром "Куртка замш" и склад "Основной"
                    //А если не указывать склад, то заблокируется несколько записей с товаром "Куртка замш",
                    //у которой будут разные склады: "Куртка замш"-"Основной", "Куртка замш"-"Розничный", "Куртка замш"-"Транзитный"
                    //Вот мы уже заблокировали 3 записи со всеми складами, где встречается этот товар </span>	
                    Блокировка.Заблокировать();               
    
                    Запрос.Текст =  
                        <span class="фиолетовый">"ВЫБРАТЬ
                        |	ВТ.Номенклатура КАК Номенклатура,
                        |	ПРЕДСТАВЛЕНИЕ(ВТ.Номенклатура) КАК НоменклатураП,
                        |	ВТ.Количество КАК Количество,
                        |	ОстаткиНоменклатуры_Билет4Остатки.Склад КАК Склад,
                        |	ЕСТЬNULL(ОстаткиНоменклатуры_Билет4Остатки.КоличествоОстаток, 0) КАК КоличествоОбщ,
                        |	ЕСТЬNULL(ОстаткиНоменклатуры_Билет4Остатки.СебестоимостьОстаток, 0) КАК СебестоимостьОбщ,
                        |   ВЫБОР
                        |       КОГДА ОстаткиНоменклатуры_Билет4Остатки.Склад = &Склад ТОГДА
                        |           0
                        |       ИНАЧЕ
                        |           1
                        |   КОНЕЦ КАК СкладИзШапки,
                        <span class="зелёный">//эта строка означает, что если для какого то склада не задан приоритет и значение равно Null, то мы переделаем Null в 
                        //в низший приоритет который у нас есть, а это приоритет "В"</span>
                        |	ЕСТЬNULL(ПриоритетыСкладов_Билет4СрезПоследних.Приоритет, ЗНАЧЕНИЕ(Перечисление.ПриоритетыСкладов_Билет4.В)) КАК Приоритет
                        |ИЗ
                        |	ВТ КАК ВТ
                        |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ОстаткиНоменклатуры_Билет4.Остатки(
                        |				&ДатаДокумента,
                        |				Номенклатура В
                        |					(ВЫБРАТЬ
                        |						ВТ.Номенклатура
                        |					ИЗ
                        |						ВТ КАК ВТ)) КАК ОстаткиНоменклатуры_Билет4Остатки
                        |		ПО ВТ.Номенклатура = ОстаткиНоменклатуры_Билет4Остатки.Номенклатура
                        |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ПриоритетыСкладов_Билет4.СрезПоследних(&ДатаДокумента) КАК ПриоритетыСкладов_Билет4СрезПоследних
                        |		ПО (ОстаткиНоменклатуры_Билет4Остатки.Склад = ПриоритетыСкладов_Билет4СрезПоследних.Склад)
                        |
                        |УПОРЯДОЧИТЬ ПО
                        |   СкладИзШапки,
                        |	Приоритет УБЫВ 
                        |АВТОУПОРЯДОЧИВАНИЕ
                        |ИТОГИ
                        |	МИНИМУМ(Количество),
                        |	СУММА(КоличествоОбщ)
                        |ПО
                        |	Номенклатура"</span>;
    
                    
                    Запрос.УстановитьПараметр(<span class="фиолетовый">"Ссылка"</span>, Ссылка);   
                    Запрос.УстановитьПараметр(<span class="фиолетовый">"Склад"</span>, Склад);   
                    Если РежимПроведения= РежимПроведенияДокумента.Неоперативный Тогда
                        Запрос.УстановитьПараметр(<span class="фиолетовый">"ДатаДокумента"</span>, МоментВремени());
                    Иначе
                        Запрос.УстановитьПараметр(<span class="фиолетовый">"ДатаДокумента"</span>, Неопределено);	
                    КонецЕсли;
                    РезультатЗапроса = Запрос.Выполнить(); 
    
                        
                    Если НЕ РезультатЗапроса.Пустой() Тогда 
                        ВыборкаГрупп = РезультатЗапроса.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
                        Пока ВыборкаГрупп.Следующий() Цикл 
                            Если ВыборкаГрупп.Количество > ВыборкаГрупп.КоличествоОбщ Тогда
                                СообщениеП = Новый СообщениеПользователю;
                                СообщениеП.Текст = СтрШаблон(<span class="фиолетовый">"Не хватает товара %1 в количестве %2"</span>,
                                                                ВыборкаГрупп.НоменклатураП,
                                                                (ВыборкаГрупп.Количество - ВыборкаГрупп.КоличествоОбщ)); 
                                СообщениеП.Сообщить();
    
                                Отказ = Истина;			
                            КонецЕсли;     
    
                            Если Отказ Тогда
                                Продолжить;
                            КонецЕсли;
    
                            СписываемоеКоличество = ВыборкаГрупп.Количество; 
    
                            ВыборкаДетальных = ВыборкаГрупп.Выбрать();   
                            Пока ВыборкаДетальных.Следующий() Цикл 
                                Если СписываемоеКоличество > 0 Тогда
                                    Движение = Движения.ОстаткиНоменклатуры_Билет4.Добавить(); 
                                    Движение.ВидДвижения = ВидДвиженияНакопления.Расход;
                                    Движение.Период = Дата;
                                    Движение.Номенклатура = ВыборкаДетальных.Номенклатура;
                                    Движение.Склад = ВыборкаДетальных.Склад;
                                
                                    Если СписываемоеКоличество &lt; ВыборкаДетальных.КоличествоОбщ Тогда
                                        Движение.Количество = СписываемоеКоличество;
                                        Движение.Себестоимость = СписываемоеКоличество / ВыборкаДетальных.КоличествоОбщ * ВыборкаДетальных.СебестоимостьОбщ;
                                        СписываемоеКоличество = СписываемоеКоличество - СписываемоеКоличество; 
                                    Иначе
                                        Движение.Количество = ВыборкаДетальных.КоличествоОбщ;
                                        Движение.Себестоимость = ВыборкаДетальных.СебестоимостьОбщ;
                                        СписываемоеКоличество = СписываемоеКоличество - ВыборкаДетальных.КоличествоОбщ;
                                    КонецЕсли;
                                КонецЕсли;		
                            КонецЦикла; 
                        КонецЦикла;	   
                    КонецЕсли;
                КонецПроцедуры
            </pre>
        </div>
        <p>Пишу уже после этого урока. Леонтьев говорит, что для измерения "Склад" нужно поставить в свойствах галочки для таких свойств как "Ведущее" и "Запрет незаполненных значений". Ну как по мне это не особо нужно для решения билета, а вот для настоящего примера из жизни наверно нужно. Да и вообще раньше слышал, что практически всегда можно ставить галовку "Ведущее", чтобы в регистрах удалялись записи с теми измерениями, которые удалили из конфигурации.</p>
        <p>Ещё раз, галочку "Запрет незаполненных значений" ставят тогда, когда запись регистра не имеет смысла без этого значения. В нашем случае без склада нет смысла делать запись в регистр.</p>
    </div>


    <div class="spec-12">
        <p class="title-size16"><b id="spec-12">Отчёт "ДвижениеТоваровЗаПериод_Билет4". Занятие 14. Билет №4(Оперативный учёт).</b></p>
        <p><span class="светло_красный">Новое в этом отчёте это то что в ресурсах нижнее число это сумма и где то оно целое, а где то дробное. Там где оно целое запятую не нужно показывать, там где оно дробное нужно показать одну цифру после запятой.</span></p>
        <p>Если смотреть на таблицу из билета, то она полностью совпадает с таблицей из билета 3. Тут такая же ведомость движения товаров. Только тут группировка по складам.</p>
        <p>Смотреть в базе отчёт "ДвижениеТоваровЗаПериод_Билет4". Был затык с тем как сделать ширину колонки с названием номенклатуры меньше. Нужно в макете для ячейки с номенклатурой в свойствах "Основные" - "Размещение текста" указать "Переносить", а затем в условном оформлении для всего отчёта указать макчимальную ширину(указывается в ширинах одной буквы).</p>
        <p><b>Сортировка</b></p>
        <p>Опять вылетала ошибка, что поле не может быть в группировке. Выделил детальные записи и в ней в сортировке указал и склад и номенклатуру, так заработало.</p>
        <p><b>Указание точности для суммы</b></p>
        <p>Есть три способа это сделать, но не все они самые лучшие. Чтобы видеть дробные числа мы добавили в приходных к сумме немного копеек, теперь в отчёте мы видим для себестоимости дробные числа с точностью 2:</p>
        <img src="../img/1С-1/2024-06-27_09-22-40.png" class="screen" alt="">
        <p>Первый способ</p>
        <p>Можно для отчёта в условном оформлении добавить для полей себестоимости формат с точностью числа 1:</p>
        <img src="../img/1С-1/2024-06-27_09-27-11.png" class="screen" alt="">
        <p>Мы получим себестоимость такую какую нам нужно, но тогда к целым числам прибавится 0 после запятой:</p>
        <img src="../img/1С-1/2024-06-27_09-29-18.png" class="screen" alt="">
        <p>Нас это не устраивает. Перейдём к первому способу. Создадим вычисляемое поле, в выражении этого поля укажем сравнение: </p>
        <img src="../img/1С-1/2024-06-27_15-56-02.png" class="screen" alt="">
        <p>Выводить это поле мы нигде не будем, оно нам нужно только для понятия, значение в поле сейчас целое или дробное. Когда система проходит по записям, то мы получаем значение себестоимости начального остатка и сравниваем его с целым значением этого же остатка. Если изначальное значение дробное, то сравнение вернёт Ложь. Итак запомним, что это поле содержит булево значение - дробный или не дробный у нас остаток начальной себестоимости.  </p>
        <p>Теперь идём в настройки отчёта на закладку "Условное оформление". Добавляем новое условное оформление. В формлении выбираем Формат = "ЧДЦ=1". Это значит что мы к значению применям точность 1 после запятой, но как мы ранее вяснили, применится ко всем значениям такая точность. Значит нам надо сделать какое то условие, по которому мы применим этот формат. В поле "Условие" мы применим отбор, где выберем наше вычисляемое поле и сравним его с Ложь. Вспоминаем, выше я писал, что если вычисляемое поле содержит Ложь, то там дробное число. Вот тут и спрашиваем: "Вычисляемое поле ты равно Ложь?" и если равно то мы выбираем оформляемые поля, к которым мы применим формат с точностью 1. Это поле будет "СебестоимостьНачальныйОстаток": </p>
        <img src="../img/1С-1/2024-06-27_16-10-09.png" class="screen" alt="">
        <p>В отчёте мы видим, что дробные числа начального остатка себестоимости обрезался до одного знака, а целые не трогались и остались целыми без запятых: </p>
        <img src="../img/1С-1/2024-06-27_16-12-30.png" class="screen" alt="">
        <p>Вот таким способом нужно для остальны полей проделать работу. Но как говорит Леонтьев, то на закладке "Выбраные поля" в настройках отчёта появится ещё 4 вычисленных поля, что захламляет список полей. Можной пойти похожим образом, но более чистым.</p>
        <p>Второй способ</p>
        <p>Заходим на закладку "Пользовательские поля" и теперь там создаём точно такое же поле, как и в предыдущем примере мы создавали вычисляемое поле, и в окошке "Выражение детальных записей" указываем точно такое же выражение. Затем создаём условное офрмление и выбираем всё то же самое, только для условия выбирем поле из пользовательских полей. Преимущество этого способа в том, что теперь все поля добавленные не захламляют список полей, а находятся в отдельной папке "Пользовательские поля":</p>
        <img src="../img/1С-1/2024-06-27_16-21-32.png" class="screen-2" alt="">
        <p>Третий способ самый оптимальный</p>
        <p>Этот способ делается на закладке "Наборы данных" в схеме компоновки данных. У полей себестоимости мы просто задаём выражение представления в соответствующем поле:</p>
        <div class="code-style">
            <pre>
                ВЫБОР 
                    КОГДА СебестоимостьРасход = Цел(СебестоимостьРасход) ТОГДА 
                        Формат(СебестоимостьРасход, "ЧДЦ=0") 
                    ИНАЧЕ 
                        Формат(СебестоимостьРасход, "ЧДЦ=1") 
                КОНЕЦ
            </pre>
        </div>
        <p>Но почему то у меня не хочет применяться этот способ, я перетыкал во всё что знал, но не применяется.</p>
        <p><span class="светло_красный">В общем я сделал через пользовательские поля по второму способу. Пока не знаю в чём причина не срабатывания через выражение представления</span>.</p>
        <p>Ещё в чате советовали способ через вычисляемые поля просто в выражении написать "Окр(СебестоимостьНачальныйОстаток, 1)" и так для каждого поля себестоимости. При таком способе целые числа так и оастанутся целыми, а с двумя цифрами после запятой округлятся до одной цифры после запятой. Ну это в принципе относится к первому способу, просто выражение другое.</p>
    </div>



    <div class="spec-13">
        <p class="title-size16"><b id="spec-13">Дополнительные затраты. Занятие 15. Билет №15(Оперативный учёт).</b></p>
        <p><span class="светло_красный">Как делать списание методами ФИФО и ЛИФО с учётом учётной политики мы описывали ранее. Здесь новое это введение документа "ДополнительныеЗатраты"</span></p>
        <p>Описание кода приходной и расходной накладной находится в документах в добавкой "_Билет15" у этих документов.</p>
        <p>В запросе нам нужно было получать и товары и услуги. Товары записываются только в регистр остатки, а товары и услуги записываются в регистр продаж. Поэтому нужно было вытащить как то вид номенклатуры в итоги, потому что уже на уровне итоговых записей надо было проверять кто услуга, а кто товар. Оказалось можно поле "ВидНоменклатуры" вытащить в итоги с помощью функции МИНИМУМ или МАКСИМУМ. Да оказывается к такому полю как перечисление можно применить функция для чисел.</p>
        <p>Итак, создаём документ "ДополнительныеЗатраты" и этот документ должен добавить в регистр продаж свои записи с добавочной себестоимостью для тех номенклатур, которые совпадают с номенклатурой из указанной расходной накладной. Я сначала не совсем понял и изменял записи регистра прибавляя к себестоимости ту сумму, которая указана в дополнительных затратах, а Леонтьев сделал так, что не изменяем записи а добавляем просто этим документом записи с добавочной себестоимостью для совпадающих номенклатур. Получается вот такой регистр:</p>
        <img src="../img/1С-1/2024-07-02_08-42-57.png" class="screen" alt="">
        <p>Мы просто добавляем в регистр дополнительную себестоимость для совпадающих номенклатур, а виртуальная таблица нам в итоге посчитает и сложит эти себестоимости. И ещё один миг. В условии задачи сказано, что себестоимость для выбранного периода должна уже включать в себя и добавленные доп затраты, в не зависимости от того когда доп затраты были проведены. Значит когда мы допзатратами пишем записи, то дату ставим ту, которая указана в расходной накладной. На картинке видно что допзатраты документ проведён позже, но в периоде стоит та же дата что и у указанной накладной. Хотя Леонтьев указал дату проведения допзатрат. Если что допишу как правильно нужно указать дату.Да, всё правильно, нужно указывать дату документа расходной накладной, который мы определяем в реквизите "РасходныйДокумент". Но как получить дату имея ссылку на документ? Можно через точку получить дату - "РасходныйДокумент.Дата", но тогда будет получен весь объект из базы со всеми реквизитами и закеширован. Можно отдельный запрос соорудить и получить только дату. А можно в существующем запросе из записей регистра просто взять данные поля Период. Мы же отобрали записи регистра по расходному документу, значит там период по этомц расходному документу. Всё берём дату из периода и записываем в новые движения. Всё это можно посмотреть в модуле объекта документа "ДополнительныеЗатраты".</p>
        <p>И ещё одно замечание. У Леонтьева если в дополнительных затратах есть номенклатура, которой нет в указанной расходной накладной, то доп затарты вообще не проводятся(Отказ = Истина). Я же не стал так делать, у меня если какой то номенклатуры нет, то она просто пропускается, а какие есть записываются. Фиг значет как правильно. В билете явно не указано как надо. Поэтому думаю и тот и другой способ подходят.</p>
    </div>
    
    

    <div class="spec-14">
        <p class="title-size16"><b id="spec-14">Отчёт "Продажи_Билет15". Занятие 15. Билет №15(Оперативный учёт).</b></p>
        <p>В этом отчёте нет ничего нового, что мы не делали ранее. Поэтому ничего описывать не буду. Отчёт можно посмотреть в базе "ПодготовкаКСпецуЛеонтьев" в отчёте "Продажа_Билет15".</p>
        <p>Напомню, если названия полей не помещаются, то можно задать свойству "Минимальная ширина" длину в количествах букв на закладке "Наборы данных" для полей.</p>
        <p>Не забываем сортировку. Сначала по виду номенклатуры, а затем по самой номенклатуре. Одно замечание. Если я использовал группировку "Детальные записи" для отображения заголовка через макет, то сортировку надо указать не для всего отчёта, а для группировки "Детальные записи", которая выводит детальные записи. Если я попытаюясь сделать сортировку для всего отчёта, то будут ошибки, потому что система пытается отсортировать и для группировки детальных запсей, которую я использую для отображения заголовка отчёта. Если бы не было группировки для заголовка, то можно было бы и для всего отчёта сделать сортировку.</p>
    </div>




    <div class="spec-15">
        <p class="title-size16"><b id="spec-15">Учёт в двух валютах. Занятие 16. Билет №7(Оперативный учёт).</b></p>
        <p><span class="светло_красный">Новое тут это использование валют.</span></p>
        <p>Тут приходная и расходная накладная делают всё то же самое что и в предыдущем 15 билете. Для назначения учётной политики используется документ "НазначениеУчетнойПолитики". Соответственно используется и регистр сведений "УчётнаяПолитика".</p>
        <p>Регистры тут как и раньше это остатки номенклатуры и продажи. По условию задачи у нас учёт ведётся в 2х ценностях: в рублях и долларах. Для этого в обоих регистрах мы задвоим ресурсы. В остатках будуд себестоимость в рублях и в долларах. В продажах будут себестоимость и сумма в рублях и долларах.</p>
        <img src="../img/1С-1/2024-07-03_07-01-21.png" class="screen-2" alt="">
        <p>Затем по условию нужно добавить реквизит "КурсДоллара" в оба документа приходной и расходной. Для этого реквизита укажем, что его заполнение обязательно, потому что от него будет зависеть заполнение ресурсов регистров.</p>
        <p><span class="светло_синий">Хорошее замечание из сообщений. "У КурсаДоллара в палитре свойств можно указать Минимальное значение (отличное от нуля, например, 1), тогда при условии Проверка заполнения- Выдавать ошибку, установить ноль в качестве КурсаДоллара будет невозможно. Таким образом перед делением на КурсДоллара  проверять его на равенство(неравенство) нулю не нужно". Но этого мало, нужно ещё и в коде установить проверку, чтобы курс не был 0, потому что есть ещё способ запускать создание и проведение документа программно, а значит настройки для реквизитов в форме не учитываются. Но Леонтьев не стал делать проверку в коде на наличие 0 в курсе. Говорит он не нужен. Я решил оставить проверку.</span></p>
        <p>В билете есть такая строка - " Возникновение курсовых разниц на себестоимость при продаже не предполагается". Что это значит? Допустим мы приходуем товар по одному курсу, то и продавать желательно по тому же курсу, иначе товар в остатках зависнет именно по образованию отрицательного/не отрицательного остатка себестоимости в долларах.Чтобы убрать такие остатки, нужно в регистр остатки в измерение "СебестоимостьВДолларах" высчитывать точно также как и рубли высчитываем. До этого мы в эту себестоимость как получали значение? Мы брали вычисленную себестоимость в рублях и делили на курс, так и записывали себестоимость в долларах. А нужно вычислять как и для рублей. Но это только для остатков такое нужно, потому что там приходы и расходы. Для продаж такое не надо. Оказалось надо. Для поля себестоимости в долларах тоже нужно отдельно вести итоговую себестоимость в долларах и её записывать. Единственное место где мы делим на курс, то это сумма продаж в долларах.</p>
        <p>Как я понял это мы и сделали условие задачи, мы убрали влияние курса на себестоимость. Как бы там курс не менялся в расходной накладной, мы всё равно списываем из полученных остатков себестоимости.</p>
        <p>На этом всё, дальше отчёт.</p>
    </div>



    <div class="spec-16">
        <p class="title-size16"><b id="spec-16">Отчёт "Продажи_Билет7". Занятие 16. Билет №7(Оперативный учёт).</b></p>
        <p>В отчёте нет ничего нового, всё как в прошлом отчёте. Если что в базе отчёт "Продажи_Билет7".</p>
    </div>



    <div class="spec-17">
        <p class="title-size16"><b id="spec-17">Стелажи и комплектующие(составляющие). Занятие 17. Билет №6(Оперативный учёт).</b></p>
        <p>Стелаж это сооружение состоящее из полок скреплённых каким-то каркасом(стойки, болты).</p>
        <p>По задаче нам нужно обеспечить уникальность составляющих для стелажей. В жизни такое почти не встречается, но тут нужно показать что мы понимаем как это сделать. Для этого нужно создать регистр сведений "СоставСтеллажей". Единственным измерением будут составляющие стелажей, регистр по этому одному измерению и будет следить за уникальностью этих комплектующих. Ресурсами будут стеллажи и количество составляющих нужное для их сбора.</p>
        <p>Далее при проведении мы можем указать в табличной части и составляющие и сами стеллажи. Нужно в коде разобрать эти стелажи на составляющие и соединить с остальными составляющими, которые будут в табличной части. В итоге мы должны получить список номенклатуры, состоящий только из составляющих и их количества, которые мы хотим продать.</p>
        <p>Разобрать стеллажи на составляющие мы можем в запросе средней сложности. Этот запрос в начале обработки "ОбработкаПроведения" расходной накладной. Себестоимость учитывать не нужно, значит из ресурсов в регистре остатков будет только "Количество". Разобрали, получили список только составных деталей и проверили остатки этих деталей на складе. Всё это описано в обработке проведения расходной накладной под номером _Билет6.</p>
        <p>Также есть такая задачка, она не относится к экзамену, но в жизни вполне могут попросить решить её. Вот продаём мы составные части и стелажи в одной табличной части. И не хватает каких то составных частей. Внизу в сообщении мы пользователю покажем каких составных частей не хватает, но, например, мы продаём "Комплектующая №1" и Стеллаж№2. И в сообщении мы показываем, что не хватает "Комплектующая №3". Ну так как продаваемых товаров мало, то понятно что этих комплектующих нет из-за стеллажа №2. А если товаров будет много, то фиг разберёшь из-за какого стеллажа идут нехватки. Поэтому можно разработать механизм, позволяющий определить стеллаж, в котором не хватает составных частей. Этот механизм есть в обработке, он помечен комментами, в которых я написал про это.</p>
        <p>Механизм этот можно сделать по разному. Я сделал так, что пользователь увидит о нехватке комплектующих, которые не видны в продаваемых товарах, но они есть в продаваемых стелажах. Если есть нехватка комплектующих, которые есть в товарах и они видны, то их нехватка так и будет показана без привязок к стеллажам.</p>
        <p>Если не очень понятно, то вот картинка проводки товаров:</p>
        <img src="../img/1С-1/2024-07-10_11-30-51.png" class="screen-2" alt="">
        <p>В товарах видно саму коплектующую "Комплектующая №1", поэтому о её нехватке так и сообщаем пользователю, думаю он увидит её в товарах и поймёт что нужно уменьшить. Даже есть эти комплектующие есть в каком то продаваемом стеллаже. Хотя в жизни думаю там всё по обстоятельствам, кому то захочется и стеллажи видеть, в которых есть эта комплектующая. А вот видим, что нехватка "Комплектующая №2" не видна физически в товарах и не совсем понятно что нужно убрать из товаров или уменьшить, чтобы нехватка исчезла. Вот мой механизм и показывает, в каком стеллаже есть нехватающая комплектующая.</p>
        <p>Леонтьев сделал так, что нехватка комплектующих показывается во всех стеллажах, которые продаются, если конечно они входят в состав этих стеллажей. </p>
        <p>Далее, у нас в билете курсивом обозначено, что изменилось в билете. Леонтьев этого не делал, именно план видов характеристик и новый отчёт, поэтому самому пришлось.</p>
        <p>Чтобы для отчёта получить стеллажи, посчитанные из имеющихся на складах составляющих, мне пришлось создать регистр сведений "СтеллажейНаСкладах_Билет6". И записывать документами приходная и расходная наличие стеллажей на складах, путём подсчёта их из составляющих имеющихся на складах. Пробовал и регистр накопления, но он не подходил, пока больше подошло хранить во времени просто состояние имеющихся полных стеллажей на тот или иной период.</p>
        <p>Ну и в отчёте просто получаем из этого регистра данные и выводим. Также в регистре храним для каждого стеллажа его характеристику, которую связали со свойствами и их значениями.</p>
    </div>



    <div class="spec-18">
        <p class="title-size16"><b id="spec-18">Отчёт "НаличиеСтеллажей_Билет6". Занятие 17. Билет №6(Оперативный учёт).</b></p>
        <p>В отчёте нет ничего нового. Если что в базе отчёт "НаличиеСтеллажей_Билет6".</p>
    </div>



    <div class="dpec-19">
        <p class="title-size16"><b id="spec-19">Индексирование таблиц. Занятие 18.</b></p>
        <p>Короче писать много, лучше видео смотреть. Оно не сложное для понимания, и желательно его пересматривать, чтобы запомнить.</p>
    </div>




    <div class="spec-20">
        <p class="title-size16"><b id="spec-20">Продукты, наборы и готовые блюда. Занятие 19/20. Билет 10(Оперативный учёт)</b></p>
        <p>Итак, по условию задачи у нас есть 3 вида номенклатуры. Создаём перечисление "ВидыНоменклатуры" с 3мя значениями: "Продукт", "НаборПродуктов" и "ГотовоеБлюдо".</p>
        <p>В задаче не сказано, но скорее всего закупает наш общепит только продукты, а потому в табличной части приходной накладной для поля "Номенклатура" укажем через параметры выбора, что приходовать можем только продукты, исключив из списка остальные номенклатуры(наборы и блюда). </p>
        <p>В расходной накладной такого ограничения конечно нет, мы должны мочь продавать всё.</p>
        <p>Далее создадим документ "Комплектация_Билет10", который будет составлять готовую еду из продуктов и проводить по регистру остатков. В модуле объекта этого документа теперь сделаем по новой методике списание продуктов, нужных на еду. Записываем в регистр, проверяем отрицательные остатки и если всё хорошо, то проводим документ. </p>
        <p><span class="светло_красный">В билете сказано, что документом "Комплектация" пользователь может делать записи в любой регистр накопления. Но леонтьев это почему то пропустил и как это делать пока не знаю. </span></p>
        <p>Теперь нам нужно как в прошлой задаче для наборов продуктов сделать регистр сведений с составом этих наборов. Тут немного по другому. Нам не нужно следить за уникальностью продуктов, которые мы можем использовать в наборе, поэтому будет 2 измерения "НаборПродуктов" и "Продукты", а ресорсом будет количество каждого продукта.</p>
        <p>И тут кроется сложность при получении количества продуктов для какого-то набора на какую-то дату. В чём эта сложность? Вот так выглядит регистр сведений. Допустим у нас есть записи для одного набора но в разные даты с разным составом:</p>
        <img src="../img/1С-1/2024-07-25_09-46-14.png" class="screen-2" alt="">
        <p>Попытаемся получить на сегодняшнюю дату состав набора №1, т.е. самые последние записи для этого набора. К удивлению мы получим такие записи:</p>
        <img src="../img/1С-1/2024-07-25_16-20-33.png" class="screen" alt="">
        <p>Как видим в выборке есть лишняя запись на более позднюю дату. Но система нам всё верно выдала. Ведь лук он же тоже из набора №1, пусть и из прошлого состава, но система этого не понимает, она смотрит на измерения. И сложность теперь в том, что надо как-то отобрать записи так, чтобы состав набора был только за одинаковую указанную дату. Т.е. только 3 верхнии записи. Лук уже лишний, он из прошлого состава набора №1.</p>
        <p>Я смог придумать пока только способ такой. Мы получаем эти записи из регистра сведений и добавляем итоги по набору и для периода применяем функцию МАКСИМУМ(). В итоговую запись попадёт наибольшая дата. По этой дате во встроенном языке мы в созданную таблицу значений отберём нужные записи. И далее используем эту таблицу значений в запросе для объединения с другими таблицами. Вот такой код:</p>
        <div class="code-style">
            <pre>
                --модуль объекта документа "РасходнаяНакладная_Билет10"
    
                <span class="зелёный">//тут мы получили записи из регистра</span>
                Запрос = Новый Запрос;
                Запрос.МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц;
                Запрос.Текст = 
                    <span class="фиолетовый">"ВЫБРАТЬ
                    |	РасходнаяНакладная_Билет10СписокНоменклатуры.Номенклатура КАК Номенклатура,
                    |	РасходнаяНакладная_Билет10СписокНоменклатуры.Количество КАК Количество
                    |ПОМЕСТИТЬ ВТ
                    |ИЗ
                    |	Документ.РасходнаяНакладная_Билет10.СписокНоменклатуры КАК РасходнаяНакладная_Билет10СписокНоменклатуры
                    |ГДЕ
                    |	РасходнаяНакладная_Билет10СписокНоменклатуры.Ссылка = &Ссылка
                    |	И РасходнаяНакладная_Билет10СписокНоменклатуры.Номенклатура.ВидНоменклатуры = ЗНАЧЕНИЕ(Перечисление.ВидыНоменклатуры_Билет10.НаборПродуктов)
                    |;
                    |
                    |////////////////////////////////////////////////////////////////////////////////
                    |ВЫБРАТЬ
                    |	ВТ.Количество КАК КоличествоПродажи,
                    |	СоставНаборовПродуктов_Билет10СрезПоследних.Период КАК Период,
                    |	СоставНаборовПродуктов_Билет10СрезПоследних.НаборПродуктов КАК НаборПродуктов,
                    |	СоставНаборовПродуктов_Билет10СрезПоследних.Продукт КАК Продукт,
                    |	СоставНаборовПродуктов_Билет10СрезПоследних.Количество КАК Количество,
                    |	ВТ.Количество * СоставНаборовПродуктов_Билет10СрезПоследних.Количество КАК КоличествоПродажиКонечное
                    |ИЗ
                    |	ВТ КАК ВТ
                    |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СоставНаборовПродуктов_Билет10.СрезПоследних(
                    |				&ДатаДокумента,
                    |				НаборПродуктов В
                    |					(ВЫБРАТЬ
                    |						ВТ.Номенклатура
                    |					ИЗ
                    |						ВТ КАК ВТ)) КАК СоставНаборовПродуктов_Билет10СрезПоследних
                    |		ПО ВТ.Номенклатура = СоставНаборовПродуктов_Билет10СрезПоследних.НаборПродуктов
                    |ИТОГИ
                    |	МАКСИМУМ(Период)
                    |ПО
                    |	НаборПродуктов"</span>;    
                
                Запрос.УстановитьПараметр(<span class="фиолетовый">"Ссылка"</span>, Ссылка);
                Запрос.УстановитьПараметр(<span class="фиолетовый">"ДатаДокумента"</span>, Дата);
                РезультатЗапроса = Запрос.Выполнить();
    
                <span class="зелёный">//создаём ТЗ для помещения туда уже правильных данных из регистра</span>
                ТаблицаСПродуктами = Новый ТаблицаЗначений; 
    
                КвалификаторыЧисла = Новый КвалификаторыЧисла(12, 3);
                ОписаниеТипаЧисло = Новый ОписаниеТипов(<span class="фиолетовый">"Число"</span>, , , КвалификаторыЧисла);
    
                ОписаниеТипаСсылка = Новый ОписаниеТипов(<span class="фиолетовый">"СправочникСсылка.Номенклатура_Билет10"</span>); 
    
                ТаблицаСПродуктами.Колонки.Добавить(<span class="фиолетовый">"Продукт"</span>, ОписаниеТипаСсылка);
                ТаблицаСПродуктами.Колонки.Добавить(<span class="фиолетовый">"Количество"</span>, ОписаниеТипаЧисло);
    
                ВыборкаПоГруппировкам = РезультатЗапроса.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
    
                Пока ВыборкаПоГруппировкам.Следующий() Цикл
                    ВыборкаДеталей = ВыборкаПоГруппировкам.Выбрать();
                
                    Пока ВыборкаДеталей.Следующий() Цикл
                        Если ВыборкаДеталей.Период = ВыборкаПоГруппировкам.Период Тогда
                            СтрокаТаблицы = ТаблицаСПродуктами.Добавить();
                            СтрокаТаблицы.Продукт = ВыборкаДеталей.Продукт;
                            СтрокаТаблицы.Количество = ВыборкаДеталей.КоличествоПродажиКонечное;
                        КонецЕсли;
                    КонецЦикла;
                КонецЦикла;	
    
    
    
                <span class="зелёный">//и тут уже параметром передаём ТЗ в запрос и используем её там</span>
                Запрос = Новый Запрос;
                Запрос.Текст =   
                    <span class="фиолетовый">"ВЫБРАТЬ
                    |	Таблица.Продукт КАК Номенклатура,
                    |	Таблица.Количество КАК Количество
                    |ПОМЕСТИТЬ ВТ1
                    |ИЗ
                    |	&ТаблицаСПродуктами КАК Таблица
                    |;
                    |////////////////////////////////////////////////////////////////////
                    |ВЫБРАТЬ
                    |	ОбъТаб.Номенклатура КАК Номенклатура, СУММА(ОбъТаб.Количество) КАК Количество
                    |ИЗ 
                    |	(ВЫБРАТЬ
                    |		РасходнаяНакладная_Билет10СписокНоменклатуры.Номенклатура КАК Номенклатура,
                    |		РасходнаяНакладная_Билет10СписокНоменклатуры.Количество КАК Количество
                    |	ИЗ
                    |		Документ.РасходнаяНакладная_Билет10.СписокНоменклатуры КАК РасходнаяНакладная_Билет10СписокНоменклатуры
                    |	ГДЕ
                    |		РасходнаяНакладная_Билет10СписокНоменклатуры.Ссылка = &Ссылка
                    |		И РасходнаяНакладная_Билет10СписокНоменклатуры.Номенклатура.ВидНоменклатуры В (ЗНАЧЕНИЕ(Перечисление.ВидыНоменклатуры_Билет10.Продукт), ЗНАЧЕНИЕ(Перечисление.ВидыНоменклатуры_Билет10.ГотовоеБлюдо))
                    |
                    |	ОБЪЕДИНИТЬ ВСЕ
                    |
                    |	ВЫБРАТЬ
                    |		ВТ1.Номенклатура,
                    |		ВТ1.Количество
                    |	ИЗ
                    |		ВТ1 КАК ВТ1) КАК ОбъТаб
                    |
                    |СГРУППИРОВАТЬ ПО
                    |	Номенклатура"</span>;
    
                Запрос.УстановитьПараметр(<span class="фиолетовый">"Ссылка"</span>, Ссылка);
                Запрос.УстановитьПараметр(<span class="фиолетовый">"ТаблицаСПродуктами"</span>, ТаблицаСПродуктами);
                РезультатЗапроса = Запрос.Выполнить(); 
            </pre>
        </div>
        <p>Дальше если решение от Леонтьева будет другим, то запишу его решение. У Леонтьева по другому, у него всё сделано в запросе. Первый запрос это мы получаем таблицу с записями, ка показано тут:</p>
        <img src="../img/1С-1/2024-07-25_16-20-33.png" class="screen" alt="">
        <p>Затем мы её помещаем во временную таблицу, далее новый пакет запроса и из этой временной таблицы получим табличку с 2мя полями. Первое поле это период, и второе это набор продуктов. Сгруппируем по набору и выберем максимальное по периоду, получится:</p>
        <img src="../img/1С-1/2024-07-27_13-02-25.png" class="screen-2" alt="">
        <p>И тоже поместим эту табличку во временную таблицу и в 3м пакете запроса соединим эту маленькую с предыдущей и получим то что нам нужно. Примеры запросов, а их два вида решения, лежат в базе в модуле объекта расходной накладной.</p>
        <p>Смотреть код в базе. Приходная, расходная и прочие регистры под билетом 10 будут.</p>
        <p>Далее разберём что значит предложение в задаче - <b>"Документом комплектация пользователь делает движения в любой регистр накопления и правильность записей контролирует сам"</b>. На самом деле это нам даже упрощает задачу. Нам не нужно выполнять контроль остатков в документе комплектации, потому что пользователь будет напрямую вносить записи в регистр и сам следить за остатками. Также может запутать такое выражение как - "пользователь делает движения в любой регистр накопления". В смысле в "любой"? У нас всего один регистр накопления. В него и будет пользователь делать движения. Если бы было больше регистров, тогда бы пользователь и выбирал бы.</p>
        <p>Итак, нам нужно сделать, чтобы пользователь мог напрямую вносить изменения в регистр накопления "ОстаткиНоменклатуры_Билет10" в документе "Комплектация". Создадим другой документ комплектации готовой еды и назовём "РучнаяКомплектация_Билет10". Также создаём в объекте конфигурации реквизиты: "ГотовоеБлюдо" и "Количество". Затем создаём свою форму документа и тут есть 2 пути, как выннести в элементы формы таблицу с данными регистра накопления остатков для этого документа.</p>
        <p>Первый это заранее для документа указать во вкладке "Движения" тот регистр, по которому мы будем делать движения. После этого действия в форме в основном реквизите "Объект" мы обнаружим коллекцию движений "Движения", в которой будет наш регистр. Выносим его в элементы формы. </p>
        <p>Второй путь это самим создать реквизит формы и указать для него тип данных такой, какой соответствует регистру накопления и также перенести в элементы формы.</p>
        <p>Между 2мя этими путями существенная разница. В первом случае не нужно при открытии формы подгружать из базы данные регистра и сохранять их в базу также не нужно. Так как это движения документа, то система сама сделает с ними всё что нужно. А вот во втором случае нужно самому всё это делать.</p>
        <p>Мы пойдём по первому пути. Также запретим провидение документа, оно нам тут не нужно. Удалим поле "Период" в таблице движений в элементах формы, чтобы пользователь не вводил даты отличающиеся от даты документа. Если удалили это поле, значит нам нужно самим его заполнить. В модуле объекта документа выбираем обработчик "ПередЗаписью" и в нём в цикле добавим в каждую запись регистра период из даты документа.</p>
        <p>Также нам нужно сделать так, чтобы при пометке на удаление документа, его движения в регистре накопления становились неактивными, т.е. в поле "Активность" для этих записей проставлялась Ложь. Такие записи при вычислении остатков не учитываются, но остаются в базе. Воплощаем это в обработчике "ПередЗаписью" в модуле объекта документа.Для экзаменов это прям сильно не требуется, чтобы была сделана возможность снятия активации при пометке на удаление, но желательно сделать, там всего 5 строчек кода.</p>
        <p>Также в целях обучения сделаем возможность при копировании документа заполнение движений той же номенклатурой, что и у источника копирования. Для этого есть обработчик "ПриКопировании" в модуле документа.</p>
        <p>В принципе на этом всё. Все детали можно посмотреть в базе.</p>
        <p><b>План видов характеристик</b></p>
        <p>Дальше продолжим выполнять то, что в билете выделено курсором. Это уже позднее добавление доп задачи в этот билет. Нужно ещё сделать для номенклатур возможность писать свойства номенклатур(что то типа - "Огуречный, входит в комплексный обед, диетический"). Свойства, как я понял, это вручную описывает сам пользователь описание номенклатуры, а затем с помощью ПВХ нам нужно для системы расшифровать эти свойства.</p>
        <p>Итак, в задаче говорится, что номенклатуру нужно вести в разрезе свойств. Значит добавим в регистр накопления остатков номенклатуры дополнительно измерение "Свойство". Какой будет тип у этого измерения? Типом будет справочник "СвойстваНоменклатуры_Билет10", который подчинён справочнику "Номенклатура_Билет10". В справочнике свойств пользователь как раз и описывает свойства для номенклатур.</p>
        <p>Далее нужно для документов приходной и расходной накладной добавить в таб. часть поле "Свойство" с таким же типом, чтобы пользователь описывал товар при поступлении и при продаже.</p>
        <p>Нужно в коде обработки проведения в запросах добавить доп. поле "Свойство". Теперь номенклатура добавляется и списывается не только по полю "Номенклатура", но и по полю "Свойство". Так что в коде нужно всё это проделать.</p>
        <p>Затем создаём ПВХ с именем "ХарактеристикиНоменклатуры_Билет10". Задаёт возможные типы: просты и ссылочные. Для ссылочного типа создадим справочник "ЗначенияХарактеристикНоменклатуры_Билет10". Этот справочник подчиняем плану и он будет содержать все значения для характеристик.</p>
        <p>Далее нужно системе объяснить какие характеристики и их значения соответствуют описанию(свойству) номенклатуры. Существует 2 способа: с помощью табличной части у элемента справочника "СвойстваНоменклатуры_Билет10" и с помощью регистра сведений.</p>
        <p><i style="text-decoration: underline;">Начнём с табличной части.</i></p>
        <p>Создаём таб. часть в справочнике "СвойстваНоменклатуры_Билет10". Заходим в пользов. часть в элементе справочника в таб. части для каждого свойства заполняем характеристики и их значения:</p>
        <img src="../img/1С-1/2024-08-15_10-36-49.png" class="screen" alt="">
        <p>Какой есть минус у этого способа. Пользователь может в таб. часть создать вторую характеристику "Цвет" и задать другой цвет в значении для одного и того же свойства, а этого нужно избежать. Хотя, думаю есть такие номенклатуры, для которых можно и нужно задавать по несколько значений характеристики. Но в нашем случае мы решили, что не нужно такое.  Кстати за наличием второй одинаковой характеристики в регистре сведений следил бы сам регистр, он не дал бы 2м одинаковым измерениям записаться. Но в нашей таб. части мы должны сами написать код, который будет следить за тем, чтобы пользователь не добавил повторную характеристику. Вот первый способ как нам проверить наличие 2 и более одинаковых свойств введённых пользователем:</p>
        <div class="code-style">
            <pre>
                --модкль объекта справочника "СвойстваНоменклатуры_Билет10"
    
                <span class="зелёный">//Этот способ вполне пригодный, но не очень отлаженный из-за того, что мы сперва записали данные
                //объекта, а потом проверяем правильные ли там данные, т.е силы сервера были потрачены на запись данных,
                //а они могут быть неправильными и их нужно будет снова стереть
                //Да и событие "ПриЗаписи" предназначено немного для другого по стандартам 1С. В этом событии мы, 
                //после записи основных данных объекта, записываем доп. данные, например в регистр. </span>
                Процедура ПриЗаписи(Отказ)
                    Запрос = Новый Запрос;
                    Запрос.Текст = 
                        <span class="фиолетовый">"ВЫБРАТЬ
                        |	СвойстваНоменклатуры_Билет10Характеристики.Характеристика КАК Характеристика,
                        |	ПРЕДСТАВЛЕНИЕ(СвойстваНоменклатуры_Билет10Характеристики.Характеристика) КАК ПХарактеристика,
                        |	КОЛИЧЕСТВО(СвойстваНоменклатуры_Билет10Характеристики.Значение) КАК КоличествоЗначений
                        |ИЗ
                        |	Справочник.СвойстваНоменклатуры_Билет10.Характеристики КАК СвойстваНоменклатуры_Билет10Характеристики
                        |ГДЕ
                        |	СвойстваНоменклатуры_Билет10Характеристики.Ссылка = &Ссылка
                        |
                        |СГРУППИРОВАТЬ ПО
                        |	СвойстваНоменклатуры_Билет10Характеристики.Характеристика
                        |
                        |ИМЕЮЩИЕ
                        |	КОЛИЧЕСТВО(СвойстваНоменклатуры_Билет10Характеристики.Значение) > 1"</span>;
                    
                    Запрос.УстановитьПараметр(<span class="фиолетовый">"Ссылка"</span>, Ссылка);
                    РезультатЗапроса = Запрос.Выполнить();  
    
                    Если Не РезультатЗапроса.Пустой() Тогда
                        Выборка = РезультатЗапроса.Выбрать();
    
                        Отказ = Истина;
                                        
                        Пока Выборка.Следующий() Цикл
                            Сообщение = Новый СообщениеПользователю;
                            Сообщение.Текст = СтрШаблон(<span class="фиолетовый">"Характеристика %1 уже была задана"</span>, Выборка.ПХарактеристика);
                            Сообщение.Сообщить();
                        КонецЦикла;
                    КонецЕсли;	
                КонецПроцедуры
            </pre>
        </div>
        <p>А вот более правильный способ, который не записывает сразу данные в базу, а проверяет их на верность введения и только потом записывает, если они правильные. Тут мы используем таб часть справочника как источник данных для запроса. Запросу не нужно лезть в БД, он берёт данные из таб. части:</p>
        <div class="code-style">
            <pre>
                Процедура ПередЗаписью(Отказ)
                    Запрос = Новый Запрос;      
                    Запрос.Текст = <span class="фиолетовый">"
                        |ВЫБРАТЬ
                        |	Характеристики.Характеристика КАК Характеристика,
                        |	Характеристики.Значение КАК Значение
                        |ПОМЕСТИТЬ ВТХарактеристики
                        |ИЗ
                        |	&Характеристики КАК Характеристики
                        |;
                        |
                        |////////////////////////////////////////////////////////////////////////////////
                        |ВЫБРАТЬ
                        |	ВТХарактеристики.Характеристика КАК Характеристика,
                        |	КОЛИЧЕСТВО(ВТХарактеристики.Значение) КАК КоличествоЗначений,
                        |	ПРЕДСТАВЛЕНИЕ(ВТХарактеристики.Характеристика) КАК ХарактеристикаПредставление
                        |ИЗ
                        |	ВТХарактеристики КАК ВТХарактеристики
                        |
                        |СГРУППИРОВАТЬ ПО
                        |	ВТХарактеристики.Характеристика
                        |
                        |ИМЕЮЩИЕ
                        |	КОЛИЧЕСТВО(ВТХарактеристики.Значение) > 1"</span>;
                
                    <span class="зелёный">//мы параметром передаём в запрос табличную часть, хотя можем и выгрузить таб часть в таблицу
                    //значений с указанными колонками, чтобы не тащить в таблицу запроса лишние колонки
                    //Но с другой стороны мы в памяти занимаем место этой таблицей значений. В нашем случае оставил без
                    //выгрузки и передаём всю таб часть, потому что там всего 3 колонки будут.</span>
                    Запрос.УстановитьПараметр(<span class="фиолетовый">"Характеристики"</span>, Характеристики);
                    РезультатЗапроса = Запрос.Выполнить();
                    
                    Если Не РезультатЗапроса.Пустой() Тогда
                        Выборка = РезультатЗапроса.Выбрать();
    
                        Отказ = Истина;
                                        
                        Пока Выборка.Следующий() Цикл
                            Сообщение = Новый СообщениеПользователю;
                            Сообщение.Текст = СтрШаблон(<span class="фиолетовый">"Характеристика %1 уже была задана"</span>, Выборка.ХарактеристикаПредставление);
                            Сообщение.Сообщить();
                        КонецЦикла;
                    КонецЕсли;	
                КонецПроцедуры
            </pre>
        </div>
        <p><span class="светло_красный">Как говорит Леонтьев, то в последних версиях типовых конфигураций характеристики находятся в табличных частях справочников, точно так как у нас в примере. Это может быть сделано для того, чтобы было проще дать права на пользование характристиками. Дал право на пользование всем справочником и значит можно пользоваться и характеристиками, которые будут в таб. части, а вот если бы они были отдельно в регистре сведений, то там с правами доступа уже потруднее.</span></p>
        <p><i style="text-decoration: underline;">Регистр сведений</i></p>
        <p>Теперь разберём как характеристики хранятся в регистре сведений. В первом примере для каждого свойства(описания номенклатуры) была своя таб. часть, в которой мы указывали характеристики и их значения соовествующие описанию из свойства. Тут же у нас вместо таб. части будет регистр сведений, где на каждое свойство будет характеритсика и значение. Назову регистр "СоответствиеХарактеристикСвойствам". Вот как вяглядит соответствия в регистре:</p>
        <img src="../img/1С-1/2024-08-21_08-59-38.png" class="screen" alt="">
        <p>В регистре для измерения "Свойство" ставим галочку "Ведущее" и тогда в элементе справочника система сама добавит ссылку на записи регистра, которые принадлежат текущему элементу справочника.</p>
        <p>Ещё для справки. В регистре все измерения система сама индексирует, а вот поля таб. части не индексируются самостоятельно. Это нам может понадобиться в отчёте, если мы будем делать отборы по харакетристикам. Отбор по индексированным полям производится быстрее.</p>
        <p>На этом всё. Что делать дальше с характеристиками я допишу в новом отчёте для билета 10.</p>
    </div>



    <div class="spec-21">
        <p class="title-size16"><b id="spec-21">Отчёт "ВедомостьПродуктов". Занятие 20. Билет 10(Оперативный учёт)</b></p>
        <p>В этом отчёте тоже ничего нового. Одна только есть деталь, которую рассказал автор. В таблице отчёта в билете видно, что сортировка идёт сначала по блюдам, а потом по продуктам. Если мы в СКД для группировки детальные записи сделаем сортировку сначала по видам номенклатуры, а потом по самой номенклатуре, то увидим, что мы, скорее всего, не добились того что нам нужно. Всё дело в том, что СКД когда сортирует по виду номенклатуры, то она берёт порядок значений перечисления "ВидыНоменклатуры", т.е. в каком порядке мы добавляли значения в перечисление, то в том порядке СКД и будет сортировать виды номенклатуры.</p>
        <p>Посмотрим, что у меня в значениях перечисления:</p>
        <img src="../img/1С-1/2024-08-09_10-53-44.png" class="screen-2" alt="">
        <p>Как видно блюда находятся в самом низу, а значит и в очёте мы увидим их внизу списка после продуктов:</p>
        <img src="../img/1С-1/2024-08-09_10-55-34.png" class="screen-2" alt="">
        <p>Чтобы исправить на правильное, поднимем значение перечисления "ГотовыеБлюда" в самый верх списка и всё заработает как надо.</p>
        <p>А вот если мы в запросе выполним сортировку, то система там отсортирует по виду номенклатуры наоборот по азбучному порядку. Сначала "ГотовыеБлюда", потом "Продукты". Т.е. сортировка в запросе сделает так как нам надо, но сортировку желательно делать в самой схеме компоновке данных, поэтому этот способ на не подходит.</p>
        <p>Но и способ с передвиганием значения перечисления только ради отчёта тоже не подходит. Самый лучший способ это в запросе сделать дополнительное поле "Порядок", которое будет формироваться из условия:</p>
        <img src="../img/1С-1/2024-08-09_11-16-47.png" class="screen" alt="">
        <p>И теперь в отчёте сортируем сначал по полю "Порядок"(возрастание), а потом по "Номенклатура"(возрастание).</p>
        <p>Также нам поле "Порядок" не хотелось бы видеть во вкладке "Настройки" во вкладках выбираемых полей, отбора и группировки. Мы можем на закладке "Наборы данных" ограничить это поле поставив галочки:</p>
        <img src="../img/1С-1/2024-08-09_11-26-35.png" class="screen" alt="">
        <p>Галочку "Упорядочивание" не ставим, потому что нам во вкладке "Сортировка" в настройках это поле нужно для сортировки. На этом всё по отчёту.</p>
    </div>



    <div class="spec-22">
        <p class="title-size16"><b id="spec-22">Новый отчёт "ВедомостьПродуктов" с характеристиками. Занятие 21. Билет 10(Оперативный учёт)</b></p>
        <p>Итак, отчёт будет таким же как и выше, это будет ведомость, но теперь добавятся и характеритсики. Механизм с планом видов характеристик уже сделан в конфигурации. Нужно получить вот такой примерно отчёт, только у нас будут продукты и блюда:</p>
        <img src="../img/1С-1/2024-08-21_09-26-47.png" class="screen" alt="">
        <p>Как видим слева к таблице добавилась колонка с характеристикой. Нам в отчёте нужно будет выбирать харакетристику и по ней должно выдать номенклатуру. У нас в конфе есть 2 воплощения планов видов характеристик: через таб частьи через регистр сведений. Для отчёта мы можем взять эту колоку с характеристиками либо и поля таб части, либо присоединить из регистра сведений. Будем брать из таб. части.</p>
        <p>В запросе мы выбираем из виртуальной таблицы остаток и оборот все остатки и саму номенклатуру, а также присоединяем поля из таб. части справочника "ОстаткиНоменклатуры_Билет10" - "Характеристика" и "Значение". Но также сразу в запросе в отборе указываем параметр "Характеристика", чтобы сразу отбирать по нужной характеристике. Такого нет в задаче, но Леонтьев где то нашёл такую таблицу из билета. </p>
        <p>Теперь в настройках отчёта нам в выбранных полях будут доступны и характеристики и их значения. Как я понял, то в этом случае нам не нужно лезть в свойство "Характеристики" у справочника "СвойстваНоменклатуры_Билет10" и не надо указывать там виды характеристик и их значения. Мы тут справились без помощи этого механизма:</p>
        <img src="../img/1С-1/2024-08-21_10-33-04.png" class="screen" alt="">
        <p>В итоге у нас получился отчёт, где мы можем только задать в отборе характеристику и период, но не можем задать конкретное значение характеристики. В отбор мы ничего не выносили, у нас на первой вкладке "Параметры" в настройках уже есть 2 параметра: Период и Харакетристика, которые мы просто включаем в пользовательские настройки.</p>
        <p>В занятии 22 мы проговорим как использовать этот механизм с дополнительными характеристиками.</p>
    </div>




    <div class="spec-23">
        <p class="title-size16"><b id="spec-23">Поступление и отгрузка по заказам покупателя. Занятие 22. Билет 12(Оперативный учёт)</b></p>
        <p>Создаём документ "ЗаказПокупателя_Билет12". Создаём регистр накопления "ОстаткиНоменклатуры_Билет12". Регистр будет с 2мя измерениями: Номенклатура и ЗаказПокупателя, и ресурсами: Количество и Себестоимость. Как говорит Леонтьев, то нужно создать ещё один регистр накопления "ТоварыКЗакупке". В этот регистр мы будем записывать из документа "ЗаказПокупателя_Билет12" то, что назаказывал покупатель, а потом, когда эти товары придут к нам на склад, то мы списываем их из этого регистра, т.е. приходная накладная будет делать расходные движения в него. Этот регистр нужен, чтобы при приходовании товаров смотреть в нём остатки ещё не доприходованных товаров из заказа. <span class="светло_синий">Я не понимаю, на кой ляд нужен этот регистр. Мы что посмотреть в табличной части заказного документа не можем, какие там нужно привезти товары? Если дальше пойму, что такой регистр нужен, то сюда допишу. Этот регистр нам нужен, чтобы смотреть остатки ещё не оприходованных товаров, например мы оприходовали часть товаров одним документом прихода, а потом решили добрать оставшуюся часть товаров, нам же нужно посмотреть, что и сколько осталось доприходовать, вот для этого регистр и нужен. В табличной части мы могли бы посмотреть, но тогда нужно было бы заниматься расчётами, сколько до этого мы оприходовали и прочее, а зачем, если есть виртуальная таблица накопления, которая остатки за нас посчтитает.</span></p>
        <p>Итак, на основании заказа мы создаём новый документ прихода, заполняем данные из документа основания в документе прихода. Пишем обработчик проведения. В обработчике для проверки остатков незаказанных ещё товаров подойдёт новая методика контроля остатков.</p>
        <p><b>ПВХ</b></p>
        <p>Теперь надо сделать план видов характеристик, делается как обычно, но есть одно отличие. Тут нет справочника со свойствами по типу - "Регион: Москва, срочность: быстро". Нам нужно характеристики привязать не к свойствам, а к самому документу заказа. Сохдаём ПВХ, затем создаём справочник дополнительных значений и создаём регистр сведений, в котором будем хранить соответствия характеристик заказу покупателя. В этом и отличие, надо запомнить, что можно ещё и так делать. </p>
        <p>Мы заходим в документ заказ покупателя и у нас появится гиперсылка на регистр сведений, из-за того что мы указали галочку "Ведущее" в регистре для измерения "ЗаказПокупателя". В этом регистре теперь заполняем соответсвия характеристик для текущего заказа:</p>
        <img src="../img/1С-1/2024-09-01_20-42-43.png" class="screen" alt="">
    </div>



    <div class="spec-24">
        <p class="title-size16"><b id="spec-24">Отчёт "АнализНедоотгруженныхЗаказов_Билет12". Занятие 23. Билет 12(Оперативный учёт)</b></p>
        <p>Нужно сделать такой отчёт:</p>
        <img src="../img/1С-1/2024-09-05_16-08-47.png" class="screen" alt="">
        <p>Как получить 2 правые колонки? Колонку "НеЗакуплено" можно получить из регистра накопления "ТоварыКЗакупке", т.к. там остатки товаров, которые мы ещё не оприходовали. А колонку "НеОтгружено" можно получить из регистра накопления "ОстаткиНоменклатуры", в ней мы отслеживаем остатки, которые ещё не продали.</p>
        <p>Сначала как делал я. Так как товары не закупленные могут не соответсвовать товаром не отгруженным, то нужно было взять какие то общие заказанные товары. Я взял все товары приходованные из основной таблицы регистра закупок. Затем левым соединением присоединил регистр остатков товаров к закупке и ещё левым соединением регистр остатков товаров. Но этот способ не совсем правильный. У нас может быть много товаров, которые и оприходовались и отгрузились и они в ноль вышли, но они будут присутсвовать в отчёте, потому что мы берём все товары из оприходованных левым соединением, а нам нужно чтобы были только не закупленные и не отгруженные. Это делается с помощью объединения 2х виртуальных таблиц остатков. Пример можно посмотреть в базе.</p>
        <p>При объединении таблиц они выстраиваются вертикально, а нам нужно 2 колонки не закупленных и не отгруженных рядом горизонтально. Для этого в первой таблице вводим 4е поле поставив 0 и обозвав его как надо, а во второй таблице 3м полем вводим 0. И вот таки способом мы разнесём по разным колонкам:</p>
        <img src="../img/1С-1/2024-09-05_16-20-26.png" class="screen" alt="">
        <p>Ну а дальше это объединение представляем в виде вложенного запроса из которого получаем новую таблицу сгруппировав записи. Далее к этой таблице присоединяем левым соединением таблицу регистра сведений, в которой описаны соответсвия характеристик и их значения каждому заказу:</p>
        <img src="../img/1С-1/2024-09-05_16-25-03.png" class="screen" alt="">
        <p>Мы получим в результате правильную таблицу, но есть одна особенность. С левой стороны у нас таблица с заказами их количеством, а справа значения характеристик для этих заказов, но если для какого то заказа не будет указан регион, то мы не увидим запись с заказаом с пустым регионом. Почему так, ведь у нас слева таблица со всеми заказами и левое соединение, мы должны видеть все заказы из левой таблицы. Но особенность в том, что если существует отбор из правой таблицы, то левое соединение превращается во внутреннее соединение. А у нас как раз такой отбор в секции "ГДЕ". Мы отбираем записи по условию из правой таблицы.</p>
        <p>Есть способ, чтобы это исправить. Мы перенесём отбор из секции "ГДЕ" в условие связи двух таблиц, вот так:</p>
        <img src="../img/1С-1/2024-09-05_16-36-10.png" class="screen" alt="">
        <p>В этом случае не нарушается левое соединение, оно им и остаётся и мы получим то что нам надо.</p>
    </div>




    <div class="spec-25">
        <p class="title-size16"><b id="spec-25">Учёт сроков годности и использования. Занятие 24. Билет 13(Оперативный учёт)</b></p>
        <p>Пока записываю как черновик.</p>
        <p>Начинаем с самого начала задачи. Нам говорят что для каждого оборудования нужно установить сроки годности и сроки использования. Устанавливаем для каждого оборудования в табличной части срок годности в днях с типом "число".</p>
        <p>Затем нам говорят, что срок годности начинается с приходованием оборудования. Значит нам нужно как то указать, что срок годности пошёл отчитываться. Как делал я. Я создавал доп. регистр сведений, куда записывал оборудование с его сроком годности(в днях) и ресурсом "НачалоСрокаГодности". В этот ресурс записывалась дата документа, что говорило, что срок пошёл с проведения этого документа. Но Леонтьев показал, как сделать проще. Мы не будем создавать доп. регистров, а сразу в регистр остатков запишем в измерение "СрокГодности"(тип "дата") уже посчитанную дату, до какого числа действует срок годности для оборудования.</p>
        <p>Переводить дни в дату мы будем в запросе приходной накладной с помощью функции <b>ДобавитьКДате(ДатаДокумента, ДЕНЬ, КоличествоДней)</b>. И получится, что мы будем иметь в регистре остатков измерение "СрокГодности" с датой, которая указывает на окончание срока годности оборудования:</p>
        <img src="../img/1С-1/2024-09-13_10-26-37.png" class="screen" alt="">
        <p>Таким образом, в отличии от моего способа, мы избавились от лишнего регистра.</p>
        <p>Далее в задаче хотят, чтобы срок использования указывался непосредственно для оборудования и не менался. Мне это было вообще не понятно, что хотят от нас. Мне показалось, что нужно в табличной части документа ввода в использования для каждого оборудования указать срок использования, но Леонтьев это понял по другому. Мы в справочнике "Номенклатура_Билет13" для каждого оборудования вводим реквизит "СрокИспользования" и там указываем этот срок в днях. Сделали.</p>
        <p>Создадим документ "ВводВИспользование" с таб. частью и двумя реквизитами в ней: "Оборудование" и "Количество". Пишем обработку проведения для этого документа, в которой проверяем срок годности оборудования и его наличие на складе. Этим документом мы будем делать расход в регистр остатков, т.е мы ввели оборудование в использование и со склада их списали.</p>
        <p>В задаче есть такая строка: "В том случае, если срок годности истек или оборудования недостаточно, документ не проводится". Получается у нас на складе 5 кинокамер с разными сроками годности. Одна кинокамера с самым маленьким сроком годности уже просрочена и получается из-за неё одной мы не сможем ввести в использование остальные кинокамеры? Так не должно быть. Если делать как написано в задаче, то так и получается, что из-за одной кинокамеры мы не сможем остальные ввести. Но мы сделаем так, чтобы не вводилась только просроченное оборудование, а остальные спокойно проходили. Для этого просто не буду отказывать в проведении, а просто мы пробежим мимо просроченного обрудования, а остальные, не просроченные, введём в использование. При этом на остатках на складе останется просроченное оборудование, но это уже забота другого документа, списать такое оборудование.</p>
        <p>Дальше по задаче нужно регламентным документом "ВыбитиеОборудования" списывать оборудование, у которого вышел срок использования или срок годности. Но мы нигде не храним введённое в использование оборудование. Поэтому нужно для начала создать регистр накопления "ОборудованиеВИспользовании_Билет13". Этот документ кстати списывает не только использованное и просроченное в процессе использования оборудование, но и то которое не было введёно в использование, но уже просрочилось. Это как раз списание с остатков на складе, т.е из регистра накопления остатков номенклатуры, того оборудования, которое там застряло просроченное.</p>
        <p>Какие измерения и ресурсы будут у регистра "ОборудованиеВИспользовании_Билет13". Измерения: "Оборудование", "ГоденДо", "ИспользованиеДо", и русурсы: "Количество" и "Себестоимость". Себестоимость можно было бы и не указывать, но она понадобится в отчёте, который мы будем строить по этому регистру.</p>
        <p>Итак, создаём регламентный документ "ВыбитиеОборудования", данных у него нет, потому как он регламентый, а значит просто служебный, раз в месяц что то там подчищает. Он должен просто проводится и выполнять некую работу. Отмечаем на вкладке "Движения" оба наших регистра.</p>
        <p>Написали обработку проведения, там кстати описанно всё что нужно знать про тонкости того, что сделали. Кстати вместо того, чтобы писать 2 запроса отдельно мы написали один пакетный запрос.</p>
    </div>




    <div class="spec-26">
        <p class="title-size16"><b id="spec-26">Отчёт "СостояниеОборудованияВИспользовании_Билет13". Занятие 24. Билет 13(Оперативный учёт)</b></p>
        <p>Отчёт этот описывать не буду, он простенький. Если что можно посмотреть в базе "ПодготовкаКСпецуЛеонтьев".</p>
    </div>


</div>