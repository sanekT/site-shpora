<div class="wrap">
    <h2 class="header-style">HTTP-заголовки ответа сервера</h2>
    <p>Функция для посыла заголовка ответа это <b>header(). В видео Уровень 2 день 1 это можно посмотреть с 01:12:20</b></p>
    
    <h3 class="header-style2">Переадресация и презапрос ресурса</h3>
    <img class="screen" src="/site-shpora/img/php/7.png" alt="">
    <p>Заголовок <b>Location</b> переадресует пользователя на другой ресурс. Когда мы делаем запрос на сервер, то вместе с заголовком Location приходит и статус кода 302. Например у нас на сайте есть форма в которой есть список select:</p>
    <div class="code-style">
        <pre>
            &lt;select name="url">
                &lt;option value="https://www.google.com">Гугл&lt;/option>
                &lt;option value="https://www.yandex.ru">Яндекс&lt;/option>
                &lt;option value="https://www.vk.com">ВК&lt;/option>
            &lt;/select>
        </pre>
    </div>
    <p>Пользователь выбирает пункт и отправляет форму, данные формы приходят на файл обработчик, в файле код получает url и посылает браузеру заголовок Location с этим адресом:</p>
    <div class="code-style">
        <pre>
            $url = strip_tags($_GET["url"]);
            if($url){
                header("Location : $url");
                exit;
            }
        </pre>
    </div>
    <p>И браузер послушно переходит на присланный адрес. Конструкция exit нужна для того, чтобы php не исполнял дальше код, так как уже в нём нет необходимости, так как заголовок улетел и браузер уже не получит дальнейший результат кода.</p>
    <p><b>Ещё один полезный способ использование этого заголовка</b>. Например есть на странице форма, мы её заполняем и отправляем данные методом POST и хотим обновить страницу, а обновление страницы это повторное послание последнего запроса. И если ннажать обновить, то появится предупреждение о повторной отправке формы, а это повторная перезапись данных в базу данных или ещё что то. Чтобы не отправлялась повторно форма, то в обработчике после всех действий с данными посылаем Location браузеру, чтобы он без нашего участия обновил страницу методом GET:</p>
    <div class="code-style">
        <pre>
            //пришли данные методом post, мы их обработали и посылаем браузеру заголовок Location
            header("Location: " . $_SERVER["PHP_SELF"]);
        </pre>
    </div>
    <p>После прихода ответа от сервера сделались все свои дела, установились там куки например и браузер должен обновить страницу, то есть сделать запрос на ту страницу на которой и находимся, но уже методом get и уже получается что последний запрос это запрос методом get, значит получается мы отправили данные методом post запрос обработался и пришёл ответ, браузер обновил страницу автоматом и теперь если мы захотим сами вручную обновить страницу, то будет выполняться последний запрос методом get, а значит повторно уже форма отправлятся не будет.</p>
    <p><b>Как перенаправить пользователя на новый адрес сайта</b>. Есть 2 способа, первый это как показано на картинке отправить 2 заголовка или послать послать один заголовок, но с дополнительными аргументами. Если мы переадресуем пользователя на другой сайт, то надо вернуть браузеру статус 301 и адрес, куда надо перейти.</p>
    <p><b>Refresh</b> - этот заголовок заставляет браузер перезагружать страницу на которой находится, время через которое надо перезапустить указанны в его значении. Если через ; указать url адрес, то через указаное время перейти на этот адрес.</p>
    <h3 class="header-style2">Заголовок Content-Type</h3>
    <p>Когда браузер запрашивает страницу, то он не знает что там придёт, сервер для этого посылает заголовок Content-Type с указанием, какой он прислал формат данных. Часто можно увидеть там такое значение:</p>
    <p><b>Content-Type: text/html; charset=UTF-8</b></p>
    <p>Это значит что пришёл формат данных - HTML в кодировке utf-8.</p>
    
    
    
    
    
    <h3 class="header-style2">Как скачать страницу</h3>
    <p>Когда мы делаем запрос на сервер, то он нам возвращает страницу-файл в виде байтов и браузер по умолчанию их выводит на экран, но мы можем сказать браузеру, чтобы он нам записал эти байты в какой то файл и дал скачать. Как это сделать? Для этого есть такие заголовки:</p>
    <p><b>header("Content-Type: file/octet-stream");</b></p>
    <p><b>header("Content-Disposition: attachment; filename='mytext.txt'");</b></p>
    <p>Если написать эти заголовки в начале какой нибудь html страницы и запросить эту страницу, то автоматом будет создан файл mytext.txt, куда запишутся все байты этой страницы и автоматом будет скачан ко мне на комп в папку Загрузки(ну это у меня так):</p>
    <img class="screen" src="/site-shpora/img/php/8.png" alt="">
    
    
    
    
    
    <h3 class="header-style2">Загрузка файлов на сервер</h3>
    <p>Пержде чем что то загружать на сервер, нужно обратить внимание на настройки php.ini:</p>
    <div class="code-style">
        <pre>
            //можно ли загружать файлы
            <span class="vue-or">file_uploads = on</span>
            
            //максимальный размер закачиваемого файла
            <span class="vue-or">upload_max_filesize = "50M"</span>
            
            //размер файла отправляемого методом post из формы
            <span class="vue-or">post_max_size = "50M"</span>
            
            //сколько файлов одновременно можно отправить
            <span class="vue-or">max_file_uploads = 20</span>
            
            //это путь до папки на сервере, куда временно закачиваются файлы, когда файлы туда закачались сервер передаёт из скрипту php и скрипт уже рассовывает по своим папкам на сайте.
            <span class="vue-or">upload_tmp_dir = "%sprogdir%/userdata/php_upload"</span>
            
            //сколько времени даём на закачку файла, стоит бесконечно
            <span class="vue-or">max_input_time = "-1"</span>
        </pre>
    </div>
    <p>После того как подправили настройки php, нам нужна веб форма, чтобы послать файл:</p>
    <div class="code-style">
        <pre>
            &lt;form enctype="<span class="vue-r">multipart/form-data</span>" method="<span class="vue-r">post</span>" action="">
                &lt;input type="hidden" name="MAX_FILE_SIZE" value="4096">
                &lt;input type="<span class="vue-r">file</span>" name="userfile">
                &lt;input type="submit" value="Отправить">
            &lt;/form>
            
            
            //по умолчанию enctype="application/x-www-form-urlencoded" - это такой способ кодировки данных
            
            //когда на сервер придёт этот файл, он сравнит его размер с тем что заданно  в поле MAX_FILE_SIZE и если размер больше он просто в свойство $_FILES['userfile']['error'] запишет номер ошибки
        </pre>
    </div>
    <p>Для примера я отправил текстовый файл через форму. Сервер этот файл временно сохранил у себя в папке(если скрипт php его не забрал, то он удалится из папки). Как посмотреть и забрать этот файл? Для этих целей есть такой суперглобальный массив $_FILES. В нём и будет лежать наш файл. Напишем скрипт обработчик для нашей формы и в скрипте выведем содержимое массива $_FILES:</p>
    <div class="code-style">
        <pre>
            if($_SERVER['REQUEST_METHOD'] == 'POST'){
                echo '&lt;pre>';
                print_r($_FILES);
                echo '&lt;/pre>';
            }
        </pre>
    </div>
    <p>Увидем такой результат:</p>
    <img class="screen-2" src="/site-shpora/img/php/10.png" alt="">
    <p><b>tmp_name</b> - по этому пути сервер временно положил наш файл и дал ему временное имя, чтобы не было конфликтов имён с другими закачиваемыми файлами. Я кстати пытался послать картинку, но в свойстве error пишет, что есть ошибка под номером 2. Пока не знаю как послать картинку, узнаю допишу. Узнал, оказывается сервер проверяет поле hidden и считывает оттуда размер и сравнивает с размером файла. Под мою картинку надо было задать число в поле hidden где то 130000, потому что картинка весила 117000 байт:</p> 
    <img class="screen-2" src="/site-shpora/img/php/11.png" alt="">
    <p>О том какие есть ошибки при загрузке файла смотрим <a href="https://www.php.net/manual/en/features.file-upload.errors.php">тут</a></p>
    <img class="screen" src="/site-shpora/img/php/12.png" alt="">
    <p>Итак, файл мы увидели в массиве, надо бы теперь его забрать, для этого есть функция <b>move_uploaded_file()</b>, 1й аргумент - откуда берём файл, 2й аргумент - куда ложим этот файл, также эта функция проверяет был ли файл передан по httpпротоколу, если нет, она его не возьмёт:</p>
    <div class="code-style">
        <pre>
            if($_SERVER['REQUEST_METHOD'] == 'POST'){
                $name = $_FILES["userfile"]["name"];
                $tmp_name = $_FILES["userfile"]["tmp_name"];
                
                move_uploaded_file($tmp_name, "upload/" . $name)
            }
        </pre>
    </div>
    <p>В результате этого кода мы перенесём файл из временной папки сервера к себе в сайт в папку upload</p>
    <p class="note">В массиве $_FILES есть свойство type, где указан тип файла, а откуда берётся эта информация? Ответ - браузер посылает. Он берёт расширение у файла и по реестру сравнивает что это за тип и отсылает серверу. Можно даже взять и текстовому файлу расширение поменять на jpg и отослать, сервер так и выдаст, что тип файла image/jpeg, поэтому нужно быть осторожней.</p>
    
    
    
    
    
    
    
    <h3 class="header-style2">Буферизация ответа</h3>
    <p>Коротко опишу смысл буферизации. Мы знаем что заголовки нужно посылать до вывода на экран какой нибудь информации. Но бывает что вверху скрипта у нас уже есть где то вывод на экран, а в низу нам нужно послать заголовок, он не пошлётся. Но мы можем все выводы на экран закинуть в буфер, и смело послыть заголовки с любого места кода. Самый простой и быстрый способ это в самом начале скрипта написать: <b>ob_start();</b> и все выводы на экран попадут в буфер, заголовки все улетят и только потом в конце выведутся на экран все вывлды из буфера.</p>
    
</div>
